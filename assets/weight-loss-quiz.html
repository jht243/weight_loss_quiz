<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weight-Loss Blueprint Quiz â€” Find your easiest fat-loss strategy</title>
    <meta name="description" content="An interactive weight-loss quiz that identifies your archetype and generates a personalized 7-day plan." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #FAFAFA;
        color: #1A1A1A;
        -webkit-font-smoothing: antialiased;
      }
      #weight-loss-quiz-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }
      #weight-loss-quiz-root > * {
        width: 100%;
        max-width: 100%;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="weight-loss-quiz-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lcyhmcm9tKSkKICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzsKfTsKdmFyIF9fdG9FU00gPSAobW9kLCBpc05vZGVNb2RlLCB0YXJnZXQpID0+ICh0YXJnZXQgPSBtb2QgIT0gbnVsbCA/IF9fY3JlYXRlKF9fZ2V0UHJvdG9PZihtb2QpKSA6IHt9LCBfX2NvcHlQcm9wcygKICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAvLyBjb21wYXRpYmxlIHRyYW5zZm9ybSAoaS5lLiAiX19lc01vZHVsZSIgaGFzIG5vdCBiZWVuIHNldCksIHRoZW4gc2V0CiAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogIG1vZAopKTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIndlYi9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKiBAdHlwZSB7UmVhY3RDb21wb25lbnR9CiAgICAgICAgICAgKi8KICAgICAgICAgIGN1cnJlbnQ6IG51bGwKICAgICAgICB9OwogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyA9IHsKICAgICAgICAgIHRyYW5zaXRpb246IG51bGwKICAgICAgICB9OwogICAgICAgIHZhciBSZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IHsKICAgICAgICAgIGN1cnJlbnQ6IG51bGwsCiAgICAgICAgICAvLyBVc2VkIHRvIHJlcHJvZHVjZSBiZWhhdmlvciBvZiBgYmF0Y2hlZFVwZGF0ZXNgIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgaXNCYXRjaGluZ0xlZ2FjeTogZmFsc2UsCiAgICAgICAgICBkaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZTogZmFsc2UKICAgICAgICB9OwogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKiBAdHlwZSB7UmVhY3RDb21wb25lbnR9CiAgICAgICAgICAgKi8KICAgICAgICAgIGN1cnJlbnQ6IG51bGwKICAgICAgICB9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0ge307CiAgICAgICAgdmFyIGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjaykgewogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHsKICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lID0gZnVuY3Rpb24oc3RhY2spIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUgPSBzdGFjazsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gbnVsbDsKICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0U3RhY2tBZGRlbmR1bSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc3RhY2sgPSAiIjsKICAgICAgICAgICAgaWYgKGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUpIHsKICAgICAgICAgICAgICBzdGFjayArPSBjdXJyZW50RXh0cmFTdGFja0ZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbXBsID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2s7CiAgICAgICAgICAgIGlmIChpbXBsKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gaW1wbCgpIHx8ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdGFjazsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY29wZUFQSSA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVDYWNoZUVsZW1lbnQgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZURlYnVnVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIsCiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZywKICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyCiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgIFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm4oZm9ybWF0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlcnJvcihmb3JtYXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdCwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0KTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfY29uc3RydWN0b3IgPSBwdWJsaWNJbnN0YW5jZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBfY29uc3RydWN0b3IgJiYgKF9jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBfY29uc3RydWN0b3IubmFtZSkgfHwgIlJlYWN0Q2xhc3MiOwogICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yKCJDYW4ndCBjYWxsICVzIG9uIGEgY29tcG9uZW50IHRoYXQgaXMgbm90IHlldCBtb3VudGVkLiBUaGlzIGlzIGEgbm8tb3AsIGJ1dCBpdCBtaWdodCBpbmRpY2F0ZSBhIGJ1ZyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBJbnN0ZWFkLCBhc3NpZ24gdG8gYHRoaXMuc3RhdGVgIGRpcmVjdGx5IG9yIGRlZmluZSBhIGBzdGF0ZSA9IHt9O2AgY2xhc3MgcHJvcGVydHkgd2l0aCB0aGUgZGVzaXJlZCBzdGF0ZSBpbiB0aGUgJXMgY29tcG9uZW50LiIsIGNhbGxlck5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3ROb29wVXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGlzIGNvbXBvc2l0ZSBjb21wb25lbnQgaXMgbW91bnRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHdlIHdhbnQgdG8gdGVzdC4KICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICogQHByb3RlY3RlZAogICAgICAgICAgICogQGZpbmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogRm9yY2VzIGFuIHVwZGF0ZS4gVGhpcyBzaG91bGQgb25seSBiZSBpbnZva2VkIHdoZW4gaXQgaXMga25vd24gd2l0aAogICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogWW91IG1heSB3YW50IHRvIGNhbGwgdGhpcyB3aGVuIHlvdSBrbm93IHRoYXQgc29tZSBkZWVwZXIgYXNwZWN0IG9mIHRoZQogICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhpcyB3aWxsIG5vdCBpbnZva2UgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAsIGJ1dCBpdCB3aWxsIGludm9rZQogICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSZXBsYWNlcyBhbGwgb2YgdGhlIHN0YXRlLiBBbHdheXMgdXNlIHRoaXMgb3IgYHNldFN0YXRlYCB0byBtdXRhdGUgc3RhdGUuCiAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlcmUgaXMgbm8gZ3VhcmFudGVlIHRoYXQgYHRoaXMuc3RhdGVgIHdpbGwgYmUgaW1tZWRpYXRlbHkgdXBkYXRlZCwgc28KICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjb21wbGV0ZVN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgKiBpbnRlcm5hbC4gVGhpcyBwcm92aWRlcyBhIG1lcmdpbmcgc3RyYXRlZ3kgdGhhdCBpcyBub3QgYXZhaWxhYmxlIHRvIGRlZXAKICAgICAgICAgICAqIHByb3BlcnRpZXMgd2hpY2ggaXMgY29uZnVzaW5nLiBUT0RPOiBFeHBvc2UgcGVuZGluZ1N0YXRlIG9yIGRvbid0IHVzZSBpdAogICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gTmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBlbXB0eU9iamVjdCA9IHt9OwogICAgICAgIHsKICAgICAgICAgIE9iamVjdC5mcmVlemUoZW1wdHlPYmplY3QpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDb21wb25lbnQocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCA9IHt9OwogICAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbihwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhcnRpYWxTdGF0ZSAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHBhcnRpYWxTdGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiBwYXJ0aWFsU3RhdGUgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFN0YXRlKC4uLik6IHRha2VzIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMgdG8gdXBkYXRlIG9yIGEgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzLiIpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy51cGRhdGVyLmVucXVldWVTZXRTdGF0ZSh0aGlzLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCAic2V0U3RhdGUiKTsKICAgICAgICB9OwogICAgICAgIENvbXBvbmVudC5wcm90b3R5cGUuZm9yY2VVcGRhdGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgdGhpcy51cGRhdGVyLmVucXVldWVGb3JjZVVwZGF0ZSh0aGlzLCBjYWxsYmFjaywgImZvcmNlVXBkYXRlIik7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZGVwcmVjYXRlZEFQSXMgPSB7CiAgICAgICAgICAgIGlzTW91bnRlZDogWyJpc01vdW50ZWQiLCAiSW5zdGVhZCwgbWFrZSBzdXJlIHRvIGNsZWFuIHVwIHN1YnNjcmlwdGlvbnMgYW5kIHBlbmRpbmcgcmVxdWVzdHMgaW4gY29tcG9uZW50V2lsbFVubW91bnQgdG8gcHJldmVudCBtZW1vcnkgbGVha3MuIl0sCiAgICAgICAgICAgIHJlcGxhY2VTdGF0ZTogWyJyZXBsYWNlU3RhdGUiLCAiUmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBzZXRTdGF0ZSBpbnN0ZWFkIChzZWUgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3Vlcy8zMjM2KS4iXQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcgPSBmdW5jdGlvbihtZXRob2ROYW1lLCBpbmZvKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb21wb25lbnQucHJvdG90eXBlLCBtZXRob2ROYW1lLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4oIiVzKC4uLikgaXMgZGVwcmVjYXRlZCBpbiBwbGFpbiBKYXZhU2NyaXB0IFJlYWN0IGNsYXNzZXMuICVzIiwgaW5mb1swXSwgaW5mb1sxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50LnByb3RvdHlwZSA9IG5ldyBDb21wb25lbnREdW1teSgpOwogICAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuY29uc3RydWN0b3IgPSBQdXJlQ29tcG9uZW50OwogICAgICAgIGFzc2lnbihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duLCBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biwgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcucmVmID09PSAic3RyaW5nIiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ICYmIGNvbmZpZy5fX3NlbGYgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IGNvbmZpZy5fX3NlbGYpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGNvbXBvbmVudE5hbWUsIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQzKHR5cGUsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lQW5kUmVwbGFjZUtleShvbGRFbGVtZW50LCBuZXdLZXkpIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gUmVhY3RFbGVtZW50KG9sZEVsZW1lbnQudHlwZSwgbmV3S2V5LCBvbGRFbGVtZW50LnJlZiwgb2xkRWxlbWVudC5fc2VsZiwgb2xkRWxlbWVudC5fc291cmNlLCBvbGRFbGVtZW50Ll9vd25lciwgb2xkRWxlbWVudC5wcm9wcyk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZiA9IGVsZW1lbnQuX3NlbGY7CiAgICAgICAgICB2YXIgc291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlICYmIGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZ1twcm9wTmFtZV0gPT09IHZvaWQgMCAmJiBkZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudChlbGVtZW50LnR5cGUsIGtleSwgcmVmLCBzZWxmLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50KG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICB9CiAgICAgICAgdmFyIFNFUEFSQVRPUiA9ICIuIjsKICAgICAgICB2YXIgU1VCU0VQQVJBVE9SID0gIjoiOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZShrZXkpIHsKICAgICAgICAgIHZhciBlc2NhcGVSZWdleCA9IC9bPTpdL2c7CiAgICAgICAgICB2YXIgZXNjYXBlckxvb2t1cCA9IHsKICAgICAgICAgICAgIj0iOiAiPTAiLAogICAgICAgICAgICAiOiI6ICI9MiIKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXNjYXBlZFN0cmluZyA9IGtleS5yZXBsYWNlKGVzY2FwZVJlZ2V4LCBmdW5jdGlvbihtYXRjaCkgewogICAgICAgICAgICByZXR1cm4gZXNjYXBlckxvb2t1cFttYXRjaF07CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiAiJCIgKyBlc2NhcGVkU3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgIHZhciB1c2VyUHJvdmlkZWRLZXlFc2NhcGVSZWdleCA9IC9cLysvZzsKICAgICAgICBmdW5jdGlvbiBlc2NhcGVVc2VyUHJvdmlkZWRLZXkodGV4dCkgewogICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSh1c2VyUHJvdmlkZWRLZXlFc2NhcGVSZWdleCwgIiQmLyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFbGVtZW50S2V5KGVsZW1lbnQsIGluZGV4KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICJvYmplY3QiICYmIGVsZW1lbnQgIT09IG51bGwgJiYgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVzY2FwZSgiIiArIGVsZW1lbnQua2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbmRleC50b1N0cmluZygzNik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcEludG9BcnJheShjaGlsZHJlbiwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5hbWVTb0ZhciwgY2FsbGJhY2spIHsKICAgICAgICAgIHZhciB0eXBlID0gdHlwZW9mIGNoaWxkcmVuOwogICAgICAgICAgaWYgKHR5cGUgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGUgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBjaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW52b2tlQ2FsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PT0gbnVsbCkgewogICAgICAgICAgICBpbnZva2VDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgICAgICBpbnZva2VDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZHJlbi4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICAgICAgICBpbnZva2VDYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbnZva2VDYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX2NoaWxkID0gY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBtYXBwZWRDaGlsZCA9IGNhbGxiYWNrKF9jaGlsZCk7CiAgICAgICAgICAgIHZhciBjaGlsZEtleSA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgKyBnZXRFbGVtZW50S2V5KF9jaGlsZCwgMCkgOiBuYW1lU29GYXI7CiAgICAgICAgICAgIGlmIChpc0FycmF5KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgIHZhciBlc2NhcGVkQ2hpbGRLZXkgPSAiIjsKICAgICAgICAgICAgICBpZiAoY2hpbGRLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXNjYXBlZENoaWxkS2V5ID0gZXNjYXBlVXNlclByb3ZpZGVkS2V5KGNoaWxkS2V5KSArICIvIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWFwSW50b0FycmF5KG1hcHBlZENoaWxkLCBhcnJheSwgZXNjYXBlZENoaWxkS2V5LCAiIiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwcGVkQ2hpbGQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChtYXBwZWRDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihtYXBwZWRDaGlsZC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCA9IGNsb25lQW5kUmVwbGFjZUtleSgKICAgICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQsCiAgICAgICAgICAgICAgICAgIC8vIEtlZXAgYm90aCB0aGUgKG1hcHBlZCkgYW5kIG9sZCBrZXlzIGlmIHRoZXkgZGlmZmVyLCBqdXN0IGFzCiAgICAgICAgICAgICAgICAgIC8vIHRyYXZlcnNlQWxsQ2hpbGRyZW4gdXNlZCB0byBkbyBmb3Igb2JqZWN0cyBhcyBjaGlsZHJlbgogICAgICAgICAgICAgICAgICBlc2NhcGVkUHJlZml4ICsgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBSZWFjdC5Qb3J0YWwgZG9lc24ndCBoYXZlIGEga2V5CiAgICAgICAgICAgICAgICAgIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSA/ICgKICAgICAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIGV4aXN0aW5nIGVsZW1lbnQncyBrZXkgY2FuIGJlIGEgbnVtYmVyCiAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWludGVybmFsL3NhZmUtc3RyaW5nLWNvZXJjaW9uCiAgICAgICAgICAgICAgICAgICAgZXNjYXBlVXNlclByb3ZpZGVkS2V5KCIiICsgbWFwcGVkQ2hpbGQua2V5KSArICIvIgogICAgICAgICAgICAgICAgICApIDogIiIpICsgY2hpbGRLZXkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFycmF5LnB1c2gobWFwcGVkQ2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgdmFyIG5leHROYW1lOwogICAgICAgICAgdmFyIHN1YnRyZWVDb3VudCA9IDA7CiAgICAgICAgICB2YXIgbmV4dE5hbWVQcmVmaXggPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SIDogbmFtZVNvRmFyICsgU1VCU0VQQVJBVE9SOwogICAgICAgICAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgICBzdWJ0cmVlQ291bnQgKz0gbWFwSW50b0FycmF5KGNoaWxkLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhYmxlQ2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiA9PT0gaXRlcmFibGVDaGlsZHJlbi5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICAgIHdhcm4oIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuQ2hpbGRyZW4ub25seSBleHBlY3RlZCB0byByZWNlaXZlIGEgc2luZ2xlIFJlYWN0IGVsZW1lbnQgY2hpbGQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgLy8gQXMgYSB3b3JrYXJvdW5kIHRvIHN1cHBvcnQgbXVsdGlwbGUgY29uY3VycmVudCByZW5kZXJlcnMsIHdlIGNhdGVnb3JpemUKICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgLy8gdGhlcmUgdG8gYmUgdHdvIGNvbmN1cnJlbnQgcmVuZGVyZXJzIGF0IG1vc3Q6IFJlYWN0IE5hdGl2ZSAocHJpbWFyeSkgYW5kCiAgICAgICAgICAgIC8vIEZhYnJpYyAoc2Vjb25kYXJ5KTsgUmVhY3QgRE9NIChwcmltYXJ5KSBhbmQgUmVhY3QgQVJUIChzZWNvbmRhcnkpLgogICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICBfY3VycmVudFZhbHVlMjogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgLy8gc3VwcG9ydHMgd2l0aGluIGluIGEgc2luZ2xlIHJlbmRlcmVyLiBTdWNoIGFzIHBhcmFsbGVsIHNlcnZlciByZW5kZXJpbmcuCiAgICAgICAgICAgIF90aHJlYWRDb3VudDogMCwKICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgIFByb3ZpZGVyOiBudWxsLAogICAgICAgICAgICBDb25zdW1lcjogbnVsbCwKICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgIF9kZWZhdWx0VmFsdWU6IG51bGwsCiAgICAgICAgICAgIF9nbG9iYWxOYW1lOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BST1ZJREVSX1RZUEUsCiAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb25zdW1lciwgewogICAgICAgICAgICAgIFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LlByb3ZpZGVyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX1Byb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSBfUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBfY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfdGhyZWFkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fdGhyZWFkQ291bnQgPSBfdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBDb25zdW1lcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycykgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Db25zdW1lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuKCJTZXR0aW5nIGBkaXNwbGF5TmFtZWAgb24gQ29udGV4dC5Db25zdW1lciBoYXMgbm8gZWZmZWN0LiBZb3Ugc2hvdWxkIHNldCBpdCBkaXJlY3RseSBvbiB0aGUgY29udGV4dCB3aXRoIENvbnRleHQuZGlzcGxheU5hbWUgPSAnJXMnLiIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb250ZXh0LkNvbnN1bWVyID0gQ29uc3VtZXI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IG51bGw7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlcjIgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIHZhciBVbmluaXRpYWxpemVkID0gLTE7CiAgICAgICAgdmFyIFBlbmRpbmcgPSAwOwogICAgICAgIHZhciBSZXNvbHZlZCA9IDE7CiAgICAgICAgdmFyIFJlamVjdGVkID0gMjsKICAgICAgICBmdW5jdGlvbiBsYXp5SW5pdGlhbGl6ZXIocGF5bG9hZCkgewogICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICB2YXIgY3RvciA9IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gY3RvcigpOwogICAgICAgICAgICB0aGVuYWJsZS50aGVuKGZ1bmN0aW9uKG1vZHVsZU9iamVjdDIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlc29sdmVkLl9zdGF0dXMgPSBSZXNvbHZlZDsKICAgICAgICAgICAgICAgIHJlc29sdmVkLl9yZXN1bHQgPSBtb2R1bGVPYmplY3QyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZWplY3RlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZWplY3RlZC5fc3RhdHVzID0gUmVqZWN0ZWQ7CiAgICAgICAgICAgICAgICByZWplY3RlZC5fcmVzdWx0ID0gZXJyb3IyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICB2YXIgcGVuZGluZyA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgcGVuZGluZy5fc3RhdHVzID0gUGVuZGluZzsKICAgICAgICAgICAgICBwZW5kaW5nLl9yZXN1bHQgPSB0aGVuYWJsZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUmVzb2x2ZWQpIHsKICAgICAgICAgICAgdmFyIG1vZHVsZU9iamVjdCA9IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChtb2R1bGVPYmplY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoImxhenk6IEV4cGVjdGVkIHRoZSByZXN1bHQgb2YgYSBkeW5hbWljIGltcG9ydCgpIGNhbGwuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzXG5cbllvdXIgY29kZSBzaG91bGQgbG9vayBsaWtlOiBcbiAgY29uc3QgTXlDb21wb25lbnQgPSBsYXp5KCgpID0+IGltcG9ydCgnLi9NeUNvbXBvbmVudCcpKVxuXG5EaWQgeW91IGFjY2lkZW50YWxseSBwdXQgY3VybHkgYnJhY2VzIGFyb3VuZCB0aGUgaW1wb3J0PyIsIG1vZHVsZU9iamVjdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoISgiZGVmYXVsdCIgaW4gbW9kdWxlT2JqZWN0KSkgewogICAgICAgICAgICAgICAgZXJyb3IoImxhenk6IEV4cGVjdGVkIHRoZSByZXN1bHQgb2YgYSBkeW5hbWljIGltcG9ydCgpIGNhbGwuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzXG5cbllvdXIgY29kZSBzaG91bGQgbG9vayBsaWtlOiBcbiAgY29uc3QgTXlDb21wb25lbnQgPSBsYXp5KCgpID0+IGltcG9ydCgnLi9NeUNvbXBvbmVudCcpKSIsIG1vZHVsZU9iamVjdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtb2R1bGVPYmplY3QuZGVmYXVsdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IHBheWxvYWQuX3Jlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGF6eShjdG9yKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IHsKICAgICAgICAgICAgLy8gV2UgdXNlIHRoZXNlIGZpZWxkcyB0byBzdG9yZSB0aGUgcmVzdWx0LgogICAgICAgICAgICBfc3RhdHVzOiBVbmluaXRpYWxpemVkLAogICAgICAgICAgICBfcmVzdWx0OiBjdG9yCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGxhenlUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTEFaWV9UWVBFLAogICAgICAgICAgICBfcGF5bG9hZDogcGF5bG9hZCwKICAgICAgICAgICAgX2luaXQ6IGxhenlJbml0aWFsaXplcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMobGF6eVR5cGUsIHsKICAgICAgICAgICAgICBkZWZhdWx0UHJvcHM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdEZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYGRlZmF1bHRQcm9wc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBuZXdEZWZhdWx0UHJvcHM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgImRlZmF1bHRQcm9wcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgcHJvcFR5cGVzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcHJvcFR5cGVzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3UHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBwcm9wVHlwZXNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgcHJvcFR5cGVzID0gbmV3UHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJwcm9wVHlwZXMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhenlUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3J3YXJkUmVmMyhyZW5kZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVxdWlyZXMgYSByZW5kZXIgZnVuY3Rpb24gYnV0IHJlY2VpdmVkIGEgYG1lbW9gIGNvbXBvbmVudC4gSW5zdGVhZCBvZiBmb3J3YXJkUmVmKG1lbW8oLi4uKSksIHVzZSBtZW1vKGZvcndhcmRSZWYoLi4uKSkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlbmRlciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCB3YXMgZ2l2ZW4gJXMuIiwgcmVuZGVyID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHJlbmRlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5sZW5ndGggIT09IDAgJiYgcmVuZGVyLmxlbmd0aCAhPT0gMikgewogICAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVuZGVyIGZ1bmN0aW9ucyBhY2NlcHQgZXhhY3RseSB0d28gcGFyYW1ldGVyczogcHJvcHMgYW5kIHJlZi4gJXMiLCByZW5kZXIubGVuZ3RoID09PSAxID8gIkRpZCB5b3UgZm9yZ2V0IHRvIHVzZSB0aGUgcmVmIHBhcmFtZXRlcj8iIDogIkFueSBhZGRpdGlvbmFsIHBhcmFtZXRlciB3aWxsIGJlIHVuZGVmaW5lZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5kZWZhdWx0UHJvcHMgIT0gbnVsbCB8fCByZW5kZXIucHJvcFR5cGVzICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgZG8gbm90IHN1cHBvcnQgcHJvcFR5cGVzIG9yIGRlZmF1bHRQcm9wcy4gRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyBhIFJlYWN0IGNvbXBvbmVudD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUsCiAgICAgICAgICAgIHJlbmRlcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bk5hbWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG93bk5hbWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgIG93bk5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgaWYgKCFyZW5kZXIubmFtZSAmJiAhcmVuZGVyLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlci5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50VHlwZTsKICAgICAgICB9CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVtbyh0eXBlLCBjb21wYXJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIm1lbW86IFRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgY29tcG9uZW50LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcyIsIHR5cGUgPT09IG51bGwgPyAibnVsbCIgOiB0eXBlb2YgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX01FTU9fVFlQRSwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghdHlwZS5uYW1lICYmICF0eXBlLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHR5cGUuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDb250ZXh0KENvbnRleHQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbnRleHQuX2NvbnRleHQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZWFsQ29udGV4dCA9IENvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKHJlYWxDb250ZXh0LkNvbnN1bWVyID09PSBDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQ2FsbGluZyB1c2VDb250ZXh0KENvbnRleHQuQ29uc3VtZXIpIGlzIG5vdCBzdXBwb3J0ZWQsIG1heSBjYXVzZSBidWdzLCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byBjYWxsIHVzZUNvbnRleHQoQ29udGV4dCkgaW5zdGVhZD8iKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlYWxDb250ZXh0LlByb3ZpZGVyID09PSBDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQ2FsbGluZyB1c2VDb250ZXh0KENvbnRleHQuUHJvdmlkZXIpIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHVzZUNvbnRleHQoQ29udGV4dCkgaW5zdGVhZD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUNvbnRleHQoQ29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN0YXRlMihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlUmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUVmZmVjdDIoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VNZW1vMihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlVHJhbnNpdGlvbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSWQoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJZCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4LnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQyKSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50Mi5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bjsKICAgICAgICB7CiAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgbmFtZSArICJgLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMoZWxlbWVudFByb3BzKSB7CiAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShlbGVtZW50UHJvcHMuX19zb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgIGluZm8gPSAiXG5cbkNoZWNrIHRoZSB0b3AtbGV2ZWwgcmVuZGVyIGNhbGwgdXNpbmcgPCIgKyBwYXJlbnROYW1lICsgIj4uIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQobm9kZSkpIHsKICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoc3RlcC52YWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheSh0eXBlKSkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIjwiICsgKGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJVbmtub3duIikgKyAiIC8+IjsKICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuY3JlYXRlRWxlbWVudDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbih0eXBlKSB7CiAgICAgICAgICB2YXIgdmFsaWRhdGVkRmFjdG9yeSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbi5iaW5kKG51bGwsIHR5cGUpOwogICAgICAgICAgdmFsaWRhdGVkRmFjdG9yeS50eXBlID0gdHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuKCJSZWFjdC5jcmVhdGVGYWN0b3J5KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIENvbnNpZGVyIHVzaW5nIEpTWCBvciB1c2UgUmVhY3QuY3JlYXRlRWxlbWVudCgpIGRpcmVjdGx5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuKCJGYWN0b3J5LnR5cGUgaXMgZGVwcmVjYXRlZC4gQWNjZXNzIHRoZSBjbGFzcyBkaXJlY3RseSBiZWZvcmUgcGFzc2luZyBpdCB0byBjcmVhdGVGYWN0b3J5LiIpOwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJ0eXBlIiwgewogICAgICAgICAgICAgICAgICB2YWx1ZTogdHlwZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbGlkYXRlZEZhY3Rvcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uKGVsZW1lbnQsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBjbG9uZUVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgbmV3RWxlbWVudC50eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKG5ld0VsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzY29wZSwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2NvcGUoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrKSB7CiAgICAgICAgICBpZiAoZW5xdWV1ZVRhc2tJbXBsID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgdmFyIG5vZGVSZXF1aXJlID0gbW9kdWxlICYmIG1vZHVsZVtyZXF1aXJlU3RyaW5nXTsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBub2RlUmVxdWlyZS5jYWxsKG1vZHVsZSwgInRpbWVycyIpLnNldEltbWVkaWF0ZTsKICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnF1ZXVlVGFza0ltcGwodGFzayk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICB2YXIgZGlkV2Fybk5vQXdhaXRBY3QgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBhY3QoY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByZXZBY3RTY29wZURlcHRoID0gYWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCsrOwogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgaWYgKCFwcmV2SXNCYXRjaGluZ0xlZ2FjeSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHByZXZJc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhciB3YXNBd2FpdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIHdhc0F3YWl0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5Ob0F3YWl0QWN0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghd2FzQXdhaXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBjYWxsZWQgYWN0KGFzeW5jICgpID0+IC4uLikgd2l0aG91dCBhd2FpdC4gVGhpcyBjb3VsZCBsZWFkIHRvIHVuZXhwZWN0ZWQgdGVzdGluZyBiZWhhdmlvdXIsIGludGVybGVhdmluZyBtdWx0aXBsZSBhY3QgY2FsbHMgYW5kIG1peGluZyB0aGVpciBzY29wZXMuIFlvdSBzaG91bGQgLSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gcmVzdWx0OwogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIF9xdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUoX3F1ZXVlKTsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZTIgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmV2QWN0U2NvcGVEZXB0aCAhPT0gYWN0U2NvcGVEZXB0aCAtIDEpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHNlZW0gdG8gaGF2ZSBvdmVybGFwcGluZyBhY3QoKSBjYWxscywgdGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBCZSBzdXJlIHRvIGF3YWl0IHByZXZpb3VzIGFjdCgpIGNhbGxzIGJlZm9yZSBtYWtpbmcgYSBuZXcgb25lLiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RTY29wZURlcHRoID0gcHJldkFjdFNjb3BlRGVwdGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlVGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmx1c2hpbmcpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUVsZW1lbnQkMSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY2xvbmVFbGVtZW50JDEgPSBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgQ2hpbGRyZW4gPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW47CiAgICAgICAgZXhwb3J0cy5Db21wb25lbnQgPSBDb21wb25lbnQ7CiAgICAgICAgZXhwb3J0cy5GcmFnbWVudCA9IFJFQUNUX0ZSQUdNRU5UX1RZUEU7CiAgICAgICAgZXhwb3J0cy5Qcm9maWxlciA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgZXhwb3J0cy5QdXJlQ29tcG9uZW50ID0gUHVyZUNvbXBvbmVudDsKICAgICAgICBleHBvcnRzLlN0cmljdE1vZGUgPSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOwogICAgICAgIGV4cG9ydHMuU3VzcGVuc2UgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBSZWFjdFNoYXJlZEludGVybmFsczsKICAgICAgICBleHBvcnRzLmFjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLmNsb25lRWxlbWVudCA9IGNsb25lRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQ7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3Rvcnk7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSZWYgPSBjcmVhdGVSZWY7CiAgICAgICAgZXhwb3J0cy5mb3J3YXJkUmVmID0gZm9yd2FyZFJlZjM7CiAgICAgICAgZXhwb3J0cy5pc1ZhbGlkRWxlbWVudCA9IGlzVmFsaWRFbGVtZW50OwogICAgICAgIGV4cG9ydHMubGF6eSA9IGxhenk7CiAgICAgICAgZXhwb3J0cy5tZW1vID0gbWVtbzsKICAgICAgICBleHBvcnRzLnN0YXJ0VHJhbnNpdGlvbiA9IHN0YXJ0VHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2FjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLnVzZUNhbGxiYWNrID0gdXNlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDsKICAgICAgICBleHBvcnRzLnVzZURlYnVnVmFsdWUgPSB1c2VEZWJ1Z1ZhbHVlOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QyOwogICAgICAgIGV4cG9ydHMudXNlSWQgPSB1c2VJZDsKICAgICAgICBleHBvcnRzLnVzZUltcGVyYXRpdmVIYW5kbGUgPSB1c2VJbXBlcmF0aXZlSGFuZGxlOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTWVtbyA9IHVzZU1lbW8yOwogICAgICAgIGV4cG9ydHMudXNlUmVkdWNlciA9IHVzZVJlZHVjZXI7CiAgICAgICAgZXhwb3J0cy51c2VSZWYgPSB1c2VSZWY7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMjsKICAgICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdXNlU3luY0V4dGVybmFsU3RvcmU7CiAgICAgICAgZXhwb3J0cy51c2VUcmFuc2l0aW9uID0gdXNlVHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnZlcnNpb24gPSBSZWFjdFZlcnNpb247CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgIndlYi9ub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJ3ZWIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGZyYW1lWWllbGRNcyA9IDU7CiAgICAgICAgZnVuY3Rpb24gcHVzaChoZWFwLCBub2RlKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIGhlYXAucHVzaChub2RlKTsKICAgICAgICAgIHNpZnRVcChoZWFwLCBub2RlLCBpbmRleCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlZWsoaGVhcCkgewogICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChoZWFwKSB7CiAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgdmFyIGxhc3QgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QgIT09IGZpcnN0KSB7CiAgICAgICAgICAgIGhlYXBbMF0gPSBsYXN0OwogICAgICAgICAgICBzaWZ0RG93bihoZWFwLCBsYXN0LCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrLCBtcykgewogICAgICAgIH0KICAgICAgICB2YXIgaGFzUGVyZm9ybWFuY2VOb3cgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgaWYgKGhhc1BlcmZvcm1hbmNlTm93KSB7CiAgICAgICAgICB2YXIgbG9jYWxQZXJmb3JtYW5jZSA9IHBlcmZvcm1hbmNlOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsUGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbG9jYWxEYXRlID0gRGF0ZTsKICAgICAgICAgIHZhciBpbml0aWFsVGltZSA9IGxvY2FsRGF0ZS5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUubm93KCkgLSBpbml0aWFsVGltZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBtYXhTaWduZWQzMUJpdEludCA9IDEwNzM3NDE4MjM7CiAgICAgICAgdmFyIElNTUVESUFURV9QUklPUklUWV9USU1FT1VUID0gLTE7CiAgICAgICAgdmFyIFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVCA9IDI1MDsKICAgICAgICB2YXIgTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQgPSA1ZTM7CiAgICAgICAgdmFyIExPV19QUklPUklUWV9USU1FT1VUID0gMWU0OwogICAgICAgIHZhciBJRExFX1BSSU9SSVRZX1RJTUVPVVQgPSBtYXhTaWduZWQzMUJpdEludDsKICAgICAgICB2YXIgdGFza1F1ZXVlID0gW107CiAgICAgICAgdmFyIHRpbWVyUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGFza0lkQ291bnRlciA9IDE7CiAgICAgICAgdmFyIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsU2V0VGltZW91dCA9IHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gc2V0VGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsQ2xlYXJUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsU2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gInVuZGVmaW5lZCIgPyBzZXRJbW1lZGlhdGUgOiBudWxsOwogICAgICAgIHZhciBpc0lucHV0UGVuZGluZyA9IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nICE9PSB2b2lkIDAgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcgIT09IHZvaWQgMCA/IG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nLmJpbmQobmF2aWdhdG9yLnNjaGVkdWxpbmcpIDogbnVsbDsKICAgICAgICBmdW5jdGlvbiBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgd2hpbGUgKHRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0aW1lci5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lci5zdGFydFRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgdGltZXIuc29ydEluZGV4ID0gdGltZXIuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIHRpbWVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoV29yayhoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxpbmcpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICBtYXJrVGFza0Vycm9yZWQoY3VycmVudFRhc2ssIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudFRhc2suaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGluaXRpYWxUaW1lMjsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrKHRhc2tRdWV1ZSkpIHsKICAgICAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gcGVlayh0YXNrUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSA9PT0gbnVsbCAmJiBuZXdUYXNrID09PSBwZWVrKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld1Rhc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbigpIHsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlKCkgewogICAgICAgICAgcmV0dXJuIHBlZWsodGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzaykgewogICAgICAgICAgdGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIHZhciBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZFRvSG9zdCgpIHsKICAgICAgICAgIHZhciB0aW1lRWxhcHNlZCA9IGV4cG9ydHMudW5zdGFibGVfbm93KCkgLSBzdGFydFRpbWU7CiAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UGFpbnQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlRnJhbWVSYXRlKGZwcykgewogICAgICAgICAgaWYgKGZwcyA8IDAgfHwgZnBzID4gMTI1KSB7CiAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gTWF0aC5mbG9vcigxZTMgLyBmcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjaGVkdWxlZEhvc3RDYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgdmFyIGhhc1RpbWVSZW1haW5pbmcgPSB0cnVlOwogICAgICAgICAgICB2YXIgaGFzTW9yZVdvcmsgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGhhc01vcmVXb3JrID0gc2NoZWR1bGVkSG9zdENhbGxiYWNrKGhhc1RpbWVSZW1haW5pbmcsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldEltbWVkaWF0ZShwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldFRpbWVvdXQocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0VGltZW91dChjYWxsYmFjaywgbXMpIHsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGV4cG9ydHMudW5zdGFibGVfbm93KCkpOwogICAgICAgICAgfSwgbXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxIb3N0VGltZW91dCgpIHsKICAgICAgICAgIGxvY2FsQ2xlYXJUaW1lb3V0KHRhc2tUaW1lb3V0SUQpOwogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zdGFibGVfcmVxdWVzdFBhaW50ID0gcmVxdWVzdFBhaW50OwogICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSWRsZVByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfUHJvZmlsaW5nID0gdW5zdGFibGVfUHJvZmlsaW5nOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NhbmNlbENhbGxiYWNrID0gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsID0gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSA9IHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVxdWVzdFBhaW50ID0gdW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayA9IHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zaG91bGRZaWVsZCA9IHNob3VsZFlpZWxkVG9Ib3N0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9zY2hlZHVsZXIvaW5kZXguanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyID0gX19jb21tb25KUyh7CiAgIndlYi9ub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIndlYi9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0MyA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgU2NoZWR1bGVyID0gcmVxdWlyZV9zY2hlZHVsZXIoKTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSBSZWFjdDMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdCwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0KTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIEZ1bmN0aW9uQ29tcG9uZW50ID0gMDsKICAgICAgICB2YXIgQ2xhc3NDb21wb25lbnQgPSAxOwogICAgICAgIHZhciBJbmRldGVybWluYXRlQ29tcG9uZW50ID0gMjsKICAgICAgICB2YXIgSG9zdFJvb3QgPSAzOwogICAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgICB2YXIgSG9zdENvbXBvbmVudCA9IDU7CiAgICAgICAgdmFyIEhvc3RUZXh0ID0gNjsKICAgICAgICB2YXIgRnJhZ21lbnQyID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgYXR0cmlidXRlIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBhdHRyaWJ1dGVOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBDU1MgcHJvcGVydHkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIEhUTUwgbWFya3VwIHVzZXMgYSB2YWx1ZSBvZiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVTRVJWRUQgPSAwOwogICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgIHZhciBCT09MRUFOSVNIX1NUUklORyA9IDI7CiAgICAgICAgdmFyIEJPT0xFQU4gPSAzOwogICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgIHZhciBOVU1FUklDID0gNTsKICAgICAgICB2YXIgUE9TSVRJVkVfTlVNRVJJQyA9IDY7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9DSEFSID0gQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJcXC0uMC05XFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICAgICAgdmFyIFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYID0gbmV3IFJlZ0V4cCgiXlsiICsgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgdmFyIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZVNhZmUoYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID4gMiAmJiAobmFtZVswXSA9PT0gIm8iIHx8IG5hbWVbMF0gPT09ICJPIikgJiYgKG5hbWVbMV0gPT09ICJuIiB8fCBuYW1lWzFdID09PSAiTiIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXByb3BlcnR5SW5mby5hY2NlcHRzQm9vbGVhbnM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXgyID0gbmFtZS50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIDUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgIT09ICJkYXRhLSIgJiYgcHJlZml4MiAhPT0gImFyaWEtIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChwcm9wZXJ0eUluZm8udHlwZSkgewogICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBPVkVSTE9BREVEX0JPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGNhc2UgTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KG5hbWUpID8gcHJvcGVydGllc1tuYW1lXSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlLCBtdXN0VXNlUHJvcGVydHksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSwgc2FuaXRpemVVUkwyLCByZW1vdmVFbXB0eVN0cmluZykgewogICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlID09PSBCT09MRUFOSVNIX1NUUklORyB8fCB0eXBlID09PSBCT09MRUFOIHx8IHR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IGF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgdGhpcy5wcm9wZXJ0eU5hbWUgPSBuYW1lOwogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuc2FuaXRpemVVUkwgPSBzYW5pdGl6ZVVSTDI7CiAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAiY2hpbGRyZW4iLAogICAgICAgICAgImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgIC8vIGVsZW1lbnRzIChub3QganVzdCBpbnB1dHMpLiBOb3cgdGhhdCBSZWFjdERPTUlucHV0IGFzc2lnbnMgdG8gdGhlCiAgICAgICAgICAvLyBkZWZhdWx0VmFsdWUgcHJvcGVydHkgLS0gZG8gd2UgbmVlZCB0aGlzPwogICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgImlubmVySFRNTCIsCiAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgInN0eWxlIgogICAgICAgIF07CiAgICAgICAgcmVzZXJ2ZWRQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBSRVNFUlZFRCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgW1siYWNjZXB0Q2hhcnNldCIsICJhY2NlcHQtY2hhcnNldCJdLCBbImNsYXNzTmFtZSIsICJjbGFzcyJdLCBbImh0bWxGb3IiLCAiZm9yIl0sIFsiaHR0cEVxdWl2IiwgImh0dHAtZXF1aXYiXV0uZm9yRWFjaChmdW5jdGlvbihfcmVmKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWZbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmWzFdOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJjb250ZW50RWRpdGFibGUiLCAiZHJhZ2dhYmxlIiwgInNwZWxsQ2hlY2siLCAidmFsdWUiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImF1dG9SZXZlcnNlIiwgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLCAiZm9jdXNhYmxlIiwgInByZXNlcnZlQWxwaGEiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAiYXN5bmMiLAogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBwcmV2ZW50cyBpdCBmcm9tIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIERPTQogICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgImF1dG9Gb2N1cyIsCiAgICAgICAgICAiYXV0b1BsYXkiLAogICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICJkZWZhdWx0IiwKICAgICAgICAgICJkZWZlciIsCiAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICJoaWRkZW4iLAogICAgICAgICAgImxvb3AiLAogICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICJub1ZhbGlkYXRlIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAicmVhZE9ubHkiLAogICAgICAgICAgInJlcXVpcmVkIiwKICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAic2NvcGVkIiwKICAgICAgICAgICJzZWFtbGVzcyIsCiAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICJpdGVtU2NvcGUiCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgIC8vIE5vdGU6IGBvcHRpb24uc2VsZWN0ZWRgIGlzIG5vdCB1cGRhdGVkIGlmIGBzZWxlY3QubXVsdGlwbGVgIGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCB3aXRoIGByZW1vdmVBdHRyaWJ1dGVgLiBXZSBoYXZlIHNwZWNpYWwgbG9naWMgZm9yIGhhbmRsaW5nIHRoaXMuCiAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgIm11dGVkIiwKICAgICAgICAgICJzZWxlY3RlZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2FwdHVyZSIsCiAgICAgICAgICAiZG93bmxvYWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNvbHMiLAogICAgICAgICAgInJvd3MiLAogICAgICAgICAgInNpemUiLAogICAgICAgICAgInNwYW4iCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFBPU0lUSVZFX05VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsicm93U3BhbiIsICJzdGFydCJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE5VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIENBTUVMSVpFID0gL1tcLVw6XShbYS16XSkvZzsKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW5bMV0udG9VcHBlckNhc2UoKTsKICAgICAgICB9OwogICAgICAgIFsKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiLAogICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCIsCiAgICAgICAgICAiY2FwLWhlaWdodCIsCiAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICJjbGlwLXJ1bGUiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICJmbG9vZC1jb2xvciIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgImZvbnQtc2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICJmb250LXN0eWxlIiwKICAgICAgICAgICJmb250LXZhcmlhbnQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICJnbHlwaC1uYW1lIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciIsCiAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAibWFya2VyLW1pZCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJwYWludC1vcmRlciIsCiAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgInN0b3AtY29sb3IiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS13aWR0aCIsCiAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iLAogICAgICAgICAgInYtYWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAidmVydC1hZHYteSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiLAogICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICJ4LWhlaWdodCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiLAogICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgInhsaW5rOnRpdGxlIiwKICAgICAgICAgICJ4bGluazp0eXBlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICJ4bWw6bGFuZyIsCiAgICAgICAgICAieG1sOnNwYWNlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInRhYkluZGV4IiwgImNyb3NzT3JpZ2luIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciB4bGlua0hyZWYgPSAieGxpbmtIcmVmIjsKICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgInhsaW5rSHJlZiIsCiAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgInhsaW5rOmhyZWYiLAogICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgWyJzcmMiLCAiaHJlZiIsICJhY3Rpb24iLCAiZm9ybUFjdGlvbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGlzSmF2YVNjcmlwdFByb3RvY29sID0gL15bXHUwMDAwLVx1MDAxRiBdKmpbXHJcblx0XSphW1xyXG5cdF0qdltcclxuXHRdKmFbXHJcblx0XSpzW1xyXG5cdF0qY1tcclxuXHRdKnJbXHJcblx0XSppW1xyXG5cdF0qcFtcclxuXHRdKnRbXHJcblx0XSpcOi9pOwogICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2FuaXRpemVVUkwodXJsKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICBkaWRXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiQSBmdXR1cmUgdmVyc2lvbiBvZiBSZWFjdCB3aWxsIGJsb2NrIGphdmFzY3JpcHQ6IFVSTHMgYXMgYSBzZWN1cml0eSBwcmVjYXV0aW9uLiBVc2UgZXZlbnQgaGFuZGxlcnMgaW5zdGVhZCBpZiB5b3UgY2FuLiBJZiB5b3UgbmVlZCB0byBnZW5lcmF0ZSB1bnNhZmUgSFRNTCB0cnkgdXNpbmcgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgaW5zdGVhZC4gUmVhY3Qgd2FzIHBhc3NlZCAlcy4iLCBKU09OLnN0cmluZ2lmeSh1cmwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTCgiIiArIGV4cGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBudWxsOwogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmdWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlID09PSBudWxsID8gZXhwZWN0ZWQgOiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5vZGUuaGFzQXR0cmlidXRlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCB2YWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyB8fCBwcm9wZXJ0eUluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUsICIiICsgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIGlmIChtdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdHlwZSA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWU7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTChhdHRyaWJ1dGVWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlTlMoYXR0cmlidXRlTmFtZXNwYWNlLCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geC5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoY3Rvciwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgb3duZXIgPSBmaWJlci5fZGVidWdPd25lciA/IGZpYmVyLl9kZWJ1Z093bmVyLnR5cGUgOiBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIkxhenkiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpbmZvICs9IGRlc2NyaWJlRmliZXIobm9kZSk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeC5tZXNzYWdlICsgIlxuIiArIHguc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUkMShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lJDEodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICBjYXNlIERlaHlkcmF0ZWRGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDI6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudCA9IG51bGw7CiAgICAgICAgdmFyIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gY3VycmVudC5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKGN1cnJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudCA9IGZpYmVyOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1JlbmRlcmluZyhyZW5kZXJpbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSByZW5kZXJpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VG9TdHJpbmdWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoYXNSZWFkT25seVZhbHVlID0gewogICAgICAgICAgYnV0dG9uOiB0cnVlLAogICAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgICBpbWFnZTogdHJ1ZSwKICAgICAgICAgIGhpZGRlbjogdHJ1ZSwKICAgICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgICAgcmVzZXQ6IHRydWUsCiAgICAgICAgICBzdWJtaXQ6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHModGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoaGFzUmVhZE9ubHlWYWx1ZVtwcm9wcy50eXBlXSB8fCBwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5vbklucHV0IHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLnZhbHVlID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGB2YWx1ZWAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRWYWx1ZWAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEocHJvcHMub25DaGFuZ2UgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuY2hlY2tlZCA9PSBudWxsKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgY2hlY2tlZGAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRDaGVja2VkYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NoZWNrYWJsZShlbGVtKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW0udHlwZTsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodHlwZSA9PT0gImNoZWNrYm94IiB8fCB0eXBlID09PSAicmFkaW8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhY2tlcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5fdmFsdWVUcmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIG5vZGUuX3ZhbHVlVHJhY2tlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gIiI7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ2hlY2thYmxlKG5vZGUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS5jaGVja2VkID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2tWYWx1ZU9uTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWVGaWVsZCA9IGlzQ2hlY2thYmxlKG5vZGUpID8gImNoZWNrZWQiIDogInZhbHVlIjsKICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihub2RlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgdmFsdWVGaWVsZCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbihub2RlW3ZhbHVlRmllbGRdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAiIiArIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICBpZiAobm9kZS5oYXNPd25Qcm9wZXJ0eSh2YWx1ZUZpZWxkKSB8fCB0eXBlb2YgZGVzY3JpcHRvciA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0b3IuZ2V0ICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBkZXNjcmlwdG9yLnNldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0MiA9IGRlc2NyaXB0b3IuZ2V0LCBzZXQyID0gZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgc2V0Mi5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIHRyYWNrZXIgPSB7CiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wVHJhY2tpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRldGFjaFRyYWNrZXIobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2sobm9kZSkgewogICAgICAgICAgaWYgKGdldFRyYWNrZXIobm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gdHJhY2tWYWx1ZU9uTm9kZShub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVJZkNoYW5nZWQobm9kZSkgewogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFja2VyID0gZ2V0VHJhY2tlcihub2RlKTsKICAgICAgICAgIGlmICghdHJhY2tlcikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0VmFsdWUgPSB0cmFja2VyLmdldFZhbHVlKCk7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gZ2V0VmFsdWVGcm9tTm9kZShub2RlKTsKICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICB0cmFja2VyLnNldFZhbHVlKG5leHRWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50KGRvYykgewogICAgICAgICAgZG9jID0gZG9jIHx8ICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiID8gZG9jdW1lbnQgOiB2b2lkIDApOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2MgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRvYy5hY3RpdmVFbGVtZW50IHx8IGRvYy5ib2R5OwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZG9jLmJvZHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0NvbnRyb2xsZWQocHJvcHMpIHsKICAgICAgICAgIHZhciB1c2VzQ2hlY2tlZCA9IHByb3BzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgcHJvcHMudHlwZSA9PT0gInJhZGlvIjsKICAgICAgICAgIHJldHVybiB1c2VzQ2hlY2tlZCA/IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA6IHByb3BzLnZhbHVlICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzLkNoaWxkcmVuLmZvckVhY2gocHJvcHMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBjaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBpbmZlciB0aGUgb3B0aW9uIHZhbHVlIG9mIGNvbXBsZXggY2hpbGRyZW4uIFBhc3MgYSBgdmFsdWVgIHByb3Agb3IgdXNlIGEgcGxhaW4gc3RyaW5nIGFzIGNoaWxkcmVuIHRvIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRJbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUGFzcyBhIGB2YWx1ZWAgcHJvcCBpZiB5b3Ugc2V0IGRhbmdlcm91c2x5SW5uZXJIVE1MIHNvIFJlYWN0IGtub3dzIHdoaWNoIHZhbHVlIHNob3VsZCBiZSBzZWxlY3RlZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLnNlbGVjdGVkICE9IG51bGwgJiYgIWRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBvbiA8c2VsZWN0PiBpbnN0ZWFkIG9mIHNldHRpbmcgYHNlbGVjdGVkYCBvbiA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgidmFsdWUiLCB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlUHJvcE5hbWVzID0gWyJ2YWx1ZSIsICJkZWZhdWx0VmFsdWUiXTsKICAgICAgICBmdW5jdGlvbiBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJzZWxlY3QiLCBwcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVQcm9wTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSB2YWx1ZVByb3BOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJvcE5hbWVJc0FycmF5ID0gaXNBcnJheShwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zKG5vZGUsIG11bHRpcGxlLCBwcm9wVmFsdWUsIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgdmFyIG9wdGlvbnMyID0gbm9kZS5vcHRpb25zOwogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlcyA9IHByb3BWYWx1ZTsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3RlZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVbIiQiICsgc2VsZWN0ZWRWYWx1ZXNbaV1dID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgb3B0aW9uczIubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0ZWRWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgiJCIgKyBvcHRpb25zMltfaV0udmFsdWUpOwogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaV0uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICYmIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3NlbGVjdGVkVmFsdWUgPSB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BWYWx1ZSkpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFNlbGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgb3B0aW9uczIubGVuZ3RoOyBfaTIrKykgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaTJdLnZhbHVlID09PSBfc2VsZWN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCA9PT0gbnVsbCAmJiAhb3B0aW9uczJbX2kyXS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkID0gb3B0aW9uczJbX2kyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZC5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tTZWxlY3RQcm9wVHlwZXMocHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICB3YXNNdWx0aXBsZTogISFwcm9wcy5tdWx0aXBsZQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9PSB2b2lkIDAgJiYgcHJvcHMuZGVmYXVsdFZhbHVlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlNlbGVjdCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBzZWxlY3QgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgbm9kZS5tdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5kZWZhdWx0VmFsdWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0VXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHdhc011bHRpcGxlID0gbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlOwogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmICh3YXNNdWx0aXBsZSAhPT0gISFwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5tdWx0aXBsZSA/IFtdIDogIiIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbERlZmF1bHRWYWwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UHJvcHMkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIGRvZXMgbm90IG1ha2Ugc2Vuc2Ugb24gPHRleHRhcmVhPi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBob3N0UHJvcHMgPSBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIjx0ZXh0YXJlYT4gY2FuIG9ubHkgaGF2ZSBhdCBtb3N0IG9uZSBjaGlsZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKGluaXRpYWxWYWx1ZSkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsICYmIG5vZGUuZGVmYXVsdFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudDsKICAgICAgICAgIGlmICh0ZXh0Q29udGVudCA9PT0gbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgIT09ICIiICYmIHRleHRDb250ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIEhUTUxfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiOwogICAgICAgIHZhciBNQVRIX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsKICAgICAgICB2YXIgU1ZHX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJzdmciOgogICAgICAgICAgICAgIHJldHVybiBTVkdfTkFNRVNQQUNFOwogICAgICAgICAgICBjYXNlICJtYXRoIjoKICAgICAgICAgICAgICByZXR1cm4gTUFUSF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnROYW1lc3BhY2UsIHR5cGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROYW1lc3BhY2UgPT0gbnVsbCB8fCBwYXJlbnROYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09PSBTVkdfTkFNRVNQQUNFICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50TmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbiA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgTVNBcHAgIT09ICJ1bmRlZmluZWQiICYmIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihhcmcwLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgICAgICAgTVNBcHAuZXhlY1Vuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYyhhcmcwLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHJldXNhYmxlU1ZHQ29udGFpbmVyOwogICAgICAgIHZhciBzZXRJbm5lckhUTUwgPSBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKICAgICAgICAgIGlmIChub2RlLm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRSkgewogICAgICAgICAgICBpZiAoISgiaW5uZXJIVE1MIiBpbiBub2RlKSkgewogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyID0gcmV1c2FibGVTVkdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+IiArIGh0bWwudmFsdWVPZigpLnRvU3RyaW5nKCkgKyAiPC9zdmc+IjsKICAgICAgICAgICAgICB2YXIgc3ZnTm9kZSA9IHJldXNhYmxlU1ZHQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVDaGlsZChub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAoc3ZnTm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN2Z05vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0pOwogICAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICAgIHZhciBURVhUX05PREUgPSAzOwogICAgICAgIHZhciBDT01NRU5UX05PREUgPSA4OwogICAgICAgIHZhciBET0NVTUVOVF9OT0RFID0gOTsKICAgICAgICB2YXIgRE9DVU1FTlRfRlJBR01FTlRfTk9ERSA9IDExOwogICAgICAgIHZhciBzZXRUZXh0Q29udGVudCA9IGZ1bmN0aW9uKG5vZGUsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAmJiBmaXJzdENoaWxkID09PSBub2RlLmxhc3RDaGlsZCAmJiBmaXJzdENoaWxkLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICB9OwogICAgICAgIHZhciBzaG9ydGhhbmRUb0xvbmdoYW5kID0gewogICAgICAgICAgYW5pbWF0aW9uOiBbImFuaW1hdGlvbkRlbGF5IiwgImFuaW1hdGlvbkRpcmVjdGlvbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25GaWxsTW9kZSIsICJhbmltYXRpb25JdGVyYXRpb25Db3VudCIsICJhbmltYXRpb25OYW1lIiwgImFuaW1hdGlvblBsYXlTdGF0ZSIsICJhbmltYXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgYmFja2dyb3VuZDogWyJiYWNrZ3JvdW5kQXR0YWNobWVudCIsICJiYWNrZ3JvdW5kQ2xpcCIsICJiYWNrZ3JvdW5kQ29sb3IiLCAiYmFja2dyb3VuZEltYWdlIiwgImJhY2tncm91bmRPcmlnaW4iLCAiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIiwgImJhY2tncm91bmRSZXBlYXQiLCAiYmFja2dyb3VuZFNpemUiXSwKICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogWyJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiXSwKICAgICAgICAgIGJvcmRlcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiLCAiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJsb2NrRW5kOiBbImJvcmRlckJsb2NrRW5kQ29sb3IiLCAiYm9yZGVyQmxvY2tFbmRTdHlsZSIsICJib3JkZXJCbG9ja0VuZFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja1N0YXJ0OiBbImJvcmRlckJsb2NrU3RhcnRDb2xvciIsICJib3JkZXJCbG9ja1N0YXJ0U3R5bGUiLCAiYm9yZGVyQmxvY2tTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCb3R0b206IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclRvcENvbG9yIl0sCiAgICAgICAgICBib3JkZXJJbWFnZTogWyJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZUVuZDogWyJib3JkZXJJbmxpbmVFbmRDb2xvciIsICJib3JkZXJJbmxpbmVFbmRTdHlsZSIsICJib3JkZXJJbmxpbmVFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVySW5saW5lU3RhcnQ6IFsiYm9yZGVySW5saW5lU3RhcnRDb2xvciIsICJib3JkZXJJbmxpbmVTdGFydFN0eWxlIiwgImJvcmRlcklubGluZVN0YXJ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlckxlZnQ6IFsiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlclJhZGl1czogWyJib3JkZXJCb3R0b21MZWZ0UmFkaXVzIiwgImJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzIiwgImJvcmRlclRvcExlZnRSYWRpdXMiLCAiYm9yZGVyVG9wUmlnaHRSYWRpdXMiXSwKICAgICAgICAgIGJvcmRlclJpZ2h0OiBbImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJTdHlsZTogWyJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJUb3BTdHlsZSJdLAogICAgICAgICAgYm9yZGVyVG9wOiBbImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJXaWR0aDogWyJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgY29sdW1uUnVsZTogWyJjb2x1bW5SdWxlQ29sb3IiLCAiY29sdW1uUnVsZVN0eWxlIiwgImNvbHVtblJ1bGVXaWR0aCJdLAogICAgICAgICAgY29sdW1uczogWyJjb2x1bW5Db3VudCIsICJjb2x1bW5XaWR0aCJdLAogICAgICAgICAgZmxleDogWyJmbGV4QmFzaXMiLCAiZmxleEdyb3ciLCAiZmxleFNocmluayJdLAogICAgICAgICAgZmxleEZsb3c6IFsiZmxleERpcmVjdGlvbiIsICJmbGV4V3JhcCJdLAogICAgICAgICAgZm9udDogWyJmb250RmFtaWx5IiwgImZvbnRGZWF0dXJlU2V0dGluZ3MiLCAiZm9udEtlcm5pbmciLCAiZm9udExhbmd1YWdlT3ZlcnJpZGUiLCAiZm9udFNpemUiLCAiZm9udFNpemVBZGp1c3QiLCAiZm9udFN0cmV0Y2giLCAiZm9udFN0eWxlIiwgImZvbnRWYXJpYW50IiwgImZvbnRWYXJpYW50QWx0ZXJuYXRlcyIsICJmb250VmFyaWFudENhcHMiLCAiZm9udFZhcmlhbnRFYXN0QXNpYW4iLCAiZm9udFZhcmlhbnRMaWdhdHVyZXMiLCAiZm9udFZhcmlhbnROdW1lcmljIiwgImZvbnRWYXJpYW50UG9zaXRpb24iLCAiZm9udFdlaWdodCIsICJsaW5lSGVpZ2h0Il0sCiAgICAgICAgICBmb250VmFyaWFudDogWyJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIl0sCiAgICAgICAgICBnYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZDogWyJncmlkQXV0b0NvbHVtbnMiLCAiZ3JpZEF1dG9GbG93IiwgImdyaWRBdXRvUm93cyIsICJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGdyaWRBcmVhOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0IiwgImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uR2FwOiBbImNvbHVtbkdhcCJdLAogICAgICAgICAgZ3JpZEdhcDogWyJjb2x1bW5HYXAiLCAicm93R2FwIl0sCiAgICAgICAgICBncmlkUm93OiBbImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkUm93R2FwOiBbInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFRlbXBsYXRlOiBbImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgbGlzdFN0eWxlOiBbImxpc3RTdHlsZUltYWdlIiwgImxpc3RTdHlsZVBvc2l0aW9uIiwgImxpc3RTdHlsZVR5cGUiXSwKICAgICAgICAgIG1hcmdpbjogWyJtYXJnaW5Cb3R0b20iLCAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIsICJtYXJnaW5Ub3AiXSwKICAgICAgICAgIG1hcmtlcjogWyJtYXJrZXJFbmQiLCAibWFya2VyTWlkIiwgIm1hcmtlclN0YXJ0Il0sCiAgICAgICAgICBtYXNrOiBbIm1hc2tDbGlwIiwgIm1hc2tDb21wb3NpdGUiLCAibWFza0ltYWdlIiwgIm1hc2tNb2RlIiwgIm1hc2tPcmlnaW4iLCAibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIiwgIm1hc2tSZXBlYXQiLCAibWFza1NpemUiXSwKICAgICAgICAgIG1hc2tQb3NpdGlvbjogWyJtYXNrUG9zaXRpb25YIiwgIm1hc2tQb3NpdGlvblkiXSwKICAgICAgICAgIG91dGxpbmU6IFsib3V0bGluZUNvbG9yIiwgIm91dGxpbmVTdHlsZSIsICJvdXRsaW5lV2lkdGgiXSwKICAgICAgICAgIG92ZXJmbG93OiBbIm92ZXJmbG93WCIsICJvdmVyZmxvd1kiXSwKICAgICAgICAgIHBhZGRpbmc6IFsicGFkZGluZ0JvdHRvbSIsICJwYWRkaW5nTGVmdCIsICJwYWRkaW5nUmlnaHQiLCAicGFkZGluZ1RvcCJdLAogICAgICAgICAgcGxhY2VDb250ZW50OiBbImFsaWduQ29udGVudCIsICJqdXN0aWZ5Q29udGVudCJdLAogICAgICAgICAgcGxhY2VJdGVtczogWyJhbGlnbkl0ZW1zIiwgImp1c3RpZnlJdGVtcyJdLAogICAgICAgICAgcGxhY2VTZWxmOiBbImFsaWduU2VsZiIsICJqdXN0aWZ5U2VsZiJdLAogICAgICAgICAgdGV4dERlY29yYXRpb246IFsidGV4dERlY29yYXRpb25Db2xvciIsICJ0ZXh0RGVjb3JhdGlvbkxpbmUiLCAidGV4dERlY29yYXRpb25TdHlsZSJdLAogICAgICAgICAgdGV4dEVtcGhhc2lzOiBbInRleHRFbXBoYXNpc0NvbG9yIiwgInRleHRFbXBoYXNpc1N0eWxlIl0sCiAgICAgICAgICB0cmFuc2l0aW9uOiBbInRyYW5zaXRpb25EZWxheSIsICJ0cmFuc2l0aW9uRHVyYXRpb24iLCAidHJhbnNpdGlvblByb3BlcnR5IiwgInRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgd29yZFdyYXA6IFsib3ZlcmZsb3dXcmFwIl0KICAgICAgICB9OwogICAgICAgIHZhciBpc1VuaXRsZXNzTnVtYmVyID0gewogICAgICAgICAgYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQ6IHRydWUsCiAgICAgICAgICBhc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlT3V0c2V0OiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VTbGljZTogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlV2lkdGg6IHRydWUsCiAgICAgICAgICBib3hGbGV4OiB0cnVlLAogICAgICAgICAgYm94RmxleEdyb3VwOiB0cnVlLAogICAgICAgICAgYm94T3JkaW5hbEdyb3VwOiB0cnVlLAogICAgICAgICAgY29sdW1uQ291bnQ6IHRydWUsCiAgICAgICAgICBjb2x1bW5zOiB0cnVlLAogICAgICAgICAgZmxleDogdHJ1ZSwKICAgICAgICAgIGZsZXhHcm93OiB0cnVlLAogICAgICAgICAgZmxleFBvc2l0aXZlOiB0cnVlLAogICAgICAgICAgZmxleFNocmluazogdHJ1ZSwKICAgICAgICAgIGZsZXhOZWdhdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhPcmRlcjogdHJ1ZSwKICAgICAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICAgICAgZ3JpZFJvdzogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dFbmQ6IHRydWUsCiAgICAgICAgICBncmlkUm93U3BhbjogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dTdGFydDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblNwYW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uU3RhcnQ6IHRydWUsCiAgICAgICAgICBmb250V2VpZ2h0OiB0cnVlLAogICAgICAgICAgbGluZUNsYW1wOiB0cnVlLAogICAgICAgICAgbGluZUhlaWdodDogdHJ1ZSwKICAgICAgICAgIG9wYWNpdHk6IHRydWUsCiAgICAgICAgICBvcmRlcjogdHJ1ZSwKICAgICAgICAgIG9ycGhhbnM6IHRydWUsCiAgICAgICAgICB0YWJTaXplOiB0cnVlLAogICAgICAgICAgd2lkb3dzOiB0cnVlLAogICAgICAgICAgekluZGV4OiB0cnVlLAogICAgICAgICAgem9vbTogdHJ1ZSwKICAgICAgICAgIC8vIFNWRy1yZWxhdGVkIHByb3BlcnRpZXMKICAgICAgICAgIGZpbGxPcGFjaXR5OiB0cnVlLAogICAgICAgICAgZmxvb2RPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3RvcE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNob2Zmc2V0OiB0cnVlLAogICAgICAgICAgc3Ryb2tlTWl0ZXJsaW1pdDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VXaWR0aDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcHJlZml4S2V5KHByZWZpeDIsIGtleSkgewogICAgICAgICAgcmV0dXJuIHByZWZpeDIgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ZXMgPSBbIldlYmtpdCIsICJtcyIsICJNb3oiLCAiTyJdOwogICAgICAgIE9iamVjdC5rZXlzKGlzVW5pdGxlc3NOdW1iZXIpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgcHJlZml4ZXMuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbih7CiAgICAgICAgICBtZW51aXRlbTogdHJ1ZQogICAgICAgIH0sIG9taXR0ZWRDbG9zZVRhZ3MpOwogICAgICAgIHZhciBIVE1MID0gIl9faHRtbCI7CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKSB7CiAgICAgICAgICBpZiAoIXByb3BzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2b2lkRWxlbWVudFRhZ3NbdGFnXSkgewogICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCB8fCBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRhZyArICIgaXMgYSB2b2lkIGVsZW1lbnQgdGFnIGFuZCBtdXN0IG5laXRoZXIgaGF2ZSBgY2hpbGRyZW5gIG5vciB1c2UgYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IHNldCBvbmUgb2YgYGNoaWxkcmVuYCBvciBgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09ICJvYmplY3QiIHx8ICEoSFRNTCBpbiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTGAgbXVzdCBiZSBpbiB0aGUgZm9ybSBge19faHRtbDogLi4ufWAuIFBsZWFzZSB2aXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGFuZ2Vyb3VzbHktc2V0LWlubmVyLWh0bWwgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFwcm9wcy5zdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmcgJiYgcHJvcHMuY29udGVudEVkaXRhYmxlICYmIHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgYGNvbnRlbnRFZGl0YWJsZWAgYW5kIGNvbnRhaW5zIGBjaGlsZHJlbmAgbWFuYWdlZCBieSBSZWFjdC4gSXQgaXMgbm93IHlvdXIgcmVzcG9uc2liaWxpdHkgdG8gZ3VhcmFudGVlIHRoYXQgbm9uZSBvZiB0aG9zZSBub2RlcyBhcmUgdW5leHBlY3RlZGx5IG1vZGlmaWVkIG9yIGR1cGxpY2F0ZWQuIFRoaXMgaXMgcHJvYmFibHkgbm90IGludGVudGlvbmFsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuc3R5bGUgIT0gbnVsbCAmJiB0eXBlb2YgcHJvcHMuc3R5bGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBzdHlsZWAgcHJvcCBleHBlY3RzIGEgbWFwcGluZyBmcm9tIHN0eWxlIHByb3BlcnRpZXMgdG8gdmFsdWVzLCBub3QgYSBzdHJpbmcuIEZvciBleGFtcGxlLCBzdHlsZT17e21hcmdpblJpZ2h0OiBzcGFjaW5nICsgJ2VtJ319IHdoZW4gdXNpbmcgSlNYLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0N1c3RvbUNvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgaWYgKHRhZ05hbWUuaW5kZXhPZigiLSIpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgICBjYXNlICJhbm5vdGF0aW9uLXhtbCI6CiAgICAgICAgICAgIGNhc2UgImNvbG9yLXByb2ZpbGUiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2Utc3JjIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXVyaSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1mb3JtYXQiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtbmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm1pc3NpbmctZ2x5cGgiOgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBvc3NpYmxlU3RhbmRhcmROYW1lcyA9IHsKICAgICAgICAgIC8vIEhUTUwKICAgICAgICAgIGFjY2VwdDogImFjY2VwdCIsCiAgICAgICAgICBhY2NlcHRjaGFyc2V0OiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICAiYWNjZXB0LWNoYXJzZXQiOiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICBhY2Nlc3NrZXk6ICJhY2Nlc3NLZXkiLAogICAgICAgICAgYWN0aW9uOiAiYWN0aW9uIiwKICAgICAgICAgIGFsbG93ZnVsbHNjcmVlbjogImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICBhbHQ6ICJhbHQiLAogICAgICAgICAgYXM6ICJhcyIsCiAgICAgICAgICBhc3luYzogImFzeW5jIiwKICAgICAgICAgIGF1dG9jYXBpdGFsaXplOiAiYXV0b0NhcGl0YWxpemUiLAogICAgICAgICAgYXV0b2NvbXBsZXRlOiAiYXV0b0NvbXBsZXRlIiwKICAgICAgICAgIGF1dG9jb3JyZWN0OiAiYXV0b0NvcnJlY3QiLAogICAgICAgICAgYXV0b2ZvY3VzOiAiYXV0b0ZvY3VzIiwKICAgICAgICAgIGF1dG9wbGF5OiAiYXV0b1BsYXkiLAogICAgICAgICAgYXV0b3NhdmU6ICJhdXRvU2F2ZSIsCiAgICAgICAgICBjYXB0dXJlOiAiY2FwdHVyZSIsCiAgICAgICAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgY2hhbGxlbmdlOiAiY2hhbGxlbmdlIiwKICAgICAgICAgIGNoYXJzZXQ6ICJjaGFyU2V0IiwKICAgICAgICAgIGNoZWNrZWQ6ICJjaGVja2VkIiwKICAgICAgICAgIGNoaWxkcmVuOiAiY2hpbGRyZW4iLAogICAgICAgICAgY2l0ZTogImNpdGUiLAogICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgY2xhc3NpZDogImNsYXNzSUQiLAogICAgICAgICAgY2xhc3NuYW1lOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNvbHM6ICJjb2xzIiwKICAgICAgICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgICAgICAgIGNvbnRlbnQ6ICJjb250ZW50IiwKICAgICAgICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIsCiAgICAgICAgICBjb250ZXh0bWVudTogImNvbnRleHRNZW51IiwKICAgICAgICAgIGNvbnRyb2xzOiAiY29udHJvbHMiLAogICAgICAgICAgY29udHJvbHNsaXN0OiAiY29udHJvbHNMaXN0IiwKICAgICAgICAgIGNvb3JkczogImNvb3JkcyIsCiAgICAgICAgICBjcm9zc29yaWdpbjogImNyb3NzT3JpZ2luIiwKICAgICAgICAgIGRhbmdlcm91c2x5c2V0aW5uZXJodG1sOiAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgZGF0YTogImRhdGEiLAogICAgICAgICAgZGF0ZXRpbWU6ICJkYXRlVGltZSIsCiAgICAgICAgICBkZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgICBkZWZhdWx0Y2hlY2tlZDogImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgIGRlZmF1bHR2YWx1ZTogImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICBkZWZlcjogImRlZmVyIiwKICAgICAgICAgIGRpcjogImRpciIsCiAgICAgICAgICBkaXNhYmxlZDogImRpc2FibGVkIiwKICAgICAgICAgIGRpc2FibGVwaWN0dXJlaW5waWN0dXJlOiAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgZGlzYWJsZXJlbW90ZXBsYXliYWNrOiAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgIGRvd25sb2FkOiAiZG93bmxvYWQiLAogICAgICAgICAgZHJhZ2dhYmxlOiAiZHJhZ2dhYmxlIiwKICAgICAgICAgIGVuY3R5cGU6ICJlbmNUeXBlIiwKICAgICAgICAgIGVudGVya2V5aGludDogImVudGVyS2V5SGludCIsCiAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgIGZvcm06ICJmb3JtIiwKICAgICAgICAgIGZvcm1tZXRob2Q6ICJmb3JtTWV0aG9kIiwKICAgICAgICAgIGZvcm1hY3Rpb246ICJmb3JtQWN0aW9uIiwKICAgICAgICAgIGZvcm1lbmN0eXBlOiAiZm9ybUVuY1R5cGUiLAogICAgICAgICAgZm9ybW5vdmFsaWRhdGU6ICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICBmb3JtdGFyZ2V0OiAiZm9ybVRhcmdldCIsCiAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgIGhlYWRlcnM6ICJoZWFkZXJzIiwKICAgICAgICAgIGhlaWdodDogImhlaWdodCIsCiAgICAgICAgICBoaWRkZW46ICJoaWRkZW4iLAogICAgICAgICAgaGlnaDogImhpZ2giLAogICAgICAgICAgaHJlZjogImhyZWYiLAogICAgICAgICAgaHJlZmxhbmc6ICJocmVmTGFuZyIsCiAgICAgICAgICBodG1sZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBodHRwZXF1aXY6ICJodHRwRXF1aXYiLAogICAgICAgICAgImh0dHAtZXF1aXYiOiAiaHR0cEVxdWl2IiwKICAgICAgICAgIGljb246ICJpY29uIiwKICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgaW1hZ2VzaXplczogImltYWdlU2l6ZXMiLAogICAgICAgICAgaW1hZ2VzcmNzZXQ6ICJpbWFnZVNyY1NldCIsCiAgICAgICAgICBpbm5lcmh0bWw6ICJpbm5lckhUTUwiLAogICAgICAgICAgaW5wdXRtb2RlOiAiaW5wdXRNb2RlIiwKICAgICAgICAgIGludGVncml0eTogImludGVncml0eSIsCiAgICAgICAgICBpczogImlzIiwKICAgICAgICAgIGl0ZW1pZDogIml0ZW1JRCIsCiAgICAgICAgICBpdGVtcHJvcDogIml0ZW1Qcm9wIiwKICAgICAgICAgIGl0ZW1yZWY6ICJpdGVtUmVmIiwKICAgICAgICAgIGl0ZW1zY29wZTogIml0ZW1TY29wZSIsCiAgICAgICAgICBpdGVtdHlwZTogIml0ZW1UeXBlIiwKICAgICAgICAgIGtleXBhcmFtczogImtleVBhcmFtcyIsCiAgICAgICAgICBrZXl0eXBlOiAia2V5VHlwZSIsCiAgICAgICAgICBraW5kOiAia2luZCIsCiAgICAgICAgICBsYWJlbDogImxhYmVsIiwKICAgICAgICAgIGxhbmc6ICJsYW5nIiwKICAgICAgICAgIGxpc3Q6ICJsaXN0IiwKICAgICAgICAgIGxvb3A6ICJsb29wIiwKICAgICAgICAgIGxvdzogImxvdyIsCiAgICAgICAgICBtYW5pZmVzdDogIm1hbmlmZXN0IiwKICAgICAgICAgIG1hcmdpbndpZHRoOiAibWFyZ2luV2lkdGgiLAogICAgICAgICAgbWFyZ2luaGVpZ2h0OiAibWFyZ2luSGVpZ2h0IiwKICAgICAgICAgIG1heDogIm1heCIsCiAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgbWVkaWE6ICJtZWRpYSIsCiAgICAgICAgICBtZWRpYWdyb3VwOiAibWVkaWFHcm91cCIsCiAgICAgICAgICBtZXRob2Q6ICJtZXRob2QiLAogICAgICAgICAgbWluOiAibWluIiwKICAgICAgICAgIG1pbmxlbmd0aDogIm1pbkxlbmd0aCIsCiAgICAgICAgICBtdWx0aXBsZTogIm11bHRpcGxlIiwKICAgICAgICAgIG11dGVkOiAibXV0ZWQiLAogICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgbm9tb2R1bGU6ICJub01vZHVsZSIsCiAgICAgICAgICBub25jZTogIm5vbmNlIiwKICAgICAgICAgIG5vdmFsaWRhdGU6ICJub1ZhbGlkYXRlIiwKICAgICAgICAgIG9wZW46ICJvcGVuIiwKICAgICAgICAgIG9wdGltdW06ICJvcHRpbXVtIiwKICAgICAgICAgIHBhdHRlcm46ICJwYXR0ZXJuIiwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAicGxhY2Vob2xkZXIiLAogICAgICAgICAgcGxheXNpbmxpbmU6ICJwbGF5c0lubGluZSIsCiAgICAgICAgICBwb3N0ZXI6ICJwb3N0ZXIiLAogICAgICAgICAgcHJlbG9hZDogInByZWxvYWQiLAogICAgICAgICAgcHJvZmlsZTogInByb2ZpbGUiLAogICAgICAgICAgcmFkaW9ncm91cDogInJhZGlvR3JvdXAiLAogICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICByZWZlcnJlcnBvbGljeTogInJlZmVycmVyUG9saWN5IiwKICAgICAgICAgIHJlbDogInJlbCIsCiAgICAgICAgICByZXF1aXJlZDogInJlcXVpcmVkIiwKICAgICAgICAgIHJldmVyc2VkOiAicmV2ZXJzZWQiLAogICAgICAgICAgcm9sZTogInJvbGUiLAogICAgICAgICAgcm93czogInJvd3MiLAogICAgICAgICAgcm93c3BhbjogInJvd1NwYW4iLAogICAgICAgICAgc2FuZGJveDogInNhbmRib3giLAogICAgICAgICAgc2NvcGU6ICJzY29wZSIsCiAgICAgICAgICBzY29wZWQ6ICJzY29wZWQiLAogICAgICAgICAgc2Nyb2xsaW5nOiAic2Nyb2xsaW5nIiwKICAgICAgICAgIHNlYW1sZXNzOiAic2VhbWxlc3MiLAogICAgICAgICAgc2VsZWN0ZWQ6ICJzZWxlY3RlZCIsCiAgICAgICAgICBzaGFwZTogInNoYXBlIiwKICAgICAgICAgIHNpemU6ICJzaXplIiwKICAgICAgICAgIHNpemVzOiAic2l6ZXMiLAogICAgICAgICAgc3BhbjogInNwYW4iLAogICAgICAgICAgc3BlbGxjaGVjazogInNwZWxsQ2hlY2siLAogICAgICAgICAgc3JjOiAic3JjIiwKICAgICAgICAgIHNyY2RvYzogInNyY0RvYyIsCiAgICAgICAgICBzcmNsYW5nOiAic3JjTGFuZyIsCiAgICAgICAgICBzcmNzZXQ6ICJzcmNTZXQiLAogICAgICAgICAgc3RhcnQ6ICJzdGFydCIsCiAgICAgICAgICBzdGVwOiAic3RlcCIsCiAgICAgICAgICBzdHlsZTogInN0eWxlIiwKICAgICAgICAgIHN1bW1hcnk6ICJzdW1tYXJ5IiwKICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgdGFyZ2V0OiAidGFyZ2V0IiwKICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgICAgdXNlbWFwOiAidXNlTWFwIiwKICAgICAgICAgIHZhbHVlOiAidmFsdWUiLAogICAgICAgICAgd2lkdGg6ICJ3aWR0aCIsCiAgICAgICAgICB3bW9kZTogIndtb2RlIiwKICAgICAgICAgIHdyYXA6ICJ3cmFwIiwKICAgICAgICAgIC8vIFNWRwogICAgICAgICAgYWJvdXQ6ICJhYm91dCIsCiAgICAgICAgICBhY2NlbnRoZWlnaHQ6ICJhY2NlbnRIZWlnaHQiLAogICAgICAgICAgImFjY2VudC1oZWlnaHQiOiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgIGFjY3VtdWxhdGU6ICJhY2N1bXVsYXRlIiwKICAgICAgICAgIGFkZGl0aXZlOiAiYWRkaXRpdmUiLAogICAgICAgICAgYWxpZ25tZW50YmFzZWxpbmU6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIjogImFsaWdubWVudEJhc2VsaW5lIiwKICAgICAgICAgIGFsbG93cmVvcmRlcjogImFsbG93UmVvcmRlciIsCiAgICAgICAgICBhbHBoYWJldGljOiAiYWxwaGFiZXRpYyIsCiAgICAgICAgICBhbXBsaXR1ZGU6ICJhbXBsaXR1ZGUiLAogICAgICAgICAgYXJhYmljZm9ybTogImFyYWJpY0Zvcm0iLAogICAgICAgICAgImFyYWJpYy1mb3JtIjogImFyYWJpY0Zvcm0iLAogICAgICAgICAgYXNjZW50OiAiYXNjZW50IiwKICAgICAgICAgIGF0dHJpYnV0ZW5hbWU6ICJhdHRyaWJ1dGVOYW1lIiwKICAgICAgICAgIGF0dHJpYnV0ZXR5cGU6ICJhdHRyaWJ1dGVUeXBlIiwKICAgICAgICAgIGF1dG9yZXZlcnNlOiAiYXV0b1JldmVyc2UiLAogICAgICAgICAgYXppbXV0aDogImF6aW11dGgiLAogICAgICAgICAgYmFzZWZyZXF1ZW5jeTogImJhc2VGcmVxdWVuY3kiLAogICAgICAgICAgYmFzZWxpbmVzaGlmdDogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IjogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgYmFzZXByb2ZpbGU6ICJiYXNlUHJvZmlsZSIsCiAgICAgICAgICBiYm94OiAiYmJveCIsCiAgICAgICAgICBiZWdpbjogImJlZ2luIiwKICAgICAgICAgIGJpYXM6ICJiaWFzIiwKICAgICAgICAgIGJ5OiAiYnkiLAogICAgICAgICAgY2FsY21vZGU6ICJjYWxjTW9kZSIsCiAgICAgICAgICBjYXBoZWlnaHQ6ICJjYXBIZWlnaHQiLAogICAgICAgICAgImNhcC1oZWlnaHQiOiAiY2FwSGVpZ2h0IiwKICAgICAgICAgIGNsaXA6ICJjbGlwIiwKICAgICAgICAgIGNsaXBwYXRoOiAiY2xpcFBhdGgiLAogICAgICAgICAgImNsaXAtcGF0aCI6ICJjbGlwUGF0aCIsCiAgICAgICAgICBjbGlwcGF0aHVuaXRzOiAiY2xpcFBhdGhVbml0cyIsCiAgICAgICAgICBjbGlwcnVsZTogImNsaXBSdWxlIiwKICAgICAgICAgICJjbGlwLXJ1bGUiOiAiY2xpcFJ1bGUiLAogICAgICAgICAgY29sb3I6ICJjb2xvciIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb246ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgIGNvbG9yaW50ZXJwb2xhdGlvbmZpbHRlcnM6ICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICBjb2xvcnByb2ZpbGU6ICJjb2xvclByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgIGNvbG9ycmVuZGVyaW5nOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyI6ICJjb2xvclJlbmRlcmluZyIsCiAgICAgICAgICBjb250ZW50c2NyaXB0dHlwZTogImNvbnRlbnRTY3JpcHRUeXBlIiwKICAgICAgICAgIGNvbnRlbnRzdHlsZXR5cGU6ICJjb250ZW50U3R5bGVUeXBlIiwKICAgICAgICAgIGN1cnNvcjogImN1cnNvciIsCiAgICAgICAgICBjeDogImN4IiwKICAgICAgICAgIGN5OiAiY3kiLAogICAgICAgICAgZDogImQiLAogICAgICAgICAgZGF0YXR5cGU6ICJkYXRhdHlwZSIsCiAgICAgICAgICBkZWNlbGVyYXRlOiAiZGVjZWxlcmF0ZSIsCiAgICAgICAgICBkZXNjZW50OiAiZGVzY2VudCIsCiAgICAgICAgICBkaWZmdXNlY29uc3RhbnQ6ICJkaWZmdXNlQ29uc3RhbnQiLAogICAgICAgICAgZGlyZWN0aW9uOiAiZGlyZWN0aW9uIiwKICAgICAgICAgIGRpc3BsYXk6ICJkaXNwbGF5IiwKICAgICAgICAgIGRpdmlzb3I6ICJkaXZpc29yIiwKICAgICAgICAgIGRvbWluYW50YmFzZWxpbmU6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSI6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgIGR1cjogImR1ciIsCiAgICAgICAgICBkeDogImR4IiwKICAgICAgICAgIGR5OiAiZHkiLAogICAgICAgICAgZWRnZW1vZGU6ICJlZGdlTW9kZSIsCiAgICAgICAgICBlbGV2YXRpb246ICJlbGV2YXRpb24iLAogICAgICAgICAgZW5hYmxlYmFja2dyb3VuZDogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIjogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgZW5kOiAiZW5kIiwKICAgICAgICAgIGV4cG9uZW50OiAiZXhwb25lbnQiLAogICAgICAgICAgZXh0ZXJuYWxyZXNvdXJjZXNyZXF1aXJlZDogImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICAgICAgICAgZmlsbDogImZpbGwiLAogICAgICAgICAgZmlsbG9wYWNpdHk6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IjogImZpbGxPcGFjaXR5IiwKICAgICAgICAgIGZpbGxydWxlOiAiZmlsbFJ1bGUiLAogICAgICAgICAgImZpbGwtcnVsZSI6ICJmaWxsUnVsZSIsCiAgICAgICAgICBmaWx0ZXI6ICJmaWx0ZXIiLAogICAgICAgICAgZmlsdGVycmVzOiAiZmlsdGVyUmVzIiwKICAgICAgICAgIGZpbHRlcnVuaXRzOiAiZmlsdGVyVW5pdHMiLAogICAgICAgICAgZmxvb2RvcGFjaXR5OiAiZmxvb2RPcGFjaXR5IiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IjogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICBmbG9vZGNvbG9yOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICBmb2N1c2FibGU6ICJmb2N1c2FibGUiLAogICAgICAgICAgZm9udGZhbWlseTogImZvbnRGYW1pbHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IjogImZvbnRGYW1pbHkiLAogICAgICAgICAgZm9udHNpemU6ICJmb250U2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplIjogImZvbnRTaXplIiwKICAgICAgICAgIGZvbnRzaXplYWRqdXN0OiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiOiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgZm9udHN0cmV0Y2g6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIjogImZvbnRTdHJldGNoIiwKICAgICAgICAgIGZvbnRzdHlsZTogImZvbnRTdHlsZSIsCiAgICAgICAgICAiZm9udC1zdHlsZSI6ICJmb250U3R5bGUiLAogICAgICAgICAgZm9udHZhcmlhbnQ6ICJmb250VmFyaWFudCIsCiAgICAgICAgICAiZm9udC12YXJpYW50IjogImZvbnRWYXJpYW50IiwKICAgICAgICAgIGZvbnR3ZWlnaHQ6ICJmb250V2VpZ2h0IiwKICAgICAgICAgICJmb250LXdlaWdodCI6ICJmb250V2VpZ2h0IiwKICAgICAgICAgIGZvcm1hdDogImZvcm1hdCIsCiAgICAgICAgICBmcm9tOiAiZnJvbSIsCiAgICAgICAgICBmeDogImZ4IiwKICAgICAgICAgIGZ5OiAiZnkiLAogICAgICAgICAgZzE6ICJnMSIsCiAgICAgICAgICBnMjogImcyIiwKICAgICAgICAgIGdseXBobmFtZTogImdseXBoTmFtZSIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSI6ICJnbHlwaE5hbWUiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbmhvcml6b250YWw6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCI6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICBnbHlwaG9yaWVudGF0aW9udmVydGljYWw6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIjogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICBnbHlwaHJlZjogImdseXBoUmVmIiwKICAgICAgICAgIGdyYWRpZW50dHJhbnNmb3JtOiAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICAgICAgICAgZ3JhZGllbnR1bml0czogImdyYWRpZW50VW5pdHMiLAogICAgICAgICAgaGFuZ2luZzogImhhbmdpbmciLAogICAgICAgICAgaG9yaXphZHZ4OiAiaG9yaXpBZHZYIiwKICAgICAgICAgICJob3Jpei1hZHYteCI6ICJob3JpekFkdlgiLAogICAgICAgICAgaG9yaXpvcmlnaW54OiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCI6ICJob3Jpek9yaWdpblgiLAogICAgICAgICAgaWRlb2dyYXBoaWM6ICJpZGVvZ3JhcGhpYyIsCiAgICAgICAgICBpbWFnZXJlbmRlcmluZzogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciOiAiaW1hZ2VSZW5kZXJpbmciLAogICAgICAgICAgaW4yOiAiaW4yIiwKICAgICAgICAgIGluOiAiaW4iLAogICAgICAgICAgaW5saXN0OiAiaW5saXN0IiwKICAgICAgICAgIGludGVyY2VwdDogImludGVyY2VwdCIsCiAgICAgICAgICBrMTogImsxIiwKICAgICAgICAgIGsyOiAiazIiLAogICAgICAgICAgazM6ICJrMyIsCiAgICAgICAgICBrNDogIms0IiwKICAgICAgICAgIGs6ICJrIiwKICAgICAgICAgIGtlcm5lbG1hdHJpeDogImtlcm5lbE1hdHJpeCIsCiAgICAgICAgICBrZXJuZWx1bml0bGVuZ3RoOiAia2VybmVsVW5pdExlbmd0aCIsCiAgICAgICAgICBrZXJuaW5nOiAia2VybmluZyIsCiAgICAgICAgICBrZXlwb2ludHM6ICJrZXlQb2ludHMiLAogICAgICAgICAga2V5c3BsaW5lczogImtleVNwbGluZXMiLAogICAgICAgICAga2V5dGltZXM6ICJrZXlUaW1lcyIsCiAgICAgICAgICBsZW5ndGhhZGp1c3Q6ICJsZW5ndGhBZGp1c3QiLAogICAgICAgICAgbGV0dGVyc3BhY2luZzogImxldHRlclNwYWNpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIjogImxldHRlclNwYWNpbmciLAogICAgICAgICAgbGlnaHRpbmdjb2xvcjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgbGltaXRpbmdjb25lYW5nbGU6ICJsaW1pdGluZ0NvbmVBbmdsZSIsCiAgICAgICAgICBsb2NhbDogImxvY2FsIiwKICAgICAgICAgIG1hcmtlcmVuZDogIm1hcmtlckVuZCIsCiAgICAgICAgICAibWFya2VyLWVuZCI6ICJtYXJrZXJFbmQiLAogICAgICAgICAgbWFya2VyaGVpZ2h0OiAibWFya2VySGVpZ2h0IiwKICAgICAgICAgIG1hcmtlcm1pZDogIm1hcmtlck1pZCIsCiAgICAgICAgICAibWFya2VyLW1pZCI6ICJtYXJrZXJNaWQiLAogICAgICAgICAgbWFya2Vyc3RhcnQ6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IjogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgIG1hcmtlcnVuaXRzOiAibWFya2VyVW5pdHMiLAogICAgICAgICAgbWFya2Vyd2lkdGg6ICJtYXJrZXJXaWR0aCIsCiAgICAgICAgICBtYXNrOiAibWFzayIsCiAgICAgICAgICBtYXNrY29udGVudHVuaXRzOiAibWFza0NvbnRlbnRVbml0cyIsCiAgICAgICAgICBtYXNrdW5pdHM6ICJtYXNrVW5pdHMiLAogICAgICAgICAgbWF0aGVtYXRpY2FsOiAibWF0aGVtYXRpY2FsIiwKICAgICAgICAgIG1vZGU6ICJtb2RlIiwKICAgICAgICAgIG51bW9jdGF2ZXM6ICJudW1PY3RhdmVzIiwKICAgICAgICAgIG9mZnNldDogIm9mZnNldCIsCiAgICAgICAgICBvcGFjaXR5OiAib3BhY2l0eSIsCiAgICAgICAgICBvcGVyYXRvcjogIm9wZXJhdG9yIiwKICAgICAgICAgIG9yZGVyOiAib3JkZXIiLAogICAgICAgICAgb3JpZW50OiAib3JpZW50IiwKICAgICAgICAgIG9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iLAogICAgICAgICAgb3JpZ2luOiAib3JpZ2luIiwKICAgICAgICAgIG92ZXJmbG93OiAib3ZlcmZsb3ciLAogICAgICAgICAgb3ZlcmxpbmVwb3NpdGlvbjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgb3ZlcmxpbmV0aGlja25lc3M6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIjogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHBhaW50b3JkZXI6ICJwYWludE9yZGVyIiwKICAgICAgICAgICJwYWludC1vcmRlciI6ICJwYWludE9yZGVyIiwKICAgICAgICAgIHBhbm9zZTE6ICJwYW5vc2UxIiwKICAgICAgICAgICJwYW5vc2UtMSI6ICJwYW5vc2UxIiwKICAgICAgICAgIHBhdGhsZW5ndGg6ICJwYXRoTGVuZ3RoIiwKICAgICAgICAgIHBhdHRlcm5jb250ZW50dW5pdHM6ICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAgICAgICAgIHBhdHRlcm50cmFuc2Zvcm06ICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAgICAgICAgIHBhdHRlcm51bml0czogInBhdHRlcm5Vbml0cyIsCiAgICAgICAgICBwb2ludGVyZXZlbnRzOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICBwb2ludHM6ICJwb2ludHMiLAogICAgICAgICAgcG9pbnRzYXR4OiAicG9pbnRzQXRYIiwKICAgICAgICAgIHBvaW50c2F0eTogInBvaW50c0F0WSIsCiAgICAgICAgICBwb2ludHNhdHo6ICJwb2ludHNBdFoiLAogICAgICAgICAgcHJlZml4OiAicHJlZml4IiwKICAgICAgICAgIHByZXNlcnZlYWxwaGE6ICJwcmVzZXJ2ZUFscGhhIiwKICAgICAgICAgIHByZXNlcnZlYXNwZWN0cmF0aW86ICJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwKICAgICAgICAgIHByaW1pdGl2ZXVuaXRzOiAicHJpbWl0aXZlVW5pdHMiLAogICAgICAgICAgcHJvcGVydHk6ICJwcm9wZXJ0eSIsCiAgICAgICAgICByOiAiciIsCiAgICAgICAgICByYWRpdXM6ICJyYWRpdXMiLAogICAgICAgICAgcmVmeDogInJlZlgiLAogICAgICAgICAgcmVmeTogInJlZlkiLAogICAgICAgICAgcmVuZGVyaW5naW50ZW50OiAicmVuZGVyaW5nSW50ZW50IiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IjogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICByZXBlYXRjb3VudDogInJlcGVhdENvdW50IiwKICAgICAgICAgIHJlcGVhdGR1cjogInJlcGVhdER1ciIsCiAgICAgICAgICByZXF1aXJlZGV4dGVuc2lvbnM6ICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICAgICAgICAgcmVxdWlyZWRmZWF0dXJlczogInJlcXVpcmVkRmVhdHVyZXMiLAogICAgICAgICAgcmVzb3VyY2U6ICJyZXNvdXJjZSIsCiAgICAgICAgICByZXN0YXJ0OiAicmVzdGFydCIsCiAgICAgICAgICByZXN1bHQ6ICJyZXN1bHQiLAogICAgICAgICAgcmVzdWx0czogInJlc3VsdHMiLAogICAgICAgICAgcm90YXRlOiAicm90YXRlIiwKICAgICAgICAgIHJ4OiAicngiLAogICAgICAgICAgcnk6ICJyeSIsCiAgICAgICAgICBzY2FsZTogInNjYWxlIiwKICAgICAgICAgIHNlY3VyaXR5OiAic2VjdXJpdHkiLAogICAgICAgICAgc2VlZDogInNlZWQiLAogICAgICAgICAgc2hhcGVyZW5kZXJpbmc6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIjogInNoYXBlUmVuZGVyaW5nIiwKICAgICAgICAgIHNsb3BlOiAic2xvcGUiLAogICAgICAgICAgc3BhY2luZzogInNwYWNpbmciLAogICAgICAgICAgc3BlY3VsYXJjb25zdGFudDogInNwZWN1bGFyQ29uc3RhbnQiLAogICAgICAgICAgc3BlY3VsYXJleHBvbmVudDogInNwZWN1bGFyRXhwb25lbnQiLAogICAgICAgICAgc3BlZWQ6ICJzcGVlZCIsCiAgICAgICAgICBzcHJlYWRtZXRob2Q6ICJzcHJlYWRNZXRob2QiLAogICAgICAgICAgc3RhcnRvZmZzZXQ6ICJzdGFydE9mZnNldCIsCiAgICAgICAgICBzdGRkZXZpYXRpb246ICJzdGREZXZpYXRpb24iLAogICAgICAgICAgc3RlbWg6ICJzdGVtaCIsCiAgICAgICAgICBzdGVtdjogInN0ZW12IiwKICAgICAgICAgIHN0aXRjaHRpbGVzOiAic3RpdGNoVGlsZXMiLAogICAgICAgICAgc3RvcGNvbG9yOiAic3RvcENvbG9yIiwKICAgICAgICAgICJzdG9wLWNvbG9yIjogInN0b3BDb2xvciIsCiAgICAgICAgICBzdG9wb3BhY2l0eTogInN0b3BPcGFjaXR5IiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiOiAic3RvcE9wYWNpdHkiLAogICAgICAgICAgc3RyaWtldGhyb3VnaHBvc2l0aW9uOiAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICBzdHJpa2V0aHJvdWdodGhpY2tuZXNzOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICBzdHJpbmc6ICJzdHJpbmciLAogICAgICAgICAgc3Ryb2tlOiAic3Ryb2tlIiwKICAgICAgICAgIHN0cm9rZWRhc2hhcnJheTogInN0cm9rZURhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSI6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgc3Ryb2tlZGFzaG9mZnNldDogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IjogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgc3Ryb2tlbGluZWNhcDogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIjogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgc3Ryb2tlbGluZWpvaW46ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgIHN0cm9rZW1pdGVybGltaXQ6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCI6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgIHN0cm9rZXdpZHRoOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgInN0cm9rZS13aWR0aCI6ICJzdHJva2VXaWR0aCIsCiAgICAgICAgICBzdHJva2VvcGFjaXR5OiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICBzdXBwcmVzc2NvbnRlbnRlZGl0YWJsZXdhcm5pbmc6ICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgc3VwcHJlc3NoeWRyYXRpb253YXJuaW5nOiAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgIHN1cmZhY2VzY2FsZTogInN1cmZhY2VTY2FsZSIsCiAgICAgICAgICBzeXN0ZW1sYW5ndWFnZTogInN5c3RlbUxhbmd1YWdlIiwKICAgICAgICAgIHRhYmxldmFsdWVzOiAidGFibGVWYWx1ZXMiLAogICAgICAgICAgdGFyZ2V0eDogInRhcmdldFgiLAogICAgICAgICAgdGFyZ2V0eTogInRhcmdldFkiLAogICAgICAgICAgdGV4dGFuY2hvcjogInRleHRBbmNob3IiLAogICAgICAgICAgInRleHQtYW5jaG9yIjogInRleHRBbmNob3IiLAogICAgICAgICAgdGV4dGRlY29yYXRpb246ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgIHRleHRsZW5ndGg6ICJ0ZXh0TGVuZ3RoIiwKICAgICAgICAgIHRleHRyZW5kZXJpbmc6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyI6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgIHRvOiAidG8iLAogICAgICAgICAgdHJhbnNmb3JtOiAidHJhbnNmb3JtIiwKICAgICAgICAgIHR5cGVvZjogInR5cGVvZiIsCiAgICAgICAgICB1MTogInUxIiwKICAgICAgICAgIHUyOiAidTIiLAogICAgICAgICAgdW5kZXJsaW5lcG9zaXRpb246ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIHVuZGVybGluZXRoaWNrbmVzczogInVuZGVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyI6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgdW5pY29kZTogInVuaWNvZGUiLAogICAgICAgICAgdW5pY29kZWJpZGk6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIjogInVuaWNvZGVCaWRpIiwKICAgICAgICAgIHVuaWNvZGVyYW5nZTogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSI6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgdW5pdHNwZXJlbTogInVuaXRzUGVyRW0iLAogICAgICAgICAgInVuaXRzLXBlci1lbSI6ICJ1bml0c1BlckVtIiwKICAgICAgICAgIHVuc2VsZWN0YWJsZTogInVuc2VsZWN0YWJsZSIsCiAgICAgICAgICB2YWxwaGFiZXRpYzogInZBbHBoYWJldGljIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgdmFsdWVzOiAidmFsdWVzIiwKICAgICAgICAgIHZlY3RvcmVmZmVjdDogInZlY3RvckVmZmVjdCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCI6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgdmVyc2lvbjogInZlcnNpb24iLAogICAgICAgICAgdmVydGFkdnk6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICAidmVydC1hZHYteSI6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueDogInZlcnRPcmlnaW5YIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IjogInZlcnRPcmlnaW5YIiwKICAgICAgICAgIHZlcnRvcmlnaW55OiAidmVydE9yaWdpblkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiOiAidmVydE9yaWdpblkiLAogICAgICAgICAgdmhhbmdpbmc6ICJ2SGFuZ2luZyIsCiAgICAgICAgICAidi1oYW5naW5nIjogInZIYW5naW5nIiwKICAgICAgICAgIHZpZGVvZ3JhcGhpYzogInZJZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyI6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgdmlld2JveDogInZpZXdCb3giLAogICAgICAgICAgdmlld3RhcmdldDogInZpZXdUYXJnZXQiLAogICAgICAgICAgdmlzaWJpbGl0eTogInZpc2liaWxpdHkiLAogICAgICAgICAgdm1hdGhlbWF0aWNhbDogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIjogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgdm9jYWI6ICJ2b2NhYiIsCiAgICAgICAgICB3aWR0aHM6ICJ3aWR0aHMiLAogICAgICAgICAgd29yZHNwYWNpbmc6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIjogIndvcmRTcGFjaW5nIiwKICAgICAgICAgIHdyaXRpbmdtb2RlOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgIndyaXRpbmctbW9kZSI6ICJ3cml0aW5nTW9kZSIsCiAgICAgICAgICB4MTogIngxIiwKICAgICAgICAgIHgyOiAieDIiLAogICAgICAgICAgeDogIngiLAogICAgICAgICAgeGNoYW5uZWxzZWxlY3RvcjogInhDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgeGhlaWdodDogInhIZWlnaHQiLAogICAgICAgICAgIngtaGVpZ2h0IjogInhIZWlnaHQiLAogICAgICAgICAgeGxpbmthY3R1YXRlOiAieGxpbmtBY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphY3R1YXRlIjogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICB4bGlua2FyY3JvbGU6ICJ4bGlua0FyY3JvbGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgIHhsaW5raHJlZjogInhsaW5rSHJlZiIsCiAgICAgICAgICAieGxpbms6aHJlZiI6ICJ4bGlua0hyZWYiLAogICAgICAgICAgeGxpbmtyb2xlOiAieGxpbmtSb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIjogInhsaW5rUm9sZSIsCiAgICAgICAgICB4bGlua3Nob3c6ICJ4bGlua1Nob3ciLAogICAgICAgICAgInhsaW5rOnNob3ciOiAieGxpbmtTaG93IiwKICAgICAgICAgIHhsaW5rdGl0bGU6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgICJ4bGluazp0aXRsZSI6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgIHhsaW5rdHlwZTogInhsaW5rVHlwZSIsCiAgICAgICAgICAieGxpbms6dHlwZSI6ICJ4bGlua1R5cGUiLAogICAgICAgICAgeG1sYmFzZTogInhtbEJhc2UiLAogICAgICAgICAgInhtbDpiYXNlIjogInhtbEJhc2UiLAogICAgICAgICAgeG1sbGFuZzogInhtbExhbmciLAogICAgICAgICAgInhtbDpsYW5nIjogInhtbExhbmciLAogICAgICAgICAgeG1sbnM6ICJ4bWxucyIsCiAgICAgICAgICAieG1sOnNwYWNlIjogInhtbFNwYWNlIiwKICAgICAgICAgIHhtbG5zeGxpbms6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgICJ4bWxuczp4bGluayI6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgIHhtbHNwYWNlOiAieG1sU3BhY2UiLAogICAgICAgICAgeTE6ICJ5MSIsCiAgICAgICAgICB5MjogInkyIiwKICAgICAgICAgIHk6ICJ5IiwKICAgICAgICAgIHljaGFubmVsc2VsZWN0b3I6ICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHo6ICJ6IiwKICAgICAgICAgIHpvb21hbmRwYW46ICJ6b29tQW5kUGFuIgogICAgICAgIH07CiAgICAgICAgdmFyIGFyaWFQcm9wZXJ0aWVzID0gewogICAgICAgICAgImFyaWEtY3VycmVudCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtZGVzY3JpcHRpb24iOiAwLAogICAgICAgICAgImFyaWEtZGV0YWlscyI6IDAsCiAgICAgICAgICAiYXJpYS1kaXNhYmxlZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaGlkZGVuIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1pbnZhbGlkIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1rZXlzaG9ydGN1dHMiOiAwLAogICAgICAgICAgImFyaWEtbGFiZWwiOiAwLAogICAgICAgICAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgIC8vIFdpZGdldCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hdXRvY29tcGxldGUiOiAwLAogICAgICAgICAgImFyaWEtY2hlY2tlZCI6IDAsCiAgICAgICAgICAiYXJpYS1leHBhbmRlZCI6IDAsCiAgICAgICAgICAiYXJpYS1oYXNwb3B1cCI6IDAsCiAgICAgICAgICAiYXJpYS1sZXZlbCI6IDAsCiAgICAgICAgICAiYXJpYS1tb2RhbCI6IDAsCiAgICAgICAgICAiYXJpYS1tdWx0aWxpbmUiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIjogMCwKICAgICAgICAgICJhcmlhLW9yaWVudGF0aW9uIjogMCwKICAgICAgICAgICJhcmlhLXBsYWNlaG9sZGVyIjogMCwKICAgICAgICAgICJhcmlhLXByZXNzZWQiOiAwLAogICAgICAgICAgImFyaWEtcmVhZG9ubHkiOiAwLAogICAgICAgICAgImFyaWEtcmVxdWlyZWQiOiAwLAogICAgICAgICAgImFyaWEtc2VsZWN0ZWQiOiAwLAogICAgICAgICAgImFyaWEtc29ydCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1heCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1pbiI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW5vdyI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZXRleHQiOiAwLAogICAgICAgICAgLy8gTGl2ZSBSZWdpb24gQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXRvbWljIjogMCwKICAgICAgICAgICJhcmlhLWJ1c3kiOiAwLAogICAgICAgICAgImFyaWEtbGl2ZSI6IDAsCiAgICAgICAgICAiYXJpYS1yZWxldmFudCI6IDAsCiAgICAgICAgICAvLyBEcmFnLWFuZC1Ecm9wIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWRyb3BlZmZlY3QiOiAwLAogICAgICAgICAgImFyaWEtZ3JhYmJlZCI6IDAsCiAgICAgICAgICAvLyBSZWxhdGlvbnNoaXAgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xjb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xzcGFuIjogMCwKICAgICAgICAgICJhcmlhLWNvbnRyb2xzIjogMCwKICAgICAgICAgICJhcmlhLWRlc2NyaWJlZGJ5IjogMCwKICAgICAgICAgICJhcmlhLWVycm9ybWVzc2FnZSI6IDAsCiAgICAgICAgICAiYXJpYS1mbG93dG8iOiAwLAogICAgICAgICAgImFyaWEtbGFiZWxsZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1vd25zIjogMCwKICAgICAgICAgICJhcmlhLXBvc2luc2V0IjogMCwKICAgICAgICAgICJhcmlhLXJvd2NvdW50IjogMCwKICAgICAgICAgICJhcmlhLXJvd2luZGV4IjogMCwKICAgICAgICAgICJhcmlhLXJvd3NwYW4iOiAwLAogICAgICAgICAgImFyaWEtc2V0c2l6ZSI6IDAKICAgICAgICB9OwogICAgICAgIHZhciB3YXJuZWRQcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJBUklBID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIHJBUklBQ2FtZWwgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0eSh0YWdOYW1lLCBuYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUFDYW1lbC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGFyaWFOYW1lID0gImFyaWEtIiArIG5hbWUuc2xpY2UoNCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShhcmlhTmFtZSkgPyBhcmlhTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3ROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIEFSSUEgYXR0cmlidXRlcyBmb2xsb3cgdGhlIHBhdHRlcm4gYXJpYS0qIGFuZCBtdXN0IGJlIGxvd2VyY2FzZS4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuYW1lICE9PSBjb3JyZWN0TmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgY29ycmVjdE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGFyaWFQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IGxvd2VyQ2FzZWROYW1lIDogbnVsbDsKICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gc3RhbmRhcmROYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5rbm93biBBUklBIGF0dHJpYnV0ZSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW52YWxpZFByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSh0eXBlLCBrZXkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaW52YWxpZFByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gaW52YWxpZFByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmIChpbnZhbGlkUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3BzICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JbnZhbGlkQVJJQVByb3BzKHR5cGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZU51bGwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZSAhPT0gImlucHV0IiAmJiB0eXBlICE9PSAidGV4dGFyZWEiICYmIHR5cGUgIT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcyAhPSBudWxsICYmIHByb3BzLnZhbHVlID09PSBudWxsICYmICFkaWRXYXJuVmFsdWVOdWxsKSB7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlTnVsbCA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiICYmIHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiYHZhbHVlYCBwcm9wIG9uIGAlc2Agc2hvdWxkIG5vdCBiZSBudWxsLiBDb25zaWRlciB1c2luZyBhbiBlbXB0eSBhcnJheSB3aGVuIGBtdWx0aXBsZWAgaXMgc2V0IHRvIGB0cnVlYCB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgc3RyaW5nIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyQxID0ge307CiAgICAgICAgICB2YXIgRVZFTlRfTkFNRV9SRUdFWCA9IC9eb24uLzsKICAgICAgICAgIHZhciBJTlZBTElEX0VWRU5UX05BTUVfUkVHRVggPSAvXm9uW15BLVpdLzsKICAgICAgICAgIHZhciByQVJJQSQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICB2YXIgckFSSUFDYW1lbCQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24odGFnTmFtZSwgbmFtZSwgdmFsdWUsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcyQxLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNpbiIgfHwgbG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3Vzb3V0IikgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCB1c2VzIG9uRm9jdXMgYW5kIG9uQmx1ciBpbnN0ZWFkIG9mIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dC4gQWxsIFJlYWN0IGV2ZW50cyBhcmUgbm9ybWFsaXplZCB0byBidWJibGUsIHNvIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dCBhcmUgbm90IG5lZWRlZC9zdXBwb3J0ZWQgYnkgUmVhY3QuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnRSZWdpc3RyeSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyID0gZXZlbnRSZWdpc3RyeS5yZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLCBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMiA9IGV2ZW50UmVnaXN0cnkucG9zc2libGVSZWdpc3RyYXRpb25OYW1lczsKICAgICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyW2xvd2VyQ2FzZWROYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBJdCB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIGlmIChJTlZBTElEX0VWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBSZWFjdCBldmVudHMgdXNlIHRoZSBjYW1lbENhc2UgbmFtaW5nIGNvbnZlbnRpb24sIGZvciBleGFtcGxlIGBvbkNsaWNrYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUEkMS50ZXN0KG5hbWUpIHx8IHJBUklBQ2FtZWwkMS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiaW5uZXJodG1sIikgewogICAgICAgICAgICAgIGVycm9yKCJEaXJlY3RseSBzZXR0aW5nIHByb3BlcnR5IGBpbm5lckhUTUxgIGlzIG5vdCBwZXJtaXR0ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBsb29rdXAgZG9jdW1lbnRhdGlvbiBvbiBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiYXJpYSIpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGBhcmlhYCBhdHRyaWJ1dGUgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UgaW4gUmVhY3QuIFBhc3MgaW5kaXZpZHVhbCBgYXJpYS1gIGF0dHJpYnV0ZXMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlzIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYSBgJXNgIGZvciBhIHN0cmluZyBhdHRyaWJ1dGUgYGlzYC4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgdHlwZW9mIHZhbHVlKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiICYmIGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBOYU4gZm9yIHRoZSBgJXNgIGF0dHJpYnV0ZS4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgbmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgICB2YXIgaXNSZXNlcnZlZCA9IHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICAgIGlmIChwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgRE9NIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1Jlc2VydmVkICYmIG5hbWUgIT09IGxvd2VyQ2FzZWROYW1lKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRvZXMgbm90IHJlY29nbml6ZSB0aGUgYCVzYCBwcm9wIG9uIGEgRE9NIGVsZW1lbnQuIElmIHlvdSBpbnRlbnRpb25hbGx5IHdhbnQgaXQgdG8gYXBwZWFyIGluIHRoZSBET00gYXMgYSBjdXN0b20gYXR0cmlidXRlLCBzcGVsbCBpdCBhcyBsb3dlcmNhc2UgYCVzYCBpbnN0ZWFkLiBJZiB5b3UgYWNjaWRlbnRhbGx5IHBhc3NlZCBpdCBmcm9tIGEgcGFyZW50IGNvbXBvbmVudCwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBlbGVtZW50LiIsIG5hbWUsIGxvd2VyQ2FzZWROYW1lKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiAmJiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LlxuXG5JZiB5b3UgdXNlZCB0byBjb25kaXRpb25hbGx5IG9taXQgaXQgd2l0aCAlcz17Y29uZGl0aW9uICYmIHZhbHVlfSwgcGFzcyAlcz17Y29uZGl0aW9uID8gdmFsdWUgOiB1bmRlZmluZWR9IGluc3RlYWQuJywgdmFsdWUsIG5hbWUsIG5hbWUsIHZhbHVlLCBuYW1lLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNSZXNlcnZlZCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHZhbHVlID09PSAiZmFsc2UiIHx8IHZhbHVlID09PSAidHJ1ZSIpICYmIHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCB0aGUgc3RyaW5nIGAlc2AgZm9yIHRoZSBib29sZWFuIGF0dHJpYnV0ZSBgJXNgLiAlcyBEaWQgeW91IG1lYW4gJXM9eyVzfT8iLCB2YWx1ZSwgbmFtZSwgdmFsdWUgPT09ICJmYWxzZSIgPyAiVGhlIGJyb3dzZXIgd2lsbCBpbnRlcnByZXQgaXQgYXMgYSB0cnV0aHkgdmFsdWUuIiA6ICdBbHRob3VnaCB0aGlzIHdvcmtzLCBpdCB3aWxsIG5vdCB3b3JrIGFzIGV4cGVjdGVkIGlmIHlvdSBwYXNzIHRoZSBzdHJpbmcgImZhbHNlIi4nLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVW5rbm93blByb3BlcnRpZXMgPSBmdW5jdGlvbih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5rbm93blByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSQxKHR5cGUsIGtleSwgcHJvcHNba2V5XSwgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICB1bmtub3duUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSB1bmtub3duUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gImAiICsgcHJvcCArICJgIjsKICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZSBmb3IgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSBpdCBmcm9tIHRoZSBlbGVtZW50LCBvciBwYXNzIGEgc3RyaW5nIG9yIG51bWJlciB2YWx1ZSB0byBrZWVwIGl0IGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5rbm93blByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZXMgZm9yIHByb3BzICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCB0aGVtIGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5Vbmtub3duUHJvcGVydGllcyh0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgfQogICAgICAgIHZhciBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSA9IDE7CiAgICAgICAgdmFyIElTX05PTl9ERUxFR0FURUQgPSAxIDw8IDE7CiAgICAgICAgdmFyIElTX0NBUFRVUkVfUEhBU0UgPSAxIDw8IDI7CiAgICAgICAgdmFyIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TID0gSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgfCBJU19OT05fREVMRUdBVEVEIHwgSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICB2YXIgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gZXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVwbGF5aW5nRXZlbnQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgY3VycmVudGx5IHJlcGxheWluZyBldmVudCB0byBub3QgYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50ID09PSBjdXJyZW50UmVwbGF5aW5nRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmF0aXZlRXZlbnQudGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnNyY0VsZW1lbnQgfHwgd2luZG93OwogICAgICAgICAgaWYgKHRhcmdldC5jb3JyZXNwb25kaW5nVXNlRWxlbWVudCkgewogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09PSBURVhUX05PREUgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3RvcmVJbXBsID0gbnVsbDsKICAgICAgICB2YXIgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKICAgICAgICAgIGlmICghaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3RvcmVJbXBsICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKCkgbmVlZHMgdG8gYmUgY2FsbGVkIHRvIGhhbmRsZSBhIHRhcmdldCBmb3IgY29udHJvbGxlZCBldmVudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoc3RhdGVOb2RlKSB7CiAgICAgICAgICAgIHZhciBfcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICAgIHJlc3RvcmVJbXBsKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlLCBpbnRlcm5hbEluc3RhbmNlLnR5cGUsIF9wcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihpbXBsKSB7CiAgICAgICAgICByZXN0b3JlSW1wbCA9IGltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KSB7CiAgICAgICAgICBpZiAocmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICBpZiAocmVzdG9yZVF1ZXVlKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlLnB1c2godGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN0b3JlUXVldWUgPSBbdGFyZ2V0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdG9yZVRhcmdldCA9IHRhcmdldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmVlZHNTdGF0ZVJlc3RvcmUoKSB7CiAgICAgICAgICByZXR1cm4gcmVzdG9yZVRhcmdldCAhPT0gbnVsbCB8fCByZXN0b3JlUXVldWUgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCkgewogICAgICAgICAgaWYgKCFyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXQgPSByZXN0b3JlVGFyZ2V0OwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldHMgPSByZXN0b3JlUXVldWU7CiAgICAgICAgICByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpOwogICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQocXVldWVkVGFyZ2V0c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJhdGNoZWRVcGRhdGVzSW1wbCA9IGZ1bmN0aW9uKGZuLCBib29ra2VlcGluZykgewogICAgICAgICAgcmV0dXJuIGZuKGJvb2trZWVwaW5nKTsKICAgICAgICB9OwogICAgICAgIHZhciBmbHVzaFN5bmNJbXBsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5pc2hFdmVudEhhbmRsZXIoKSB7CiAgICAgICAgICB2YXIgY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMgPSBuZWVkc1N0YXRlUmVzdG9yZSgpOwogICAgICAgICAgaWYgKGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0ltcGwoKTsKICAgICAgICAgICAgcmVzdG9yZVN0YXRlSWZOZWVkZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEsIGIpIHsKICAgICAgICAgIGlmIChpc0luc2lkZUV2ZW50SGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gZm4oYSwgYik7CiAgICAgICAgICB9CiAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYmF0Y2hlZFVwZGF0ZXNJbXBsKGZuLCBhLCBiKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgICAgIGZpbmlzaEV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKF9iYXRjaGVkVXBkYXRlc0ltcGwsIF9kaXNjcmV0ZVVwZGF0ZXNJbXBsLCBfZmx1c2hTeW5jSW1wbCkgewogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXNJbXBsID0gX2JhdGNoZWRVcGRhdGVzSW1wbDsKICAgICAgICAgIGZsdXNoU3luY0ltcGwgPSBfZmx1c2hTeW5jSW1wbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlcmFjdGl2ZSh0YWcpIHsKICAgICAgICAgIHJldHVybiB0YWcgPT09ICJidXR0b24iIHx8IHRhZyA9PT0gImlucHV0IiB8fCB0YWcgPT09ICJzZWxlY3QiIHx8IHRhZyA9PT0gInRleHRhcmVhIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUHJldmVudE1vdXNlRXZlbnQobmFtZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICBjYXNlICJvbkNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25DbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbkRvdWJsZUNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93biI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VEb3duQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmVDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VFbnRlciI6CiAgICAgICAgICAgICAgcmV0dXJuICEhKHByb3BzLmRpc2FibGVkICYmIGlzSW50ZXJhY3RpdmUodHlwZSkpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXIoaW5zdCwgcmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUoc3RhdGVOb2RlKTsKICAgICAgICAgIGlmIChwcm9wcyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHByb3BzW3JlZ2lzdHJhdGlvbk5hbWVdOwogICAgICAgICAgaWYgKHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGluc3QudHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVyICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGAiICsgcmVnaXN0cmF0aW9uTmFtZSArICJgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCIgKyB0eXBlb2YgbGlzdGVuZXIgKyAiYCB0eXBlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0aW9ucywgInBhc3NpdmUiLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRpc3BhdGNoRXZlbnQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBkb2N1bWVudGAgZ2xvYmFsIHdhcyBkZWZpbmVkIHdoZW4gUmVhY3Qgd2FzIGluaXRpYWxpemVkLCBidXQgaXMgbm90IGRlZmluZWQgYW55bW9yZS4gVGhpcyBjYW4gaGFwcGVuIGluIGEgdGVzdCBlbnZpcm9ubWVudCBpZiBhIGNvbXBvbmVudCBzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgZmluaXNoZWQgcnVubmluZy4gVG8gc29sdmUgdGhpcywgeW91IGNhbiBlaXRoZXIgdW5tb3VudCB0aGUgY29tcG9uZW50IGF0IHRoZSBlbmQgb2YgeW91ciB0ZXN0IChhbmQgZW5zdXJlIHRoYXQgYW55IGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGdldCBjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmIHRvIGJlIGFzeW5jaHJvbm91cy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgICAgICAgIHZhciBkaWRDYWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LCAiZXZlbnQiKTsKICAgICAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpIHsKICAgICAgICAgICAgICAgIGZha2VOb2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgiZXZlbnQiKSkgewogICAgICAgICAgICAgICAgICB3aW5kb3cuZXZlbnQgPSB3aW5kb3dFdmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2syKCkgewogICAgICAgICAgICAgICAgZGlkQ2FsbCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBpc0Nyb3NzT3JpZ2luRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVXaW5kb3dFcnJvcihldmVudCkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gZXZlbnQuZXJyb3I7CiAgICAgICAgICAgICAgICBkaWRTZXRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IyID09PSBudWxsICYmIGV2ZW50LmNvbG5vID09PSAwICYmIGV2ZW50LmxpbmVubyA9PT0gMCkgewogICAgICAgICAgICAgICAgICBpc0Nyb3NzT3JpZ2luRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIHR5cGVvZiBlcnJvcjIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChpbm5lcikgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0VHlwZSA9ICJyZWFjdC0iICsgKG5hbWUgPyBuYW1lIDogImludm9rZWd1YXJkZWRjYWxsYmFjayIpOwogICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5hZGRFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2dFR5cGUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgZmFrZU5vZGUuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgIGlmICh3aW5kb3dFdmVudERlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICJldmVudCIsIHdpbmRvd0V2ZW50RGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRDYWxsICYmIGRpZEVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFNldEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihgQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0IGRvZXNuJ3Qga25vdyB3aGF0IGl0IHdhcy4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGJyb3dzZXIgZmxha2luZXNzLiBSZWFjdCBkb2VzIGl0cyBiZXN0IHRvIHByZXNlcnZlIHRoZSAiUGF1c2Ugb24gZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lIERFVi1tb2RlIG9ubHkgdHJpY2tzLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlc2UgZG9uJ3Qgd29yayBpbiB5b3VyIGJyb3dzZXIuIFRyeSB0cmlnZ2VyaW5nIHRoZSBlcnJvciBpbiBwcm9kdWN0aW9uIG1vZGUsIG9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgYWN0dWFsbHkgYW4gaXNzdWUgd2l0aCBSZWFjdCwgcGxlYXNlIGZpbGUgYW4gaXNzdWUuYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3Jvc3NPcmlnaW5FcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIkEgY3Jvc3Mtb3JpZ2luIGVycm9yIHdhcyB0aHJvd24uIFJlYWN0IGRvZXNuJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGFjdHVhbCBlcnJvciBvYmplY3QgaW4gZGV2ZWxvcG1lbnQuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY3Jvc3NvcmlnaW4tZXJyb3IgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGlmICghZGlkQ2FsbCkgewogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxID0gaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbDsKICAgICAgICB2YXIgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICB2YXIgcmVwb3J0ZXIgPSB7CiAgICAgICAgICBvbkVycm9yOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFjayhuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxLmFwcGx5KHJlcG9ydGVyLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IGVycm9yMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSByZXRocm93RXJyb3I7CiAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NhdWdodEVycm9yKCkgewogICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjYXVnaHRFcnJvcjsKICAgICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXJyb3IyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICBrZXkuX3JlYWN0SW50ZXJuYWxzID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBQZXJmb3JtZWRXb3JrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBVcGRhdGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBDaGlsZERlbGV0aW9uID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIENhbGxiYWNrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBEaWRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmVmID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBTbmFwc2hvdCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwNDgKICAgICAgICApOwogICAgICAgIHZhciBIeWRyYXRpbmcgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBWaXNpYmlsaXR5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBTdG9yZUNvbnNpc3RlbmN5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Mzg0CiAgICAgICAgKTsKICAgICAgICB2YXIgTGlmZWN5Y2xlRWZmZWN0TWFzayA9IFBhc3NpdmUgfCBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmIHwgSHlkcmF0aW5nIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgUGFzc2l2ZU1hc2sgPSBQYXNzaXZlIHwgQ2hpbGREZWxldGlvbjsKICAgICAgICB2YXIgU3RhdGljTWFzayA9IExheW91dFN0YXRpYyB8IFBhc3NpdmVTdGF0aWMgfCBSZWZTdGF0aWM7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGZpYmVyOwogICAgICAgICAgaWYgKCFmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgdmFyIG5leHROb2RlID0gbm9kZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIG5vZGUgPSBuZXh0Tm9kZTsKICAgICAgICAgICAgICBpZiAoKG5vZGUuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIG5lYXJlc3RNb3VudGVkID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnJldHVybikgewogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICByZXR1cm4gbmVhcmVzdE1vdW50ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250YWluZXJGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RSb290ID8gZmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZpYmVyTW91bnRlZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNb3VudGVkKGNvbXBvbmVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgb3duZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gb3duZXJGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgaXNNb3VudGVkIGluc2lkZSBpdHMgcmVuZGVyKCkgZnVuY3Rpb24uIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lckZpYmVyKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbih7fSwgaW50ZXJuYWxzLCB7CiAgICAgICAgICAgICAgICBnZXRMYW5lTGFiZWxNYXAsCiAgICAgICAgICAgICAgICBpbmplY3RQcm9maWxpbmdIb29rcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlcmVySUQgPSBob29rLmluamVjdChpbnRlcm5hbHMpOwogICAgICAgICAgICBpbmplY3RlZEhvb2sgPSBob29rOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaG9vay5jaGVja0RDRSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25TY2hlZHVsZVJvb3Qocm9vdDMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFJvb3Qocm9vdDMsIGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IChyb290My5jdXJyZW50LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIpIHsKICAgICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBzY2hlZHVsZXJQcmlvcml0eSwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHZvaWQgMCwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Qb3N0Q29tbWl0Um9vdChyb290MykgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKG5ld0lzU3RyaWN0TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHVuc3RhYmxlX3lpZWxkVmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZShuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIHNldFN1cHByZXNzV2FybmluZyhuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlKHJlbmRlcmVySUQsIG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdFByb2ZpbGluZ0hvb2tzKHByb2ZpbGluZ0hvb2tzKSB7CiAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gcHJvZmlsaW5nSG9va3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVMYWJlbE1hcCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXgyID0gMDsgaW5kZXgyIDwgVG90YWxMYW5lczsgaW5kZXgyKyspIHsKICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgbWFwLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlcllpZWxkZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29uY3VycmVudE1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQcm9maWxlTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdExlZ2FjeU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0RWZmZWN0c01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgY2x6MzIgPSBNYXRoLmNsejMyID8gTWF0aC5jbHozMiA6IGNsejMyRmFsbGJhY2s7CiAgICAgICAgdmFyIGxvZyA9IE1hdGgubG9nOwogICAgICAgIHZhciBMTjIgPSBNYXRoLkxOMjsKICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4ID4+PiAwOwogICAgICAgICAgaWYgKGFzVWludCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gMzI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMzEgLSAobG9nKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgfQogICAgICAgIHZhciBUb3RhbExhbmVzID0gMzE7CiAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgTm9MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgU3luY0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MjQwCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTggPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMxMDcyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjYyMTQ0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTI0Mjg4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY3MTA4ODY0CiAgICAgICAgKTsKICAgICAgICB2YXIgU29tZVJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgdmFyIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgMTM0MjE3NzI4CiAgICAgICAgKTsKICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTUKICAgICAgICApOwogICAgICAgIHZhciBJZGxlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTM2ODcwOTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDczNzQxODI0CiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbEZvckxhbmUobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTeW5jIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91c0h5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHRIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb25IeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlJldHJ5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlNlbGVjdGl2ZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb1RpbWVzdGFtcCA9IC0xOwogICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgdmFyIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKGxhbmVzKSB7CiAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRMYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFRyYW5zaXRpb25MYW5lczsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgUmV0cnlMYW5lczsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUxhbmU7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChwZW5kaW5nTGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgbm9uSWRsZVBlbmRpbmdMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIE5vbklkbGVMYW5lczsKICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub25JZGxlVW5ibG9ja2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAobm9uSWRsZVVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9uSWRsZVBpbmdlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVQaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5ibG9ja2VkTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0TGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2lwTGFuZXMgIT09IE5vTGFuZXMgJiYgd2lwTGFuZXMgIT09IG5leHRMYW5lcyAmJiAvLyBJZiB3ZSBhbHJlYWR5IHN1c3BlbmRlZCB3aXRoIGEgZGVsYXksIHRoZW4gaW50ZXJydXB0aW5nIGlzIGZpbmUuIERvbid0CiAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICh3aXBMYW5lcyAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbmV4dExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKG5leHRMYW5lcyk7CiAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBUZXN0cyB3aGV0aGVyIHRoZSBuZXh0IGxhbmUgaXMgZXF1YWwgb3IgbG93ZXIgcHJpb3JpdHkgdGhhbiB0aGUgd2lwCiAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgbmV4dExhbmUgPj0gd2lwTGFuZSB8fCAvLyBEZWZhdWx0IHByaW9yaXR5IHVwZGF0ZXMgc2hvdWxkIG5vdCBpbnRlcnJ1cHQgdHJhbnNpdGlvbiB1cGRhdGVzLiBUaGUKICAgICAgICAgICAgICAvLyBvbmx5IGRpZmZlcmVuY2UgYmV0d2VlbiBkZWZhdWx0IHVwZGF0ZXMgYW5kIHRyYW5zaXRpb24gdXBkYXRlcyBpcyB0aGF0CiAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgbmV4dExhbmUgPT09IERlZmF1bHRMYW5lICYmICh3aXBMYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dExhbmVzIHw9IHBlbmRpbmdMYW5lcyAmIERlZmF1bHRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICBpZiAoZW50YW5nbGVkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICAgIG5leHRMYW5lcyB8PSBlbnRhbmdsZW1lbnRzW2luZGV4Ml07CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0TGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vc3RSZWNlbnRFdmVudFRpbWUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBldmVudFRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChldmVudFRpbWUgPiBtb3N0UmVjZW50RXZlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHN3aXRjaCAobGFuZSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyAyNTA7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyA1ZTM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgaWYgKChsYW5lICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzIHx8IChsYW5lICYgcGluZ2VkTGFuZXMpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzIHw9IGxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290MykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKSB7CiAgICAgICAgICB2YXIgZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5PZmZzY3JlZW5MYW5lOwogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTeW5jTGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNOb25JZGxlV29yayhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKGxhbmVzKSB7CiAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBVcmdlbnRMYW5lcykgPT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIFN5bmNEZWZhdWx0TGFuZXMgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRIeWRyYXRpb25MYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0RlZmF1bHRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgcm9vdDMuZXhwaXJlZExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUcmFuc2l0aW9uTGFuZShsYW5lKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0VHJhbnNpdGlvbkxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRSZXRyeUxhbmU7CiAgICAgICAgICBuZXh0UmV0cnlMYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0luZGV4KGxhbmUpIHsKICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1NvbWVMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiAoYSAmIGIpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0Miwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gKHNldDIgJiBzdWJzZXQpID09PSBzdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQyLCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQyICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgJiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9MYW5lcyhsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyUHJpb3JpdHlMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSBOb0xhbmUgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb3dlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgPT09IDAgfHwgYSA+IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgdmFyIGxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jbHVkZXNOb25JZGxlV29yayhsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpIHsKICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSByb290My5jdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICB9CiAgICAgICAgdmFyIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDE7CiAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgdmFyIHF1ZXVlZERpc2NyZXRlRXZlbnRzID0gW107CiAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMgPSBbXTsKICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgIm1vdXNlZG93biIsCiAgICAgICAgICAibW91c2V1cCIsCiAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgInRvdWNoZW5kIiwKICAgICAgICAgICJ0b3VjaHN0YXJ0IiwKICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAiZGJsY2xpY2siLAogICAgICAgICAgInBvaW50ZXJjYW5jZWwiLAogICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICJwb2ludGVydXAiLAogICAgICAgICAgImRyYWdlbmQiLAogICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAiZHJvcCIsCiAgICAgICAgICAiY29tcG9zaXRpb25lbmQiLAogICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgImtleWRvd24iLAogICAgICAgICAgImtleXByZXNzIiwKICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgInRleHRJbnB1dCIsCiAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgImNvcHkiLAogICAgICAgICAgImN1dCIsCiAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgImNsaWNrIiwKICAgICAgICAgICJjaGFuZ2UiLAogICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICJyZXNldCIsCiAgICAgICAgICAic3VibWl0IgogICAgICAgIF07CiAgICAgICAgZnVuY3Rpb24gaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGV2ZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cy5pbmRleE9mKGV2ZW50VHlwZSkgPiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSwKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncywKICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnM6IFt0YXJnZXRDb250YWluZXJdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoZXhpc3RpbmdRdWV1ZWRFdmVudCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZWRFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGV4aXN0aW5nUXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncyB8PSBldmVudFN5c3RlbUZsYWdzOwogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBleGlzdGluZ1F1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnB1c2godGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjogewogICAgICAgICAgICAgIHZhciBmb2N1c0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIGRyYWdFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZERyYWcsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGRyYWdFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjogewogICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZE1vdXNlLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBtb3VzZUV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuc2V0KHBvaW50ZXJJZCwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVycy5nZXQocG9pbnRlcklkKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBwb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5zZXQoX3BvaW50ZXJJZDIsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlckNhcHR1cmVzLmdldChfcG9pbnRlcklkMikgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgX3BvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocXVldWVkVGFyZ2V0LnRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHF1ZXVlZFRhcmdldC5wcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSgpOwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHsKICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHByaW9yaXR5OiB1cGRhdGVQcmlvcml0eQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zcGxpY2UoaSwgMCwgcXVldWVkVGFyZ2V0KTsKICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gcXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIHdoaWxlICh0YXJnZXRDb250YWluZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChxdWV1ZWRFdmVudC5kb21FdmVudE5hbWUsIHF1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcXVldWVkRXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50Q2xvbmUgPSBuZXcgbmF0aXZlRXZlbnQuY29uc3RydWN0b3IobmF0aXZlRXZlbnQudHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICBuYXRpdmVFdmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIHJlc2V0UmVwbGF5aW5nRXZlbnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjMgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKG5leHRCbG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcChxdWV1ZWRFdmVudCwga2V5LCBtYXApIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcGxheVVuYmxvY2tlZEV2ZW50cygpIHsKICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEZvY3VzKSkgewogICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZERyYWcpKSB7CiAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkTW91c2UpKSB7CiAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudCwgdW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0KSB7CiAgICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IHRydWU7CiAgICAgICAgICAgICAgU2NoZWR1bGVyLnVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2soU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5LCByZXBsYXlVbmJsb2NrZWRFdmVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5SWZCbG9ja2VkT24odW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRGlzY3JldGVFdmVudHNbMF0sIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBxdWV1ZWREaXNjcmV0ZUV2ZW50c1tpXTsKICAgICAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEZvY3VzLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERyYWcsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZE1vdXNlLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVuYmxvY2sgPSBmdW5jdGlvbihxdWV1ZWRFdmVudDIpIHsKICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudDIsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9OwogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tfaV07CiAgICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXh0RXhwbGljaXRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbMF07CiAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KG5leHRFeHBsaWNpdFRhcmdldCk7CiAgICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zaGlmdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgX2VuYWJsZWQgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIHNldEVuYWJsZWQoZW5hYmxlZCkgewogICAgICAgICAgX2VuYWJsZWQgPSAhIWVuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRW5hYmxlZCgpIHsKICAgICAgICAgIHJldHVybiBfZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpIHsKICAgICAgICAgIHZhciBldmVudFByaW9yaXR5ID0gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpOwogICAgICAgICAgdmFyIGxpc3RlbmVyV3JhcHBlcjsKICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaERpc2NyZXRlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcldyYXBwZXIuYmluZChudWxsLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRGlzY3JldGVFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmICghX2VuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgYmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSAmJiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICB3aGlsZSAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IGJsb2NrZWRPbikgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBudWxsLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiY2xvc2UiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImludmFsaWQiOgogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgY2FzZSAicGxheSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgIGNhc2UgInJhdGVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgIGNhc2UgInJlc2l6ZSI6CiAgICAgICAgICAgIGNhc2UgInNlZWtlZCI6CiAgICAgICAgICAgIGNhc2UgInN1Ym1pdCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAidm9sdW1lY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlaW5wdXQiOgogICAgICAgICAgICBjYXNlICJibHVyIjoKICAgICAgICAgICAgY2FzZSAiZnVsbHNjcmVlbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzIjoKICAgICAgICAgICAgY2FzZSAiaGFzaGNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInBvcHN0YXRlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0c3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgIGNhc2UgInRvZ2dsZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgY2FzZSAibW91c2VlbnRlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbGVhdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZW50ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybGVhdmUiOgogICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAibWVzc2FnZSI6IHsKICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHkgPSBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpOwogICAgICAgICAgICAgIHN3aXRjaCAoc2NoZWR1bGVyUHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lciwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIHZhciByb290MiA9IG51bGw7CiAgICAgICAgdmFyIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgcm9vdDIgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IGdldFRleHQoKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICAgIHJvb3QyID0gbnVsbDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgICAgaWYgKGZhbGxiYWNrVGV4dCkgewogICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgdmFyIHN0YXJ0VmFsdWUgPSBzdGFydFRleHQ7CiAgICAgICAgICB2YXIgc3RhcnRMZW5ndGggPSBzdGFydFZhbHVlLmxlbmd0aDsKICAgICAgICAgIHZhciBlbmQ7CiAgICAgICAgICB2YXIgZW5kVmFsdWUgPSBnZXRUZXh0KCk7CiAgICAgICAgICB2YXIgZW5kTGVuZ3RoID0gZW5kVmFsdWUubGVuZ3RoOwogICAgICAgICAgZm9yIChzdGFydCA9IDA7IHN0YXJ0IDwgc3RhcnRMZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRdICE9PSBlbmRWYWx1ZVtzdGFydF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG1pbkVuZCA9IHN0YXJ0TGVuZ3RoIC0gc3RhcnQ7CiAgICAgICAgICBmb3IgKGVuZCA9IDE7IGVuZCA8PSBtaW5FbmQ7IGVuZCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0TGVuZ3RoIC0gZW5kXSAhPT0gZW5kVmFsdWVbZW5kTGVuZ3RoIC0gZW5kXSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2xpY2VUYWlsID0gZW5kID4gMSA/IDEgLSBlbmQgOiB2b2lkIDA7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBlbmRWYWx1ZS5zbGljZShzdGFydCwgc2xpY2VUYWlsKTsKICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRleHQoKSB7CiAgICAgICAgICBpZiAoInZhbHVlIiBpbiByb290MikgewogICAgICAgICAgICByZXR1cm4gcm9vdDIudmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcm9vdDIudGV4dENvbnRlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjaGFyQ29kZTsKICAgICAgICAgIHZhciBrZXlDb2RlID0gbmF0aXZlRXZlbnQua2V5Q29kZTsKICAgICAgICAgIGlmICgiY2hhckNvZGUiIGluIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gbmF0aXZlRXZlbnQuY2hhckNvZGU7CiAgICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMCAmJiBrZXlDb2RlID09PSAxMykgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0ga2V5Q29kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMTApIHsKICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA+PSAzMiB8fCBjaGFyQ29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZSgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3ludGhldGljRXZlbnQoSW50ZXJmYWNlKSB7CiAgICAgICAgICBmdW5jdGlvbiBTeW50aGV0aWNCYXNlRXZlbnQocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMuX3JlYWN0TmFtZSA9IHJlYWN0TmFtZTsKICAgICAgICAgICAgdGhpcy5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHJlYWN0RXZlbnRUeXBlOwogICAgICAgICAgICB0aGlzLm5hdGl2ZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9wcm9wTmFtZSBpbiBJbnRlcmZhY2UpIHsKICAgICAgICAgICAgICBpZiAoIUludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShfcHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5hdGl2ZUV2ZW50W19wcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJldmVudGVkID0gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAhPSBudWxsID8gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCA6IG5hdGl2ZUV2ZW50LnJldHVyblZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgYXNzaWduKFN5bnRoZXRpY0Jhc2VFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogV2UgcmVsZWFzZSBhbGwgZGlzcGF0Y2hlZCBgU3ludGhldGljRXZlbnRgcyBhZnRlciBlYWNoIGV2ZW50IGxvb3AsIGFkZGluZwogICAgICAgICAgICAgKiB0aGVtIGJhY2sgaW50byB0aGUgcG9vbC4gVGhpcyBhbGxvd3MgYSB3YXkgdG8gaG9sZCBvbnRvIGEgcmVmZXJlbmNlIHRoYXQKICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGVyc2lzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgaWYgdGhpcyBldmVudCBzaG91bGQgYmUgcmVsZWFzZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgc2hvdWxkIG5vdCBiZSByZWxlYXNlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gU3ludGhldGljQmFzZUV2ZW50OwogICAgICAgIH0KICAgICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgICBldmVudFBoYXNlOiAwLAogICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgIGNhbmNlbGFibGU6IDAsCiAgICAgICAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiAwLAogICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgU3ludGhldGljRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgc2NyZWVuWDogMCwKICAgICAgICAgIHNjcmVlblk6IDAsCiAgICAgICAgICBjbGllbnRYOiAwLAogICAgICAgICAgY2xpZW50WTogMCwKICAgICAgICAgIHBhZ2VYOiAwLAogICAgICAgICAgcGFnZVk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgYnV0dG9uOiAwLAogICAgICAgICAgYnV0dG9uczogMCwKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5yZWxhdGVkVGFyZ2V0ID09PSB2b2lkIDApIHJldHVybiBldmVudC5mcm9tRWxlbWVudCA9PT0gZXZlbnQuc3JjRWxlbWVudCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRYIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRZIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY01vdXNlRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChNb3VzZUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRHJhZ0V2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhVHJhbnNmZXI6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRHJhZ0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRHJhZ0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRm9jdXNFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgYW5pbWF0aW9uTmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNBbmltYXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBjbGlwYm9hcmREYXRhOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImNsaXBib2FyZERhdGEiIGluIGV2ZW50ID8gZXZlbnQuY2xpcGJvYXJkRGF0YSA6IHdpbmRvdy5jbGlwYm9hcmREYXRhOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDbGlwYm9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENsaXBib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGtleTogZ2V0RXZlbnRLZXksCiAgICAgICAgICBjb2RlOiAwLAogICAgICAgICAgbG9jYXRpb246IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgcmVwZWF0OiAwLAogICAgICAgICAgbG9jYWxlOiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgLy8gTGVnYWN5IEludGVyZmFjZQogICAgICAgICAgY2hhckNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIGtleUNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIHdoaWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljS2V5Ym9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEtleWJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBQb2ludGVyRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHBvaW50ZXJJZDogMCwKICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgcHJlc3N1cmU6IDAsCiAgICAgICAgICB0YW5nZW50aWFsUHJlc3N1cmU6IDAsCiAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgIHRpbHRZOiAwLAogICAgICAgICAgdHdpc3Q6IDAsCiAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgIGlzUHJpbWFyeTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUb3VjaEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHByb3BlcnR5TmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBXaGVlbEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkZWx0YVg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFYIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWCA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWCIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVggOiAwCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWSIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVkgOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVkgOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YWAgZm9yIElFPDkgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFaOiAwLAogICAgICAgICAgLy8gQnJvd3NlcnMgd2l0aG91dCAiZGVsdGFNb2RlIiBpcyByZXBvcnRpbmcgaW4gcmF3IHdoZWVsIGRlbHRhIHdoZXJlIG9uZQogICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgIC8vIEEgZ29vZCBhcHByb3hpbWF0aW9uIG9mIERPTV9ERUxUQV9MSU5FICgxKSBpcyA1JSBvZiB2aWV3cG9ydCBzaXplIG9yCiAgICAgICAgICAvLyB+NDAgcGl4ZWxzLCBmb3IgRE9NX0RFTFRBX1NDUkVFTiAoMikgaXQgaXMgODcuNSUgb2Ygdmlld3BvcnQgc2l6ZS4KICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNXaGVlbEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoV2hlZWxFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICB2YXIgU1RBUlRfS0VZQ09ERSA9IDIyOTsKICAgICAgICB2YXIgY2FuVXNlQ29tcG9zaXRpb25FdmVudCA9IGNhblVzZURPTSAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNhblVzZVRleHRJbnB1dEV2ZW50ID0gY2FuVXNlRE9NICYmICJUZXh0RXZlbnQiIGluIHdpbmRvdyAmJiAhZG9jdW1lbnRNb2RlOwogICAgICAgIHZhciB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSA9IGNhblVzZURPTSAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnROYW1lID0gIm9uIiArIGV2ZW50TmFtZVN1ZmZpeDsKICAgICAgICAgIHZhciBpc1N1cHBvcnRlZCA9IGV2ZW50TmFtZSBpbiBkb2N1bWVudDsKICAgICAgICAgIGlmICghaXNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnROYW1lLCAicmV0dXJuOyIpOwogICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHR5cGVvZiBlbGVtZW50W2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNTdXBwb3J0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDEoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ2hhbmdlIiwgWyJjaGFuZ2UiLCAiY2xpY2siLCAiZm9jdXNpbiIsICJmb2N1c291dCIsICJpbnB1dCIsICJrZXlkb3duIiwgImtleXVwIiwgInNlbGVjdGlvbmNoYW5nZSJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpIHsKICAgICAgICAgIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoaW5zdCwgIm9uQ2hhbmdlIik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvbkNoYW5nZSIsICJjaGFuZ2UiLCBudWxsLCBuYXRpdmVFdmVudCwgdGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFVzZUNoYW5nZUV2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAic2VsZWN0IiB8fCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJmaWxlIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBhY3RpdmVFbGVtZW50SW5zdCwgbmF0aXZlRXZlbnQsIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSk7CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhydW5FdmVudEluQmF0Y2gsIGRpc3BhdGNoUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBydW5FdmVudEluQmF0Y2goZGlzcGF0Y2hRdWV1ZSkgewogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgMCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCk7CiAgICAgICAgICBpZiAodXBkYXRlVmFsdWVJZkNoYW5nZWQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKGNhblVzZURPTSkgewogICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuZGV0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5wcm9wZXJ0eU5hbWUgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCkpIHsKICAgICAgICAgICAgbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICAgIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpOwogICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJzZWxlY3Rpb25jaGFuZ2UiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleXVwIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJpbnB1dCIgfHwgZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKG5vZGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmNvbnRyb2xsZWQgfHwgbm9kZS50eXBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCAibnVtYmVyIiwgbm9kZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgdmFyIGdldFRhcmdldEluc3RGdW5jLCBoYW5kbGVFdmVudEZ1bmM7CiAgICAgICAgICBpZiAoc2hvdWxkVXNlQ2hhbmdlRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBpZiAoaXNJbnB1dEV2ZW50U3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkVXNlQ2xpY2tFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldFRhcmdldEluc3RGdW5jKSB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0Tm9kZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIodGFyZ2V0Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDIoKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlRW50ZXIiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyRW50ZXIiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJMZWF2ZSIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBpc092ZXJFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3ZlciIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiOwogICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICBpZiAoaXNPdmVyRXZlbnQgJiYgIWlzUmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocmVsYXRlZCkgfHwgaXNDb250YWluZXJNYXJrZWRBc1Jvb3QocmVsYXRlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudFRhcmdldC53aW5kb3cgPT09IG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHdpbiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRvYyA9IG5hdGl2ZUV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aW4gPSB3aW5kb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tOwogICAgICAgICAgdmFyIHRvOwogICAgICAgICAgaWYgKGlzT3V0RXZlbnQpIHsKICAgICAgICAgICAgdmFyIF9yZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC50b0VsZW1lbnQ7CiAgICAgICAgICAgIGZyb20gPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0byA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0byk7CiAgICAgICAgICAgICAgaWYgKHRvICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0by50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgdG8udGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdG8gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbSA9IG51bGw7CiAgICAgICAgICAgIHRvID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcm9tID09PSB0bykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgIHZhciBsZWF2ZUV2ZW50VHlwZSA9ICJvbk1vdXNlTGVhdmUiOwogICAgICAgICAgdmFyIGVudGVyRXZlbnRUeXBlID0gIm9uTW91c2VFbnRlciI7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlUHJlZml4ID0gIm1vdXNlIjsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciIpIHsKICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICBsZWF2ZUV2ZW50VHlwZSA9ICJvblBvaW50ZXJMZWF2ZSI7CiAgICAgICAgICAgIGVudGVyRXZlbnRUeXBlID0gIm9uUG9pbnRlckVudGVyIjsKICAgICAgICAgICAgZXZlbnRUeXBlUHJlZml4ID0gInBvaW50ZXIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb21Ob2RlID0gZnJvbSA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZShmcm9tKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0byA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZSh0byk7CiAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bywgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZW50ZXJFdmVudC50YXJnZXQgPSB0b05vZGU7CiAgICAgICAgICAgIGVudGVyRXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgICBlbnRlciA9IGVudGVyRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlLCBlbnRlciwgZnJvbSwgdG8pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpcyh4LCB5KSB7CiAgICAgICAgICByZXR1cm4geCA9PT0geSAmJiAoeCAhPT0gMCB8fCAxIC8geCA9PT0gMSAvIHkpIHx8IHggIT09IHggJiYgeSAhPT0geTsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzOwogICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgICAgICAgICBpZiAob2JqZWN0SXMob2JqQSwgb2JqQikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50S2V5ID0ga2V5c0FbaV07CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBjdXJyZW50S2V5KSB8fCAhb2JqZWN0SXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5XSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTaWJsaW5nTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQocm9vdDMsIG9mZnNldCkgewogICAgICAgICAgdmFyIG5vZGUgPSBnZXRMZWFmTm9kZShyb290Myk7CiAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBub2RlRW5kID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBub2RlRW5kID0gbm9kZVN0YXJ0ICsgbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKG5vZGVTdGFydCA8PSBvZmZzZXQgJiYgbm9kZUVuZCA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0IC0gbm9kZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlU3RhcnQgPSBub2RlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBnZXRMZWFmTm9kZShnZXRTaWJsaW5nTm9kZShub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE9mZnNldHMob3V0ZXJOb2RlKSB7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IG91dGVyTm9kZS5vd25lckRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsZWN0aW9uLmFuY2hvck5vZGUsIGFuY2hvck9mZnNldCA9IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbi5mb2N1c05vZGUsIGZvY3VzT2Zmc2V0ID0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgZm9jdXNOb2RlLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBzdGFydCA9IC0xOwogICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluQW5jaG9yID0gMDsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkZvY3VzID0gMDsKICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgb3V0ZXI6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoICsgYW5jaG9yT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZm9jdXNOb2RlICYmIChmb2N1c09mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGggKyBmb2N1c09mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgICAgbGVuZ3RoICs9IG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5maXJzdENoaWxkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG91dGVyTm9kZSkgewogICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBhbmNob3JOb2RlICYmICsraW5kZXhXaXRoaW5BbmNob3IgPT09IGFuY2hvck9mZnNldCkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xIHx8IGVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRPZmZzZXRzKG5vZGUsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gZG9jICYmIGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAoIXdpbi5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKG9mZnNldHMuc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0IDogTWF0aC5taW4ob2Zmc2V0cy5lbmQsIGxlbmd0aCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5leHRlbmQgJiYgc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgdmFyIHRlbXAgPSBlbmQ7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgICBzdGFydCA9IHRlbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIHN0YXJ0KTsKICAgICAgICAgIHZhciBlbmRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIGVuZCk7CiAgICAgICAgICBpZiAoc3RhcnRNYXJrZXIgJiYgZW5kTWFya2VyKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMSAmJiBzZWxlY3Rpb24uYW5jaG9yTm9kZSA9PT0gc3RhcnRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSA9PT0gZW5kTWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzT2Zmc2V0ID09PSBlbmRNYXJrZXIub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZS5zZXRTdGFydChzdGFydE1hcmtlci5ub2RlLCBzdGFydE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkgewogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmV4dGVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUpIHsKICAgICAgICAgIGlmICghb3V0ZXJOb2RlIHx8ICFpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUgPT09IGlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShvdXRlck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShpbm5lck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCJjb250YWlucyIgaW4gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBvdXRlck5vZGUuY29udGFpbnMoaW5uZXJOb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAhIShvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24oaW5uZXJOb2RlKSAmIDE2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbkRvY3VtZW50KG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUub3duZXJEb2N1bWVudCAmJiBjb250YWluc05vZGUobm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgbm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbkZyYW1lKGlmcmFtZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZnJhbWUuY29udGVudFdpbmRvdy5sb2NhdGlvbi5ocmVmID09PSAic3RyaW5nIjsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnREZWVwKCkgewogICAgICAgICAgdmFyIHdpbiA9IHdpbmRvdzsKICAgICAgICAgIHZhciBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCgpOwogICAgICAgICAgd2hpbGUgKGVsZW1lbnQgaW5zdGFuY2VvZiB3aW4uSFRNTElGcmFtZUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGlzU2FtZU9yaWdpbkZyYW1lKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgd2luID0gZWxlbWVudC5jb250ZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KHdpbi5kb2N1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJ0ZXh0IiB8fCBlbGVtLnR5cGUgPT09ICJzZWFyY2giIHx8IGVsZW0udHlwZSA9PT0gInRlbCIgfHwgZWxlbS50eXBlID09PSAidXJsIiB8fCBlbGVtLnR5cGUgPT09ICJwYXNzd29yZCIpIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiIHx8IGVsZW0uY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBmb2N1c2VkRWxlbSwKICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2U6IGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhmb2N1c2VkRWxlbSkgPyBnZXRTZWxlY3Rpb24oZm9jdXNlZEVsZW0pIDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVNlbGVjdGlvbihwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uKSB7CiAgICAgICAgICB2YXIgY3VyRm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgdmFyIHByaW9yRm9jdXNlZEVsZW0gPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLmZvY3VzZWRFbGVtOwogICAgICAgICAgdmFyIHByaW9yU2VsZWN0aW9uUmFuZ2UgPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLnNlbGVjdGlvblJhbmdlOwogICAgICAgICAgaWYgKGN1ckZvY3VzZWRFbGVtICE9PSBwcmlvckZvY3VzZWRFbGVtICYmIGlzSW5Eb2N1bWVudChwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICBpZiAocHJpb3JTZWxlY3Rpb25SYW5nZSAhPT0gbnVsbCAmJiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgICBzZXRTZWxlY3Rpb24ocHJpb3JGb2N1c2VkRWxlbSwgcHJpb3JTZWxlY3Rpb25SYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdOwogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSBwcmlvckZvY3VzZWRFbGVtOwogICAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgZWxlbWVudDogYW5jZXN0b3IsCiAgICAgICAgICAgICAgICAgIGxlZnQ6IGFuY2VzdG9yLnNjcm9sbExlZnQsCiAgICAgICAgICAgICAgICAgIHRvcDogYW5jZXN0b3Iuc2Nyb2xsVG9wCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmlvckZvY3VzZWRFbGVtLmZvY3VzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW5jZXN0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSBhbmNlc3RvcnNbaV07CiAgICAgICAgICAgICAgaW5mby5lbGVtZW50LnNjcm9sbExlZnQgPSBpbmZvLmxlZnQ7CiAgICAgICAgICAgICAgaW5mby5lbGVtZW50LnNjcm9sbFRvcCA9IGluZm8udG9wOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbihpbnB1dCkgewogICAgICAgICAgdmFyIHNlbGVjdGlvbjsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIGlucHV0KSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IHsKICAgICAgICAgICAgICBzdGFydDogaW5wdXQuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBpbnB1dC5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGVjdGlvbiA9IGdldE9mZnNldHMoaW5wdXQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNlbGVjdGlvbiB8fCB7CiAgICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgICBlbmQ6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNlbGVjdGlvbihpbnB1dCwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIHN0YXJ0ID0gb2Zmc2V0cy5zdGFydDsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZDsKICAgICAgICAgIGlmIChlbmQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIGlucHV0KSB7CiAgICAgICAgICAgIGlucHV0LnNlbGVjdGlvblN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgICAgIGlucHV0LnNlbGVjdGlvbkVuZCA9IE1hdGgubWluKGVuZCwgaW5wdXQudmFsdWUubGVuZ3RoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldE9mZnNldHMoaW5wdXQsIG9mZnNldHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50ID0gY2FuVXNlRE9NICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZSA8PSAxMTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQzKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvblNlbGVjdCIsIFsiZm9jdXNvdXQiLCAiY29udGV4dG1lbnUiLCAiZHJhZ2VuZCIsICJmb2N1c2luIiwgImtleWRvd24iLCAia2V5dXAiLCAibW91c2Vkb3duIiwgIm1vdXNldXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgIHZhciBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24kMShub2RlKSB7CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBub2RlICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhub2RlKSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHN0YXJ0OiBub2RlLnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogbm9kZS5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB3aW4gPSBub2RlLm93bmVyRG9jdW1lbnQgJiYgbm9kZS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBhbmNob3JOb2RlOiBzZWxlY3Rpb24uYW5jaG9yTm9kZSwKICAgICAgICAgICAgICBhbmNob3JPZmZzZXQ6IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsCiAgICAgICAgICAgICAgZm9jdXNOb2RlOiBzZWxlY3Rpb24uZm9jdXNOb2RlLAogICAgICAgICAgICAgIGZvY3VzT2Zmc2V0OiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUYXJnZXREb2N1bWVudChldmVudFRhcmdldCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gZXZlbnRUYXJnZXQgPyBldmVudFRhcmdldC5kb2N1bWVudCA6IGV2ZW50VGFyZ2V0Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gZXZlbnRUYXJnZXQgOiBldmVudFRhcmdldC5vd25lckRvY3VtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBkb2MgPSBnZXRFdmVudFRhcmdldERvY3VtZW50KG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmIChtb3VzZURvd24gfHwgYWN0aXZlRWxlbWVudCQxID09IG51bGwgfHwgYWN0aXZlRWxlbWVudCQxICE9PSBnZXRBY3RpdmVFbGVtZW50KGRvYykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBnZXRTZWxlY3Rpb24kMShhY3RpdmVFbGVtZW50JDEpOwogICAgICAgICAgaWYgKCFsYXN0U2VsZWN0aW9uIHx8ICFzaGFsbG93RXF1YWwobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoYWN0aXZlRWxlbWVudEluc3QkMSwgIm9uU2VsZWN0Iik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25TZWxlY3QiLCAic2VsZWN0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpIHx8IHRhcmdldE5vZGUuY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBpZiAoc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFrZVByZWZpeE1hcChzdHlsZVByb3AsIGV2ZW50TmFtZSkgewogICAgICAgICAgdmFyIHByZWZpeGVzMiA9IHt9OwogICAgICAgICAgcHJlZml4ZXMyW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcHJlZml4ZXMyWyJXZWJraXQiICsgc3R5bGVQcm9wXSA9ICJ3ZWJraXQiICsgZXZlbnROYW1lOwogICAgICAgICAgcHJlZml4ZXMyWyJNb3oiICsgc3R5bGVQcm9wXSA9ICJtb3oiICsgZXZlbnROYW1lOwogICAgICAgICAgcmV0dXJuIHByZWZpeGVzMjsKICAgICAgICB9CiAgICAgICAgdmFyIHZlbmRvclByZWZpeGVzID0gewogICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICBhbmltYXRpb25pdGVyYXRpb246IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25JdGVyYXRpb24iKSwKICAgICAgICAgIGFuaW1hdGlvbnN0YXJ0OiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uU3RhcnQiKSwKICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgfTsKICAgICAgICB2YXIgcHJlZml4ZWRFdmVudE5hbWVzID0ge307CiAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgaWYgKGNhblVzZURPTSkgewogICAgICAgICAgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKS5zdHlsZTsKICAgICAgICAgIGlmICghKCJBbmltYXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uZW5kLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbml0ZXJhdGlvbi5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25zdGFydC5hbmltYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoISgiVHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy50cmFuc2l0aW9uZW5kLnRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKGV2ZW50TmFtZSkgewogICAgICAgICAgaWYgKHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmVmaXhNYXAgPSB2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdOwogICAgICAgICAgZm9yICh2YXIgc3R5bGVQcm9wIGluIHByZWZpeE1hcCkgewogICAgICAgICAgICBpZiAocHJlZml4TWFwLmhhc093blByb3BlcnR5KHN0eWxlUHJvcCkgJiYgc3R5bGVQcm9wIGluIHN0eWxlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdID0gcHJlZml4TWFwW3N0eWxlUHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgfQogICAgICAgIHZhciBBTklNQVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbmVuZCIpOwogICAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbml0ZXJhdGlvbiIpOwogICAgICAgIHZhciBBTklNQVRJT05fU1RBUlQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uc3RhcnQiKTsKICAgICAgICB2YXIgVFJBTlNJVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgidHJhbnNpdGlvbmVuZCIpOwogICAgICAgIHZhciB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzID0gWyJhYm9ydCIsICJhdXhDbGljayIsICJjYW5jZWwiLCAiY2FuUGxheSIsICJjYW5QbGF5VGhyb3VnaCIsICJjbGljayIsICJjbG9zZSIsICJjb250ZXh0TWVudSIsICJjb3B5IiwgImN1dCIsICJkcmFnIiwgImRyYWdFbmQiLCAiZHJhZ0VudGVyIiwgImRyYWdFeGl0IiwgImRyYWdMZWF2ZSIsICJkcmFnT3ZlciIsICJkcmFnU3RhcnQiLCAiZHJvcCIsICJkdXJhdGlvbkNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJnb3RQb2ludGVyQ2FwdHVyZSIsICJpbnB1dCIsICJpbnZhbGlkIiwgImtleURvd24iLCAia2V5UHJlc3MiLCAia2V5VXAiLCAibG9hZCIsICJsb2FkZWREYXRhIiwgImxvYWRlZE1ldGFkYXRhIiwgImxvYWRTdGFydCIsICJsb3N0UG9pbnRlckNhcHR1cmUiLCAibW91c2VEb3duIiwgIm1vdXNlTW92ZSIsICJtb3VzZU91dCIsICJtb3VzZU92ZXIiLCAibW91c2VVcCIsICJwYXN0ZSIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicG9pbnRlckNhbmNlbCIsICJwb2ludGVyRG93biIsICJwb2ludGVyTW92ZSIsICJwb2ludGVyT3V0IiwgInBvaW50ZXJPdmVyIiwgInBvaW50ZXJVcCIsICJwcm9ncmVzcyIsICJyYXRlQ2hhbmdlIiwgInJlc2V0IiwgInJlc2l6ZSIsICJzZWVrZWQiLCAic2Vla2luZyIsICJzdGFsbGVkIiwgInN1Ym1pdCIsICJzdXNwZW5kIiwgInRpbWVVcGRhdGUiLCAidG91Y2hDYW5jZWwiLCAidG91Y2hFbmQiLCAidG91Y2hTdGFydCIsICJ2b2x1bWVDaGFuZ2UiLCAic2Nyb2xsIiwgInRvZ2dsZSIsICJ0b3VjaE1vdmUiLCAid2FpdGluZyIsICJ3aGVlbCJdOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzLnNldChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQocmVhY3ROYW1lLCBbZG9tRXZlbnROYW1lXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZXZlbnROYW1lID0gc2ltcGxlRXZlbnRQbHVnaW5FdmVudHNbaV07CiAgICAgICAgICAgIHZhciBkb21FdmVudE5hbWUgPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGNhcGl0YWxpemVkRXZlbnQgPSBldmVudE5hbWVbMF0udG9VcHBlckNhc2UoKSArIGV2ZW50TmFtZS5zbGljZSgxKTsKICAgICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsICJvbiIgKyBjYXBpdGFsaXplZEV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0VORCwgIm9uQW5pbWF0aW9uRW5kIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9JVEVSQVRJT04sICJvbkFuaW1hdGlvbkl0ZXJhdGlvbiIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fU1RBUlQsICJvbkFuaW1hdGlvblN0YXJ0Iik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJkYmxjbGljayIsICJvbkRvdWJsZUNsaWNrIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c2luIiwgIm9uRm9jdXMiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3Vzb3V0IiwgIm9uQmx1ciIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChUUkFOU0lUSU9OX0VORCwgIm9uVHJhbnNpdGlvbkVuZCIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHJlYWN0TmFtZSA9IHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzLmdldChkb21FdmVudE5hbWUpOwogICAgICAgICAgaWYgKHJlYWN0TmFtZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNFdmVudDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50VHlwZSA9IGRvbUV2ZW50TmFtZTsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljS2V5Ym9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiZm9jdXMiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJibHVyIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmJ1dHRvbiA9PT0gMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNNb3VzZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ292ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNEcmFnRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUb3VjaEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9FTkQ6CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0lURVJBVElPTjoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fU1RBUlQ6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQW5pbWF0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVFJBTlNJVElPTl9FTkQ6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVHJhbnNpdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1VJRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNXaGVlbEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNQb2ludGVyRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWNjdW11bGF0ZVRhcmdldE9ubHkgPSAhaW5DYXB0dXJlUGhhc2UgJiYgLy8gVE9ETzogaWRlYWxseSwgd2UnZCBldmVudHVhbGx5IGFkZCBhbGwgZXZlbnRzIGZyb20KICAgICAgICAgICAgLy8gbm9uRGVsZWdhdGVkRXZlbnRzIGxpc3QgaW4gRE9NUGx1Z2luRXZlbnRTeXN0ZW0uCiAgICAgICAgICAgIC8vIFRoZW4gd2UgY2FuIHJlbW92ZSB0aGlzIHNwZWNpYWwgbGlzdC4KICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGJyZWFraW5nIGNoYW5nZSB0aGF0IGNhbiB3YWl0IHVudGlsIFJlYWN0IDE4LgogICAgICAgICAgICBkb21FdmVudE5hbWUgPT09ICJzY3JvbGwiOwogICAgICAgICAgICB2YXIgX2xpc3RlbmVycyA9IGFjY3VtdWxhdGVTaW5nbGVQaGFzZUxpc3RlbmVycyh0YXJnZXRJbnN0LCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50LnR5cGUsIGluQ2FwdHVyZVBoYXNlLCBhY2N1bXVsYXRlVGFyZ2V0T25seSk7CiAgICAgICAgICAgIGlmIChfbGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgX2V2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50Q3RvcihyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudDogX2V2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzOiBfbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudHMoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQyKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMSgpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDMoKTsKICAgICAgICByZWdpc3RlckV2ZW50cygpOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TKSA9PT0gMDsKICAgICAgICAgIGlmIChzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zKSB7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMihkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMkMyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgbWVkaWFFdmVudFR5cGVzID0gWyJhYm9ydCIsICJjYW5wbGF5IiwgImNhbnBsYXl0aHJvdWdoIiwgImR1cmF0aW9uY2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImxvYWRlZGRhdGEiLCAibG9hZGVkbWV0YWRhdGEiLCAibG9hZHN0YXJ0IiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwcm9ncmVzcyIsICJyYXRlY2hhbmdlIiwgInJlc2l6ZSIsICJzZWVrZWQiLCAic2Vla2luZyIsICJzdGFsbGVkIiwgInN1c3BlbmQiLCAidGltZXVwZGF0ZSIsICJ2b2x1bWVjaGFuZ2UiLCAid2FpdGluZyJdOwogICAgICAgIHZhciBub25EZWxlZ2F0ZWRFdmVudHMgPSBuZXcgU2V0KFsiY2FuY2VsIiwgImNsb3NlIiwgImludmFsaWQiLCAibG9hZCIsICJzY3JvbGwiLCAidG9nZ2xlIl0uY29uY2F0KG1lZGlhRXZlbnRUeXBlcykpOwogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgbGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0eXBlID0gZXZlbnQudHlwZSB8fCAidW5rbm93bi1ldmVudCI7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gY3VycmVudFRhcmdldDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcih0eXBlLCBsaXN0ZW5lciwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2U7CiAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRpID0gZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGluc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuaW5zdGFuY2UsIGN1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5jdXJyZW50VGFyZ2V0LCBsaXN0ZW5lciA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmxpc3RlbmVyOwogICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgbGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kgPSBkaXNwYXRjaExpc3RlbmVyc1tfaV0sIF9pbnN0YW5jZSA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5pbnN0YW5jZSwgX2N1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kuY3VycmVudFRhcmdldCwgX2xpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmxpc3RlbmVyOwogICAgICAgICAgICAgIGlmIChfaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIF9saXN0ZW5lciwgX2N1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBfaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlzcGF0Y2hRdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX2Rpc3BhdGNoUXVldWUkaSA9IGRpc3BhdGNoUXVldWVbaV0sIGV2ZW50ID0gX2Rpc3BhdGNoUXVldWUkaS5ldmVudCwgbGlzdGVuZXJzID0gX2Rpc3BhdGNoUXVldWUkaS5saXN0ZW5lcnM7CiAgICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlSXRlbXNJbk9yZGVyKGV2ZW50LCBsaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldGhyb3dDYXVnaHRFcnJvcigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0RWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoKSBjYWxsIGZvciAiJXMiLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0ID0gZ2V0RXZlbnRMaXN0ZW5lclNldCh0YXJnZXRFbGVtZW50KTsKICAgICAgICAgIHZhciBsaXN0ZW5lclNldEtleSA9IGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgICBpZiAoIWxpc3RlbmVyU2V0LmhhcyhsaXN0ZW5lclNldEtleSkpIHsKICAgICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0RWxlbWVudCwgZG9tRXZlbnROYW1lLCBJU19OT05fREVMRUdBVEVELCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgICAgbGlzdGVuZXJTZXQuYWRkKGxpc3RlbmVyU2V0S2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIHRhcmdldCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpICYmICFpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9OYXRpdmVFdmVudCgpIGNhbGwgZm9yICIlcyIgaW4gdGhlIGJ1YmJsZSBwaGFzZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuJywgZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50U3lzdGVtRmxhZ3MgPSAwOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncyB8PSBJU19DQVBUVVJFX1BIQVNFOwogICAgICAgICAgfQogICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0LCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgbGlzdGVuaW5nTWFya2VyID0gIl9yZWFjdExpc3RlbmluZyIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgaWYgKCFyb290Q29udGFpbmVyRWxlbWVudFtsaXN0ZW5pbmdNYXJrZXJdKSB7CiAgICAgICAgICAgIHJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0gPSB0cnVlOwogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuZm9yRWFjaChmdW5jdGlvbihkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lICE9PSAic2VsZWN0aW9uY2hhbmdlIikgewogICAgICAgICAgICAgICAgaWYgKCFub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGZhbHNlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgdHJ1ZSwgcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKCFvd25lckRvY3VtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgICAgIG93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCBmYWxzZSwgb3duZXJEb2N1bWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFRyYXBwZWRFdmVudExpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyLCBpc0RlZmVycmVkTGlzdGVuZXJGb3JMZWdhY3lGQlN1cHBvcnQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5lciA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBpc1Bhc3NpdmVMaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgIGlmIChwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICBpc1Bhc3NpdmVMaXN0ZW5lciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1bnN1YnNjcmliZUxpc3RlbmVyOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1Bhc3NpdmVMaXN0ZW5lciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01hdGNoaW5nUm9vdENvbnRhaW5lcihncmFuZENvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICByZXR1cm4gZ3JhbmRDb250YWluZXIgPT09IHRhcmdldENvbnRhaW5lciB8fCBncmFuZENvbnRhaW5lci5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFICYmIGdyYW5kQ29udGFpbmVyLnBhcmVudE5vZGUgPT09IHRhcmdldENvbnRhaW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHRhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGFuY2VzdG9ySW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICBpZiAoKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSkgPT09IDAgJiYgKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19OT05fREVMRUdBVEVEKSA9PT0gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyTm9kZSA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgbWFpbkxvb3A6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbm9kZVRhZyA9IG5vZGUudGFnOwogICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RSb290IHx8IG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoY29udGFpbmVyMiwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBncmFuZE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZ3JhbmROb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmRUYWcgPSBncmFuZE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGdyYW5kVGFnID09PSBIb3N0Um9vdCB8fCBncmFuZFRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmRDb250YWluZXIgPSBncmFuZE5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihncmFuZENvbnRhaW5lciwgdGFyZ2V0Q29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGdyYW5kTm9kZSA9IGdyYW5kTm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHdoaWxlIChjb250YWluZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShjb250YWluZXIyKTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50Tm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBwYXJlbnRUYWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICBub2RlID0gYW5jZXN0b3JJbnN0ID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIG1haW5Mb29wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb250YWluZXIyID0gY29udGFpbmVyMi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBhbmNlc3Rvckluc3QpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgbGlzdGVuZXIsCiAgICAgICAgICAgIGN1cnJlbnRUYXJnZXQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVTaW5nbGVQaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudFR5cGUsIGluQ2FwdHVyZVBoYXNlLCBhY2N1bXVsYXRlVGFyZ2V0T25seSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSAhPT0gbnVsbCA/IHJlYWN0TmFtZSArICJDYXB0dXJlIiA6IG51bGw7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudE5hbWUgPSBpbkNhcHR1cmVQaGFzZSA/IGNhcHR1cmVOYW1lIDogcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0RmliZXI7CiAgICAgICAgICB2YXIgbGFzdEhvc3RDb21wb25lbnQgPSBudWxsOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTIuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0SG9zdENvbXBvbmVudCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocmVhY3RFdmVudE5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdEV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lciwgbGFzdEhvc3RDb21wb25lbnQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFjY3VtdWxhdGVUYXJnZXRPbmx5KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICsgIkNhcHR1cmUiOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0RmliZXI7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMy5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTMudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50VGFyZ2V0ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZU5hbWUpOwogICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdE5hbWUpOwogICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBhcmVudChpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaW5zdCA9IGluc3QucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAoaW5zdCAmJiBpbnN0LnRhZyAhPT0gSG9zdENvbXBvbmVudCk7CiAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMb3dlc3RDb21tb25BbmNlc3RvcihpbnN0QSwgaW5zdEIpIHsKICAgICAgICAgIHZhciBub2RlQSA9IGluc3RBOwogICAgICAgICAgdmFyIG5vZGVCID0gaW5zdEI7CiAgICAgICAgICB2YXIgZGVwdGhBID0gMDsKICAgICAgICAgIGZvciAodmFyIHRlbXBBID0gbm9kZUE7IHRlbXBBOyB0ZW1wQSA9IGdldFBhcmVudCh0ZW1wQSkpIHsKICAgICAgICAgICAgZGVwdGhBKys7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGhCID0gMDsKICAgICAgICAgIGZvciAodmFyIHRlbXBCID0gbm9kZUI7IHRlbXBCOyB0ZW1wQiA9IGdldFBhcmVudCh0ZW1wQikpIHsKICAgICAgICAgICAgZGVwdGhCKys7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhBIC0gZGVwdGhCID4gMCkgewogICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgIGRlcHRoQS0tOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQiAtIGRlcHRoQSA+IDApIHsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgICBkZXB0aEItLTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aCA9IGRlcHRoQTsKICAgICAgICAgIHdoaWxlIChkZXB0aC0tKSB7CiAgICAgICAgICAgIGlmIChub2RlQSA9PT0gbm9kZUIgfHwgbm9kZUIgIT09IG51bGwgJiYgbm9kZUEgPT09IG5vZGVCLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlQTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlQSA9IGdldFBhcmVudChub2RlQSk7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGV2ZW50LCB0YXJnZXQsIGNvbW1vbiwgaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lID0gZXZlbnQuX3JlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gaW5zdGFuY2UsIGFsdGVybmF0ZSA9IF9pbnN0YW5jZTQuYWx0ZXJuYXRlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2U0LnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlNC50YWc7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50VGFyZ2V0ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZUV2ZW50LCBlbnRlckV2ZW50LCBmcm9tLCB0bykgewogICAgICAgICAgdmFyIGNvbW1vbiA9IGZyb20gJiYgdG8gPyBnZXRMb3dlc3RDb21tb25BbmNlc3Rvcihmcm9tLCB0bykgOiBudWxsOwogICAgICAgICAgaWYgKGZyb20gIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBsZWF2ZUV2ZW50LCBmcm9tLCBjb21tb24sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0byAhPT0gbnVsbCAmJiBlbnRlckV2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZW50ZXJFdmVudCwgdG8sIGNvbW1vbiwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgY2FwdHVyZSkgewogICAgICAgICAgcmV0dXJuIGRvbUV2ZW50TmFtZSArICJfXyIgKyAoY2FwdHVyZSA/ICJjYXB0dXJlIiA6ICJidWJibGUiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MID0gImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIjsKICAgICAgICB2YXIgU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HID0gInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyI7CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HID0gInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyI7CiAgICAgICAgdmFyIEFVVE9GT0NVUyA9ICJhdXRvRm9jdXMiOwogICAgICAgIHZhciBDSElMRFJFTiA9ICJjaGlsZHJlbiI7CiAgICAgICAgdmFyIFNUWUxFID0gInN0eWxlIjsKICAgICAgICB2YXIgSFRNTCQxID0gIl9faHRtbCI7CiAgICAgICAgdmFyIHdhcm5lZFVua25vd25UYWdzOwogICAgICAgIHZhciB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50OwogICAgICAgIHZhciB3YXJuRm9yUHJvcERpZmZlcmVuY2U7CiAgICAgICAgdmFyIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcjsKICAgICAgICB2YXIgY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZzsKICAgICAgICB2YXIgbm9ybWFsaXplSFRNTDsKICAgICAgICB7CiAgICAgICAgICB3YXJuZWRVbmtub3duVGFncyA9IHsKICAgICAgICAgICAgLy8gVGhlcmUgYXJlIHdvcmtpbmcgcG9seWZpbGxzIGZvciA8ZGlhbG9nPi4gTGV0IHBlb3BsZSB1c2UgaXQuCiAgICAgICAgICAgIGRpYWxvZzogdHJ1ZSwKICAgICAgICAgICAgLy8gRWxlY3Ryb24gc2hpcHMgYSBjdXN0b20gPHdlYnZpZXc+IHRhZyB0byBkaXNwbGF5IGV4dGVybmFsIHdlYiBjb250ZW50IGluCiAgICAgICAgICAgIC8vIGFuIGlzb2xhdGVkIGZyYW1lIGFuZCBwcm9jZXNzLgogICAgICAgICAgICAvLyBUaGlzIHRhZyBpcyBub3QgcHJlc2VudCBpbiBub24gRWxlY3Ryb24gZW52aXJvbm1lbnRzIHN1Y2ggYXMgSlNEb20gd2hpY2gKICAgICAgICAgICAgLy8gaXMgb2Z0ZW4gdXNlZCBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KICAgICAgICAgICAgLy8gQHNlZSBodHRwczovL2VsZWN0cm9uanMub3JnL2RvY3MvYXBpL3dlYnZpZXctdGFnCiAgICAgICAgICAgIHdlYnZpZXc6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50ID0gZnVuY3Rpb24odHlwZSwgcHJvcHMpIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgewogICAgICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsCiAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nID0gY2FuVXNlRE9NICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UgPSBmdW5jdGlvbihwcm9wTmFtZSwgc2VydmVyVmFsdWUsIGNsaWVudFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJWYWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVmFsdWUgPT09IG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyaWJ1dGVOYW1lcykgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgYXR0cmlidXRlTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yKCJFeHRyYSBhdHRyaWJ1dGVzIGZyb20gdGhlIHNlcnZlcjogJXMiLCBuYW1lcyk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ocmVnaXN0cmF0aW9uTmFtZSwgbGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGxpc3RlbmVyID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGBmYWxzZWAuXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4iLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgYCVzYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAlc2AgdHlwZS4iLCByZWdpc3RyYXRpb25OYW1lLCB0eXBlb2YgbGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgbm9ybWFsaXplSFRNTCA9IGZ1bmN0aW9uKHBhcmVudCwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgcmV0dXJuIHRlc3RFbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBOT1JNQUxJWkVfTkVXTElORVNfUkVHRVggPSAvXHJcbj8vZzsKICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUobWFya3VwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWFya3VwU3RyaW5nID0gdHlwZW9mIG1hcmt1cCA9PT0gInN0cmluZyIgPyBtYXJrdXAgOiAiIiArIG1hcmt1cDsKICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChzZXJ2ZXJUZXh0LCBjbGllbnRUZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVGV4dCk7CiAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclRleHQgPT09IG5vcm1hbGl6ZWRDbGllbnRUZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgJiYgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRleHQgY29udGVudCBkb2VzIG5vdCBtYXRjaCBzZXJ2ZXItcmVuZGVyZWQgSFRNTC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KG5vZGUpIHsKICAgICAgICAgIG5vZGUub25jbGljayA9IG5vb3A7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEluaXRpYWxET01Qcm9wZXJ0aWVzKHRhZywgZG9tRWxlbWVudCwgcm9vdENvbnRhaW5lckVsZW1lbnQsIG5leHRQcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gbmV4dFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIGNhblNldFRleHRDb250ZW50ID0gdGFnICE9PSAidGV4dGFyZWEiIHx8IG5leHRQcm9wICE9PSAiIjsKICAgICAgICAgICAgICAgIGlmIChjYW5TZXRUZXh0Q29udGVudCkgewogICAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cGRhdGVQYXlsb2FkLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIHZhciBwcm9wS2V5ID0gdXBkYXRlUGF5bG9hZFtpXTsKICAgICAgICAgICAgdmFyIHByb3BWYWx1ZSA9IHVwZGF0ZVBheWxvYWRbaSArIDFdOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgcHJvcFZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudDModHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50LCBwYXJlbnROYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHZhciBkb21FbGVtZW50OwogICAgICAgICAgdmFyIG5hbWVzcGFjZVVSSSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZVVSSSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIHR5cGUgIT09IHR5cGUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gInNjcmlwdCIpIHsKICAgICAgICAgICAgICB2YXIgZGl2ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gZGl2LnJlbW92ZUNoaWxkKGZpcnN0Q2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUsIHsKICAgICAgICAgICAgICAgIGlzOiBwcm9wcy5pcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAocHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLnNpemUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5zaXplID0gcHJvcHMuc2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUkksIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRvbUVsZW1lbnQpID09PSAiW29iamVjdCBIVE1MVW5rbm93bkVsZW1lbnRdIiAmJiAhaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRVbmtub3duVGFncywgdHlwZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgdGFnIDwlcz4gaXMgdW5yZWNvZ25pemVkIGluIHRoaXMgYnJvd3Nlci4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIFJlYWN0IGNvbXBvbmVudCwgc3RhcnQgaXRzIG5hbWUgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpOwogICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCBmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0UHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBsYXN0UmF3UHJvcHM7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbGFzdFByb3BzLm9uQ2xpY2sgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG5leHRQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgIHZhciBwcm9wS2V5OwogICAgICAgICAgdmFyIHN0eWxlTmFtZTsKICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgZm9yIChwcm9wS2V5IGluIGxhc3RQcm9wcykgewogICAgICAgICAgICBpZiAobmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8ICFsYXN0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbGFzdFByb3BzW3Byb3BLZXldID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RTdHlsZSkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RTdHlsZS5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIHZhciBsYXN0UHJvcCA9IGxhc3RQcm9wcyAhPSBudWxsID8gbGFzdFByb3BzW3Byb3BLZXldIDogdm9pZCAwOwogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBuZXh0UHJvcCA9PT0gbGFzdFByb3AgfHwgbmV4dFByb3AgPT0gbnVsbCAmJiBsYXN0UHJvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFByb3ApIHsKICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmICghbmV4dFByb3AgfHwgIW5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9IG5leHRQcm9wW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0gbmV4dFByb3A7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RIdG1sICE9PSBuZXh0SHRtbCkgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBsYXN0UHJvcCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0eWxlVXBkYXRlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFByb3BzW1NUWUxFXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcykgewogICAgICAgICAgaWYgKHRhZyA9PT0gImlucHV0IiAmJiBuZXh0UmF3UHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuZXh0UmF3UHJvcHMubmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RVcGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHByb3BOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICghcG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVyRWxlbWVudCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIGV4dHJhQXR0cmlidXRlTmFtZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBkb21FbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlc1tfaV0ubmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNoZWNrZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdGVkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmFkZChhdHRyaWJ1dGVzW19pXS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFyYXdQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IHJhd1Byb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSAiIiArIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgdHlwZW9mIGlzQ3VzdG9tQ29tcG9uZW50VGFnID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICB2YXIgc2VydmVyVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gPT09IHRydWUpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgfHwgLy8gQ29udHJvbGxlZCBhdHRyaWJ1dGVzIGFyZSBub3QgdmFsaWRhdGVkCiAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgcHJvcEtleSA9PT0gInZhbHVlIiB8fCBwcm9wS2V5ID09PSAiY2hlY2tlZCIgfHwgcHJvcEtleSA9PT0gInNlbGVjdGVkIikgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRIVE1MICE9PSBzZXJ2ZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlckhUTUwsIGV4cGVjdGVkSFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgIGlmIChjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFN0eWxlID0gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkU3R5bGUgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBleHBlY3RlZFN0eWxlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgJiYgIWVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkSWdub3JlQXR0cmlidXRlKHByb3BLZXksIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpICYmICFzaG91bGRSZW1vdmVBdHRyaWJ1dGUocHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBvd25OYW1lc3BhY2UgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodGFnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG51bGwgJiYgc3RhbmRhcmROYW1lICE9PSBwcm9wS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgIGlmICghZG9udFdhcm5DdXN0b21FbGVtZW50ICYmIG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSAmJiAhaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgLSBTaG91bGQgYmUgaW5mZXJyZWQgYXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuc2l6ZSA+IDAgJiYgcmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzKGV4dHJhQXR0cmlidXRlTmFtZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIHRydWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFRleHQodGV4dE5vZGUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBpc0RpZmZlcmVudCA9IHRleHROb2RlLm5vZGVWYWx1ZSAhPT0gdGV4dDsKICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIDwlcz4gaW4gPCVzPi4iLCBjaGlsZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIHRoZSB0ZXh0IG5vZGUgIiVzIiBpbiA8JXM+LicsIGNoaWxkLm5vZGVWYWx1ZSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyA8JXM+IGluIDwlcz4uIiwgdGFnLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0V4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyB0ZXh0IG5vZGUgZm9yICIlcyIgaW4gPCVzPi4nLCB0ZXh0LCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMoZG9tRWxlbWVudCwgdGFnLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHNwZWNpYWxUYWdzID0gWyJhZGRyZXNzIiwgImFwcGxldCIsICJhcmVhIiwgImFydGljbGUiLCAiYXNpZGUiLCAiYmFzZSIsICJiYXNlZm9udCIsICJiZ3NvdW5kIiwgImJsb2NrcXVvdGUiLCAiYm9keSIsICJiciIsICJidXR0b24iLCAiY2FwdGlvbiIsICJjZW50ZXIiLCAiY29sIiwgImNvbGdyb3VwIiwgImRkIiwgImRldGFpbHMiLCAiZGlyIiwgImRpdiIsICJkbCIsICJkdCIsICJlbWJlZCIsICJmaWVsZHNldCIsICJmaWdjYXB0aW9uIiwgImZpZ3VyZSIsICJmb290ZXIiLCAiZm9ybSIsICJmcmFtZSIsICJmcmFtZXNldCIsICJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiIsICJoZWFkIiwgImhlYWRlciIsICJoZ3JvdXAiLCAiaHIiLCAiaHRtbCIsICJpZnJhbWUiLCAiaW1nIiwgImlucHV0IiwgImlzaW5kZXgiLCAibGkiLCAibGluayIsICJsaXN0aW5nIiwgIm1haW4iLCAibWFycXVlZSIsICJtZW51IiwgIm1lbnVpdGVtIiwgIm1ldGEiLCAibmF2IiwgIm5vZW1iZWQiLCAibm9mcmFtZXMiLCAibm9zY3JpcHQiLCAib2JqZWN0IiwgIm9sIiwgInAiLCAicGFyYW0iLCAicGxhaW50ZXh0IiwgInByZSIsICJzY3JpcHQiLCAic2VjdGlvbiIsICJzZWxlY3QiLCAic291cmNlIiwgInN0eWxlIiwgInN1bW1hcnkiLCAidGFibGUiLCAidGJvZHkiLCAidGQiLCAidGVtcGxhdGUiLCAidGV4dGFyZWEiLCAidGZvb3QiLCAidGgiLCAidGhlYWQiLCAidGl0bGUiLCAidHIiLCAidHJhY2siLCAidWwiLCAid2JyIiwgInhtcCJdOwogICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAiYXBwbGV0IiwKICAgICAgICAgICAgImNhcHRpb24iLAogICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICJ0YWJsZSIsCiAgICAgICAgICAgICJ0ZCIsCiAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICJtYXJxdWVlIiwKICAgICAgICAgICAgIm9iamVjdCIsCiAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnQKICAgICAgICAgICAgLy8gVE9ETzogRGlzdGluZ3Vpc2ggYnkgbmFtZXNwYWNlIGhlcmUgLS0gZm9yIDx0aXRsZT4sIGluY2x1ZGluZyBpdCBoZXJlCiAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgImZvcmVpZ25PYmplY3QiLAogICAgICAgICAgICAiZGVzYyIsCiAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgIF07CiAgICAgICAgICB2YXIgYnV0dG9uU2NvcGVUYWdzID0gaW5TY29wZVRhZ3MuY29uY2F0KFsiYnV0dG9uIl0pOwogICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgdmFyIGVtcHR5QW5jZXN0b3JJbmZvID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICBhVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgYnV0dG9uVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIHBUYWdJbkJ1dHRvblNjb3BlOiBudWxsLAogICAgICAgICAgICBsaXN0SXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsLAogICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbihvbGRJbmZvLCB0YWcpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbih7fSwgb2xkSW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbmZvID0gewogICAgICAgICAgICAgIHRhZwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaW5TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJ1dHRvblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbFRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSAmJiB0YWcgIT09ICJhZGRyZXNzIiAmJiB0YWcgIT09ICJkaXYiICYmIHRhZyAhPT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmN1cnJlbnQgPSBpbmZvOwogICAgICAgICAgICBpZiAodGFnID09PSAiZm9ybSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZm9ybVRhZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImEiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYnV0dG9uIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAibm9iciIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImxpIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiZGQiIHx8IHRhZyA9PT0gImR0IikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mbzsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgaXNUYWdWYWxpZFdpdGhQYXJlbnQgPSBmdW5jdGlvbih0YWcsIHBhcmVudFRhZykgewogICAgICAgICAgICBzd2l0Y2ggKHBhcmVudFRhZykgewogICAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICJvcHRncm91cCIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJ0ciI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAidGgiIHx8IHRhZyA9PT0gInRkIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAidGJvZHkiOgogICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJ0Zm9vdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAidHIiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY29sIiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNhcHRpb24iIHx8IHRhZyA9PT0gImNvbGdyb3VwIiB8fCB0YWcgPT09ICJ0Ym9keSIgfHwgdGFnID09PSAidGZvb3QiIHx8IHRhZyA9PT0gInRoZWFkIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaGVhZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiYmFzZSIgfHwgdGFnID09PSAiYmFzZWZvbnQiIHx8IHRhZyA9PT0gImJnc291bmQiIHx8IHRhZyA9PT0gImxpbmsiIHx8IHRhZyA9PT0gIm1ldGEiIHx8IHRhZyA9PT0gInRpdGxlIiB8fCB0YWcgPT09ICJub3NjcmlwdCIgfHwgdGFnID09PSAibm9mcmFtZXMiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJoZWFkIiB8fCB0YWcgPT09ICJib2R5IiB8fCB0YWcgPT09ICJmcmFtZXNldCI7CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImZyYW1lIjsKICAgICAgICAgICAgICBjYXNlICIjZG9jdW1lbnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImh0bWwiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiaDEiOgogICAgICAgICAgICAgIGNhc2UgImgyIjoKICAgICAgICAgICAgICBjYXNlICJoMyI6CiAgICAgICAgICAgICAgY2FzZSAiaDQiOgogICAgICAgICAgICAgIGNhc2UgImg1IjoKICAgICAgICAgICAgICBjYXNlICJoNiI6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VGFnICE9PSAiaDEiICYmIHBhcmVudFRhZyAhPT0gImgyIiAmJiBwYXJlbnRUYWcgIT09ICJoMyIgJiYgcGFyZW50VGFnICE9PSAiaDQiICYmIHBhcmVudFRhZyAhPT0gImg1IiAmJiBwYXJlbnRUYWcgIT09ICJoNiI7CiAgICAgICAgICAgICAgY2FzZSAicnAiOgogICAgICAgICAgICAgIGNhc2UgInJ0IjoKICAgICAgICAgICAgICAgIHJldHVybiBpbXBsaWVkRW5kVGFncy5pbmRleE9mKHBhcmVudFRhZykgPT09IC0xOwogICAgICAgICAgICAgIGNhc2UgImJvZHkiOgogICAgICAgICAgICAgIGNhc2UgImNhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImNvbCI6CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZSI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgY2FzZSAidGJvZHkiOgogICAgICAgICAgICAgIGNhc2UgInRkIjoKICAgICAgICAgICAgICBjYXNlICJ0Zm9vdCI6CiAgICAgICAgICAgICAgY2FzZSAidGgiOgogICAgICAgICAgICAgIGNhc2UgInRoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJ0ciI6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VGFnID09IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcgPSBmdW5jdGlvbih0YWcsIGFuY2VzdG9ySW5mbykgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImFkZHJlc3MiOgogICAgICAgICAgICAgIGNhc2UgImFydGljbGUiOgogICAgICAgICAgICAgIGNhc2UgImFzaWRlIjoKICAgICAgICAgICAgICBjYXNlICJibG9ja3F1b3RlIjoKICAgICAgICAgICAgICBjYXNlICJjZW50ZXIiOgogICAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlyIjoKICAgICAgICAgICAgICBjYXNlICJkaXYiOgogICAgICAgICAgICAgIGNhc2UgImRsIjoKICAgICAgICAgICAgICBjYXNlICJmaWVsZHNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZmlnY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiZmlndXJlIjoKICAgICAgICAgICAgICBjYXNlICJmb290ZXIiOgogICAgICAgICAgICAgIGNhc2UgImhlYWRlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJtYWluIjoKICAgICAgICAgICAgICBjYXNlICJtZW51IjoKICAgICAgICAgICAgICBjYXNlICJuYXYiOgogICAgICAgICAgICAgIGNhc2UgIm9sIjoKICAgICAgICAgICAgICBjYXNlICJwIjoKICAgICAgICAgICAgICBjYXNlICJzZWN0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJzdW1tYXJ5IjoKICAgICAgICAgICAgICBjYXNlICJ1bCI6CiAgICAgICAgICAgICAgY2FzZSAicHJlIjoKICAgICAgICAgICAgICBjYXNlICJsaXN0aW5nIjoKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgY2FzZSAiaHIiOgogICAgICAgICAgICAgIGNhc2UgInhtcCI6CiAgICAgICAgICAgICAgY2FzZSAiaDEiOgogICAgICAgICAgICAgIGNhc2UgImgyIjoKICAgICAgICAgICAgICBjYXNlICJoMyI6CiAgICAgICAgICAgICAgY2FzZSAiaDQiOgogICAgICAgICAgICAgIGNhc2UgImg1IjoKICAgICAgICAgICAgICBjYXNlICJoNiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImZvcm0iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5mb3JtVGFnIHx8IGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJsaSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc7CiAgICAgICAgICAgICAgY2FzZSAiZGQiOgogICAgICAgICAgICAgIGNhc2UgImR0IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3Npbmc7CiAgICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJhIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibm9iciI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBkaWRXYXJuJDEgPSB7fTsKICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyA9IGZ1bmN0aW9uKGNoaWxkVGFnLCBjaGlsZFRleHQsIGFuY2VzdG9ySW5mbykgewogICAgICAgICAgICBhbmNlc3RvckluZm8gPSBhbmNlc3RvckluZm8gfHwgZW1wdHlBbmNlc3RvckluZm87CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmZvID0gYW5jZXN0b3JJbmZvLmN1cnJlbnQ7CiAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnRJbmZvICYmIHBhcmVudEluZm8udGFnOwogICAgICAgICAgICBpZiAoY2hpbGRUZXh0ICE9IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGRUYWcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZzogd2hlbiBjaGlsZFRleHQgaXMgcGFzc2VkLCBjaGlsZFRhZyBzaG91bGQgYmUgbnVsbCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZFRhZyA9ICIjdGV4dCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnQgPSBpc1RhZ1ZhbGlkV2l0aFBhcmVudChjaGlsZFRhZywgcGFyZW50VGFnKSA/IG51bGwgOiBwYXJlbnRJbmZvOwogICAgICAgICAgICB2YXIgaW52YWxpZEFuY2VzdG9yID0gaW52YWxpZFBhcmVudCA/IG51bGwgOiBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnKGNoaWxkVGFnLCBhbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudE9yQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50IHx8IGludmFsaWRBbmNlc3RvcjsKICAgICAgICAgICAgaWYgKCFpbnZhbGlkUGFyZW50T3JBbmNlc3RvcikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jZXN0b3JUYWcgPSBpbnZhbGlkUGFyZW50T3JBbmNlc3Rvci50YWc7CiAgICAgICAgICAgIHZhciB3YXJuS2V5ID0gISFpbnZhbGlkUGFyZW50ICsgInwiICsgY2hpbGRUYWcgKyAifCIgKyBhbmNlc3RvclRhZzsKICAgICAgICAgICAgaWYgKGRpZFdhcm4kMVt3YXJuS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuJDFbd2FybktleV0gPSB0cnVlOwogICAgICAgICAgICB2YXIgdGFnRGlzcGxheU5hbWUgPSBjaGlsZFRhZzsKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2VJbmZvID0gIiI7CiAgICAgICAgICAgIGlmIChjaGlsZFRhZyA9PT0gIiN0ZXh0IikgewogICAgICAgICAgICAgIGlmICgvXFMvLnRlc3QoY2hpbGRUZXh0KSkgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiVGV4dCBub2RlcyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIldoaXRlc3BhY2UgdGV4dCBub2RlcyI7CiAgICAgICAgICAgICAgICB3aGl0ZXNwYWNlSW5mbyA9ICIgTWFrZSBzdXJlIHlvdSBkb24ndCBoYXZlIGFueSBleHRyYSB3aGl0ZXNwYWNlIGJldHdlZW4gdGFncyBvbiBlYWNoIGxpbmUgb2YgeW91ciBzb3VyY2UgY29kZS4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICI8IiArIGNoaWxkVGFnICsgIj4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnZhbGlkUGFyZW50KSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3JUYWcgPT09ICJ0YWJsZSIgJiYgY2hpbGRUYWcgPT09ICJ0ciIpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBBZGQgYSA8dGJvZHk+LCA8dGhlYWQ+IG9yIDx0Zm9vdD4gdG8geW91ciBjb2RlIHRvIG1hdGNoIHRoZSBET00gdHJlZSBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZyguLi4pOiAlcyBjYW5ub3QgYXBwZWFyIGFzIGEgY2hpbGQgb2YgPCVzPi4lcyVzIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnLCB3aGl0ZXNwYWNlSW5mbywgaW5mbyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXJyb3IoInZhbGlkYXRlRE9NTmVzdGluZyguLi4pOiAlcyBjYW5ub3QgYXBwZWFyIGFzIGEgZGVzY2VuZGFudCBvZiA8JXM+LiIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxID0gInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1NUQVJUX0RBVEEgPSAiJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0VORF9EQVRBID0gIi8kIjsKICAgICAgICB2YXIgU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBID0gIiQ/IjsKICAgICAgICB2YXIgU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSA9ICIkISI7CiAgICAgICAgdmFyIFNUWUxFJDEgPSAic3R5bGUiOwogICAgICAgIHZhciBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICB2YXIgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGV4dChyb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgdmFyIG5hbWVzcGFjZTsKICAgICAgICAgIHZhciBub2RlVHlwZSA9IHJvb3RDb250YWluZXJJbnN0YW5jZS5ub2RlVHlwZTsKICAgICAgICAgIHN3aXRjaCAobm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9OT0RFOgogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX0ZSQUdNRU5UX05PREU6IHsKICAgICAgICAgICAgICB0eXBlID0gbm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyAiI2RvY3VtZW50IiA6ICIjZnJhZ21lbnQiOwogICAgICAgICAgICAgIHZhciByb290MyA9IHJvb3RDb250YWluZXJJbnN0YW5jZS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gcm9vdDMgPyByb290My5uYW1lc3BhY2VVUkkgOiBnZXRDaGlsZE5hbWVzcGFjZShudWxsLCAiIik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJJbnN0YW5jZS5wYXJlbnROb2RlIDogcm9vdENvbnRhaW5lckluc3RhbmNlOwogICAgICAgICAgICAgIHZhciBvd25OYW1lc3BhY2UgPSBjb250YWluZXIyLm5hbWVzcGFjZVVSSSB8fCBudWxsOwogICAgICAgICAgICAgIHR5cGUgPSBjb250YWluZXIyLnRhZ05hbWU7CiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gZ2V0Q2hpbGROYW1lc3BhY2Uob3duTmFtZXNwYWNlLCB0eXBlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRhdGVkVGFnID0gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhudWxsLCB2YWxpZGF0ZWRUYWcpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGRIb3N0Q29udGV4dChwYXJlbnRIb3N0Q29udGV4dCwgdHlwZSwgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnRIb3N0Q29udGV4dERldiA9IHBhcmVudEhvc3RDb250ZXh0OwogICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50SG9zdENvbnRleHREZXYubmFtZXNwYWNlLCB0eXBlKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8ocGFyZW50SG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGb3JDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IGlzRW5hYmxlZCgpOwogICAgICAgICAgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpOwogICAgICAgICAgdmFyIGFjdGl2ZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgIHNldEVuYWJsZWQoZmFsc2UpOwogICAgICAgICAgcmV0dXJuIGFjdGl2ZUluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEFmdGVyQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIHJlc3RvcmVTZWxlY3Rpb24oc2VsZWN0aW9uSW5mb3JtYXRpb24pOwogICAgICAgICAgc2V0RW5hYmxlZChldmVudHNFbmFibGVkKTsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgICAgc2VsZWN0aW9uSW5mb3JtYXRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyh0eXBlLCBudWxsLCBob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8pOwogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgcHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudE5hbWVzcGFjZSA9IGhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkb21FbGVtZW50ID0gY3JlYXRlRWxlbWVudDModHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgcGFyZW50TmFtZXNwYWNlKTsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIGRvbUVsZW1lbnQpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmV0dXJuICEhcHJvcHMuYXV0b0ZvY3VzOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVVwZGF0ZShkb21FbGVtZW50LCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gIT09IHR5cGVvZiBvbGRQcm9wcy5jaGlsZHJlbiAmJiAodHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSkgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gdHlwZSA9PT0gInRleHRhcmVhIiB8fCB0eXBlID09PSAibm9zY3JpcHQiIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIiB8fCB0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgPT09ICJvYmplY3QiICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSBudWxsICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLl9faHRtbCAhPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0SW5zdGFuY2UodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHRleHQsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBjcmVhdGVUZXh0Tm9kZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGV4dE5vZGUpOwogICAgICAgICAgcmV0dXJuIHRleHROb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RXZlbnRQcmlvcml0eSgpIHsKICAgICAgICAgIHZhciBjdXJyZW50RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEV2ZW50ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldEV2ZW50UHJpb3JpdHkoY3VycmVudEV2ZW50LnR5cGUpOwogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBjYW5jZWxUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IHZvaWQgMDsKICAgICAgICB2YXIgbm9UaW1lb3V0ID0gLTE7CiAgICAgICAgdmFyIGxvY2FsUHJvbWlzZSA9IHR5cGVvZiBQcm9taXNlID09PSAiZnVuY3Rpb24iID8gUHJvbWlzZSA6IHZvaWQgMDsKICAgICAgICB2YXIgc2NoZWR1bGVNaWNyb3Rhc2sgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICJmdW5jdGlvbiIgPyBxdWV1ZU1pY3JvdGFzayA6IHR5cGVvZiBsb2NhbFByb21pc2UgIT09ICJ1bmRlZmluZWQiID8gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiBsb2NhbFByb21pc2UucmVzb2x2ZShudWxsKS50aGVuKGNhbGxiYWNrKS5jYXRjaChoYW5kbGVFcnJvckluTmV4dFRpY2spOwogICAgICAgIH0gOiBzY2hlZHVsZVRpbWVvdXQ7CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3JJbk5leHRUaWNrKGVycm9yMikgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE1vdW50KGRvbUVsZW1lbnQsIHR5cGUsIG5ld1Byb3BzLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaWYgKG5ld1Byb3BzLmF1dG9Gb2N1cykgewogICAgICAgICAgICAgICAgZG9tRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgImltZyI6IHsKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuc3JjKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LnNyYyA9IG5ld1Byb3BzLnNyYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZShkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoZG9tRWxlbWVudCwgbmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFRleHRDb250ZW50KGRvbUVsZW1lbnQpIHsKICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSBuZXdUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZCkgewogICAgICAgICAgdmFyIHBhcmVudE5vZGU7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjb250YWluZXIyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyOwogICAgICAgICAgICBwYXJlbnROb2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWFjdFJvb3RDb250YWluZXIgPSBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICBpZiAoKHJlYWN0Um9vdENvbnRhaW5lciA9PT0gbnVsbCB8fCByZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMCkgJiYgcGFyZW50Tm9kZS5vbmNsaWNrID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KHBhcmVudE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEluQ29udGFpbmVyQmVmb3JlKGNvbnRhaW5lcjIsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjb250YWluZXIyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KHBhcmVudEluc3RhbmNlLCBzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2U7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICAgICAgaWYgKG5leHROb2RlICYmIG5leHROb2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5leHROb2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQobmV4dE5vZGUpOwogICAgICAgICAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgfSB3aGlsZSAobm9kZSk7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnlGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGNvbnRhaW5lcjIucGFyZW50Tm9kZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGUyID0gaW5zdGFuY2Uuc3R5bGU7CiAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlMi5zZXRQcm9wZXJ0eSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoImRpc3BsYXkiLCAibm9uZSIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0eWxlMi5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9ICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bmhpZGVJbnN0YW5jZShpbnN0YW5jZSwgcHJvcHMpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGVQcm9wID0gcHJvcHNbU1RZTEUkMV07CiAgICAgICAgICB2YXIgZGlzcGxheSA9IHN0eWxlUHJvcCAhPT0gdm9pZCAwICYmIHN0eWxlUHJvcCAhPT0gbnVsbCAmJiBzdHlsZVByb3AuaGFzT3duUHJvcGVydHkoImRpc3BsYXkiKSA/IHN0eWxlUHJvcC5kaXNwbGF5IDogbnVsbDsKICAgICAgICAgIGluc3RhbmNlLnN0eWxlLmRpc3BsYXkgPSBkYW5nZXJvdXNTdHlsZVZhbHVlKCJkaXNwbGF5IiwgZGlzcGxheSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSkgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IEVMRU1FTlRfTk9ERSB8fCB0eXBlLnRvTG93ZXJDYXNlKCkgIT09IGluc3RhbmNlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UoaW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0ID09PSAiIiB8fCBpbnN0YW5jZS5ub2RlVHlwZSAhPT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgZGF0YXNldCA9IGluc3RhbmNlLm5leHRTaWJsaW5nICYmIGluc3RhbmNlLm5leHRTaWJsaW5nLmRhdGFzZXQ7CiAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgIGlmIChkYXRhc2V0KSB7CiAgICAgICAgICAgIGRpZ2VzdCA9IGRhdGFzZXQuZGdzdDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1lc3NhZ2UgPSBkYXRhc2V0Lm1zZzsKICAgICAgICAgICAgICBzdGFjayA9IGRhdGFzZXQuc3RjazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgICAgZGlnZXN0LAogICAgICAgICAgICAgIHN0YWNrCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KGluc3RhbmNlLCBjYWxsYmFjaykgewogICAgICAgICAgaW5zdGFuY2UuX3JlYWN0UmV0cnkgPSBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGUobm9kZSkgewogICAgICAgICAgZm9yICg7IG5vZGUgIT0gbnVsbDsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGVEYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChub2RlRGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUoaW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRDb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgaW5zdGFuY2UpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhpbnN0YW5jZSwgcHJvcHMpOwogICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHBhcmVudE5hbWVzcGFjZSA9IGhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKGludGVybmFsSW5zdGFuY2VIYW5kbGUubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgcmV0dXJuIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlLCB0ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0SW5zdGFuY2UpOwogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2UubmV4dFNpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXRJbnN0YW5jZSkgewogICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0YW5jZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZENvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRGVsZXRlVW5oeWRyYXRlZFRhaWxJbnN0YW5jZXMocGFyZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIHBhcmVudFR5cGUgIT09ICJoZWFkIiAmJiBwYXJlbnRUeXBlICE9PSAiYm9keSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdE1hdGNoSHlkcmF0ZWRDb250YWluZXJUZXh0SW5zdGFuY2UocGFyZW50Q29udGFpbmVyLCB0ZXh0SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgaWYgKHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudENvbnRhaW5lciwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Q29udGFpbmVyLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzLCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9ySHlkcmF0aW5nQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGh5ZHJhdGlvbi4gVGhlIHNlcnZlciBIVE1MIHdhcyByZXBsYWNlZCB3aXRoIGNsaWVudCBjb250ZW50IGluIDwlcz4uIiwgcGFyZW50Q29udGFpbmVyLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlUG9ydGFsTW91bnQocG9ydGFsSW5zdGFuY2UpIHsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHBvcnRhbEluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJhbmRvbUtleSA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIHZhciBpbnRlcm5hbEluc3RhbmNlS2V5ID0gIl9fcmVhY3RGaWJlciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbFByb3BzS2V5ID0gIl9fcmVhY3RQcm9wcyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5ID0gIl9fcmVhY3RDb250YWluZXIkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5ID0gIl9fcmVhY3RFdmVudHMkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXkgPSAiX19yZWFjdExpc3RlbmVycyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlc1NldEtleSA9ICJfX3JlYWN0SGFuZGxlcyQiICsgcmFuZG9tS2V5OwogICAgICAgIGZ1bmN0aW9uIGRldGFjaERlbGV0ZWRJbnN0YW5jZShub2RlKSB7CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsUHJvcHNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyTGlzdGVuZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlY2FjaGVGaWJlck5vZGUoaG9zdEluc3QsIG5vZGUpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gPSBob3N0SW5zdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbnRhaW5lckFzUm9vdChob3N0Um9vdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IGhvc3RSb290OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bm1hcmtDb250YWluZXJBc1Jvb3Qobm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGFpbmVyTWFya2VkQXNSb290KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIW5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHRhcmdldE5vZGUpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gdGFyZ2V0Tm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB3aGlsZSAocGFyZW50Tm9kZSkgewogICAgICAgICAgICB0YXJnZXRJbnN0ID0gcGFyZW50Tm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSB8fCBwYXJlbnROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSB0YXJnZXRJbnN0LmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5zdC5jaGlsZCAhPT0gbnVsbCB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2UodGFyZ2V0Tm9kZSk7CiAgICAgICAgICAgICAgICB3aGlsZSAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0U3VzcGVuc2VJbnN0ID0gc3VzcGVuc2VJbnN0YW5jZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFN1c3BlbnNlSW5zdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRTdXNwZW5zZUluc3Q7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldE5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICBwYXJlbnROb2RlID0gdGFyZ2V0Tm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIGluc3QgPSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldIHx8IG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0IHx8IGluc3QudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGcm9tSW5zdGFuY2UoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gaW5zdC5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImdldE5vZGVGcm9tSW5zdGFuY2U6IEludmFsaWQgYXJndW1lbnQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGVbaW50ZXJuYWxQcm9wc0tleV0gfHwgbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRmliZXJQcm9wcyhub2RlLCBwcm9wcykgewogICAgICAgICAgbm9kZVtpbnRlcm5hbFByb3BzS2V5XSA9IHByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudExpc3RlbmVyU2V0KG5vZGUpIHsKICAgICAgICAgIHZhciBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV07CiAgICAgICAgICBpZiAoZWxlbWVudExpc3RlbmVyU2V0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZWxlbWVudExpc3RlbmVyU2V0ID0gbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50TGlzdGVuZXJTZXQ7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMiA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMih0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVTdGFjayA9IFtdOwogICAgICAgIHZhciBmaWJlclN0YWNrOwogICAgICAgIHsKICAgICAgICAgIGZpYmVyU3RhY2sgPSBbXTsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ3Vyc29yKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY3VycmVudDogZGVmYXVsdFZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3AoY3Vyc29yLCBmaWJlcikgewogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcG9wLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBmaWJlclN0YWNrW2luZGV4XSkgewogICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIEZpYmVyIHBvcHBlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZVN0YWNrW2luZGV4XTsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaW5kZXgtLTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaChjdXJzb3IsIHZhbHVlLCBmaWJlcikgewogICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gY3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0OwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgZW1wdHlDb250ZXh0T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eUNvbnRleHRPYmplY3QpOwogICAgICAgIH0KICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgdmFyIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZmFsc2UpOwogICAgICAgIHZhciBwcmV2aW91c0NvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgZnVuY3Rpb24gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBkaWRQdXNoT3duQ29udGV4dElmUHJvdmlkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlciAmJiBpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgbWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0OwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dCA9IG1hc2tlZENvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IHR5cGUuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAoIWNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPT09IHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGV4dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjb250ZXh0VHlwZXMsIGNvbnRleHQsICJjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzQ29udGV4dENoYW5nZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGV4dFByb3ZpZGVyKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGZpYmVyLCBjb250ZXh0LCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgY29udGV4dCwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCB0eXBlLCBwYXJlbnRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jaGlsZENvbnRleHRUeXBlcyBpcyBzcGVjaWZpZWQgYnV0IHRoZXJlIGlzIG5vIGdldENoaWxkQ29udGV4dCgpIG1ldGhvZCBvbiB0aGUgaW5zdGFuY2UuIFlvdSBjYW4gZWl0aGVyIGRlZmluZSBnZXRDaGlsZENvbnRleHQoKSBvbiAlcyBvciByZW1vdmUgY2hpbGRDb250ZXh0VHlwZXMgZnJvbSBpdC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dCA9IGluc3RhbmNlLmdldENoaWxkQ29udGV4dCgpOwogICAgICAgICAgICBmb3IgKHZhciBjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dCkgewogICAgICAgICAgICAgIGlmICghKGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0VHlwZXMpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIikgKyAnLmdldENoaWxkQ29udGV4dCgpOiBrZXkgIicgKyBjb250ZXh0S2V5ICsgJyIgaXMgbm90IGRlZmluZWQgaW4gY2hpbGRDb250ZXh0VHlwZXMuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjaGlsZENvbnRleHRUeXBlcywgY2hpbGRDb250ZXh0LCAiY2hpbGQgY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHBhcmVudENvbnRleHQsIGNoaWxkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0IHx8IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgdHlwZSwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYW4gaW5zdGFuY2UgYnkgdGhpcyBwb2ludC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkQ2hhbmdlKSB7CiAgICAgICAgICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdHlwZSwgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuY29udGV4dDsKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgIHZhciBDb25jdXJyZW50Um9vdCA9IDE7CiAgICAgICAgdmFyIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgIHZhciBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3luY1F1ZXVlID0gW2NhbGxiYWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IHRydWU7CiAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICBpZiAoIWlzRmx1c2hpbmdTeW5jUXVldWUgJiYgc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSB0cnVlOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gc3luY1F1ZXVlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IHN5bmNRdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgdmFyIGZvcmtTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUZvcmtQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgIHZhciBpZFN0YWNrID0gW107CiAgICAgICAgdmFyIGlkU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlQ29udGV4dElkID0gMTsKICAgICAgICB2YXIgdHJlZUNvbnRleHRPdmVyZmxvdyA9ICIiOwogICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9ya2VkKSAhPT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ya3NBdExldmVsKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJlZUlkKCkgewogICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBpZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBpZCA9IGlkV2l0aExlYWRpbmdCaXQgJiB+Z2V0TGVhZGluZ0JpdChpZFdpdGhMZWFkaW5nQml0KTsKICAgICAgICAgIHJldHVybiBpZC50b1N0cmluZygzMikgKyBvdmVyZmxvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya0NvdW50OwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gdG90YWxDaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4sIGluZGV4MikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIGJhc2VJZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBiYXNlT3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgIHZhciBiYXNlSWQgPSBiYXNlSWRXaXRoTGVhZGluZ0JpdCAmIH4oMSA8PCBiYXNlTGVuZ3RoKTsKICAgICAgICAgIHZhciBzbG90ID0gaW5kZXgyICsgMTsKICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDMwKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZk92ZXJmbG93Qml0cyA9IGJhc2VMZW5ndGggLSBiYXNlTGVuZ3RoICUgNTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvdyA9IChiYXNlSWQgJiBuZXdPdmVyZmxvd0JpdHMpLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VJZCA9IGJhc2VJZCA+PiBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZMZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdE9mTmV3Qml0cyA9IHNsb3QgPDwgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIGlkID0gcmVzdE9mTmV3Qml0cyB8IHJlc3RPZkJhc2VJZDsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IHJlc3RPZkxlbmd0aCB8IGlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIF9pZCA9IG5ld0JpdHMgfCBiYXNlSWQ7CiAgICAgICAgICAgIHZhciBfb3ZlcmZsb3cgPSBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IF9vdmVyZmxvdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IDE7CiAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJpdExlbmd0aChudW1iZXIpIHsKICAgICAgICAgIHJldHVybiAzMiAtIGNsejMyKG51bWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWRpbmdCaXQoaWQpIHsKICAgICAgICAgIHJldHVybiAxIDw8IGdldEJpdExlbmd0aChpZCkgLSAxOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgPT09IHRyZWVGb3JrUHJvdmlkZXIpIHsKICAgICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSBmb3JrU3RhY2tbLS1mb3JrU3RhY2tJbmRleF07CiAgICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0UHJvdmlkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBpZDogdHJlZUNvbnRleHRJZCwKICAgICAgICAgICAgICBvdmVyZmxvdzogdHJlZUNvbnRleHRPdmVyZmxvdwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbmRlZENvbnRleHQpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgdHJlZUNvbnRleHRJZCA9IHN1c3BlbmRlZENvbnRleHQuaWQ7CiAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gc3VzcGVuZGVkQ29udGV4dC5vdmVyZmxvdzsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZk5vdEh5ZHJhdGluZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGJlIGh5ZHJhdGluZy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgdmFyIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgdmFyIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybklmSHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICBlcnJvcigiV2Ugc2hvdWxkIG5vdCBiZSBoeWRyYXRpbmcgaGVyZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYSBidWcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFN1c3BlbmRPckVycm9yREVWOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRJbnN0YW5jZSk7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyLCBzdXNwZW5zZUluc3RhbmNlLCB0cmVlQ29udGV4dCkgewogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIGlmICh0cmVlQ29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXN0b3JlU3VzcGVuZGVkVHJlZUNvbnRleHQoZmliZXIsIHRyZWVDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihyZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci50eXBlLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdGF0ZU5vZGUsCiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpOwogICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIGNoaWxkVG9EZWxldGUucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvckRFVikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudFR5cGUgPSByZXR1cm5GaWJlci50eXBlOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICBfcHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdGV4dCwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHJldHVybkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX3BhcmVudEluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKF9wYXJlbnRJbnN0YW5jZSAhPT0gbnVsbCkgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciBfcHJvcHMyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3R5cGUyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgX3RleHQyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShfcGFyZW50SW5zdGFuY2UsIF90ZXh0Mik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcikgewogICAgICAgICAgZmliZXIuZmxhZ3MgPSBmaWJlci5mbGFncyAmIH5IeWRyYXRpbmcgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY2FuSHlkcmF0ZUluc3RhbmNlKG5leHRJbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIHRleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UobmV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgICAgICBpZiAodGV4dEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB0ZXh0SW5zdGFuY2U7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gewogICAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkOiBzdXNwZW5zZUluc3RhbmNlLAogICAgICAgICAgICAgICAgICB0cmVlQ29udGV4dDogZ2V0U3VzcGVuZGVkVHJlZUNvbnRleHQoKSwKICAgICAgICAgICAgICAgICAgcmV0cnlMYW5lOiBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IHN1c3BlbnNlU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGVoeWRyYXRlZEZyYWdtZW50LnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgICAgZmliZXIuY2hpbGQgPSBkZWh5ZHJhdGVkRnJhZ21lbnQ7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAoZmliZXIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkh5ZHJhdGlvbiBmYWlsZWQgYmVjYXVzZSB0aGUgaW5pdGlhbCBVSSBkb2VzIG5vdCBtYXRjaCB3aGF0IHdhcyByZW5kZXJlZCBvbiB0aGUgc2VydmVyLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSA9IG5leHRJbnN0YW5jZTsKICAgICAgICAgIGlmICghdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaXJzdEF0dGVtcHRlZEluc3RhbmNlKTsKICAgICAgICAgICAgdmFyIHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSB8fCAhdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIsIGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKGZpYmVyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYgPSAhZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgZmliZXIsIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2KTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IGZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHRDb250ZW50LCBmaWJlcik7CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q29udGFpbmVyID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGV4dEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRDb250ZW50LAogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRQcm9wcyA9IHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIF9pc0NvbmN1cnJlbnRNb2RlMiA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgIGRpZE5vdE1hdGNoSHlkcmF0ZWRUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZTIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcikgewogICAgICAgICAgdmFyIHBhcmVudCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwgJiYgcGFyZW50LnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Um9vdCAmJiBwYXJlbnQudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIgIT09IGh5ZHJhdGlvblBhcmVudEZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gSG9zdFJvb3QgJiYgKGZpYmVyLnRhZyAhPT0gSG9zdENvbXBvbmVudCB8fCBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhmaWJlci50eXBlKSAmJiAhc2hvdWxkU2V0VGV4dENvbnRlbnQoZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcykpKSB7CiAgICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgICBpZiAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKGZpYmVyKTsKICAgICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShmaWJlciwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBoeWRyYXRpb25QYXJlbnRGaWJlciA/IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaWJlci5zdGF0ZU5vZGUpIDogbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nICYmIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpIHsKICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgd2hpbGUgKG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIeWRyYXRpb25TdGF0ZSgpIHsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCkgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGh5ZHJhdGlvbkVycm9ycyk7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldElzSHlkcmF0aW5nKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUh5ZHJhdGlvbkVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIE5vVHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEN1cnJlbnRUcmFuc2l0aW9uKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEudHJhbnNpdGlvbjsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzID0gewogICAgICAgICAgcmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgfSwKICAgICAgICAgIGZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICByZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZGlzY2FyZFBlbmRpbmdXYXJuaW5nczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZmluZFN0cmljdFJvb3QgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgbWF5YmVTdHJpY3RSb290ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgbWF5YmVTdHJpY3RSb290ID0gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXliZVN0cmljdFJvb3Q7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHNldFRvU29ydGVkU3RyaW5nID0gZnVuY3Rpb24oc2V0MikgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgc2V0Mi5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gYXJyYXkuc29ydCgpLmpvaW4oIiwgIik7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmhhcyhmaWJlci50eXBlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiAvLyBEb24ndCB3YXJuIGFib3V0IHJlYWN0LWxpZmVjeWNsZXMtY29tcGF0IHBvbHlmaWxsZWQgY29tcG9uZW50cy4KICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50Ll9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHNvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczIgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4oImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybigiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIHRvIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNSA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybigiY29tcG9uZW50V2lsbFVwZGF0ZSBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsVXBkYXRlIHRvIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgc3RyaWN0Um9vdCA9IGZpbmRTdHJpY3RSb290KGZpYmVyKTsKICAgICAgICAgICAgaWYgKHN0cmljdFJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIFN0cmljdE1vZGUgY29tcG9uZW50IGluIGEgc3RyaWN0IG1vZGUgdHJlZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0ZvclJvb3QgPSBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZ2V0KHN0cmljdFJvb3QpOwogICAgICAgICAgICBpZiAoZmliZXIudHlwZS5jb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBmaWJlci50eXBlLmNoaWxkQ29udGV4dFR5cGVzICE9IG51bGwgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh3YXJuaW5nc0ZvclJvb3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290ID0gW107CiAgICAgICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuc2V0KHN0cmljdFJvb3QsIHdhcm5pbmdzRm9yUm9vdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5pbmdzRm9yUm9vdC5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLmZvckVhY2goZnVuY3Rpb24oZmliZXJBcnJheSwgc3RyaWN0Um9vdCkgewogICAgICAgICAgICAgIGlmIChmaWJlckFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmlyc3RGaWJlciA9IGZpYmVyQXJyYXlbMF07CiAgICAgICAgICAgICAgdmFyIHVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBmaWJlckFycmF5LmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIHVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0LmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyh1bmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaXJzdEZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJMZWdhY3kgY29udGV4dCBBUEkgaGFzIGJlZW4gZGV0ZWN0ZWQgd2l0aGluIGEgc3RyaWN0LW1vZGUgdHJlZS5cblxuVGhlIG9sZCBBUEkgd2lsbCBiZSBzdXBwb3J0ZWQgaW4gYWxsIDE2LnggcmVsZWFzZXMsIGJ1dCBhcHBsaWNhdGlvbnMgdXNpbmcgaXQgc2hvdWxkIG1pZ3JhdGUgdG8gdGhlIG5ldyB2ZXJzaW9uLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXNcblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0Iiwgc29ydGVkTmFtZXMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZW5lcmF0b3JzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmc7CiAgICAgICAgdmFyIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZzsKICAgICAgICB2YXIgd2FybkZvck1pc3NpbmdLZXkgPSBmdW5jdGlvbihjaGlsZCwgcmV0dXJuRmliZXIpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nID0ge307CiAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgICAgICBpZiAoY2hpbGQgPT09IG51bGwgfHwgdHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNoaWxkLl9zdG9yZSB8fCBjaGlsZC5fc3RvcmUudmFsaWRhdGVkIHx8IGNoaWxkLmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQuX3N0b3JlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QgQ29tcG9uZW50IGluIHdhcm5Gb3JNaXNzaW5nS2V5IHNob3VsZCBoYXZlIGEgX3N0b3JlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVhY3RDbGFzcyh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5wcm90b3R5cGUgJiYgdHlwZS5wcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZWxlbWVudCkgewogICAgICAgICAgdmFyIG1peGVkUmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICBpZiAobWl4ZWRSZWYgIT09IG51bGwgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBtaXhlZFJlZiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICgocmV0dXJuRmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgfHwgd2FybkFib3V0U3RyaW5nUmVmcykgJiYgLy8gV2Ugd2FybiBpbiBSZWFjdEVsZW1lbnQuanMgaWYgb3duZXIgYW5kIHNlbGYgYXJlIGVxdWFsIGZvciBzdHJpbmcgcmVmcwogICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uCiAgICAgICAgICAgICAgLy8gdXNpbmcgYSBjb2RlbW9kLiBUaGVyZWZvcmUsIHdlIGRvbid0IGhhdmUgdG8gd2FybiBhYm91dCBzdHJpbmcgcmVmcyBhZ2Fpbi4KICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX3NlbGYgJiYgZWxlbWVudC5fb3duZXIuc3RhdGVOb2RlICE9PSBlbGVtZW50Ll9zZWxmKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcyIKICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpICYmIC8vIFdpbGwgYWxyZWFkeSB3YXJuIHdpdGggIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMiCiAgICAgICAgICAgICAgISh0eXBlb2YgZWxlbWVudC50eXBlID09PSAiZnVuY3Rpb24iICYmICFpc1JlYWN0Q2xhc3MoZWxlbWVudC50eXBlKSkgJiYgLy8gV2lsbCBhbHJlYWR5IHRocm93IHdpdGggIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKHNvbWVTdHJpbmdSZWYpIGJ1dCBubyBvd25lciB3YXMgc2V0IgogICAgICAgICAgICAgIGVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFdlIHJlY29tbWVuZCB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgbWl4ZWRSZWYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdDsKICAgICAgICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgICBpZiAob3duZXJGaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcy4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluc3QgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFpbnN0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3Npbmcgb3duZXIgZm9yIHN0cmluZyByZWYgIiArIG1peGVkUmVmICsgIi4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSW5zdCA9IGluc3Q7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wU3RyaW5nQ29lcmNpb24obWl4ZWRSZWYsICJyZWYiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1JlZiA9ICIiICsgbWl4ZWRSZWY7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLnJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgY3VycmVudDIucmVmID09PSAiZnVuY3Rpb24iICYmIGN1cnJlbnQyLnJlZi5fc3RyaW5nUmVmID09PSBzdHJpbmdSZWYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Mi5yZWY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHJlZnMgPSByZXNvbHZlZEluc3QucmVmczsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGUgcmVmc1tzdHJpbmdSZWZdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVmc1tzdHJpbmdSZWZdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZWYuX3N0cmluZ1JlZiA9IHN0cmluZ1JlZjsKICAgICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbWl4ZWRSZWYgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlZiB0byBiZSBhIGZ1bmN0aW9uLCBhIHN0cmluZywgYW4gb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZVJlZigpLCBvciBudWxsLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKCIgKyBtaXhlZFJlZiArICIpIGJ1dCBubyBvd25lciB3YXMgc2V0LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgZnVuY3Rpb24gY29tcG9uZW50XG4yLiBZb3UgbWF5IGJlIGFkZGluZyBhIHJlZiB0byBhIGNvbXBvbmVudCB0aGF0IHdhcyBub3QgY3JlYXRlZCBpbnNpZGUgYSBjb21wb25lbnQncyByZW5kZXIgbWV0aG9kXG4zLiBZb3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlZnMtbXVzdC1oYXZlLW93bmVyIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1peGVkUmVmOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKSB7CiAgICAgICAgICB2YXIgY2hpbGRTdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobmV3Q2hpbGQpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRTdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhuZXdDaGlsZCkuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbnMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkLiBUaGlzIG1heSBoYXBwZW4gaWYgeW91IHJldHVybiBhIENvbXBvbmVudCBpbnN0ZWFkIG9mIDxDb21wb25lbnQgLz4gZnJvbSByZW5kZXIuIE9yIG1heWJlIHlvdSBtZWFudCB0byBjYWxsIHRoaXMgZnVuY3Rpb24gcmF0aGVyIHRoYW4gcmV0dXJuIGl0LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eShsYXp5VHlwZSkgewogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5VHlwZS5fcGF5bG9hZDsKICAgICAgICAgIHZhciBpbml0ID0gbGF6eVR5cGUuX2luaXQ7CiAgICAgICAgICByZXR1cm4gaW5pdChwYXlsb2FkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ2hpbGRSZWNvbmNpbGVyKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2NoaWxkVG9EZWxldGVdOwogICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGRUb0RlbGV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICBjaGlsZFRvRGVsZXRlID0gY2hpbGRUb0RlbGV0ZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGV4aXN0aW5nQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDaGlsZC5rZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uc2V0KGV4aXN0aW5nQ2hpbGQua2V5LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5pbmRleCwgZXhpc3RpbmdDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGQgPSBleGlzdGluZ0NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VGaWJlcihmaWJlciwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGZpYmVyLCBwZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBjbG9uZS5pbmRleCA9IDA7CiAgICAgICAgICAgIGNsb25lLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICAgIG5ld0ZpYmVyLmluZGV4ID0gbmV3SW5kZXg7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IEZvcmtlZDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEluZGV4ID0gY3VycmVudDIuaW5kZXg7CiAgICAgICAgICAgICAgaWYgKG9sZEluZGV4IDwgbGFzdFBsYWNlZEluZGV4KSB7CiAgICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkSW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZVNpbmdsZUNoaWxkKG5ld0ZpYmVyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudDIsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgfHwgY3VycmVudDIudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCh0ZXh0Q29udGVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50LCBsYW5lcykgewogICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGN1cnJlbnQyLCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGN1cnJlbnQyLnR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBwb3J0YWwsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi50YWcgIT09IEhvc3RQb3J0YWwgfHwgY3VycmVudDIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gIT09IHBvcnRhbC5jb250YWluZXJJbmZvIHx8IGN1cnJlbnQyLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiAhPT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGZyYWdtZW50LCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi50YWcgIT09IEZyYWdtZW50MikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIGZyYWdtZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgbnVsbCwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkMi5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheShuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgICAgX2NyZWF0ZWQzLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gb2xkRmliZXIgIT09IG51bGwgPyBvbGRGaWJlci5rZXkgOiBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheShuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgbWF0Y2hlZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlciA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0NoaWxkLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IG5ld0NoaWxkLmtleSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMiA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0NoaWxkLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IG5ld0NoaWxkLmtleSkgfHwgbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheShuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIzLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IiB8fCBjaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCwgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIkVuY291bnRlcmVkIHR3byBjaGlsZHJlbiB3aXRoIHRoZSBzYW1lIGtleSwgYCVzYC4gS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSBhY3Jvc3MgdXBkYXRlcy4gTm9uLXVuaXF1ZSBrZXlzIG1heSBjYXVzZSBjaGlsZHJlbiB0byBiZSBkdXBsaWNhdGVkIGFuZC9vciBvbWl0dGVkIFx1MjAxNCB0aGUgYmVoYXZpb3IgaXMgdW5zdXBwb3J0ZWQgYW5kIGNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gY2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gY2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRLZXkoaW5pdChwYXlsb2FkKSwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMiA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXIyLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjIua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MyID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbkl0ZXJhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgLy8gJEZsb3dGaXhNZSBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCB0b1N0cmluZ1RhZwogICAgICAgICAgICAgIG5ld0NoaWxkcmVuSXRlcmFibGVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gIkdlbmVyYXRvciIpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgR2VuZXJhdG9ycyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgdW5leHBlY3RlZCByZXN1bHRzIGJlY2F1c2UgZW51bWVyYXRpbmcgYSBnZW5lcmF0b3IgbXV0YXRlcyBpdC4gWW91IG1heSBjb252ZXJ0IGl0IHRvIGFuIGFycmF5IHdpdGggYEFycmF5LmZyb20oKWAgb3IgdGhlIGBbLi4uc3ByZWFkXWAgb3BlcmF0b3IgYmVmb3JlIHJlbmRlcmluZy4gS2VlcCBpbiBtaW5kIHlvdSBtaWdodCBuZWVkIHRvIHBvbHlmaWxsIHRoZXNlIGZlYXR1cmVzIGZvciBvbGRlciBicm93c2Vycy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSBpdGVyYXRvckZuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX25ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gaXRlcmFibGUgb2JqZWN0IHByb3ZpZGVkIG5vIGl0ZXJhdG9yLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMyA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMywgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjQua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyNC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjQsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczQgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50MikgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY2hpbGQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9leGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBvcnRhbC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgIGlmIChpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheShuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCAiIiArIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczI7CiAgICAgICAgfQogICAgICAgIHZhciByZWNvbmNpbGVDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcih0cnVlKTsKICAgICAgICB2YXIgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcihmYWxzZSk7CiAgICAgICAgZnVuY3Rpb24gY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50Mi5jaGlsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlc3VtaW5nIHdvcmsgbm90IHlldCBpbXBsZW1lbnRlZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50Q2hpbGQgPSBjdXJyZW50Q2hpbGQuc2libGluZzsKICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgdmFyIGNoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3MoY2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVDdXJzb3IgPSBjcmVhdGVDdXJzb3IobnVsbCk7CiAgICAgICAgdmFyIHJlbmRlcmVyU2lnaWw7CiAgICAgICAgewogICAgICAgICAgcmVuZGVyZXJTaWdpbCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgIHZhciBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgIHZhciBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgIHZhciBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCkgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUHJvdmlkZXIocHJvdmlkZXJGaWJlciwgY29udGV4dCwgbmV4dFZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2godmFsdWVDdXJzb3IsIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHZvaWQgMCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IG51bGwgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSByZW5kZXJlclNpZ2lsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRGV0ZWN0ZWQgbXVsdGlwbGUgcmVuZGVyZXJzIGNvbmN1cnJlbnRseSByZW5kZXJpbmcgdGhlIHNhbWUgY29udGV4dCBwcm92aWRlci4gVGhpcyBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IHJlbmRlcmVyU2lnaWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUHJvdmlkZXIoY29udGV4dCwgcHJvdmlkZXJGaWJlcikgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHZhbHVlQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3AodmFsdWVDdXJzb3IsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50LCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgdmFyIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmICFpc1N1YnNldE9mTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vZGUgIT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcm9wYWdhdGlvbiByb290IHdoZW4gc2NoZWR1bGluZyBjb250ZXh0IHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV4dEZpYmVyID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgbGlzdCA9IGZpYmVyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKGxpc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeSA9IGxpc3QuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIHdoaWxlIChkZXBlbmRlbmN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jeS5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGxpc3QubGFuZXMgPSBtZXJnZUxhbmVzKGxpc3QubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kubmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDb250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIudHlwZSA/IG51bGwgOiBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRTdXNwZW5zZSA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UganVzdCBjYW1lIGZyb20gYSBwYXJlbnQgc28gd2UgbXVzdCBoYXZlIGhhZCBhIHBhcmVudC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UubGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudFN1c3BlbnNlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfYWx0ZXJuYXRlID0gcGFyZW50U3VzcGVuc2UuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChfYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhfYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudFN1c3BlbnNlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHdoaWxlIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0RmliZXIgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gbmV4dEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBuZXh0RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RDb250ZXh0ID0gZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICBpZiAoZmlyc3RDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShkZXBlbmRlbmNpZXMubGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkQ29udGV4dChjb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICBpZiAobGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID09PSBjb250ZXh0KSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvbnRleHRJdGVtID0gewogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgbWVtb2l6ZWRWYWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAobGFzdENvbnRleHREZXBlbmRlbmN5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlci5kZXBlbmRlbmNpZXMgPSB7CiAgICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY29udGV4dEl0ZW0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGxhc3RDb250ZXh0RGVwZW5kZW5jeS5uZXh0ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBbcXVldWVdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcy5wdXNoKHF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoUXVldWVpbmdDb25jdXJyZW50VXBkYXRlcygpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uY3VycmVudFF1ZXVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGNvbmN1cnJlbnRRdWV1ZXNbaV07CiAgICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBmaXJzdEludGVybGVhdmVkVXBkYXRlID0gbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKGxhc3RQZW5kaW5nVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbGFzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIHZhciB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QgPSBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdDsKICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChzb3VyY2VGaWJlciwgbGFuZSkgewogICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCAmJiAoc291cmNlRmliZXIuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBzb3VyY2VGaWJlcjsKICAgICAgICAgIHZhciBwYXJlbnQgPSBzb3VyY2VGaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnQuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIGFsdGVybmF0ZSA9IHBhcmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgocGFyZW50LmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gcGFyZW50OwogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBVcGRhdGVTdGF0ZSA9IDA7CiAgICAgICAgdmFyIFJlcGxhY2VTdGF0ZSA9IDE7CiAgICAgICAgdmFyIEZvcmNlVXBkYXRlID0gMjsKICAgICAgICB2YXIgQ2FwdHVyZVVwZGF0ZSA9IDM7CiAgICAgICAgdmFyIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGU7CiAgICAgICAgdmFyIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplVXBkYXRlUXVldWUoZmliZXIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgYmFzZVN0YXRlOiBmaWJlci5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBzaGFyZWQ6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVmZmVjdHM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGNsb25lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBldmVudFRpbWUsCiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIHRhZzogVXBkYXRlU3RhdGUsCiAgICAgICAgICAgIHBheWxvYWQ6IG51bGwsCiAgICAgICAgICAgIGNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9PT0gc2hhcmVkUXVldWUgJiYgIWRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIChzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCBvciBmb3JjZVVwZGF0ZSkgd2FzIHNjaGVkdWxlZCBmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsIHdpdGggemVybyBzaWRlLWVmZmVjdHMuIENvbnNpZGVyIHVzaW5nIGNvbXBvbmVudERpZFVwZGF0ZSBvciBhIGNhbGxiYWNrLiIpOwogICAgICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNVbnNhZmVDbGFzc1JlbmRlclBoYXNlVXBkYXRlKCkpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICByZXR1cm4gdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBzaGFyZWRRdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gc2hhcmVkUXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjYXB0dXJlZFVwZGF0ZSkgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0ZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3TGFzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGUuZXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZS5sYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWUgPSB7CiAgICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG5ld0ZpcnN0LAogICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG5ld0xhc3QsCiAgICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIHByZXZTdGF0ZSwgbmV4dFByb3BzLCBpbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoICh1cGRhdGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgUmVwbGFjZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYXB0dXJlVXBkYXRlOiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVXBkYXRlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgX3BheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgX3BheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcmNlVXBkYXRlOiB7CiAgICAgICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIHByb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICB2YXIgY3VycmVudExhc3RCYXNlVXBkYXRlID0gY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgIT09IGxhc3RCYXNlVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50TGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBxdWV1ZS5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0xhc3RCYXNlVXBkYXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUV2ZW50VGltZSA9IHVwZGF0ZS5ldmVudFRpbWU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMyLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZSA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0xhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgbmV3U3RhdGUsIHByb3BzLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSB1cGRhdGUuY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgLy8gSWYgdGhlIHVwZGF0ZSB3YXMgYWxyZWFkeSBjb21taXR0ZWQsIHdlIHNob3VsZCBub3QgcXVldWUgaXRzCiAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayBhZ2Fpbi4KICAgICAgICAgICAgICAgIHVwZGF0ZS5sYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0cyA9IHF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcXVldWUuZWZmZWN0cyA9IFt1cGRhdGVdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHMucHVzaCh1cGRhdGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgIGlmICh1cGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgICAgICAgIHZhciBfZmlyc3RQZW5kaW5nVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdXBkYXRlID0gX2ZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IG5ld0ZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLnNoYXJlZC5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIGludGVybGVhdmVkLmxhbmUpOwogICAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHF1ZXVlLnNoYXJlZC5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhuZXdMYW5lcyk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG5ld0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFyZ3VtZW50IHBhc3NlZCBhcyBjYWxsYmFjay4gRXhwZWN0ZWQgYSBmdW5jdGlvbi4gSW5zdGVhZCAiICsgKCJyZWNlaXZlZDogIiArIGNhbGxiYWNrKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpIHsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaGFzRm9yY2VVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgZmluaXNoZWRRdWV1ZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBlZmZlY3RzID0gZmluaXNoZWRRdWV1ZS5lZmZlY3RzOwogICAgICAgICAgZmluaXNoZWRRdWV1ZS5lZmZlY3RzID0gbnVsbDsKICAgICAgICAgIGlmIChlZmZlY3RzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWZmZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBlZmZlY3RzW2ldOwogICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGVmZmVjdC5jYWxsYmFjazsKICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVmZmVjdC5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICBjYWxsQ2FsbGJhY2soY2FsbGJhY2ssIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5PX0NPTlRFWFQgPSB7fTsKICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yJDEgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciByb290SW5zdGFuY2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICBmdW5jdGlvbiByZXF1aXJlZENvbnRleHQoYykgewogICAgICAgICAgaWYgKGMgPT09IE5PX0NPTlRFWFQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBob3N0IGNvbnRleHQgdG8gZXhpc3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250YWluZXIoKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIHJvb3RJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250YWluZXIoZmliZXIsIG5leHRSb290SW5zdGFuY2UpIHsKICAgICAgICAgIHB1c2gocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIG5leHRSb290SW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBOT19DT05URVhULCBmaWJlcik7CiAgICAgICAgICB2YXIgbmV4dFJvb3RDb250ZXh0ID0gZ2V0Um9vdEhvc3RDb250ZXh0KG5leHRSb290SW5zdGFuY2UpOwogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Um9vdENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRhaW5lcihmaWJlcikgewogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgIHBvcChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0Q29udGV4dCgpIHsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgcmV0dXJuIGNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcmVxdWlyZWRDb250ZXh0KGNvbnRleHRTdGFja0N1cnNvciQxLmN1cnJlbnQpOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZ2V0Q2hpbGRIb3N0Q29udGV4dChjb250ZXh0LCBmaWJlci50eXBlKTsKICAgICAgICAgIGlmIChjb250ZXh0ID09PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dENvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIGlmIChjb250ZXh0RmliZXJTdGFja0N1cnNvci5jdXJyZW50ICE9PSBmaWJlcikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgRGVmYXVsdFN1c3BlbnNlQ29udGV4dCA9IDA7CiAgICAgICAgdmFyIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrID0gMTsKICAgICAgICB2YXIgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0ID0gMTsKICAgICAgICB2YXIgRm9yY2VTdXNwZW5zZUZhbGxiYWNrID0gMjsKICAgICAgICB2YXIgc3VzcGVuc2VTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihEZWZhdWx0U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICBmdW5jdGlvbiBoYXNTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIChwYXJlbnRDb250ZXh0ICYgZmxhZykgIT09IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc2hhbGxvd0NvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0ICYgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgfCBzaGFsbG93Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzdWJ0cmVlQ29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgfCBzdWJ0cmVlQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN1c3BlbnNlQ29udGV4dChmaWJlciwgbmV3Q29udGV4dCkgewogICAgICAgICAgcHVzaChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBuZXdDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFN1c3BlbnNlQ29udGV4dChmaWJlcikgewogICAgICAgICAgcG9wKHN1c3BlbnNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKHdvcmtJblByb2dyZXNzMiwgaGFzSW52aXNpYmxlUGFyZW50KSB7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEZpcnN0U3VzcGVuZGVkKHJvdykgewogICAgICAgICAgdmFyIG5vZGUgPSByb3c7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgPT09IG51bGwgfHwgaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhkZWh5ZHJhdGVkKSB8fCBpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhkZWh5ZHJhdGVkKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCAmJiAvLyByZXZlYWxPcmRlciB1bmRlZmluZWQgY2FuJ3QgYmUgdHJ1c3RlZCBiZWNhdXNlIGl0IGRvbid0CiAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2Ygd2hldGhlciBpdCBzdXNwZW5kZWQgb3Igbm90LgogICAgICAgICAgICBub2RlLm1lbW9pemVkUHJvcHMucmV2ZWFsT3JkZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKG5vZGUuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHJvdykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHJvdykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIE5vRmxhZ3MkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBIYXNFZmZlY3QgPSAoCiAgICAgICAgICAvKiAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIEluc2VydGlvbiA9ICgKICAgICAgICAgIC8qICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIExheW91dCA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUGFzc2l2ZSQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzU291cmNlcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlID0gd29ya0luUHJvZ3Jlc3NTb3VyY2VzW2ldOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbXV0YWJsZVNvdXJjZS5fd29ya0luUHJvZ3Jlc3NWZXJzaW9uUHJpbWFyeSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpIHsKICAgICAgICAgIHZhciBnZXRWZXJzaW9uID0gbXV0YWJsZVNvdXJjZS5fZ2V0VmVyc2lvbjsKICAgICAgICAgIHZhciB2ZXJzaW9uID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb25dOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YS5wdXNoKG11dGFibGVTb3VyY2UsIHZlcnNpb24pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIHZhciByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50SG9vayA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWRDb3VudGVyID0gMDsKICAgICAgICB2YXIgUkVfUkVOREVSX0xJTUlUID0gMjU7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICB2YXIgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICB2YXIgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBtb3VudEhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYgPSBbaG9va05hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhvb2tUeXBlc0Rldi5wdXNoKGhvb2tOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYrKzsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2W2hvb2tUeXBlc1VwZGF0ZUluZGV4RGV2XSAhPT0gaG9va05hbWUpIHsKICAgICAgICAgICAgICAgIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGhvb2tOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGVwcyAhPT0gdm9pZCAwICYmIGRlcHMgIT09IG51bGwgJiYgIWlzQXJyYXkoZGVwcykpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGN1cnJlbnRIb29rTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kQ29sdW1uU3RhcnQgPSAzMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZEhvb2tOYW1lID0gaG9va1R5cGVzRGV2W2ldOwogICAgICAgICAgICAgICAgICB2YXIgbmV3SG9va05hbWUgPSBpID09PSBob29rVHlwZXNVcGRhdGVJbmRleERldiA/IGN1cnJlbnRIb29rTmFtZSA6IG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cubGVuZ3RoIDwgc2Vjb25kQ29sdW1uU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICByb3cgKz0gIiAiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvdyArPSBuZXdIb29rTmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIHRhYmxlICs9IHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBoYXMgZGV0ZWN0ZWQgYSBjaGFuZ2UgaW4gdGhlIG9yZGVyIG9mIEhvb2tzIGNhbGxlZCBieSAlcy4gVGhpcyB3aWxsIGxlYWQgdG8gYnVncyBhbmQgZXJyb3JzIGlmIG5vdCBmaXhlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHJlYWQgdGhlIFJ1bGVzIG9mIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3NcblxuICAgUHJldmlvdXMgcmVuZGVyICAgICAgICAgICAgTmV4dCByZW5kZXJcbiAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJXMgICBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5cbiIsIGNvbXBvbmVudE5hbWUsIHRhYmxlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCBkdXJpbmcgdGhpcyByZW5kZXIsIGJ1dCBub3QgZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIEV2ZW4gdGhvdWdoIHRoZSBmaW5hbCBhcmd1bWVudCBpcyBvcHRpb25hbCwgaXRzIHR5cGUgY2Fubm90IGNoYW5nZSBiZXR3ZWVuIHJlbmRlcnMuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzLmxlbmd0aCAhPT0gcHJldkRlcHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBmaW5hbCBhcmd1bWVudCBwYXNzZWQgdG8gJXMgY2hhbmdlZCBzaXplIGJldHdlZW4gcmVuZGVycy4gVGhlIG9yZGVyIGFuZCBzaXplIG9mIHRoaXMgYXJyYXkgbXVzdCByZW1haW4gY29uc3RhbnQuXG5cblByZXZpb3VzOiAlc1xuSW5jb21pbmc6ICVzIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsICJbIiArIHByZXZEZXBzLmpvaW4oIiwgIikgKyAiXSIsICJbIiArIG5leHREZXBzLmpvaW4oIiwgIikgKyAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZEZXBzLmxlbmd0aCAmJiBpIDwgbmV4dERlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHNlY29uZEFyZywgbmV4dFJlbmRlckxhbmVzKSB7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IG5leHRSZW5kZXJMYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IGN1cnJlbnQyICE9PSBudWxsID8gY3VycmVudDIuX2RlYnVnSG9va1R5cGVzIDogbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mUmVSZW5kZXJzID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgICAgICBpZiAobnVtYmVyT2ZSZVJlbmRlcnMgPj0gUkVfUkVOREVSX0xJTUlUKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW1iZXJPZlJlUmVuZGVycyArPSAxOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIH0gd2hpbGUgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGhvb2tUeXBlc0RldjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRSZW5kZXJUb29GZXdIb29rcyA9IGN1cnJlbnRIb29rICE9PSBudWxsICYmIGN1cnJlbnRIb29rLm5leHQgIT09IG51bGw7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIChjdXJyZW50Mi5mbGFncyAmIFN0YXRpY01hc2spICE9PSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgU3RhdGljTWFzaykgJiYgLy8gRGlzYWJsZSB0aGlzIHdhcm5pbmcgaW4gbGVnYWN5IG1vZGUsIGJlY2F1c2UgbGVnYWN5IFN1c3BlbnNlIGlzIHdlaXJkCiAgICAgICAgICAgIC8vIGFuZCBjcmVhdGVzIGZhbHNlIHBvc2l0aXZlcy4gVG8gbWFrZSB0aGlzIHdvcmsgaW4gbGVnYWN5IG1vZGUsIHdlJ2QKICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgLy8gbm93IEknbGwgZGlzYWJsZSB0aGUgd2FybmluZyB0aGF0IG1vc3Qgb2YgdGhlIGJ1Z3MgdGhhdCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICAgIC8vIGl0IGFyZSBlaXRoZXIgZXhjbHVzaXZlIHRvIGNvbmN1cnJlbnQgbW9kZSBvciBleGlzdCBpbiBib3RoLgogICAgICAgICAgICAoY3VycmVudDIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBFeHBlY3RlZCBzdGF0aWMgZmxhZyB3YXMgbWlzc2luZy4gUGxlYXNlIG5vdGlmeSB0aGUgUmVhY3QgdGVhbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgaWYgKGRpZFJlbmRlclRvb0Zld0hvb2tzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICB2YXIgZGlkUmVuZGVySWRIb29rID0gbG9jYWxJZENvdW50ZXIgIT09IDA7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0SG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KE1vdW50UGFzc2l2ZURldiB8IE1vdW50TGF5b3V0RGV2IHwgUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQyLmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDIubGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIb29rc0FmdGVyVGhyb3coKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vayA9IGhvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB7CiAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVF1ZXVlOiBudWxsLAogICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gaG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudEhvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIG1vcmUgaG9va3MgdGhhbiBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIG5ld0hvb2sgPSB7CiAgICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBiYXNlUXVldWU6IGN1cnJlbnRIb29rLmJhc2VRdWV1ZSwKICAgICAgICAgICAgICBxdWV1ZTogY3VycmVudEhvb2sucXVldWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICBzdG9yZXM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhc2ljU3RhdGVSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iID8gYWN0aW9uKHN0YXRlKSA6IGFjdGlvbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpbml0aWFsU3RhdGU7CiAgICAgICAgICBpZiAoaW5pdCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXQoaW5pdGlhbEFyZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsQXJnOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IHJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoUmVkdWNlckFjdGlvbi5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIGJhc2VRdWV1ZSA9IGN1cnJlbnQyLmJhc2VRdWV1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGJhc2VGaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIHZhciBwZW5kaW5nRmlyc3QgPSBwZW5kaW5nUXVldWUubmV4dDsKICAgICAgICAgICAgICBiYXNlUXVldWUubmV4dCA9IHBlbmRpbmdGaXJzdDsKICAgICAgICAgICAgICBwZW5kaW5nUXVldWUubmV4dCA9IGJhc2VGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmJhc2VRdWV1ZSAhPT0gYmFzZVF1ZXVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgZXJyb3I6IEV4cGVjdGVkIHdvcmstaW4tcHJvZ3Jlc3MgcXVldWUgdG8gYmUgYSBjbG9uZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDIuYmFzZVF1ZXVlID0gYmFzZVF1ZXVlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGN1cnJlbnQyLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVGaXJzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVMYXN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lcywgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVGaXJzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXModXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZS5oYXNFYWdlclN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gdXBkYXRlLmVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsICYmIHVwZGF0ZSAhPT0gZmlyc3QpOwogICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IG5ld0Jhc2VRdWV1ZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlUXVldWUgPSBuZXdCYXNlUXVldWVMYXN0OwogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWRMYW5lID0gaW50ZXJsZWF2ZWQubGFuZTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgfSBlbHNlIGlmIChiYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgdmFyIGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobGFzdFJlbmRlclBoYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IGxhc3RSZW5kZXJQaGFzZVVwZGF0ZS5uZXh0OwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlKTsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbbmV3U3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpc0h5ZHJhdGluZzIgPSBnZXRJc0h5ZHJhdGluZygpOwogICAgICAgICAgaWYgKGlzSHlkcmF0aW5nMikgewogICAgICAgICAgICBpZiAoZ2V0U2VydmVyU25hcHNob3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBnZXRTZXJ2ZXJTbmFwc2hvdCwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIHNlcnZlci1yZW5kZXJlZCBjb250ZW50LiBXaWxsIHJldmVydCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNlcnZlclNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFNuYXBzaG90ICE9PSBnZXRTZXJ2ZXJTbmFwc2hvdCgpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNlcnZlclNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaW5zdCA9IHsKICAgICAgICAgICAgdmFsdWU6IG5leHRTbmFwc2hvdCwKICAgICAgICAgICAgZ2V0U25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gaW5zdDsKICAgICAgICAgIG1vdW50RWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZTbmFwc2hvdCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzbmFwc2hvdENoYW5nZWQgPSAhb2JqZWN0SXMocHJldlNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgaWYgKHNuYXBzaG90Q2hhbmdlZCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGhvb2sucXVldWU7CiAgICAgICAgICB1cGRhdGVFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBpZiAoaW5zdC5nZXRTbmFwc2hvdCAhPT0gZ2V0U25hcHNob3QgfHwgc25hcHNob3RDaGFuZ2VkIHx8IC8vIENoZWNrIGlmIHRoZSBzdXNiY3JpYmUgZnVuY3Rpb24gY2hhbmdlZC4gV2UgY2FuIHNhdmUgc29tZSBtZW1vcnkgYnkKICAgICAgICAgIC8vIGNoZWNraW5nIHdoZXRoZXIgd2Ugc2NoZWR1bGVkIGEgc3Vic2NyaXB0aW9uIGVmZmVjdCBhYm92ZS4KICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzc0hvb2subWVtb2l6ZWRTdGF0ZS50YWcgJiBIYXNFZmZlY3QpIHsKICAgICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIHJlbmRlcmVkU25hcHNob3QpIHsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFN0b3JlQ29uc2lzdGVuY3k7CiAgICAgICAgICB2YXIgY2hlY2sgPSB7CiAgICAgICAgICAgIGdldFNuYXBzaG90LAogICAgICAgICAgICB2YWx1ZTogcmVuZGVyZWRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzdG9yZXMgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgIGlmIChzdG9yZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3Jlcy5wdXNoKGNoZWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdG9yZUluc3RhbmNlKGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSB7CiAgICAgICAgICBpbnN0LnZhbHVlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3Vic2NyaWJlVG9TdG9yZShmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB2YXIgaGFuZGxlU3RvcmVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShoYW5kbGVTdG9yZUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgewogICAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBpbnN0LnZhbHVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMocHJldlZhbHVlLCBuZXh0VmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpIHsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiBiYXNpY1N0YXRlUmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZQogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hTZXRTdGF0ZS5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hFZmZlY3QodGFnLCBjcmVhdGUsIGRlc3Ryb3ksIGRlcHMpIHsKICAgICAgICAgIHZhciBlZmZlY3QgPSB7CiAgICAgICAgICAgIHRhZywKICAgICAgICAgICAgY3JlYXRlLAogICAgICAgICAgICBkZXN0cm95LAogICAgICAgICAgICBkZXBzLAogICAgICAgICAgICAvLyBDaXJjdWxhcgogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICBsYXN0RWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgICAgZWZmZWN0Lm5leHQgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWZmZWN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9yZWYyID0gewogICAgICAgICAgICAgIGN1cnJlbnQ6IGluaXRpYWxWYWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBfcmVmMjsKICAgICAgICAgICAgcmV0dXJuIF9yZWYyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgcmV0dXJuIGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIHZvaWQgMCwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIGhvb2tGbGFncywgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldkVmZmVjdCA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGRlc3Ryb3kgPSBwcmV2RWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZFZmZlY3QuZGVwczsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgaG9va0ZsYWdzLCBjcmVhdGUsIGRlc3Ryb3ksIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoTW91bnRQYXNzaXZlRGV2IHwgUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoUGFzc2l2ZSB8IFBhc3NpdmVTdGF0aWMsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoUGFzc2l2ZSwgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdChjcmVhdGUsIHJlZikgewogICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHJlZkNhbGxiYWNrID0gcmVmOwogICAgICAgICAgICB2YXIgX2luc3QgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmQ2FsbGJhY2soX2luc3QpOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmQ2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHJlZiAhPT0gbnVsbCAmJiByZWYgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gcmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFyZWZPYmplY3QuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBmaXJzdCBhcmd1bWVudCB0byBlaXRoZXIgYmUgYSByZWYgY2FsbGJhY2sgb3IgUmVhY3QuY3JlYXRlUmVmKCkgb2JqZWN0LiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCAiYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKHJlZk9iamVjdCkuam9pbigiLCAiKSArICJ9Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfaW5zdDIgPSBjcmVhdGUoKTsKICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBfaW5zdDI7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgfQogICAgICAgIHZhciB1cGRhdGVEZWJ1Z1ZhbHVlID0gbW91bnREZWJ1Z1ZhbHVlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW2NhbGxiYWNrLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByZXNvbHZlZEN1cnJlbnRIb29rID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gcmVzb2x2ZWRDdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBzaG91bGREZWZlclZhbHVlID0gIWluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKHJlbmRlckxhbmVzKTsKICAgICAgICAgIGlmIChzaG91bGREZWZlclZhbHVlKSB7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXModmFsdWUsIHByZXZWYWx1ZSkpIHsKICAgICAgICAgICAgICB2YXIgZGVmZXJyZWRMYW5lID0gY2xhaW1OZXh0VHJhbnNpdGlvbkxhbmUoKTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZXZWYWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VTdGF0ZSkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2V0UGVuZGluZywgY2FsbGJhY2ssIG9wdGlvbnMyKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGhpZ2hlckV2ZW50UHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSwgQ29udGludW91c0V2ZW50UHJpb3JpdHkpKTsKICAgICAgICAgIHNldFBlbmRpbmcodHJ1ZSk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSB7fTsKICAgICAgICAgIHZhciBjdXJyZW50VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldFBlbmRpbmcoZmFsc2UpOwogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChwcmV2VHJhbnNpdGlvbiA9PT0gbnVsbCAmJiBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycykgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZWRGaWJlcnNDb3VudCA9IGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLnNpemU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlZEZpYmVyc0NvdW50ID4gMTApIHsKICAgICAgICAgICAgICAgICAgd2FybigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldChpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0KGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDIubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDIuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWw7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50Mi5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQyLnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50MiwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQyLmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBnZXRDdXJyZW50RmliZXJPd25lck5hbWVJbkRldk9yTnVsbCgpOwogICAgICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gb3duZXJOYW1lIHx8ICIiOwogICAgICAgICAgICAgIHZhciBkZWJ1Z1NvdXJjZSA9IHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgaWYgKGRlYnVnU291cmNlKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nS2V5ID0gZGVidWdTb3VyY2UuZmlsZU5hbWUgKyAiOiIgKyBkZWJ1Z1NvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBiZSBnaXZlbiByZWZzLiBBdHRlbXB0cyB0byBhY2Nlc3MgdGhpcyByZWYgd2lsbCBmYWlsLiBEaWQgeW91IG1lYW4gdG8gdXNlIFJlYWN0LmZvcndhcmRSZWYoKT8lcyIsIGluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50Mi5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50MikpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQyLmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50MiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50MiwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDIsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQyKTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50Miwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQyXTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50Mi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHModHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50MjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3R5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZTIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wcyhfQ29tcG9uZW50MiwgX3VucmVzb2x2ZWRQcm9wczQpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50MiwgX3Jlc29sdmVkUHJvcHM0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb250YWluZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb21wb25lbnQkMTsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbiA9IGZ1bmN0aW9uKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MyLCBuZWVkc1Zpc2liaWxpdHlUb2dnbGUsIGlzSGlkZGVuKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50JDEgPSBmdW5jdGlvbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gcHJlcGFyZVVwZGF0ZShpbnN0YW5jZSwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlclN0YXRlLnRhaWxNb2RlKSB7CiAgICAgICAgICAgIGNhc2UgImhpZGRlbiI6IHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBsYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlICh0YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUgPSB0YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgIHZhciBfdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBfbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlID0gX3RhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RhaWxOb2RlID0gX3RhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjayAmJiByZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnViYmxlUHJvcGVydGllcyhjb21wbGV0ZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZGlkQmFpbG91dCA9IGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlLmNoaWxkID09PSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIWRpZEJhaWxvdXQpIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIHRyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoY2hpbGQubGFuZXMsIGNoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IHRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQubGFuZXMsIF9jaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBfY2hpbGQucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBfY2hpbGQyID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBfY2hpbGQyID0gX2NoaWxkMi5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMyA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMy5sYW5lcywgX2NoaWxkMy5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX2NoaWxkMy5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkMyA9IF9jaGlsZDMuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVkV29yay5jaGlsZExhbmVzID0gbmV3Q2hpbGRMYW5lczsKICAgICAgICAgIHJldHVybiBkaWRCYWlsb3V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSkgewogICAgICAgICAgaWYgKGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSAmJiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlciB8IEluY29tcGxldGUgfCBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIXdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2lzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKF9pc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IF9wcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQyOgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQyID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDIgPT09IG51bGwgfHwgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDIsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50Mi5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50Mi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHNuYXBzaG90ID0gaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IHByZXZQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50MiwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzKGZpbmlzaGVkV29yay50eXBlLCBjdXJyZW50Mi5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgdXBkYXRlUXVldWUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKF91cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLmNoaWxkLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBnZXRQdWJsaWNJbnN0YW5jZShmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBfdXBkYXRlUXVldWUsIF9pbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgJiYgZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICBjb21taXRNb3VudChfaW5zdGFuY2UyLCB0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9maW5pc2hlZFdvcmskbWVtb2l6ZTIgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgb25Db21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uQ29tbWl0LCBvblJlbmRlciA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25SZW5kZXI7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gY3VycmVudDIgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25SZW5kZXIoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBmaW5pc2hlZFdvcmsuYWN0dWFsRHVyYXRpb24sIGZpbmlzaGVkV29yay50cmVlQmFzZUR1cmF0aW9uLCBmaW5pc2hlZFdvcmsuYWN0dWFsU3RhcnRUaW1lLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Db21taXQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ29tbWl0KGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZWZmZWN0RHVyYXRpb24sIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGRlbGV0ZWRGaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX2VmZmVjdCA9IGVmZmVjdCwgZGVzdHJveSA9IF9lZmZlY3QuZGVzdHJveSwgdGFnID0gX2VmZmVjdC50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGFnICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgodGFnICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVkRmliZXIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBkZWxldGVkRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IGRlbGV0ZWRGaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG5ld1N0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgd2FrZWFibGVzID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChyZXRyeUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPSBuZXcgUG9zc2libHlXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FrZWFibGVzLmZvckVhY2goZnVuY3Rpb24od2FrZWFibGUpIHsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXNvbHZlUmV0cnlXYWtlYWJsZS5iaW5kKG51bGwsIGZpbmlzaGVkV29yaywgd2FrZWFibGUpOwogICAgICAgICAgICAgIGlmICghcmV0cnlDYWNoZS5oYXMod2FrZWFibGUpKSB7CiAgICAgICAgICAgICAgICByZXRyeUNhY2hlLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpblByb2dyZXNzTGFuZXMgIT09IG51bGwgJiYgaW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMoaW5Qcm9ncmVzc1Jvb3QsIGluUHJvZ3Jlc3NMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBmaW5pc2hlZCByb290IGFuZCBsYW5lcyB0byBiZSBzZXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YWtlYWJsZS50aGVuKHJldHJ5LCByZXRyeSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290Myk7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBsYW5lcykgewogICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHBhcmVudEZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGRlbGV0aW9uc1tpXTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjaGlsZFRvRGVsZXRlLCBwYXJlbnRGaWJlciwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RGVidWdGaWJlciA9IGdldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgaWYgKHBhcmVudEZpYmVyLnN1YnRyZWVGbGFncyAmIE11dGF0aW9uTWFzaykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRGaWJlci5jaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNoaWxkKTsKICAgICAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGNoaWxkLCByb290Myk7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldkRlYnVnRmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQyLCBjdXJyZW50Mi5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIGN1cnJlbnQyLnJldHVybik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXNldFRleHRDb250ZW50KGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAoX2luc3RhbmNlNCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogbmV3UHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGUoX2luc3RhbmNlNCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBzaG91bGQgaGF2ZSBhIHRleHQgbm9kZSBpbml0aWFsaXplZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFRleHQgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBuZXdUZXh0OwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZSb290U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2Um9vdFN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkZpYmVyID0gZmluaXNoZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5GaWJlci5mbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5JbnN0YW5jZSA9IG9mZnNjcmVlbkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IG9mZnNjcmVlbkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBuZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIG9mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gaXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKCF3YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgX3dhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuSW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIF9uZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIF9pc0hpZGRlbiA9IF9uZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5Cb3VuZGFyeSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IF9pc0hpZGRlbjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKF9pc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIGlmICghX3dhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChvZmZzY3JlZW5Cb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5Cb3VuZGFyeS5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9mZnNjcmVlbkNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4ob2Zmc2NyZWVuQ2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihvZmZzY3JlZW5Cb3VuZGFyeSwgX2lzSGlkZGVuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIGlmIChmbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5QbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmxhZ3MgJiBIeWRyYXRpbmcpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5IeWRyYXRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IChzdWJ0cmVlUm9vdC5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgJiYgaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gaXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgIGlmIChuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gd2FzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuICYmICFwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbigKICAgICAgICAgICAgICAgICAgICBjaGlsZCwKICAgICAgICAgICAgICAgICAgICAvLyBOZXcgcm9vdDsgYnViYmxlIGJhY2sgdXAgdG8gaGVyZSBhbmQgc3RvcC4KICAgICAgICAgICAgICAgICAgICByb290MywKICAgICAgICAgICAgICAgICAgICBjb21taXR0ZWRMYW5lcwogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MgJiYgZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihyb290MywgY3VycmVudDIsIGZpYmVyLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGRlbGV0ZWRTdWJ0cmVlUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoZmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhmaWJlcik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyID09PSBkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHN3aXRjaCAoY3VycmVudDIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50Mik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwgPSBNYXRoLmNlaWw7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudE93bmVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLCBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgdmFyIE5vQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQmF0Y2hlZENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUmVuZGVyQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29tbWl0Q29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUm9vdEluUHJvZ3Jlc3MgPSAwOwogICAgICAgIHZhciBSb290RmF0YWxFcnJvcmVkID0gMTsKICAgICAgICB2YXIgUm9vdEVycm9yZWQgPSAyOwogICAgICAgIHZhciBSb290U3VzcGVuZGVkID0gMzsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZFdpdGhEZWxheSA9IDQ7CiAgICAgICAgdmFyIFJvb3RDb21wbGV0ZWQgPSA1OwogICAgICAgIHZhciBSb290RGlkTm90Q29tcGxldGUgPSA2OwogICAgICAgIHZhciBleGVjdXRpb25Db250ZXh0ID0gTm9Db250ZXh0OwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5vTGFuZXMpOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgdmFyIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSAwOwogICAgICAgIHZhciBGQUxMQkFDS19USFJPVFRMRV9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyVGFyZ2V0VGltZSA9IEluZmluaXR5OwogICAgICAgIHZhciBSRU5ERVJfVElNRU9VVF9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRSZW5kZXJUaW1lcigpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBub3coKSArIFJFTkRFUl9USU1FT1VUX01TOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWU7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICB2YXIgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSBudWxsOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIHZhciBORVNURURfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgdmFyIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID0gTm9MYW5lczsKICAgICAgICB2YXIgaXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEV2ZW50VGltZSgpIHsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRpbWUgIT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IG5vdygpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCAmJiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmUod29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzVHJhbnNpdGlvbiA9IHJlcXVlc3RDdXJyZW50VHJhbnNpdGlvbigpICE9PSBOb1RyYW5zaXRpb247CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgICBpZiAoIXRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRMYW5lID0gZ2V0Q3VycmVudEV2ZW50UHJpb3JpdHkoKTsKICAgICAgICAgIHJldHVybiBldmVudExhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RSZXRyeUxhbmUoZmliZXIpIHsKICAgICAgICAgIHZhciBtb2RlID0gZmliZXIubW9kZTsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjbGFpbU5leHRSZXRyeUxhbmUoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCkgewogICAgICAgICAgICAgIGVycm9yKCJ1c2VJbnNlcnRpb25FZmZlY3QgbXVzdCBub3Qgc2NoZWR1bGUgdXBkYXRlcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0xhbmVzICYmIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcik7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICBpZiAobGFuZSA9PT0gU3luY0xhbmUgJiYgZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0ICYmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICBjdXJyZW50Mi5sYW5lcyA9IGxhbmU7CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIG91dGRhdGVkIGRlZmVyUmVuZGVyUGhhc2VVcGRhdGVUb05leHRCYXRjaCBleHBlcmltZW50LiBXZQogICAgICAgICAgICAvLyBkZWNpZGVkIG5vdCB0byBlbmFibGUgaXQuCiAgICAgICAgICAgIChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpOwogICAgICAgICAgdmFyIG5leHRMYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0NhbGxiYWNrTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrJDEoZXhpc3RpbmdDYWxsYmFja05vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja1ByaW9yaXR5ID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9IHJvb3QzLmNhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ID09PSBuZXdDYWxsYmFja1ByaW9yaXR5ICYmIC8vIFNwZWNpYWwgY2FzZSByZWxhdGVkIHRvIGBhY3RgLiBJZiB0aGUgY3VycmVudGx5IHNjaGVkdWxlZCB0YXNrIGlzIGEKICAgICAgICAgIC8vIFNjaGVkdWxlciB0YXNrLCByYXRoZXIgdGhhbiBhbiBgYWN0YCB0YXNrLCBjYW5jZWwgaXQgYW5kIHJlLXNjaGVkdWxlZAogICAgICAgICAgLy8gb24gdGhlIGBhY3RgIHF1ZXVlLgogICAgICAgICAgIShSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IGZha2VBY3RDYWxsYmFja05vZGUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgIT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2NoZWR1bGVkIGNhbGxiYWNrIHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT0gbnVsbCkgewogICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja05vZGU7CiAgICAgICAgICBpZiAobmV3Q2FsbGJhY2tQcmlvcml0eSA9PT0gU3luY0xhbmUpIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyA9PT0gTGVnYWN5Um9vdCkgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKHBlcmZvcm1TeW5jV29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudC5wdXNoKGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlTWljcm90YXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHN3aXRjaCAobGFuZXNUb0V2ZW50UHJpb3JpdHkobmV4dExhbmVzKSkgewogICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBzY2hlZHVsZUNhbGxiYWNrJDEoc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCwgcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBuZXdDYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tOb2RlID0gbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3Qocm9vdDMsIGRpZFRpbWVvdXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFja05vZGUgPSByb290My5jYWxsYmFja05vZGU7CiAgICAgICAgICB2YXIgZGlkRmx1c2hQYXNzaXZlRWZmZWN0cyA9IGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIGlmIChkaWRGbHVzaFBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgIT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVGltZVNsaWNlID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSAmJiAhZGlkVGltZW91dDsKICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gc2hvdWxkVGltZVNsaWNlID8gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSA6IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICBpZiAoZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICB2YXIgZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RGlkTm90Q29tcGxldGUpIHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcldhc0NvbmN1cnJlbnQgPSAhaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuY3VycmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcldhc0NvbmN1cnJlbnQgJiYgIWlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspKSB7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Vycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgaWYgKF9lcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgICBsYW5lcyA9IF9lcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBfZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICAgICAgICB0aHJvdyBfZmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgICBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSA9PT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKSB7CiAgICAgICAgICB2YXIgZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnM7CiAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgdmFyIHJvb3RXb3JrSW5Qcm9ncmVzcyA9IHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICByb290V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvckh5ZHJhdGluZ0NvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4aXRTdGF0dXMgPSByZW5kZXJSb290U3luYyhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgIGlmIChleGl0U3RhdHVzICE9PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB2YXIgZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9yczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBlcnJvcnNGcm9tRmlyc3RBdHRlbXB0OwogICAgICAgICAgICBpZiAoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycy5wdXNoLmFwcGx5KHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCBlcnJvcnMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcykgewogICAgICAgICAgc3dpdGNoIChleGl0U3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgUm9vdEluUHJvZ3Jlc3M6CiAgICAgICAgICAgIGNhc2UgUm9vdEZhdGFsRXJyb3JlZDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdEVycm9yZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290U3VzcGVuZGVkOiB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSAmJiAvLyBkbyBub3QgZGVsYXkgaWYgd2UncmUgaW5zaWRlIGFuIGFjdCgpIHNjb3BlCiAgICAgICAgICAgICAgIXNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpKSB7CiAgICAgICAgICAgICAgICB2YXIgbXNVbnRpbFRpbWVvdXQgPSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lICsgRkFMTEJBQ0tfVEhST1RUTEVfTVMgLSBub3coKTsKICAgICAgICAgICAgICAgIGlmIChtc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAobmV4dExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHN1c3BlbmRlZExhbmVzLCBsYW5lcykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICAgIG1hcmtSb290UGluZ2VkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgbXNVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZFdpdGhEZWxheTogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lTXMgPSBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgICAgICAgICAgdmFyIHRpbWVFbGFwc2VkTXMgPSBub3coKSAtIGV2ZW50VGltZU1zOwogICAgICAgICAgICAgICAgdmFyIF9tc1VudGlsVGltZW91dCA9IGpuZCh0aW1lRWxhcHNlZE1zKSAtIHRpbWVFbGFwc2VkTXM7CiAgICAgICAgICAgICAgICBpZiAoX21zVW50aWxUaW1lb3V0ID4gMTApIHsKICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgX21zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RDb21wbGV0ZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByb290IGV4aXQgc3RhdHVzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgaWYgKG5vZGUuZmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5KSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gbm9kZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjaGVja3MgPSB1cGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hlY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrID0gY2hlY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIHZhciBnZXRTbmFwc2hvdCA9IGNoZWNrLmdldFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZFZhbHVlID0gY2hlY2sudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMoZ2V0U25hcHNob3QoKSwgcmVuZGVyZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAobm9kZS5zdWJ0cmVlRmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5ICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQkMShyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzKTsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1TeW5jV29ya09uUm9vdChyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBzeW5jTmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgdmFyIGxhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShsYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIGxhbmVzID0gZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIHRocm93IGZhdGFsRXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSb290KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKGxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBtZXJnZUxhbmVzKGxhbmVzLCBTeW5jTGFuZSkpOwogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyQxKGZuLCBhKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBmbihhKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNjcmV0ZVVwZGF0ZXMoZm4sIGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIsIGMsIGQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCAmJiByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cy50YWcgPT09IExlZ2FjeVJvb3QgJiYgKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IEJhdGNoZWRDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlSZW5kZXJpbmcoKSB7CiAgICAgICAgICByZXR1cm4gKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUmVuZGVyTGFuZXMoZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBwdXNoKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgc3VidHJlZVJlbmRlckxhbmVzLCBmaWJlcik7CiAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHN1YnRyZWVSZW5kZXJMYW5lcywgbGFuZXMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BSZW5kZXJMYW5lcyhmaWJlcikgewogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3Aoc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHRpbWVvdXRIYW5kbGUgPSByb290My50aW1lb3V0SGFuZGxlOwogICAgICAgICAgaWYgKHRpbWVvdXRIYW5kbGUgIT09IG5vVGltZW91dCkgewogICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgICBjYW5jZWxUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcnJ1cHRlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChpbnRlcnJ1cHRlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBpbnRlcnJ1cHRlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50MiwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBpbnRlcnJ1cHRlZFdvcmsgPSBpbnRlcnJ1cHRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhyb290My5jdXJyZW50LCBudWxsKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gcm9vdFdvcmtJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBzdWJ0cmVlUmVuZGVyTGFuZXMgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIGlmIChlcnJvcmVkV29yayA9PT0gbnVsbCB8fCBlcnJvcmVkV29yay5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RmF0YWxFcnJvcmVkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlcnJvcmVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZXJyb3JlZFdvcmssIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICAgICAgaWYgKHRocm93blZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB0aHJvd25WYWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRocm93blZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZXJyb3JlZFdvcmssIHdha2VhYmxlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3JlZChlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dFeGNlcHRpb24ocm9vdDMsIGVycm9yZWRXb3JrLnJldHVybiwgZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKGVycm9yZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoeWV0QW5vdGhlclRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgdGhyb3duVmFsdWUgPSB5ZXRBbm90aGVyVGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzID09PSBlcnJvcmVkV29yayAmJiBlcnJvcmVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSBlcnJvcmVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGVycm9yZWRXb3JrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaERpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudDsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKHByZXZEaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpIHsKICAgICAgICAgIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSBub3coKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1NraXBwZWRVcGRhdGVMYW5lcyhsYW5lKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBtZXJnZUxhbmVzKGxhbmUsIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmQoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwgJiYgKGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKSB8fCBpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKSkpIHsKICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMSh3b3JrSW5Qcm9ncmVzc1Jvb3QsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyAhPT0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEVycm9yZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gW2Vycm9yMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IFJlbmRlckNvbnRleHQ7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBwdXNoRGlzcGF0Y2hlcigpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gcm9vdDMgfHwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICAgIGlmIChtZW1vaXplZFVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBnZXRUcmFuc2l0aW9uc0ZvckxhbmVzKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcFN5bmMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJvb3RJblByb2dyZXNzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BDb25jdXJyZW50KCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsICYmICFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGN1cnJlbnQyID0gdW5pdE9mV29yay5hbHRlcm5hdGU7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIodW5pdE9mV29yayk7CiAgICAgICAgICB2YXIgbmV4dDsKICAgICAgICAgIGlmICgodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDIsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEodW5pdE9mV29yaywgdHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDIsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgdW5pdE9mV29yay5tZW1vaXplZFByb3BzID0gdW5pdE9mV29yay5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGNvbXBsZXRlZFdvcmsgPSB1bml0T2ZXb3JrOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gY29tcGxldGVkV29yay5yZXR1cm47CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5mbGFncyAmIEluY29tcGxldGUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNvbXBsZXRlZFdvcmspOwogICAgICAgICAgICAgIHZhciBuZXh0ID0gdm9pZCAwOwogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDIsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDIsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGNvbXBsZXRlZFdvcmssIGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBpZiAobmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHQgPSB1bndpbmRXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoX25leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9uZXh0LmZsYWdzICY9IEhvc3RFZmZlY3RNYXNrOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBfbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB2YXIgYWN0dWFsRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3REaWROb3RDb21wbGV0ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmdGaWJlciA9IGNvbXBsZXRlZFdvcmsuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gc2libGluZ0ZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gY29tcGxldGVkV29yazsKICAgICAgICAgIH0gd2hpbGUgKGNvbXBsZXRlZFdvcmsgIT09IG51bGwpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290Q29tcGxldGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290KHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHJlbmRlclByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfSB3aGlsZSAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpOwogICAgICAgICAgZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuZmluaXNoZWRXb3JrOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdDMuZmluaXNoZWRMYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyb290LmZpbmlzaGVkTGFuZXMgc2hvdWxkIG5vdCBiZSBlbXB0eSBkdXJpbmcgYSBjb21taXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByb290My5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSByb290My5jdXJyZW50KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJlbWFpbmluZ0xhbmVzID0gbWVyZ2VMYW5lcyhmaW5pc2hlZFdvcmsubGFuZXMsIGZpbmlzaGVkV29yay5jaGlsZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKTsKICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzIHx8IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gdHJhbnNpdGlvbnM7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VidHJlZUhhc0VmZmVjdHMgPSAoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIHZhciByb290SGFzRWZmZWN0ID0gKGZpbmlzaGVkV29yay5mbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChzdWJ0cmVlSGFzRWZmZWN0cyB8fCByb290SGFzRWZmZWN0KSB7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHNob3VsZEZpcmVBZnRlckFjdGl2ZUluc3RhbmNlQmx1cjIgPSBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGxhbmVzKTsKICAgICAgICAgICAgcmVzZXRBZnRlckNvbW1pdChyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXF1ZXN0UGFpbnQoKTsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlY29yZENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3REaWRIYXZlUGFzc2l2ZUVmZmVjdHMgPSByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0czsKICAgICAgICAgIGlmIChyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IHJvb3QzOwogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IGxhbmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHJlbWFpbmluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFyb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb25Db21taXRSb290KGZpbmlzaGVkV29yay5zdGF0ZU5vZGUsIHJlbmRlclByaW9yaXR5TGV2ZWwpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByb290My5tZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgb25Db21taXRSb290JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSByb290My5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3ZlcmFibGVFcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IHJlY292ZXJhYmxlRXJyb3JzW2ldOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHJlY292ZXJhYmxlRXJyb3Iuc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCA9IHJlY292ZXJhYmxlRXJyb3IuZGlnZXN0OwogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvcihyZWNvdmVyYWJsZUVycm9yLnZhbHVlLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICAgIGRpZ2VzdAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzVW5jYXVnaHRFcnJvcikgewogICAgICAgICAgICBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZmlyc3RVbmNhdWdodEVycm9yOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvciQxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMsIFN5bmNMYW5lKSAmJiByb290My50YWcgIT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfQogICAgICAgICAgcmVtYWluaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW1haW5pbmdMYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0cygpIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcmVuZGVyUHJpb3JpdHkgPSBsYW5lc1RvRXZlbnRQcmlvcml0eShwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyk7CiAgICAgICAgICAgIHZhciBwcmlvcml0eSA9IGxvd2VyRXZlbnRQcmlvcml0eShEZWZhdWx0RXZlbnRQcmlvcml0eSwgcmVuZGVyUHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJpb3JpdHkpOwogICAgICAgICAgICAgIHJldHVybiBmbHVzaFBhc3NpdmVFZmZlY3RzSW1wbCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrJDEoTm9ybWFsUHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYW5zaXRpb25zID0gcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9uczsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgICAgdmFyIHJvb3QzID0gcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lczsKICAgICAgICAgIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmx1c2ggcGFzc2l2ZSBlZmZlY3RzIHdoaWxlIGFscmVhZHkgcmVuZGVyaW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhyb290My5jdXJyZW50KTsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIHJvb3QzLmN1cnJlbnQsIGxhbmVzLCB0cmFuc2l0aW9ucyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9maWxlckVmZmVjdHMgPSBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0czsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9maWxlckVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyID0gcHJvZmlsZXJFZmZlY3RzW2ldOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVFZmZlY3REdXJhdGlvbnMocm9vdDMsIF9maWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYocm9vdDMuY3VycmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAocm9vdDMgPT09IHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvblBvc3RDb21taXRSb290KHJvb3QzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHJvb3QzLmN1cnJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQgIT09IG51bGwgJiYgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuaGFzKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZChpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID09PSBudWxsKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2luc3RhbmNlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZC5hZGQoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoIWhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9uVW5jYXVnaHRFcnJvciA9IHByZXBhcmVUb1Rocm93VW5jYXVnaHRFcnJvcjsKICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChyb290RmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvcjIpIHsKICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvcjIsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUocm9vdEZpYmVyLCBlcnJvckluZm8sIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUocm9vdEZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihzb3VyY2VGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IkMSkgewogICAgICAgICAgewogICAgICAgICAgICByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IkMSk7CiAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChzb3VyY2VGaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlciA9IG5lYXJlc3RNb3VudGVkQW5jZXN0b3I7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChmaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGN0b3IgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBBdHRlbXB0ZWQgdG8gY2FwdHVyZSBhIGNvbW1pdCBwaGFzZSBlcnJvciBpbnNpZGUgYSBkZXRhY2hlZCB0cmVlLiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdC4gTGlrZWx5IGNhdXNlcyBpbmNsdWRlIGRlbGV0aW5nIHRoZSBzYW1lIGZpYmVyIG1vcmUgdGhhbiBvbmNlLCBjb21taXR0aW5nIGFuIGFscmVhZHktZmluaXNoZWQgdHJlZSwgb3IgYW4gaW5jb25zaXN0ZW50IHJldHVybiBwb2ludGVyLlxuXG5FcnJvciBtZXNzYWdlOlxuXG4lcyIsIGVycm9yJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaW5nU3VzcGVuZGVkUm9vdChyb290Mywgd2FrZWFibGUsIHBpbmdlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUuZGVsZXRlKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMpOwogICAgICAgICAgd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCA9PT0gcm9vdDMgJiYgaXNTdWJzZXRPZkxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzLCBwaW5nZWRMYW5lcykpIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCAmJiBpbmNsdWRlc09ubHlSZXRyaWVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKSAmJiBub3coKSAtIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPCBGQUxMQkFDS19USFJPVFRMRV9NUykgewogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBpZiAocmV0cnlMYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0cnlMYW5lID0gcmVxdWVzdFJldHJ5TGFuZShib3VuZGFyeUZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHJldHJ5TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVSZXRyeVdha2VhYmxlKGJvdW5kYXJ5RmliZXIsIHdha2VhYmxlKSB7CiAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJldHJ5Q2FjaGU7CiAgICAgICAgICBzd2l0Y2ggKGJvdW5kYXJ5RmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGJvdW5kYXJ5RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBpbmdlZCB1bmtub3duIHN1c3BlbnNlIGJvdW5kYXJ5IHR5cGUuIFRoaXMgaXMgcHJvYmFibHkgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0cnlDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUNhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gam5kKHRpbWVFbGFwc2VkKSB7CiAgICAgICAgICByZXR1cm4gdGltZUVsYXBzZWQgPCAxMjAgPyAxMjAgOiB0aW1lRWxhcHNlZCA8IDQ4MCA/IDQ4MCA6IHRpbWVFbGFwc2VkIDwgMTA4MCA/IDEwODAgOiB0aW1lRWxhcHNlZCA8IDE5MjAgPyAxOTIwIDogdGltZUVsYXBzZWQgPCAzZTMgPyAzZTMgOiB0aW1lRWxhcHNlZCA8IDQzMjAgPyA0MzIwIDogY2VpbCh0aW1lRWxhcHNlZCAvIDE5NjApICogMTk2MDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKG5lc3RlZFVwZGF0ZUNvdW50ID4gTkVTVEVEX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IHJlcGVhdGVkbHkgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIGNvbXBvbmVudFdpbGxVcGRhdGUgb3IgY29tcG9uZW50RGlkVXBkYXRlLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiBuZXN0ZWQgdXBkYXRlcyB0byBwcmV2ZW50IGluZmluaXRlIGxvb3BzLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID4gTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICBlcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IGNhbGxzIHNldFN0YXRlIGluc2lkZSB1c2VFZmZlY3QsIGJ1dCB1c2VFZmZlY3QgZWl0aGVyIGRvZXNuJ3QgaGF2ZSBhIGRlcGVuZGVuY3kgYXJyYXksIG9yIG9uZSBvZiB0aGUgZGVwZW5kZW5jaWVzIGNoYW5nZXMgb24gZXZlcnkgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZygpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYoZmliZXIsIGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VFZmZlY3RzSW5EZXYoZmlyc3RDaGlsZCwgZmliZXJGbGFncywgaW52b2tlRWZmZWN0Rm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIHN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlTdWJ0cmVlRmxhZyA9IGN1cnJlbnQyLnN1YnRyZWVGbGFncyAmIGZpYmVyRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBzdWJ0cmVlUm9vdCAmJiBjdXJyZW50Mi5jaGlsZCAhPT0gbnVsbCAmJiBwcmltYXJ5U3VidHJlZUZsYWcgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBmaWJlckZsYWdzKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBpbnZva2VFZmZlY3RGbihjdXJyZW50Mik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50MiA9IGN1cnJlbnQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50MiA9IHN1YnRyZWVSb290ID0gY3VycmVudDIucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyAhPT0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCAmJiB0YWcgIT09IEhvc3RSb290ICYmIHRhZyAhPT0gQ2xhc3NDb21wb25lbnQgJiYgdGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiB0YWcgIT09IEZvcndhcmRSZWYgJiYgdGFnICE9PSBNZW1vQ29tcG9uZW50ICYmIHRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJSZWFjdENvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbY29tcG9uZW50TmFtZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGVycm9yKCJDYW4ndCBwZXJmb3JtIGEgUmVhY3Qgc3RhdGUgdXBkYXRlIG9uIGEgY29tcG9uZW50IHRoYXQgaGFzbid0IG1vdW50ZWQgeWV0LiBUaGlzIGluZGljYXRlcyB0aGF0IHlvdSBoYXZlIGEgc2lkZS1lZmZlY3QgaW4geW91ciByZW5kZXIgZnVuY3Rpb24gdGhhdCBhc3luY2hyb25vdXNseSBsYXRlciBjYWxscyB0cmllcyB0byB1cGRhdGUgdGhlIGNvbXBvbmVudC4gTW92ZSB0aGlzIHdvcmsgdG8gdXNlRWZmZWN0IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiZWdpbldvcmskMTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZHVtbXlGaWJlciA9IG51bGw7CiAgICAgICAgICBiZWdpbldvcmskMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBsYW5lcykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gYmVnaW5Xb3JrKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHx8IG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih1bml0T2ZXb3JrLCBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSk7CiAgICAgICAgICAgICAgaWYgKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBiZWdpbldvcmssIG51bGwsIGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIHZhciByZXBsYXlFcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGF5RXJyb3IgPT09ICJvYmplY3QiICYmIHJlcGxheUVycm9yICE9PSBudWxsICYmIHJlcGxheUVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgIW9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiAhZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSA9IHdvcmtJblByb2dyZXNzICYmIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgdmFyIGRlZHVwZUtleSA9IHJlbmRlcmluZ0NvbXBvbmVudE5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmhhcyhkZWR1cGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmFkZChkZWR1cGVLZXkpOwogICAgICAgICAgICAgICAgICAgIHZhciBzZXRTdGF0ZUNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgYSBjb21wb25lbnQgKGAlc2ApIHdoaWxlIHJlbmRlcmluZyBhIGRpZmZlcmVudCBjb21wb25lbnQgKGAlc2ApLiBUbyBsb2NhdGUgdGhlIGJhZCBzZXRTdGF0ZSgpIGNhbGwgaW5zaWRlIGAlc2AsIGZvbGxvdyB0aGUgc3RhY2sgdHJhY2UgYXMgZGVzY3JpYmVkIGluIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zZXRzdGF0ZS1pbi1yZW5kZXIiLCBzZXRTdGF0ZUNvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgZHVyaW5nIGFuIGV4aXN0aW5nIHN0YXRlIHRyYW5zaXRpb24gKHN1Y2ggYXMgd2l0aGluIGByZW5kZXJgKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIik7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKHNjaGVkdWxpbmdGaWJlcikgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBzY2hlZHVsaW5nRmliZXIsIGxhbmVzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUFjdENhbGxiYWNrTm9kZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2skMShwcmlvcml0eUxldmVsLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChhY3RRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFjdFF1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgIHJldHVybiBmYWtlQWN0Q2FsbGJhY2tOb2RlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxDYWxsYmFjayQxKGNhbGxiYWNrTm9kZSkgewogICAgICAgICAgaWYgKGNhbGxiYWNrTm9kZSA9PT0gZmFrZUFjdENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FuY2VsQ2FsbGJhY2soY2FsbGJhY2tOb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVXBkYXRlc05vdFdyYXBwZWRXaXRoQWN0REVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc0xlZ2FjeUFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiBmaWJlci50YWcgIT09IEZvcndhcmRSZWYgJiYgZmliZXIudGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIHRvICVzIGluc2lkZSBhIHRlc3Qgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCBjYXVzZXMgUmVhY3Qgc3RhdGUgdXBkYXRlcyBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaXJlIGV2ZW50cyB0aGF0IHVwZGF0ZSBzdGF0ZSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0IiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCAmJiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGlzUnVubmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICB2YXIgZmFpbGVkQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgdmFyIHNldFJlZnJlc2hIYW5kbGVyID0gZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgICAgewogICAgICAgICAgICByZXNvbHZlRmFtaWx5ID0gaGFuZGxlcjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUgIT09IG51bGwgJiYgdHlwZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUucmVuZGVyICE9PSBjdXJyZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFLAogICAgICAgICAgICAgICAgICAgIHJlbmRlcjogY3VycmVudFJlbmRlcgogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAodHlwZS5kaXNwbGF5TmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3ludGhldGljVHlwZS5kaXNwbGF5TmFtZSA9IHR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY1R5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGZpYmVyLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2VHlwZSA9IGZpYmVyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICB2YXIgbmV4dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgJCR0eXBlb2ZOZXh0VHlwZSA9IHR5cGVvZiBuZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgbmV4dFR5cGUgIT09IG51bGwgPyBuZXh0VHlwZS4kJHR5cGVvZiA6IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX01FTU9fVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNDb21wYXJlRmFtaWxpZXMpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZhbWlseSA9IHJlc29sdmVGYW1pbHkocHJldlR5cGUpOwogICAgICAgICAgICAgIGlmIChwcmV2RmFtaWx5ICE9PSB2b2lkIDAgJiYgcHJldkZhbWlseSA9PT0gcmVzb2x2ZUZhbWlseShuZXh0VHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgV2Vha1NldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzLmFkZChmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgdXBkYXRlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdGFsZUZhbWlsaWVzID0gdXBkYXRlLnN0YWxlRmFtaWxpZXMsIHVwZGF0ZWRGYW1pbGllcyA9IHVwZGF0ZS51cGRhdGVkRmFtaWxpZXM7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgc2NoZWR1bGVSb290ID0gZnVuY3Rpb24ocm9vdDMsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLmNvbnRleHQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoZmliZXIsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlLCBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlLnJlbmRlcjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCByZXNvbHZlRmFtaWx5IHRvIGJlIHNldCBkdXJpbmcgaG90IHJlbG9hZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmVlZHNSZW5kZXIgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIG5lZWRzUmVtb3VudCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoY2FuZGlkYXRlVHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KGNhbmRpZGF0ZVR5cGUpOwogICAgICAgICAgICAgIGlmIChmYW1pbHkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKHN0YWxlRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlZEZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbmRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcy5oYXMoZmliZXIpIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBmYWlsZWRCb3VuZGFyaWVzLmhhcyhhbHRlcm5hdGUpKSB7CiAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnTmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNSZW1vdW50IHx8IG5lZWRzUmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIF9yb290ID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKF9yb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIoX3Jvb3QsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwgJiYgIW5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoY2hpbGQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZpbmRIb3N0SW5zdGFuY2VzRm9yUmVmcmVzaCA9IGZ1bmN0aW9uKHJvb3QzLCBmYW1pbGllcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciB0eXBlcyA9IG5ldyBTZXQoZmFtaWxpZXMubWFwKGZ1bmN0aW9uKGZhbWlseSkgewogICAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICByZXR1cm4gaG9zdEluc3RhbmNlczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShmaWJlciwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQsIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nLCB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICB2YXIgY2FuZGlkYXRlVHlwZSA9IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZE1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgZGlkTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkTWF0Y2gpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShjaGlsZCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgaWYgKGZvdW5kSG9zdEluc3RhbmNlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNCYWRNYXBQb2x5ZmlsbDsKICAgICAgICB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5vbkV4dGVuc2libGVPYmplY3QgPSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMoe30pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtub25FeHRlbnNpYmxlT2JqZWN0XSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2libGluZyA9IG51bGw7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgdGhpcy5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgIHRoaXMubW9kZSA9IG1vZGU7CiAgICAgICAgICB0aGlzLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIHRoaXMubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnSG9va1R5cGVzID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhc2hvdWxkQ29uc3RydWN0JDEodHlwZSkgJiYgdHlwZS5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KSB7CiAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKENvbXBvbmVudCAhPT0gdm9pZCAwICYmIENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBDb21wb25lbnQuJCR0eXBlb2Y7CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSkgewogICAgICAgICAgICAgIHJldHVybiBGb3J3YXJkUmVmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50MiwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gY3VycmVudDIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50Mi50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDIua2V5LCBjdXJyZW50Mi5tb2RlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID0gY3VycmVudDIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDIudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQyLnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2UgPSBjdXJyZW50Mi5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDIuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGN1cnJlbnQyLl9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDI7CiAgICAgICAgICAgIGN1cnJlbnQyLmFsdGVybmF0ZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDIudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGN1cnJlbnQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDIuY2hpbGRMYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQyLmxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zaWJsaW5nID0gY3VycmVudDIuc2libGluZzsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5pbmRleCA9IGN1cnJlbnQyLmluZGV4OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQyLnJlZjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50Mi5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50Mi5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQyLnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQyLnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhjdXJyZW50Mi50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gU3RhdGljTWFzayB8IFBsYWNlbWVudDsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50Mi5jaGlsZExhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50Mi5sYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQyLnR5cGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgICAgbGFuZXM6IGN1cnJlbnREZXBlbmRlbmNpZXMubGFuZXMsCiAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50Mi5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSkgewogICAgICAgICAgdmFyIG1vZGU7CiAgICAgICAgICBpZiAodGFnID09PSBDb25jdXJyZW50Um9vdCkgewogICAgICAgICAgICBtb2RlID0gQ29uY3VycmVudE1vZGU7CiAgICAgICAgICAgIGlmIChpc1N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vZGUgPSBOb01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgbW9kZSB8PSBQcm9maWxlTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlcihIb3N0Um9vdCwgbnVsbCwgbnVsbCwgbW9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh0eXBlLCBrZXksIHBlbmRpbmdQcm9wcywgb3duZXIsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXJUYWcgPSBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENvbnN0cnVjdCQxKHR5cGUpKSB7CiAgICAgICAgICAgICAgZmliZXJUYWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICBmaWJlclRhZyA9IEhvc3RDb21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRUYWc6IHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21GcmFnbWVudChwZW5kaW5nUHJvcHMuY2hpbGRyZW4sIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTW9kZTsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX09GRlNDUkVFTl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU0NPUEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NBQ0hFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfREVCVUdfVFJBQ0lOR19NT0RFX1RZUEU6CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0Q29uc3VtZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBGb3J3YXJkUmVmOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBMYXp5Q29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IG93bmVyID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcikgOiBudWxsOwogICAgICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZDogZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpICIgKyAoImJ1dCBnb3Q6ICIgKyAodHlwZSA9PSBudWxsID8gdHlwZSA6IHR5cGVvZiB0eXBlKSArICIuIiArIGluZm8pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50MiwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldChwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50ICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50KSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheSh1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybigiY29weVdpdGhSZW5hbWUoKSBleHBlY3RzIHBhdGhzIG9mIHRoZSBzYW1lIGxlbmd0aCIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld1BhdGgubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUGF0aFtpXSAhPT0gbmV3UGF0aFtpXSkgewogICAgICAgICAgICAgICAgICB3YXJuKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29weVdpdGhSZW5hbWVJbXBsKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0SW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaW5kZXgyID49IHBhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIHVwZGF0ZWRba2V5XSA9IGNvcHlXaXRoU2V0SW1wbChvYmpba2V5XSwgcGF0aCwgaW5kZXgyICsgMSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBmdW5jdGlvbihvYmosIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFNldEltcGwob2JqLCBwYXRoLCAwLCB2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZpbmRIb29rID0gZnVuY3Rpb24oZmliZXIsIGlkKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SG9vazIgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudEhvb2syICE9PSBudWxsICYmIGlkID4gMCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rMiA9IGN1cnJlbnRIb29rMi5uZXh0OwogICAgICAgICAgICAgIGlkLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb29rMjsKICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoU2V0KGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgcGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24oe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoUmVuYW1lKGhvb2subWVtb2l6ZWRTdGF0ZSwgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFNldChmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgcGF0aCkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aERlbGV0ZShmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoUmVuYW1lKGZpYmVyLm1lbW9pemVkUHJvcHMsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNjaGVkdWxlVXBkYXRlID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzZXRFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRFcnJvckltcGwpIHsKICAgICAgICAgICAgc2hvdWxkRXJyb3JJbXBsID0gbmV3U2hvdWxkRXJyb3JJbXBsOwogICAgICAgICAgfTsKICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZFN1c3BlbmRJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZFN1c3BlbmRJbXBsID0gbmV3U2hvdWxkU3VzcGVuZEltcGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlQnlGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdEludG9EZXZUb29scyhkZXZUb29sc0NvbmZpZykgewogICAgICAgICAgdmFyIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlID0gZGV2VG9vbHNDb25maWcuZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U7CiAgICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgICAgcmV0dXJuIGluamVjdEludGVybmFscyh7CiAgICAgICAgICAgIGJ1bmRsZVR5cGU6IGRldlRvb2xzQ29uZmlnLmJ1bmRsZVR5cGUsCiAgICAgICAgICAgIHZlcnNpb246IGRldlRvb2xzQ29uZmlnLnZlcnNpb24sCiAgICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyUGFja2FnZU5hbWUsCiAgICAgICAgICAgIHJlbmRlcmVyQ29uZmlnOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlckNvbmZpZywKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzLAogICAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGgsCiAgICAgICAgICAgIHNldEVycm9ySGFuZGxlciwKICAgICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyLAogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSwKICAgICAgICAgICAgY3VycmVudERpc3BhdGNoZXJSZWY6IFJlYWN0Q3VycmVudERpc3BhdGNoZXIyLAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlQnlGaWJlciwKICAgICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlIHx8IGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UsCiAgICAgICAgICAgIC8vIFJlYWN0IFJlZnJlc2gKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUm9vdCwKICAgICAgICAgICAgc2V0UmVmcmVzaEhhbmRsZXIsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gYXBwZW5kIG93bmVyIHN0YWNrcyB0byBlcnJvciBtZXNzYWdlcyBpbiBERVYgbW9kZS4KICAgICAgICAgICAgZ2V0Q3VycmVudEZpYmVyOiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scywKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBkZXRlY3QgcmVjb25jaWxlciB2ZXJzaW9uIHJhdGhlciB0aGFuIHJlbmRlcmVyIHZlcnNpb24KICAgICAgICAgICAgLy8gd2hpY2ggbWF5IG5vdCBtYXRjaCBmb3IgdGhpcmQgcGFydHkgcmVuZGVyZXJzLgogICAgICAgICAgICByZWNvbmNpbGVyVmVyc2lvbjogUmVhY3RWZXJzaW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3IgPSB0eXBlb2YgcmVwb3J0RXJyb3IgPT09ICJmdW5jdGlvbiIgPyAoCiAgICAgICAgICAvLyBJbiBtb2Rlcm4gYnJvd3NlcnMsIHJlcG9ydEVycm9yIHdpbGwgZGlzcGF0Y2ggYW4gZXJyb3IgZXZlbnQsCiAgICAgICAgICAvLyBlbXVsYXRpbmcgYW4gdW5jYXVnaHQgSmF2YVNjcmlwdCBlcnJvci4KICAgICAgICAgIHJlcG9ydEVycm9yCiAgICAgICAgKSA6IGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgY29uc29sZVsiZXJyb3IiXShlcnJvcjIpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gUmVhY3RET01Sb290KGludGVybmFsUm9vdCkgewogICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gaW50ZXJuYWxSb290OwogICAgICAgIH0KICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnJlbmRlciA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB1cGRhdGUgYW4gdW5tb3VudGVkIHJvb3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRDb250YWluZXIoYXJndW1lbnRzWzFdKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgY29udGFpbmVyIHRvIHRoZSBzZWNvbmQgYXJndW1lbnQgb2Ygcm9vdC5yZW5kZXIoLi4uKS4gWW91IGRvbid0IG5lZWQgdG8gcGFzcyBpdCBhZ2FpbiBzaW5jZSB5b3UgYWxyZWFkeSBwYXNzZWQgaXQgdG8gY3JlYXRlIHRoZSByb290LiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBzZWNvbmQgYXJndW1lbnQgdG8gcm9vdC5yZW5kZXIoLi4uKSBidXQgaXQgb25seSBhY2NlcHRzIG9uZSBhcmd1bWVudC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGUgcm9vdCBjb250YWluZXIgd2FzIHJlbW92ZWQgd2l0aG91dCB1c2luZyBSZWFjdC4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGNhdXNlIGVycm9ycy4gSW5zdGVhZCwgY2FsbCByb290LnVubW91bnQoKSB0byBlbXB0eSBhIHJvb3QncyBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICB9OwogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IFJlYWN0RE9NUm9vdC5wcm90b3R5cGUudW5tb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJ1bm1vdW50KC4uLik6IGRvZXMgbm90IHN1cHBvcnQgYSBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IHRoaXMuX2ludGVybmFsUm9vdDsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IHJvb3QzLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJBdHRlbXB0ZWQgdG8gc3luY2hyb25vdXNseSB1bm1vdW50IGEgcm9vdCB3aGlsZSBSZWFjdCB3YXMgYWxyZWFkeSByZW5kZXJpbmcuIFJlYWN0IGNhbm5vdCBmaW5pc2ggdW5tb3VudGluZyB0aGUgcm9vdCB1bnRpbCB0aGUgY3VycmVudCByZW5kZXIgaGFzIGNvbXBsZXRlZCwgd2hpY2ggbWF5IGxlYWQgdG8gYSByYWNlIGNvbmRpdGlvbi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihudWxsLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1bm1hcmtDb250YWluZXJBc1Jvb3QoY29udGFpbmVyMik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY3JlYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG51bGw7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmh5ZHJhdGUpIHsKICAgICAgICAgICAgICAgIHdhcm4oImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbSA9IF9fY29tbW9uSlMoewogICJ3ZWIvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgY2hlY2tEQ0UoKTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIndlYi9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIG0gPSByZXF1aXJlX3JlYWN0X2RvbSgpOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IG0uY3JlYXRlUm9vdDsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IG0uaHlkcmF0ZVJvb3Q7CiAgICB9IGVsc2UgewogICAgICBpID0gbS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gZnVuY3Rpb24oYywgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uY3JlYXRlUm9vdChjLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBmdW5jdGlvbihjLCBoLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5oeWRyYXRlUm9vdChjLCBoLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICB2YXIgaTsKICB9Cn0pOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAid2ViL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIFJlYWN0MyA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3QzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4LnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bjsKICAgICAgICB2YXIgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSksIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgICAgaWYgKG1heWJlS2V5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1heWJlS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBtYXliZUtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheShub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50KG5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRSB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheSh0eXBlKSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJhcnJheSI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIjwiICsgKGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJVbmtub3duIikgKyAiIC8+IjsKICAgICAgICAgICAgICAgIGluZm8gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqc3hERVYodHlwZSwgcHJvcHMsIGtleSwgc291cmNlLCBzZWxmKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoY2hpbGRyZW5baV0sIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IFN0YXRpYyBjaGlsZHJlbiBzaG91bGQgYWx3YXlzIGJlIGFuIGFycmF5LiBZb3UgYXJlIGxpa2VseSBleHBsaWNpdGx5IGNhbGxpbmcgUmVhY3QuanN4cyBvciBSZWFjdC5qc3hERVYuIFVzZSB0aGUgQmFiZWwgdHJhbnNmb3JtIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3BzLCAia2V5IikpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcykuZmlsdGVyKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGsgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcwp2YXIgcmVxdWlyZV9qc3hfcnVudGltZSA9IF9fY29tbW9uSlMoewogICJ3ZWIvbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gd2ViL3NyYy9tYWluLnRzeAp2YXIgaW1wb3J0X3JlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF9jbGllbnQgPSBfX3RvRVNNKHJlcXVpcmVfY2xpZW50KCksIDEpOwoKLy8gd2ViL3NyYy9XZWlnaHRMb3NzUXVpei50c3gKdmFyIGltcG9ydF9yZWFjdDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzCnZhciBpbXBvcnRfcmVhY3QyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qcwp2YXIgdG9LZWJhYkNhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgIiQxLSQyIikudG9Mb3dlckNhc2UoKTsKdmFyIHRvQ2FtZWxDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoCiAgL14oW0EtWl0pfFtccy1fXSsoXHcpL2csCiAgKG1hdGNoLCBwMSwgcDIpID0+IHAyID8gcDIudG9VcHBlckNhc2UoKSA6IHAxLnRvTG93ZXJDYXNlKCkKKTsKdmFyIHRvUGFzY2FsQ2FzZSA9IChzdHJpbmcpID0+IHsKICBjb25zdCBjYW1lbENhc2UgPSB0b0NhbWVsQ2FzZShzdHJpbmcpOwogIHJldHVybiBjYW1lbENhc2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbENhc2Uuc2xpY2UoMSk7Cn07CnZhciBtZXJnZUNsYXNzZXMgPSAoLi4uY2xhc3NlcykgPT4gY2xhc3Nlcy5maWx0ZXIoKGNsYXNzTmFtZSwgaW5kZXgsIGFycmF5KSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4oY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUudHJpbSgpICE9PSAiIiAmJiBhcnJheS5pbmRleE9mKGNsYXNzTmFtZSkgPT09IGluZGV4Owp9KS5qb2luKCIgIikudHJpbSgpOwp2YXIgaGFzQTExeVByb3AgPSAocHJvcHMpID0+IHsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHsKICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoImFyaWEtIikgfHwgcHJvcCA9PT0gInJvbGUiIHx8IHByb3AgPT09ICJ0aXRsZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9OwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanMKdmFyIGRlZmF1bHRBdHRyaWJ1dGVzID0gewogIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLAogIHdpZHRoOiAyNCwKICBoZWlnaHQ6IDI0LAogIHZpZXdCb3g6ICIwIDAgMjQgMjQiLAogIGZpbGw6ICJub25lIiwKICBzdHJva2U6ICJjdXJyZW50Q29sb3IiLAogIHN0cm9rZVdpZHRoOiAyLAogIHN0cm9rZUxpbmVjYXA6ICJyb3VuZCIsCiAgc3Ryb2tlTGluZWpvaW46ICJyb3VuZCIKfTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIEljb24gPSAoMCwgaW1wb3J0X3JlYWN0LmZvcndhcmRSZWYpKAogICh7CiAgICBjb2xvciA9ICJjdXJyZW50Q29sb3IiLAogICAgc2l6ZSA9IDI0LAogICAgc3Ryb2tlV2lkdGggPSAyLAogICAgYWJzb2x1dGVTdHJva2VXaWR0aCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgY2hpbGRyZW4sCiAgICBpY29uTm9kZSwKICAgIC4uLnJlc3QKICB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkoCiAgICAic3ZnIiwKICAgIHsKICAgICAgcmVmLAogICAgICAuLi5kZWZhdWx0QXR0cmlidXRlcywKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgc3Ryb2tlOiBjb2xvciwKICAgICAgc3Ryb2tlV2lkdGg6IGFic29sdXRlU3Ryb2tlV2lkdGggPyBOdW1iZXIoc3Ryb2tlV2lkdGgpICogMjQgLyBOdW1iZXIoc2l6ZSkgOiBzdHJva2VXaWR0aCwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoImx1Y2lkZSIsIGNsYXNzTmFtZSksCiAgICAgIC4uLiFjaGlsZHJlbiAmJiAhaGFzQTExeVByb3AocmVzdCkgJiYgeyAiYXJpYS1oaWRkZW4iOiAidHJ1ZSIgfSwKICAgICAgLi4ucmVzdAogICAgfSwKICAgIFsKICAgICAgLi4uaWNvbk5vZGUubWFwKChbdGFnLCBhdHRyc10pID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkodGFnLCBhdHRycykpLAogICAgICAuLi5BcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuIDogW2NoaWxkcmVuXQogICAgXQogICkKKTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGNyZWF0ZUx1Y2lkZUljb24gPSAoaWNvbk5hbWUsIGljb25Ob2RlKSA9PiB7CiAgY29uc3QgQ29tcG9uZW50ID0gKDAsIGltcG9ydF9yZWFjdDIuZm9yd2FyZFJlZikoCiAgICAoeyBjbGFzc05hbWUsIC4uLnByb3BzIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdDIuY3JlYXRlRWxlbWVudCkoSWNvbiwgewogICAgICByZWYsCiAgICAgIGljb25Ob2RlLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygKICAgICAgICBgbHVjaWRlLSR7dG9LZWJhYkNhc2UodG9QYXNjYWxDYXNlKGljb25OYW1lKSl9YCwKICAgICAgICBgbHVjaWRlLSR7aWNvbk5hbWV9YCwKICAgICAgICBjbGFzc05hbWUKICAgICAgKSwKICAgICAgLi4ucHJvcHMKICAgIH0pCiAgKTsKICBDb21wb25lbnQuZGlzcGxheU5hbWUgPSB0b1Bhc2NhbENhc2UoaWNvbk5hbWUpOwogIHJldHVybiBDb21wb25lbnQ7Cn07CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9hY3Rpdml0eS5qcwp2YXIgX19pY29uTm9kZSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMjIgMTJoLTIuNDhhMiAyIDAgMCAwLTEuOTMgMS40NmwtMi4zNSA4LjM2YS4yNS4yNSAwIDAgMS0uNDggMEw5LjI0IDIuMThhLjI1LjI1IDAgMCAwLS40OCAwbC0yLjM1IDguMzZBMiAyIDAgMCAxIDQuNDkgMTJIMiIsCiAgICAgIGtleTogIjE2OXpzZSIKICAgIH0KICBdCl07CnZhciBBY3Rpdml0eSA9IGNyZWF0ZUx1Y2lkZUljb24oImFjdGl2aXR5IiwgX19pY29uTm9kZSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9hcnJvdy1yaWdodC5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xMiA1IDcgNy03IDciLCBrZXk6ICJ4cXV6NGMiIH1dCl07CnZhciBBcnJvd1JpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctcmlnaHQiLCBfX2ljb25Ob2RlMik7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGFydC1jb2x1bW4uanMKdmFyIF9faWNvbk5vZGUzID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDN2MTZhMiAyIDAgMCAwIDIgMmgxNiIsIGtleTogImMyNGk0OCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE4IDE3VjkiLCBrZXk6ICIyYno2MG4iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMyAxN1Y1Iiwga2V5OiAiMWZyZHQ4IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCAxN3YtMyIsIGtleTogIjE3c2thMCIgfV0KXTsKdmFyIENoYXJ0Q29sdW1uID0gY3JlYXRlTHVjaWRlSWNvbigiY2hhcnQtY29sdW1uIiwgX19pY29uTm9kZTMpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1sZWZ0LmpzCnZhciBfX2ljb25Ob2RlNCA9IFtbInBhdGgiLCB7IGQ6ICJtMTUgMTgtNi02IDYtNiIsIGtleTogIjF3bmZnMyIgfV1dOwp2YXIgQ2hldnJvbkxlZnQgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGV2cm9uLWxlZnQiLCBfX2ljb25Ob2RlNCk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtY2hlY2suanMKdmFyIF9faWNvbk5vZGU1ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTkgMTIgMiAyIDQtNCIsIGtleTogImR6bW03NCIgfV0KXTsKdmFyIENpcmNsZUNoZWNrID0gY3JlYXRlTHVjaWRlSWNvbigiY2lyY2xlLWNoZWNrIiwgX19pY29uTm9kZTUpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZmxhbWUuanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xMiAzcTEgNCA0IDYuNXQzIDUuNWExIDEgMCAwIDEtMTQgMCA1IDUgMCAwIDEgMS0zIDEgMSAwIDAgMCA1IDBjMC0yLTEuNS0zLTEuNS01cTAtMiAyLjUtNCIsCiAgICAgIGtleTogIjFzbGNpaCIKICAgIH0KICBdCl07CnZhciBGbGFtZSA9IGNyZWF0ZUx1Y2lkZUljb24oImZsYW1lIiwgX19pY29uTm9kZTYpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZm9vdHByaW50cy5qcwp2YXIgX19pY29uTm9kZTcgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTQgMTZ2LTIuMzhDNCAxMS41IDIuOTcgMTAuNSAzIDhjLjAzLTIuNzIgMS40OS02IDQuNS02QzkuMzcgMiAxMCAzLjggMTAgNS41YzAgMy4xMS0yIDUuNjYtMiA4LjY4VjE2YTIgMiAwIDEgMS00IDBaIiwKICAgICAga2V5OiAiMWR1ZGptIgogICAgfQogIF0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIwIDIwdi0yLjM4YzAtMi4xMiAxLjAzLTMuMTIgMS01LjYyLS4wMy0yLjcyLTEuNDktNi00LjUtNkMxNC42MyA2IDE0IDcuOCAxNCA5LjVjMCAzLjExIDIgNS42NiAyIDguNjhWMjBhMiAyIDAgMSAwIDQgMFoiLAogICAgICBrZXk6ICJsMnQ4eGMiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTYgMTdoNCIsIGtleTogIjFkZWp4dCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTQgMTNoNCIsIGtleTogIjFid2g4YiIgfV0KXTsKdmFyIEZvb3RwcmludHMgPSBjcmVhdGVMdWNpZGVJY29uKCJmb290cHJpbnRzIiwgX19pY29uTm9kZTcpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yIDkuNWE1LjUgNS41IDAgMCAxIDkuNTkxLTMuNjc2LjU2LjU2IDAgMCAwIC44MTggMEE1LjQ5IDUuNDkgMCAwIDEgMjIgOS41YzAgMi4yOS0xLjUgNC0zIDUuNWwtNS40OTIgNS4zMTNhMiAyIDAgMCAxLTMgLjAxOUw1IDE1Yy0xLjUtMS41LTMtMy4yLTMtNS41IiwKICAgICAga2V5OiAibXZyMWEwIgogICAgfQogIF0KXTsKdmFyIEhlYXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiaGVhcnQiLCBfX2ljb25Ob2RlOCk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9sb2FkZXItY2lyY2xlLmpzCnZhciBfX2ljb25Ob2RlOSA9IFtbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMSAxLTYuMjE5LTguNTYiLCBrZXk6ICIxM3phbGQiIH1dXTsKdmFyIExvYWRlckNpcmNsZSA9IGNyZWF0ZUx1Y2lkZUljb24oImxvYWRlci1jaXJjbGUiLCBfX2ljb25Ob2RlOSk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC45OTEgNS43MjdhMiAyIDAgMCAxLTIuMDA5IDBMMiA3Iiwga2V5OiAiMTMycTdxIiB9XSwKICBbInJlY3QiLCB7IHg6ICIyIiwgeTogIjQiLCB3aWR0aDogIjIwIiwgaGVpZ2h0OiAiMTYiLCByeDogIjIiLCBrZXk6ICJpenhsYW8iIH1dCl07CnZhciBNYWlsID0gY3JlYXRlTHVjaWRlSWNvbigibWFpbCIsIF9faWNvbk5vZGUxMCk7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qcwp2YXIgX19pY29uTm9kZTExID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMiAxN2EyIDIgMCAwIDEtMiAySDYuODI4YTIgMiAwIDAgMC0xLjQxNC41ODZsLTIuMjAyIDIuMjAyQS43MS43MSAwIDAgMSAyIDIxLjI4NlY1YTIgMiAwIDAgMSAyLTJoMTZhMiAyIDAgMCAxIDIgMnoiLAogICAgICBrZXk6ICIxODg4N3AiCiAgICB9CiAgXQpdOwp2YXIgTWVzc2FnZVNxdWFyZSA9IGNyZWF0ZUx1Y2lkZUljb24oIm1lc3NhZ2Utc3F1YXJlIiwgX19pY29uTm9kZTExKTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JvdGF0ZS1jY3cuanMKdmFyIF9faWNvbk5vZGUxMiA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMyAxMmE5IDkgMCAxIDAgOS05IDkuNzUgOS43NSAwIDAgMC02Ljc0IDIuNzRMMyA4Iiwga2V5OiAiMTM1N2UzIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMyAzdjVoNSIsIGtleTogIjF4aHE4YSIgfV0KXTsKdmFyIFJvdGF0ZUNjdyA9IGNyZWF0ZUx1Y2lkZUljb24oInJvdGF0ZS1jY3ciLCBfX2ljb25Ob2RlMTIpOwoKLy8gd2ViL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc3BhcmtsZXMuanMKdmFyIF9faWNvbk5vZGUxMyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTEuMDE3IDIuODE0YTEgMSAwIDAgMSAxLjk2NiAwbDEuMDUxIDUuNTU4YTIgMiAwIDAgMCAxLjU5NCAxLjU5NGw1LjU1OCAxLjA1MWExIDEgMCAwIDEgMCAxLjk2NmwtNS41NTggMS4wNTFhMiAyIDAgMCAwLTEuNTk0IDEuNTk0bC0xLjA1MSA1LjU1OGExIDEgMCAwIDEtMS45NjYgMGwtMS4wNTEtNS41NThhMiAyIDAgMCAwLTEuNTk0LTEuNTk0bC01LjU1OC0xLjA1MWExIDEgMCAwIDEgMC0xLjk2Nmw1LjU1OC0xLjA1MWEyIDIgMCAwIDAgMS41OTQtMS41OTR6IiwKICAgICAga2V5OiAiMXMyZ3JyIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTIwIDJ2NCIsIGtleTogIjFyZjNvbCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIyIDRoLTQiLCBrZXk6ICJnd293ajYiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjQiLCBjeTogIjIwIiwgcjogIjIiLCBrZXk6ICI2a3FqMXkiIH1dCl07CnZhciBTcGFya2xlcyA9IGNyZWF0ZUx1Y2lkZUljb24oInNwYXJrbGVzIiwgX19pY29uTm9kZTEzKTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RhcmdldC5qcwp2YXIgX19pY29uTm9kZTE0ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjYiLCBrZXk6ICIxdmxmcmgiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIyIiwga2V5OiAiMWM5cDc4IiB9XQpdOwp2YXIgVGFyZ2V0ID0gY3JlYXRlTHVjaWRlSWNvbigidGFyZ2V0IiwgX19pY29uTm9kZTE0KTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy1kb3duLmpzCnZhciBfX2ljb25Ob2RlMTUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE3IDE0VjIiLCBrZXk6ICI4eW1xbmsiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk05IDE4LjEyIDEwIDE0SDQuMTdhMiAyIDAgMCAxLTEuOTItMi41NmwyLjMzLThBMiAyIDAgMCAxIDYuNSAySDIwYTIgMiAwIDAgMSAyIDJ2OGEyIDIgMCAwIDEtMiAyaC0yLjc2YTIgMiAwIDAgMC0xLjc5IDEuMTFMMTIgMjJhMy4xMyAzLjEzIDAgMCAxLTMtMy44OFoiLAogICAgICBrZXk6ICJtNjFtNzciCiAgICB9CiAgXQpdOwp2YXIgVGh1bWJzRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oInRodW1icy1kb3duIiwgX19pY29uTm9kZTE1KTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy11cC5qcwp2YXIgX19pY29uTm9kZTE2ID0gWwogIFsicGF0aCIsIHsgZDogIk03IDEwdjEyIiwga2V5OiAiMXFjOTNuIiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTUgNS44OCAxNCAxMGg1LjgzYTIgMiAwIDAgMSAxLjkyIDIuNTZsLTIuMzMgOEEyIDIgMCAwIDEgMTcuNSAyMkg0YTIgMiAwIDAgMS0yLTJ2LThhMiAyIDAgMCAxIDItMmgyLjc2YTIgMiAwIDAgMCAxLjc5LTEuMTFMMTIgMmEzLjEzIDMuMTMgMCAwIDEgMyAzLjg4WiIsCiAgICAgIGtleTogImVtbW1jciIKICAgIH0KICBdCl07CnZhciBUaHVtYnNVcCA9IGNyZWF0ZUx1Y2lkZUljb24oInRodW1icy11cCIsIF9faWNvbk5vZGUxNik7CgovLyB3ZWIvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aW1lci5qcwp2YXIgX19pY29uTm9kZTE3ID0gWwogIFsibGluZSIsIHsgeDE6ICIxMCIsIHgyOiAiMTQiLCB5MTogIjIiLCB5MjogIjIiLCBrZXk6ICIxNHZhcTgiIH1dLAogIFsibGluZSIsIHsgeDE6ICIxMiIsIHgyOiAiMTUiLCB5MTogIjE0IiwgeTI6ICIxMSIsIGtleTogIjE3ZmRpdSIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjE0IiwgcjogIjgiLCBrZXk6ICIxZTF1MG8iIH1dCl07CnZhciBUaW1lciA9IGNyZWF0ZUx1Y2lkZUljb24oInRpbWVyIiwgX19pY29uTm9kZTE3KTsKCi8vIHdlYi9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Ryb3BoeS5qcwp2YXIgX19pY29uTm9kZTE4ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMCAxNC42NnYxLjYyNmEyIDIgMCAwIDEtLjk3NiAxLjY5NkE1IDUgMCAwIDAgNyAyMS45NzgiLCBrZXk6ICIxbjNocGQiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAxNC42NnYxLjYyNmEyIDIgMCAwIDAgLjk3NiAxLjY5NkE1IDUgMCAwIDEgMTcgMjEuOTc4Iiwga2V5OiAicmZlMXppIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTggOWgxLjVhMSAxIDAgMCAwIDAtNUgxOCIsIGtleTogIjd4eTZiaCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTQgMjJoMTYiLCBrZXk6ICI1N3d4djAiIH1dLAogIFsicGF0aCIsIHsgZDogIk02IDlhNiA2IDAgMCAwIDEyIDBWM2ExIDEgMCAwIDAtMS0xSDdhMSAxIDAgMCAwLTEgMXoiLCBrZXk6ICIxbWhmdXEiIH1dLAogIFsicGF0aCIsIHsgZDogIk02IDlINC41YTEgMSAwIDAgMSAwLTVINiIsIGtleTogInRleDQ4cCIgfV0KXTsKdmFyIFRyb3BoeSA9IGNyZWF0ZUx1Y2lkZUljb24oInRyb3BoeSIsIF9faWNvbk5vZGUxOCk7CgovLyB3ZWIvc3JjL1dlaWdodExvc3NRdWl6LnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgaW5qZWN0ZWRTdHlsZXMgPSBgCkBrZXlmcmFtZXMgZmxvYXRJbiB7CiAgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMHB4KTsgb3BhY2l0eTogMDsgfQogIHRvIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDApOyBvcGFjaXR5OiAxOyB9Cn0KLmhpZGUtc2Nyb2xsYmFyOjotd2Via2l0LXNjcm9sbGJhciB7IGRpc3BsYXk6IG5vbmU7IH0KLmhpZGUtc2Nyb2xsYmFyIHsgLW1zLW92ZXJmbG93LXN0eWxlOiBub25lOyBzY3JvbGxiYXItd2lkdGg6IG5vbmU7IH0KLmJ0bi1wcmVzcyB7IHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGVhc2UsIG9wYWNpdHkgMC4ycyBlYXNlOyB9Ci5idG4tcHJlc3M6YWN0aXZlIHsgdHJhbnNmb3JtOiBzY2FsZSgwLjk3KTsgfQouYnRuLXByZXNzOmhvdmVyIHsgb3BhY2l0eTogMC44NTsgfQpgOwppZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiAhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIndlaWdodC1sb3NzLXF1aXotc3R5bGVzIikpIHsKICBjb25zdCBzdHlsZUVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICBzdHlsZUVsLmlkID0gIndlaWdodC1sb3NzLXF1aXotc3R5bGVzIjsKICBzdHlsZUVsLnRleHRDb250ZW50ID0gaW5qZWN0ZWRTdHlsZXM7CiAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZUVsKTsKfQp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjMkQ2QTRGIiwKICBwcmltYXJ5RGFyazogIiMxQjQzMzIiLAogIGJnOiAiI0Y1RjBFOCIsCiAgY2FyZDogIiNGRkZGRkYiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM2QjcyODAiLAogIHRleHRNdXRlZDogIiM5Q0EzQUYiLAogIGJvcmRlcjogIiNEREQ4RDAiLAogIGJvcmRlckxpZ2h0OiAiI0VCRTZERSIsCiAgaW5wdXRCZzogIiNGNUYwRTgiLAogIGFjY2VudExpZ2h0OiAiI0UyRURFNiIsCiAgd2FybmluZzogIiNDNDk1M0EiLAogIHdhcm5pbmdCZzogIiNGNUVERDgiLAogIGRhbmdlcjogIiNDMDM5MkIiLAogIGRhbmdlckJnOiAiI0Y1REVEQSIKfTsKdmFyIEZPTlRTID0gewogIGRpc3BsYXk6ICciQXZlbmlyIE5leHQiLCAiRnV0dXJhIiwgIlRyZWJ1Y2hldCBNUyIsIHNhbnMtc2VyaWYnLAogIGJvZHk6ICciQXZlbmlyIE5leHQiLCAiU2Vnb2UgVUkiLCBzYW5zLXNlcmlmJwp9Owp2YXIgbWFrZVN1cHBsZW1lbnRJbWFnZSA9ICh0aXRsZSwgc3VidGl0bGUsIHRvcENvbG9yLCBib3R0b21Db2xvcikgPT4gewogIGNvbnN0IHN2ZyA9IGA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDcyMCA0ODAiPgogIDxkZWZzPgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJiZyIgeDE9IjAiIHkxPSIwIiB4Mj0iMSIgeTI9IjEiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIke3RvcENvbG9yfSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIke2JvdHRvbUNvbG9yfSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI3MjAiIGhlaWdodD0iNDgwIiBmaWxsPSJ1cmwoI2JnKSIgcng9IjI0IiAvPgogIDxyZWN0IHg9IjI1MCIgeT0iNzAiIHdpZHRoPSIyMjAiIGhlaWdodD0iMzMwIiByeD0iMzgiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjk2IiAvPgogIDxyZWN0IHg9IjI5NSIgeT0iMzQiIHdpZHRoPSIxMzAiIGhlaWdodD0iNTIiIHJ4PSIxNCIgZmlsbD0iIzFCNDMzMiIgLz4KICA8cmVjdCB4PSIyNzUiIHk9IjE2OCIgd2lkdGg9IjE3MCIgaGVpZ2h0PSIxMjAiIHJ4PSIxOCIgZmlsbD0iJHt0b3BDb2xvcn0iIG9wYWNpdHk9IjAuODgiIC8+CiAgPHRleHQgeD0iMzYwIiB5PSIyMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMzQiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iIzFCNDMzMiI+JHt0aXRsZX08L3RleHQ+CiAgPHRleHQgeD0iMzYwIiB5PSIyNTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZmlsbD0iIzFCNDMzMiI+JHtzdWJ0aXRsZX08L3RleHQ+CiAgPHRleHQgeD0iMzYwIiB5PSI0NDQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZmlsbD0iI0ZGRkZGRiIgb3BhY2l0eT0iMC45NSI+U3VwcGxlbWVudCBQaWNrPC90ZXh0PgogIDwvc3ZnPmA7CiAgcmV0dXJuIGBkYXRhOmltYWdlL3N2Zyt4bWw7dXRmOCwke2VuY29kZVVSSUNvbXBvbmVudChzdmcpfWA7Cn07CnZhciBTVVBQTEVNRU5UX1ZJU1VBTF9MSUJSQVJZID0gewogIHByb3RlaW46IHsKICAgIGltYWdlOiBtYWtlU3VwcGxlbWVudEltYWdlKCJQcm90ZWluIiwgIldoZXkgLyBQbGFudCIsICIjRDdGMEUzIiwgIiM4NEI1OUYiKSwKICAgIGFtYXpvblVybDogImh0dHBzOi8vd3d3LmFtYXpvbi5jb20vcz9rPXByb3RlaW4rcG93ZGVyIgogIH0sCiAgY3JlYXRpbmU6IHsKICAgIGltYWdlOiBtYWtlU3VwcGxlbWVudEltYWdlKCJDcmVhdGluZSIsICJNb25vaHlkcmF0ZSIsICIjREJFQUZFIiwgIiM2MEE1RkEiKSwKICAgIGFtYXpvblVybDogImh0dHBzOi8vd3d3LmFtYXpvbi5jb20vcz9rPWNyZWF0aW5lK21vbm9oeWRyYXRlIgogIH0sCiAgZmliZXI6IHsKICAgIGltYWdlOiBtYWtlU3VwcGxlbWVudEltYWdlKCJGaWJlciIsICJQc3lsbGl1bSIsICIjRkVGM0M3IiwgIiNGNTlFMEIiKSwKICAgIGFtYXpvblVybDogImh0dHBzOi8vd3d3LmFtYXpvbi5jb20vcz9rPXBzeWxsaXVtK2h1c2srZmliZXIiCiAgfSwKICBtYWduZXNpdW06IHsKICAgIGltYWdlOiBtYWtlU3VwcGxlbWVudEltYWdlKCJNYWduZXNpdW0iLCAiR2x5Y2luYXRlIiwgIiNFREU5RkUiLCAiI0E3OEJGQSIpLAogICAgYW1hem9uVXJsOiAiaHR0cHM6Ly93d3cuYW1hem9uLmNvbS9zP2s9bWFnbmVzaXVtK2dseWNpbmF0ZSIKICB9LAogIGVsZWN0cm9seXRlOiB7CiAgICBpbWFnZTogbWFrZVN1cHBsZW1lbnRJbWFnZSgiRWxlY3Ryb2x5dGVzIiwgIlN1Z2FyLUZyZWUiLCAiI0RDRkNFNyIsICIjMzREMzk5IiksCiAgICBhbWF6b25Vcmw6ICJodHRwczovL3d3dy5hbWF6b24uY29tL3M/az1zdWdhcitmcmVlK2VsZWN0cm9seXRlK3Bvd2RlciIKICB9LAogIG9tZWdhMzogewogICAgaW1hZ2U6IG1ha2VTdXBwbGVtZW50SW1hZ2UoIk9tZWdhLTMiLCAiRVBBIC8gREhBIiwgIiNGRkU0RTYiLCAiI0ZCNzE4NSIpLAogICAgYW1hem9uVXJsOiAiaHR0cHM6Ly93d3cuYW1hem9uLmNvbS9zP2s9b21lZ2ErMytmaXNoK29pbCIKICB9Cn07CnZhciBTVVBQTEVNRU5UX1BIT1RPX0RJUiA9ICIvYXNzZXRzL3N1cHBsZW1lbnQtcGhvdG9zIjsKdmFyIFNVUFBMRU1FTlRfUEhPVE9fQUxJQVNFUyA9IHsKICBwcm90ZWluOiBbInByb3RlaW4iLCAicHJvdGVpbi1zaGFrZSIsICJydGQtcHJvdGVpbiJdLAogIGNyZWF0aW5lOiBbImNyZWF0aW5lIiwgImNyZWF0aW5lLW1vbm9oeWRyYXRlIl0sCiAgZmliZXI6IFsiZmliZXIiLCAiZmliZXItYmxlbmQiLCAicHN5bGxpdW0tZmliZXIiXSwKICBtYWduZXNpdW06IFsibWFnbmVzaXVtIiwgIm1hZ25lc2l1bS1nbHljaW5hdGUiXSwKICBlbGVjdHJvbHl0ZTogWyJlbGVjdHJvbHl0ZSIsICJlbGVjdHJvbHl0ZXMiLCAiZWxlY3Ryb2x5dGUtbWl4Il0sCiAgb21lZ2EzOiBbIm9tZWdhLTMiLCAib21lZ2EzIiwgImZpc2gtb2lsIl0KfTsKdmFyIEZFQVRVUkVEX1NVUFBMRU1FTlRTID0gWwogIHsKICAgIG5hbWU6ICJHTFAtMSBCdXJuZXIgVW5sZWFzaGVkIiwKICAgIGNhcmRUaXRsZTogIkdMUC0xIEJ1cm5lciBVbmxlYXNoZWQiLAogICAgYW1hem9uVXJsOiAiaHR0cHM6Ly9hbXpuLnRvLzRhdWNNQnUiLAogICAgcGhvdG9MYWJlbHM6IFsiZ2xwMV9idXJuZXIiXQogIH0sCiAgewogICAgbmFtZTogIlN0cmlwZmFzdDUwMDAgV2VpZ2h0IE1hbmFnZW1lbnQgU3VwcG9ydCArIFJlbGF4YXRpb24gQ2Fwc3VsZXMiLAogICAgY2FyZFRpdGxlOiAiU3RyaXBmYXN0NTAwMCBXZWlnaHQgTWFuYWdlbWVudCBTdXBwb3J0IiwKICAgIGFtYXpvblVybDogImh0dHBzOi8vYW16bi50by80cjZXUHExIiwKICAgIHBob3RvTGFiZWxzOiBbInN0cmlwZmFzdF9uaWdodF9idWxsZXRzIl0KICB9LAogIHsKICAgIG5hbWU6ICJNZXRhYm9saWMgSGVhbHRoIC0gR3V0IEhlYWx0aCBTdXBwbGVtZW50IHRvIEFpZCBXZWlnaHQgTWFuYWdlbWVudCogLSBGb3JtdWxhdGVkIHdpdGggQmVyZ2Ftb3QgYW5kIFR1cm1lcmljIChDdXJjdW1pbiBQaHl0b3NvbWUpIiwKICAgIGNhcmRUaXRsZTogIk1ldGFib2xpYyBIZWFsdGggLSBHdXQgSGVhbHRoIFN1cHBsZW1lbnQiLAogICAgYW1hem9uVXJsOiAiaHR0cHM6Ly9hbXpuLnRvLzRhSG5YRlAiLAogICAgcGhvdG9MYWJlbHM6IFsibWV0YWJvbGljIGhlYWx0aCB0aG9ybmUiXQogIH0KXTsKdmFyIGdldFN1cHBsZW1lbnRLZXkgPSAobmFtZSkgPT4gewogIGNvbnN0IGxvd2VyTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICBpZiAobG93ZXJOYW1lLmluY2x1ZGVzKCJjcmVhdGluZSIpKSByZXR1cm4gImNyZWF0aW5lIjsKICBpZiAobG93ZXJOYW1lLmluY2x1ZGVzKCJwc3lsbGl1bSIpIHx8IGxvd2VyTmFtZS5pbmNsdWRlcygiZmliZXIiKSkgcmV0dXJuICJmaWJlciI7CiAgaWYgKGxvd2VyTmFtZS5pbmNsdWRlcygibWFnbmVzaXVtIikpIHJldHVybiAibWFnbmVzaXVtIjsKICBpZiAobG93ZXJOYW1lLmluY2x1ZGVzKCJlbGVjdHJvbHl0ZSIpKSByZXR1cm4gImVsZWN0cm9seXRlIjsKICBpZiAobG93ZXJOYW1lLmluY2x1ZGVzKCJvbWVnYSIpKSByZXR1cm4gIm9tZWdhMyI7CiAgcmV0dXJuICJwcm90ZWluIjsKfTsKdmFyIG5vcm1hbGl6ZVN1cHBsZW1lbnRGaWxlTGFiZWwgPSAodmFsdWUpID0+IHsKICByZXR1cm4gdmFsdWUudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8mL2csICJhbmQiKS5yZXBsYWNlKC9cKy9nLCAicGx1cyIpLnJlcGxhY2UoL1teYS16MC05XSsvZywgIi0iKS5yZXBsYWNlKC9eLSt8LSskL2csICIiKTsKfTsKdmFyIGJ1aWxkU3VwcGxlbWVudFBob3RvQ2FuZGlkYXRlcyA9IChuYW1lLCBjdXN0b21MYWJlbHMgPSBbXSkgPT4gewogIGNvbnN0IGtleSA9IGdldFN1cHBsZW1lbnRLZXkobmFtZSk7CiAgY29uc3QgbGFiZWxzID0gQXJyYXkuZnJvbSgKICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsKICAgICAgLi4uY3VzdG9tTGFiZWxzLAogICAgICAuLi5jdXN0b21MYWJlbHMubWFwKChsYWJlbCkgPT4gbm9ybWFsaXplU3VwcGxlbWVudEZpbGVMYWJlbChsYWJlbCkpLAogICAgICBuYW1lLAogICAgICBub3JtYWxpemVTdXBwbGVtZW50RmlsZUxhYmVsKG5hbWUpLAogICAgICAuLi5TVVBQTEVNRU5UX1BIT1RPX0FMSUFTRVNba2V5XQogICAgXSkKICApLmZpbHRlcihCb29sZWFuKTsKICBjb25zdCBleHRlbnNpb25zID0gWyJ3ZWJwIiwgInBuZyIsICJqcGciLCAianBlZyJdOwogIHJldHVybiBsYWJlbHMuZmxhdE1hcCgobGFiZWwpID0+IGV4dGVuc2lvbnMubWFwKChleHQpID0+IGAke1NVUFBMRU1FTlRfUEhPVE9fRElSfS8ke2VuY29kZVVSSUNvbXBvbmVudChsYWJlbCl9LiR7ZXh0fWApKTsKfTsKdmFyIGdldFN1cHBsZW1lbnRWaXN1YWwgPSAobmFtZSkgPT4gewogIHJldHVybiBTVVBQTEVNRU5UX1ZJU1VBTF9MSUJSQVJZW2dldFN1cHBsZW1lbnRLZXkobmFtZSldOwp9Owp2YXIgUVVJWl9TVEFURV9LRVkgPSAiV0VJR0hUX0xPU1NfUVVJWl9TVEFURSI7CnZhciBFTkpPWV9WT1RFX0tFWSA9ICJXRUlHSFRfTE9TU19RVUlaX0VOSk9ZX1ZPVEUiOwp2YXIgUFJPRklMRV9PUkRFUiA9IFsKICAic3RydWN0dXJlZF9hY2hpZXZlciIsCiAgImJ1c3lfbWluaW1hbGlzdCIsCiAgImNyYXZpbmdfY3J1c2hlciIsCiAgIndlZWtlbmRfd2FycmlvciIsCiAgIm1vbWVudHVtX2J1aWxkZXIiCl07CnZhciBBUkNIRVRZUEVfVklTVUFMUyA9IHsKICBzdHJ1Y3R1cmVkX2FjaGlldmVyOiB7CiAgICBjb2RlOiAiU0EiLAogICAgaGVhZGxpbmU6ICJCdWlsdCBmb3IgcHJlY2lzaW9uLCBzdHJ1Y3R1cmUsIGFuZCB2aXNpYmxlIHByb2dyZXNzLiIsCiAgICBwaWxsYXJzOiBbCiAgICAgIHsgbGV0dGVyOiAiUyIsIHRpdGxlOiAiU3lzdGVtcyIsIGRldGFpbDogIllvdSB0aHJpdmUgb24gY2xlYXIgcnVsZXMsIHJvdXRpbmVzLCBhbmQgY2hlY2tsaXN0cy4iLCBjb2xvcjogIiMyRjgwRUQiIH0sCiAgICAgIHsgbGV0dGVyOiAiQSIsIHRpdGxlOiAiQWRqdXN0bWVudHMiLCBkZXRhaWw6ICJZb3UgaW1wcm92ZSBxdWlja2x5IHdoZW4gcmV2aWV3aW5nIGRhdGEgd2Vla2x5LiIsIGNvbG9yOiAiIzI3QUU2MCIgfSwKICAgICAgeyBsZXR0ZXI6ICJSIiwgdGl0bGU6ICJSZXN1bHRzIiwgZGV0YWlsOiAiU2VlaW5nIG1lYXN1cmFibGUgd2lucyBrZWVwcyBtb3RpdmF0aW9uIGhpZ2guIiwgY29sb3I6ICIjRjI5OTRBIiB9CiAgICBdCiAgfSwKICBidXN5X21pbmltYWxpc3Q6IHsKICAgIGNvZGU6ICJCTSIsCiAgICBoZWFkbGluZTogIlNpbXBsZSBkZWZhdWx0cyBiZWF0IGNvbXBsaWNhdGVkIHBsYW5zIGV2ZXJ5IHRpbWUuIiwKICAgIHBpbGxhcnM6IFsKICAgICAgeyBsZXR0ZXI6ICJCIiwgdGl0bGU6ICJCYXNlbGluZXMiLCBkZXRhaWw6ICJZb3UgbmVlZCBub24tbmVnb3RpYWJsZSBtaW5pbXVtcyB0aGF0IGZpdCBidXN5IGRheXMuIiwgY29sb3I6ICIjMUY3OEI0IiB9LAogICAgICB7IGxldHRlcjogIk0iLCB0aXRsZTogIk1pbmltYWxpc20iLCBkZXRhaWw6ICJMb3ctZnJpY3Rpb24gbWVhbHMgYW5kIHJvdXRpbmVzIHJlZHVjZSBkZWNpc2lvbiBmYXRpZ3VlLiIsIGNvbG9yOiAiIzMzQTAyQyIgfSwKICAgICAgeyBsZXR0ZXI6ICJGIiwgdGl0bGU6ICJGbG93IiwgZGV0YWlsOiAiTW9tZW50dW0gY29tZXMgZnJvbSByZXBlYXRhYmxlIHN5c3RlbXMsIG5vdCB3aWxscG93ZXIgc3Bpa2VzLiIsIGNvbG9yOiAiI0ZGN0YwMCIgfQogICAgXQogIH0sCiAgY3JhdmluZ19jcnVzaGVyOiB7CiAgICBjb2RlOiAiQ0MiLAogICAgaGVhZGxpbmU6ICJTYXRpZXR5IGFuZCB0cmlnZ2VyIGNvbnRyb2wgYXJlIHlvdXIgc3VwZXJwb3dlci4iLAogICAgcGlsbGFyczogWwogICAgICB7IGxldHRlcjogIkMiLCB0aXRsZTogIkNvbnRyb2wiLCBkZXRhaWw6ICJZb3Ugd2luIHdoZW4gaGlnaC1yaXNrIHRyaWdnZXIgbW9tZW50cyBhcmUgcHJlLXBsYW5uZWQuIiwgY29sb3I6ICIjRTMxQTFDIiB9LAogICAgICB7IGxldHRlcjogIlMiLCB0aXRsZTogIlNhdGlldHkiLCBkZXRhaWw6ICJQcm90ZWluICsgZmliZXIgc3RydWN0dXJlIGxvd2VycyB1cmdlLWRyaXZlbiBlYXRpbmcuIiwgY29sb3I6ICIjRkI5QTk5IiB9LAogICAgICB7IGxldHRlcjogIlIiLCB0aXRsZTogIlJlc2lsaWVuY2UiLCBkZXRhaWw6ICJPbmUgYmV0dGVyIHJlc3BvbnNlIGJlYXRzIGFsbC1vci1ub3RoaW5nIGN5Y2xlcy4iLCBjb2xvcjogIiM2QTNEOUEiIH0KICAgIF0KICB9LAogIHdlZWtlbmRfd2FycmlvcjogewogICAgY29kZTogIldXIiwKICAgIGhlYWRsaW5lOiAiWW91ciB3ZWVrZGF5cyBhcmUgc3Ryb25nOyB3ZWVrZW5kcyBhcmUgdGhlIHVubG9jay4iLAogICAgcGlsbGFyczogWwogICAgICB7IGxldHRlcjogIlciLCB0aXRsZTogIldlZWtkYXkgQmFzZSIsIGRldGFpbDogIllvdSBhbHJlYWR5IGhhdmUgYSBzb2xpZCBiYXNlbGluZSByb3V0aW5lIGluIHBsYWNlLiIsIGNvbG9yOiAiIzFENEU4OSIgfSwKICAgICAgeyBsZXR0ZXI6ICJHIiwgdGl0bGU6ICJHdWFyZHJhaWxzIiwgZGV0YWlsOiAiUHJlLWNvbW1pdHRlZCBzb2NpYWwgcnVsZXMgcHJldmVudCB3ZWVrZW5kIGRyaWZ0LiIsIGNvbG9yOiAiI0Y1OUUwQiIgfSwKICAgICAgeyBsZXR0ZXI6ICJSIiwgdGl0bGU6ICJSZWNvdmVyeSIsIGRldGFpbDogIkZhc3QgcmVzZXRzIGtlZXAgb25lIGV2ZW50IGZyb20gYmVjb21pbmcgYSBsb3N0IHdlZWsuIiwgY29sb3I6ICIjMTBCOTgxIiB9CiAgICBdCiAgfSwKICBtb21lbnR1bV9idWlsZGVyOiB7CiAgICBjb2RlOiAiTUIiLAogICAgaGVhZGxpbmU6ICJTbWFsbCB3aW5zIGNvbXBvdW5kIGludG8gbG9uZy10ZXJtIHRyYW5zZm9ybWF0aW9uLiIsCiAgICBwaWxsYXJzOiBbCiAgICAgIHsgbGV0dGVyOiAiTSIsIHRpdGxlOiAiTW9tZW50dW0iLCBkZXRhaWw6ICJTaG9ydCBkYWlseSB3aW5zIGNyZWF0ZSBhIHN0cmVhayB3b3J0aCBwcm90ZWN0aW5nLiIsIGNvbG9yOiAiIzBFQTVFOSIgfSwKICAgICAgeyBsZXR0ZXI6ICJDIiwgdGl0bGU6ICJDb25maWRlbmNlIiwgZGV0YWlsOiAiWW91IHByb2dyZXNzIHdoZW4gZ29hbHMgZmVlbCBhY2hpZXZhYmxlIGFuZCByZXBlYXRhYmxlLiIsIGNvbG9yOiAiIzIyQzU1RSIgfSwKICAgICAgeyBsZXR0ZXI6ICJQIiwgdGl0bGU6ICJQcm9ncmVzc2lvbiIsIGRldGFpbDogIkFkZCBpbnRlbnNpdHkgb25seSBhZnRlciBjb25zaXN0ZW5jeSBpcyBzdGFibGUuIiwgY29sb3I6ICIjOEI1Q0Y2IiB9CiAgICBdCiAgfQp9Owp2YXIgUFJPRklMRVMgPSB7CiAgc3RydWN0dXJlZF9hY2hpZXZlcjogewogICAgbGFiZWw6ICJTdHJ1Y3R1cmVkIEFjaGlldmVyIiwKICAgIHRhZzogIkRhdGEtZnJpZW5kbHkgYW5kIHJvdXRpbmUtZHJpdmVuIiwKICAgIGRlc2NyaXB0aW9uOiBbCiAgICAgICJZb3UgcGVyZm9ybSBiZXN0IHdoZW4geW91ciBwbGFuIGlzIG1lYXN1cmFibGUsIHZpc2libGUsIGFuZCBlYXN5IHRvIHJldmlldyBlYWNoIHdlZWsuIiwKICAgICAgIkluc3RlYWQgb2YgcmVseWluZyBvbiBtb3RpdmF0aW9uLCB5b3VyIHByb2dyZXNzIGFjY2VsZXJhdGVzIHdoZW4geW91IHVzZSBjbGVhciB0YXJnZXRzIGZvciBwcm90ZWluLCBjYWxvcmllcywgYW5kIHdvcmtvdXRzLiIsCiAgICAgICJZb3VyIGVkZ2UgaXMgY29uc2lzdGVuY3kgdGhyb3VnaCBzdHJ1Y3R1cmUsIG5vdCBleHRyZW1lIGRpZXRpbmcuIgogICAgXSwKICAgIGZpcnN0Rm9jdXM6ICJCdWlsZCBvbmUgc2ltcGxlIGRhc2hib2FyZCB0aGlzIHdlZWs6IHByb3RlaW4gdGFyZ2V0LCBjYWxvcmllIHJhbmdlLCBzdGVwcywgYW5kIHN0cmVuZ3RoIHNlc3Npb25zLiIsCiAgICB3ZWVrUGxhbjogWwogICAgICB7IGRheTogIkRheSAxIiwgZm9jdXM6ICJTZXQgeW91ciBzY29yZWJvYXJkIiwgZGV0YWlsczogIkRlZmluZSB5b3VyIGNhbG9yaWUgcmFuZ2UsIHByb3RlaW4gbWluaW11bSwgaHlkcmF0aW9uIGdvYWwsIGFuZCBkYWlseSBzdGVwIGZsb29yIGluIG9uZSBub3RlIGFwcC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDIiLCBmb2N1czogIkxvY2sgeW91ciBtZWFsIGZyYW1ld29yayIsIGRldGFpbHM6ICJQaWNrIGJyZWFrZmFzdCwgbHVuY2gsIGFuZCBkaW5uZXIgdGVtcGxhdGVzIHNvIHlvdXIgd2Vla2RheXMgcnVuIG9uIGF1dG9waWxvdC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDMiLCBmb2N1czogIlN0cmVuZ3RoIHNlc3Npb24gMSIsIGRldGFpbHM6ICJDb21wbGV0ZSBhIGZ1bGwtYm9keSBsaWZ0IGFuZCBsb2cgc2V0cy9yZXBzLiBBaW0gZm9yIDQ1LTYwIG1pbnV0ZXMuIiB9LAogICAgICB7IGRheTogIkRheSA0IiwgZm9jdXM6ICJBdWRpdCBodW5nZXIgdHJpZ2dlcnMiLCBkZXRhaWxzOiAiUmV2aWV3IHllc3RlcmRheSdzIGZvb2QgbG9nIGFuZCBpZGVudGlmeSB3aGVyZSBjcmF2aW5ncyBvciBsb3ctcHJvdGVpbiBtZWFscyBhcHBlYXJlZC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDUiLCBmb2N1czogIlN0cmVuZ3RoIHNlc3Npb24gMiIsIGRldGFpbHM6ICJSZXBlYXQgZnVsbC1ib2R5IG9yIHVwcGVyL2xvd2VyIHNwbGl0IGFuZCBrZWVwIHByb2dyZXNzaXZlIG92ZXJsb2FkIHNpbXBsZS4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDYiLCBmb2N1czogIldlZWtlbmQgZ3VhcmRyYWlscyIsIGRldGFpbHM6ICJQcmUtcGxhbiBzb2NpYWwgbWVhbHMgYW5kIGRlZmluZSBhbiBhbGNvaG9sL2Rlc3NlcnQgY2FwIGJlZm9yZSB0aGUgZGF5IHN0YXJ0cy4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDciLCBmb2N1czogIldlZWtseSByZXZpZXciLCBkZXRhaWxzOiAiQ2hlY2sgYWRoZXJlbmNlLCBzY2FsZSB0cmVuZCwgYW5kIGVuZXJneS4gQWRqdXN0IG9uZSB2YXJpYWJsZSBvbmx5IGZvciBuZXh0IHdlZWsuIiB9CiAgICBdLAogICAgc3VwcGxlbWVudHM6IFsKICAgICAgeyBuYW1lOiAiUHJvdGVpbiBwb3dkZXIgKHdoZXkgb3IgcGxhbnQpIiwgaG93OiAiVXNlIDEgc2VydmluZyAoMjAtMzVnIHByb3RlaW4pIHRvIGNsb3NlIHByb3RlaW4gZ2Fwcy4iLCB3aHk6ICJIaWdoZXIgcHJvdGVpbiBzdXBwb3J0cyBzYXRpZXR5IGFuZCBoZWxwcyBwcmVzZXJ2ZSBtdXNjbGUgZHVyaW5nIGZhdCBsb3NzLiIsIG5vdGU6ICJDaG9vc2UgcHJvZHVjdHMgd2l0aCB0aGlyZC1wYXJ0eSB0ZXN0aW5nIHdoZW4gcG9zc2libGUuIiB9LAogICAgICB7IG5hbWU6ICJDcmVhdGluZSBtb25vaHlkcmF0ZSIsIGhvdzogIjMtNWcgZGFpbHksIGFueSB0aW1lIG9mIGRheS4iLCB3aHk6ICJTdXBwb3J0cyBzdHJlbmd0aCBwZXJmb3JtYW5jZSBhbmQgbGVhbiBtYXNzIHdoaWxlIGRpZXRpbmcuIiwgbm90ZTogIkNhbiBjYXVzZSBzbGlnaHQgd2F0ZXIgcmV0ZW50aW9uOyB0aGlzIGlzIGV4cGVjdGVkLiIgfSwKICAgICAgeyBuYW1lOiAiUHN5bGxpdW0gaHVzayBmaWJlciIsIGhvdzogIjUtMTBnIGRhaWx5IHdpdGggcGxlbnR5IG9mIHdhdGVyLiIsIHdoeTogIkltcHJvdmVzIGZ1bGxuZXNzIGFuZCBjYW4gbWFrZSBhcHBldGl0ZSBjb250cm9sIGVhc2llci4iLCBub3RlOiAiU3RhcnQgbG93IGFuZCBpbmNyZWFzZSBncmFkdWFsbHkgdG8gYXZvaWQgR0kgZGlzY29tZm9ydC4iIH0KICAgIF0sCiAgICBtZW50b3Jpbmc6IFsKICAgICAgeyBsYWJlbDogIk5vb20iLCB1cmw6ICJodHRwczovL3d3dy5ub29tLmNvbS8iLCBub3RlOiAiQmVoYXZpb3IgY29hY2hpbmcgYW5kIGhhYml0IGFjY291bnRhYmlsaXR5IGZvciBkYWlseSBleGVjdXRpb24uIiB9LAogICAgICB7IGxhYmVsOiAiUHJlY2lzaW9uIE51dHJpdGlvbiBDb2FjaGluZyIsIHVybDogImh0dHBzOi8vd3d3LnByZWNpc2lvbm51dHJpdGlvbi5jb20vY29hY2hpbmciLCBub3RlOiAiU3RydWN0dXJlZCBjb2FjaGluZyB3aXRoIGNsZWFyIG51dHJpdGlvbiBtaWxlc3RvbmVzLiIgfSwKICAgICAgeyBsYWJlbDogIkZpbmQgYSBSZWdpc3RlcmVkIERpZXRpdGlhbiIsIHVybDogImh0dHBzOi8vd3d3LmVhdHJpZ2h0Lm9yZy9maW5kLWEtbnV0cml0aW9uLWV4cGVydCIsIG5vdGU6ICJHcmVhdCBvcHRpb24gZm9yIHBlcnNvbmFsaXplZCBudXRyaXRpb24gYW5kIG1lZGljYWwgY29udGV4dC4iIH0KICAgIF0sCiAgICByZWNpcGVzOiBbCiAgICAgIHsgbmFtZTogIk1hY3JvIFBvd2VyIEJvd2wiLCB3aHk6ICJIaWdoLXByb3RlaW4gYW5kIGVhc3kgdG8gdHJhY2sgZm9yIGNvbnNpc3RlbmN5LiIsIGJ1aWxkOiAiQ2hpY2tlbiBicmVhc3QsIHF1aW5vYSwgcm9hc3RlZCB2ZWdldGFibGVzLCBvbGl2ZSBvaWwsIGFuZCBsZW1vbi4iIH0sCiAgICAgIHsgbmFtZTogIkdyZWVrIFlvZ3VydCBQcm90ZWluIFBhcmZhaXQiLCB3aHk6ICJGYXN0LCBtZWFzdXJhYmxlIGJyZWFrZmFzdCB3aXRoIGhpZ2ggc2F0aWV0eS4iLCBidWlsZDogIkdyZWVrIHlvZ3VydCwgd2hleSBzY29vcCwgYmVycmllcywgY2hpYSBzZWVkcywgYW5kIGFsbW9uZHMuIiB9LAogICAgICB7IG5hbWU6ICJTaGVldC1QYW4gU2FsbW9uIFBsYXRlIiwgd2h5OiAiU3RydWN0dXJlZCBkaW5uZXIgdGVtcGxhdGUgd2l0aCBwcm90ZWluICsgZmliZXIuIiwgYnVpbGQ6ICJTYWxtb24gZmlsbGV0LCBicm9jY29saSwgc3dlZXQgcG90YXRvLCBnYXJsaWMsIGFuZCBvbGl2ZSBvaWwuIiB9CiAgICBdLAogICAgYXZvaWQ6ICJBdm9pZCBwZXJmZWN0aW9uIG1vZGUgd2hlcmUgb25lIG9mZi1wbGFuIG1lYWwgdHVybnMgaW50byBhbiBvZmYtcGxhbiB3ZWVrLiIsCiAgICB0aW1lbGluZTogIkV4cGVjdCB2aXNpYmxlIG1vbWVudHVtIGluIDItMyB3ZWVrcyB3aXRoIGNvbnNpc3RlbnQgdHJhY2tpbmcuIiwKICAgIGFjY2VudDogQ09MT1JTLnByaW1hcnksCiAgICBiZzogQ09MT1JTLmFjY2VudExpZ2h0CiAgfSwKICBidXN5X21pbmltYWxpc3Q6IHsKICAgIGxhYmVsOiAiQnVzeSBNaW5pbWFsaXN0IiwKICAgIHRhZzogIkxvdy1mcmljdGlvbiBoYWJpdHMgd2luIiwKICAgIGRlc2NyaXB0aW9uOiBbCiAgICAgICJZb3UgYXJlIG5vdCBsYWNraW5nIGRpc2NpcGxpbmU7IHlvdXIgc2NoZWR1bGUgaXMgc2ltcGx5IG92ZXJsb2FkZWQgYW5kIGRlY2lzaW9uIGZhdGlndWUgaXMgaGlnaC4iLAogICAgICAiVGhlIGJlc3Qgc3RyYXRlZ3kgZm9yIHlvdSBpcyByZW1vdmluZyBjb21wbGV4aXR5IHNvIGhlYWx0aHkgY2hvaWNlcyBoYXBwZW4gYXV0b21hdGljYWxseSBldmVuIG9uIGNoYW90aWMgZGF5cy4iLAogICAgICAiV2hlbiB5b3VyIHN5c3RlbSBpcyBzaW1wbGUsIHlvdXIgY29uc2lzdGVuY3kgY2FuIG91dHBlcmZvcm0gbW9yZSBhZ2dyZXNzaXZlIHBsYW5zLiIKICAgIF0sCiAgICBmaXJzdEZvY3VzOiAiQnVpbGQgYSBsb3ctZnJpY3Rpb24gcm91dGluZSB3aXRoIHJlcGVhdGFibGUgbWVhbHMsIHByZWRpY3RhYmxlIHNob3BwaW5nLCBhbmQgb25lIG1vdmVtZW50IG1pbmltdW0uIiwKICAgIHdlZWtQbGFuOiBbCiAgICAgIHsgZGF5OiAiRGF5IDEiLCBmb2N1czogIkNyZWF0ZSB5b3VyIGVtZXJnZW5jeSBtZW51IiwgZGV0YWlsczogIldyaXRlIDMgcXVpY2sgbWVhbHMgYW5kIDIgc25hY2tzIHlvdSBjYW4gZXhlY3V0ZSBpbiB1bmRlciAxMCBtaW51dGVzLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgMiIsIGZvY3VzOiAiQmF0Y2gtcHJlcCBiYXNpY3MiLCBkZXRhaWxzOiAiQ29vayBwcm90ZWluLCBwcmVwIHZlZ2V0YWJsZXMsIGFuZCBwcmUtcG9ydGlvbiBncmFiLWFuZC1nbyBzbmFja3MuIiB9LAogICAgICB7IGRheTogIkRheSAzIiwgZm9jdXM6ICJNb3ZlbWVudCBtaW5pbXVtIiwgZGV0YWlsczogIlNldCBhIHJlYWxpc3RpYyBzdGVwIGZsb29yIGFuZCBzdGFjayBvbmUgMTUtbWludXRlIHdhbGsgYWZ0ZXIgYSBtZWFsLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNCIsIGZvY3VzOiAiQ2FsZW5kYXItcHJvb2YgeW91ciBwbGFuIiwgZGV0YWlsczogIklkZW50aWZ5IHlvdXIgYnVzaWVzdCAyIGJsb2NrcyBhbmQgcHJlLWFzc2lnbiBtZWFscyBmb3IgdGhvc2Ugd2luZG93cy4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDUiLCBmb2N1czogIlRpZ2h0ZW4geW91ciBlbnZpcm9ubWVudCIsIGRldGFpbHM6ICJQbGFjZSBoaWdoLXByb3RlaW4gb3B0aW9ucyBhdCBleWUgbGV2ZWwgYW5kIGhpZGUgdHJpZ2dlciBzbmFja3MuIiB9LAogICAgICB7IGRheTogIkRheSA2IiwgZm9jdXM6ICJTb2NpYWwgc2ltcGxpY2l0eSIsIGRldGFpbHM6ICJVc2Ugb25lIG9yZGVyaW5nIHJ1bGUgZm9yIHJlc3RhdXJhbnRzOiBwcm90ZWluIGZpcnN0LCB0aGVuIGZpYmVyLCB0aGVuIGNhcmJzLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNyIsIGZvY3VzOiAiUmVzZXQgKyByZWZpbGwiLCBkZXRhaWxzOiAiUmVwZWF0IGdyb2NlcnkgbGlzdCwgcHJlcCBpbiA0NSBtaW51dGVzLCBhbmQgbG9jayBpbiBuZXh0IHdlZWsncyBkZWZhdWx0cy4iIH0KICAgIF0sCiAgICBzdXBwbGVtZW50czogWwogICAgICB7IG5hbWU6ICJQcm90ZWluIHNoYWtlIG9yIFJURCBwcm90ZWluIiwgaG93OiAiVXNlIDEgc2VydmluZyB3aGVuIG1lYWxzIGFyZSBydXNoZWQuIiwgd2h5OiAiSGVscHMgcHJldmVudCBsb3ctcHJvdGVpbiBkYXlzIHRoYXQgZHJpdmUgbGF0ZSBjcmF2aW5ncy4iLCBub3RlOiAiTG9vayBmb3IgMjBnKyBwcm90ZWluIHdpdGggbG93IGFkZGVkIHN1Z2FyLiIgfSwKICAgICAgeyBuYW1lOiAiTWFnbmVzaXVtIGdseWNpbmF0ZSIsIGhvdzogIjIwMC0zNTBtZyBpbiB0aGUgZXZlbmluZy4iLCB3aHk6ICJNYXkgc3VwcG9ydCBzbGVlcCBxdWFsaXR5IGFuZCByZWNvdmVyeSBkdXJpbmcgc3RyZXNzZnVsIHdlZWtzLiIsIG5vdGU6ICJBdm9pZCBpZiBpdCBjb25mbGljdHMgd2l0aCB5b3VyIGNsaW5pY2lhbidzIGFkdmljZS4iIH0sCiAgICAgIHsgbmFtZTogIlBzeWxsaXVtIGZpYmVyIG9yIGZpYmVyIGJsZW5kIiwgaG93OiAiNWcgb25jZSBkYWlseSB0byBzdGFydC4iLCB3aHk6ICJIZWxwcyB3aXRoIGZ1bGxuZXNzIGFuZCBjb25zaXN0ZW5jeSB3aGVuIG1lYWxzIGFyZSBsaWdodCBvbiBwcm9kdWNlLiIsIG5vdGU6ICJJbmNyZWFzZSB3YXRlciBpbnRha2Ugd2hlbiBhZGRpbmcgZmliZXIuIiB9CiAgICBdLAogICAgbWVudG9yaW5nOiBbCiAgICAgIHsgbGFiZWw6ICJOb29tIiwgdXJsOiAiaHR0cHM6Ly93d3cubm9vbS5jb20vIiwgbm90ZTogIkdvb2QgZm9yIGJlaGF2aW9yIHByb21wdHMgYW5kIGhhYml0IHJlbWluZGVycyBvbiBidXN5IHNjaGVkdWxlcy4iIH0sCiAgICAgIHsgbGFiZWw6ICJXVyAoV2VpZ2h0V2F0Y2hlcnMpIiwgdXJsOiAiaHR0cHM6Ly93d3cud2VpZ2h0d2F0Y2hlcnMuY29tLyIsIG5vdGU6ICJTaW1wbGUgc3RydWN0dXJlIHdpdGggZmxleGlibGUgZm9vZCBjaG9pY2VzLiIgfSwKICAgICAgeyBsYWJlbDogIkZpbmQgYSBSZWdpc3RlcmVkIERpZXRpdGlhbiIsIHVybDogImh0dHBzOi8vd3d3LmVhdHJpZ2h0Lm9yZy9maW5kLWEtbnV0cml0aW9uLWV4cGVydCIsIG5vdGU6ICJVc2VmdWwgaWYgeW91IG5lZWQgYSBwbGFuIHRhaWxvcmVkIHRvIHlvdXIgd2Vla2x5IHdvcmtmbG93LiIgfQogICAgXSwKICAgIHJlY2lwZXM6IFsKICAgICAgeyBuYW1lOiAiMTAtTWludXRlIFJvdGlzc2VyaWUgV3JhcCIsIHdoeTogIk1pbmltYWwgcHJlcCBmb3IgcGFja2VkIHdlZWtkYXlzLiIsIGJ1aWxkOiAiUm90aXNzZXJpZSBjaGlja2VuLCB3aG9sZS13aGVhdCB3cmFwLCBzcGluYWNoLCBodW1tdXMsIGN1Y3VtYmVyLiIgfSwKICAgICAgeyBuYW1lOiAiTWljcm93YXZlIEVnZyAmIE9hdHMgQm93bCIsIHdoeTogIk9uZS1ib3dsIGJyZWFrZmFzdCB3aXRoIHByb3RlaW4gYW5kIGZpYmVyLiIsIGJ1aWxkOiAiRWdnIHdoaXRlcywgc3BpbmFjaCwgcXVpY2sgb2F0cywgc2Fsc2EsIGFuZCBzaHJlZGRlZCBjaGVlc2UuIiB9LAogICAgICB7IG5hbWU6ICJGcmVlemVyIFN0aXItRnJ5IFNob3J0Y3V0Iiwgd2h5OiAiUmVsaWFibGUgbG93LWZyaWN0aW9uIGRpbm5lciBkZWZhdWx0LiIsIGJ1aWxkOiAiRnJvemVuIHZlZ2dpZSBtaXgsIHByZS1jb29rZWQgcHJvdGVpbiwgbWljcm93YXZlIHJpY2UsIHNveS1naW5nZXIgc2F1Y2UuIiB9CiAgICBdLAogICAgYXZvaWQ6ICJBdm9pZCBvdmVyY29tcGxpY2F0ZWQgcGxhbnMgd2l0aCB0b28gbWFueSBydWxlcy4iLAogICAgdGltZWxpbmU6ICJFeHBlY3QgY29uc2lzdGVuY3kgZ2FpbnMgaW4gdGhlIGZpcnN0IHdlZWsgYW5kIGZhdC1sb3NzIHRyZW5kIGluIDMtNCB3ZWVrcy4iLAogICAgYWNjZW50OiAiIzZCNzA1QyIsCiAgICBiZzogIiNFQ0VBRTIiCiAgfSwKICBjcmF2aW5nX2NydXNoZXI6IHsKICAgIGxhYmVsOiAiQ3JhdmluZyBDcnVzaGVyIiwKICAgIHRhZzogIkFwcGV0aXRlIGFuZCB0cmlnZ2VycyBhcmUgdGhlIGxldmVyIiwKICAgIGRlc2NyaXB0aW9uOiBbCiAgICAgICJZb3VyIG1haW4gY2hhbGxlbmdlIGlzIG5vdCBlZmZvcnQsIGl0IGlzIGFwcGV0aXRlIHByZXNzdXJlIGFuZCB0cmlnZ2VyIGV4cG9zdXJlIGFjcm9zcyB0aGUgZGF5LiIsCiAgICAgICJXaGVuIG1lYWxzIGFyZSBtb3JlIGZpbGxpbmcgYW5kIHlvdXIgZW52aXJvbm1lbnQgaXMgZW5naW5lZXJlZCBmb3Igc3VjY2VzcywgY3JhdmluZ3MgbG9zZSB0aGVpciBwb3dlci4iLAogICAgICAiWW91IHdpbGwgbWFrZSB0aGUgZmFzdGVzdCBwcm9ncmVzcyBieSBpbXByb3Zpbmcgc2F0aWV0eSBiZWZvcmUgaW5jcmVhc2luZyByZXN0cmljdGlvbi4iCiAgICBdLAogICAgZmlyc3RGb2N1czogIkRlc2lnbiBodW5nZXItcHJvb2YgbWVhbHMgYW5kIHJlZHVjZSB0aGUgbnVtYmVyIG9mIGhpZ2gtdHJpZ2dlciBtb21lbnRzIGluIHlvdXIgaG9tZSBhbmQgcm91dGluZS4iLAogICAgd2Vla1BsYW46IFsKICAgICAgeyBkYXk6ICJEYXkgMSIsIGZvY3VzOiAiU2F0aWV0eSBiYXNlbGluZSIsIGRldGFpbHM6ICJTZXQgYSBwcm90ZWluIHRhcmdldCBwZXIgbWVhbCBhbmQgYWRkIG9uZSBoaWdoLWZpYmVyIGZvb2QgYXQgZWFjaCBlYXRpbmcgb2NjYXNpb24uIiB9LAogICAgICB7IGRheTogIkRheSAyIiwgZm9jdXM6ICJDcmF2aW5nIG1hcCIsIGRldGFpbHM6ICJJZGVudGlmeSB5b3VyIHRvcCAzIHRyaWdnZXIgdGltZXMgYW5kIHdyaXRlIGEgcmVwbGFjZW1lbnQgcGxhbiBmb3IgZWFjaC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDMiLCBmb2N1czogIktpdGNoZW4gcmVzZXQiLCBkZXRhaWxzOiAiUmVtb3ZlIG9yIHBvcnRpb24gaGlnaC10cmlnZ2VyIGZvb2RzOyBwbGFjZSBzdXBwb3J0aXZlIG9wdGlvbnMgaW4gZnJvbnQuIiB9LAogICAgICB7IGRheTogIkRheSA0IiwgZm9jdXM6ICJFdmVuaW5nIHN0cmF0ZWd5IiwgZGV0YWlsczogIlByZS1sb2cgZGlubmVyIGFuZCBhIHBsYW5uZWQgc25hY2sgdG8gYXZvaWQgdW5wbGFubmVkIGdyYXppbmcuIiB9LAogICAgICB7IGRheTogIkRheSA1IiwgZm9jdXM6ICJWb2x1bWUgZGF5IiwgZGV0YWlsczogIkJ1aWxkIGhpZ2gtdm9sdW1lIHBsYXRlcyAobGVhbiBwcm90ZWluLCB2ZWdldGFibGVzLCBmcnVpdCwgYnJvdGgtYmFzZWQgYWRkaXRpb25zKS4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDYiLCBmb2N1czogIlN0cmVzcyByZXNwb25zZSIsIGRldGFpbHM6ICJVc2UgYSAxMC1taW51dGUgcGF1c2Ugcm91dGluZSAod2FsaywgaHlkcmF0aW9uLCBicmVhdGhpbmcpIGJlZm9yZSByZWFjdGl2ZSBlYXRpbmcuIiB9LAogICAgICB7IGRheTogIkRheSA3IiwgZm9jdXM6ICJSZWZpbmUgYW5kIHJlcGVhdCIsIGRldGFpbHM6ICJSZXZpZXcgd2hpY2ggc3dhcHMgcmVkdWNlZCBjcmF2aW5ncyBtb3N0IGFuZCByZXBlYXQgdGhvc2UgbmV4dCB3ZWVrLiIgfQogICAgXSwKICAgIHN1cHBsZW1lbnRzOiBbCiAgICAgIHsgbmFtZTogIlByb3RlaW4gcG93ZGVyIiwgaG93OiAiMSBzZXJ2aW5nIHdoZW4gbWVhbHMgYXJlIHByb3RlaW4tbGlnaHQuIiwgd2h5OiAiSGVscHMgaW1wcm92ZSBmdWxsbmVzcyBhbmQgcmVkdWNlIHJlYm91bmQgaHVuZ2VyLiIsIG5vdGU6ICJBdm9pZCByZXBsYWNpbmcgZXZlcnkgbWVhbDsgdXNlIGFzIGEgc3VwcG9ydCB0b29sLiIgfSwKICAgICAgeyBuYW1lOiAiUHN5bGxpdW0gaHVzayBmaWJlciIsIGhvdzogIjUtMTBnIGRhaWx5IHNwbGl0IGludG8gMS0yIHNlcnZpbmdzLiIsIHdoeTogIkNhbiBpbXByb3ZlIHNhdGlldHkgYW5kIHJlZHVjZSB1cmdlLWRyaXZlbiBzbmFja2luZy4iLCBub3RlOiAiVGFrZSB3aXRoIGFkZXF1YXRlIHdhdGVyIGFuZCBzZXBhcmF0ZSBmcm9tIG1lZGljYXRpb25zIGlmIGFkdmlzZWQuIiB9LAogICAgICB7IG5hbWU6ICJNYWduZXNpdW0gZ2x5Y2luYXRlIiwgaG93OiAiMjAwLTM1MG1nIGluIGV2ZW5pbmcuIiwgd2h5OiAiTWF5IHN1cHBvcnQgc2xlZXAgYW5kIHN0cmVzcyByZWd1bGF0aW9uLCB3aGljaCBjYW4gcmVkdWNlIGNyYXZpbmdzLiIsIG5vdGU6ICJDaGVjayBzdWl0YWJpbGl0eSB3aXRoIHlvdXIgY2xpbmljaWFuLiIgfQogICAgXSwKICAgIG1lbnRvcmluZzogWwogICAgICB7IGxhYmVsOiAiTm9vbSIsIHVybDogImh0dHBzOi8vd3d3Lm5vb20uY29tLyIsIG5vdGU6ICJIZWxwZnVsIGZvciBtaW5kc2V0IGFuZCB0cmlnZ2VyLWF3YXJlbmVzcyBjb2FjaGluZy4iIH0sCiAgICAgIHsgbGFiZWw6ICJXVyAoV2VpZ2h0V2F0Y2hlcnMpIiwgdXJsOiAiaHR0cHM6Ly93d3cud2VpZ2h0d2F0Y2hlcnMuY29tLyIsIG5vdGU6ICJTdHJ1Y3R1cmUgd2l0aCBiZWhhdmlvciBzdXBwb3J0IGFuZCBjb21tdW5pdHkgYWNjb3VudGFiaWxpdHkuIiB9LAogICAgICB7IGxhYmVsOiAiRmluZCBhIFJlZ2lzdGVyZWQgRGlldGl0aWFuIiwgdXJsOiAiaHR0cHM6Ly93d3cuZWF0cmlnaHQub3JnL2ZpbmQtYS1udXRyaXRpb24tZXhwZXJ0Iiwgbm90ZTogIlVzZWZ1bCBmb3IgYXBwZXRpdGUgc3RyYXRlZ3kgYW5kIG1lZGljYWwgcGVyc29uYWxpemF0aW9uLiIgfQogICAgXSwKICAgIHJlY2lwZXM6IFsKICAgICAgeyBuYW1lOiAiR2lhbnQgQ3J1bmNoIFNhbGFkIiwgd2h5OiAiSGlnaCB2b2x1bWUgKyBwcm90ZWluIHRvIGN1cmIgYXBwZXRpdGUuIiwgYnVpbGQ6ICJMZXR0dWNlLCBjaGlja2VuLCBjaGlja3BlYXMsIGN1Y3VtYmVycywgdG9tYXRvZXMsIGxpZ2h0IGRyZXNzaW5nLiIgfSwKICAgICAgeyBuYW1lOiAiQ2hvY29sYXRlIFByb3RlaW4gUHVkZGluZyIsIHdoeTogIlNhdGlzZmllcyBkZXNzZXJ0IGNyYXZpbmdzIGluIGEgY29udHJvbGxlZCB3YXkuIiwgYnVpbGQ6ICJHcmVlayB5b2d1cnQsIGNvY29hIHBvd2RlciwgcHJvdGVpbiBwb3dkZXIsIGJlcnJpZXMuIiB9LAogICAgICB7IG5hbWU6ICJUYWNvIENhdWxpZmxvd2VyIFNraWxsZXQiLCB3aHk6ICJDcmF2aW5nLWZyaWVuZGx5IGNvbWZvcnQgbWVhbCB3aXRoIGZld2VyIGNhbG9yaWVzLiIsIGJ1aWxkOiAiTGVhbiBncm91bmQgdHVya2V5LCBjYXVsaWZsb3dlciByaWNlLCBzYWxzYSwgYmxhY2sgYmVhbnMsIGF2b2NhZG8uIiB9CiAgICBdLAogICAgYXZvaWQ6ICJBdm9pZCBsb25nIHVuZGVyLWVhdGluZyBzdHJldGNoZXMgdGhhdCByZWJvdW5kIGludG8gbmlnaHQgb3ZlcmVhdGluZy4iLAogICAgdGltZWxpbmU6ICJFeHBlY3QgZmV3ZXIgY3JhdmluZ3MgaW4gNy0xMCBkYXlzIGFuZCBzdGVhZGllciBmYXQgbG9zcyBieSB3ZWVrIDMuIiwKICAgIGFjY2VudDogQ09MT1JTLndhcm5pbmcsCiAgICBiZzogQ09MT1JTLndhcm5pbmdCZwogIH0sCiAgd2Vla2VuZF93YXJyaW9yOiB7CiAgICBsYWJlbDogIldlZWtlbmQgV2FycmlvciIsCiAgICB0YWc6ICJTdHJvbmcgd2Vla2RheXMsIGxvb3NlIHdlZWtlbmRzIiwKICAgIGRlc2NyaXB0aW9uOiBbCiAgICAgICJZb3VyIHdlZWtkYXkgc3RydWN0dXJlIGlzIHNvbGlkLCB3aGljaCBtZWFucyB5b3VyIHJlc3VsdHMgYXJlIG1vc3RseSBkZWNpZGVkIGJ5IDQ4IHdlZWtlbmQgaG91cnMuIiwKICAgICAgIllvdSBkbyBub3QgbmVlZCBhIHN0cmljdGVyIGRpZXQ7IHlvdSBuZWVkIGEgYmV0dGVyIHNvY2lhbCBzdHJhdGVneSBiZWZvcmUgZXZlbnRzIGJlZ2luLiIsCiAgICAgICJPbmNlIHdlZWtlbmRzIGJlY29tZSBjb250cm9sbGVkIGluc3RlYWQgb2YgY2hhb3RpYywgYm9keSBjb21wb3NpdGlvbiBjaGFuZ2VzIHF1aWNrbHkuIgogICAgXSwKICAgIGZpcnN0Rm9jdXM6ICJJbnN0YWxsIHdlZWtlbmQgZ3VhcmRyYWlscyBlYXJseTogcHJlLWNvbW1pdG1lbnRzIGZvciBhbGNvaG9sLCBwb3J0aW9ucywgYW5kIHBvc3QtZXZlbnQgcmVzZXRzLiIsCiAgICB3ZWVrUGxhbjogWwogICAgICB7IGRheTogIkRheSAxIiwgZm9jdXM6ICJXZWVrZW5kIHJ1bGVzIiwgZGV0YWlsczogIlNldCBzcGVjaWZpYyBsaW1pdHMgZm9yIGRyaW5rcywgZGVzc2VydHMsIGFuZCBsYXRlLW5pZ2h0IGVhdGluZy4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDIiLCBmb2N1czogIlByb3RlaW4gZnJvbnQtbG9hZCIsIGRldGFpbHM6ICJIaXQgcHJvdGVpbiBhdCBicmVha2Zhc3QvbHVuY2ggc28gZXZlbmluZyBzb2NpYWwgbWVhbHMgYXJlIGVhc2llciB0byBjb250cm9sLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgMyIsIGZvY3VzOiAiUmVzdGF1cmFudCBwbGF5Ym9vayIsIGRldGFpbHM6ICJVc2Ugb25lIHBsYXRlIG1ldGhvZDogcHJvdGVpbiBhbmNob3IsIHZlZ2V0YWJsZXMsIHRoZW4gb3B0aW9uYWwgZXh0cmFzLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNCIsIGZvY3VzOiAiRXZlbnQgYnVmZmVyIiwgZGV0YWlsczogIlRha2UgYSBwcmUtZXZlbnQgd2FsayBhbmQgaHlkcmF0ZSBiZWZvcmUgc29jaWFsIG1lYWxzLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNSIsIGZvY3VzOiAiQWxjb2hvbCBzdHJhdGVneSIsIGRldGFpbHM6ICJBbHRlcm5hdGUgZHJpbmtzIHdpdGggd2F0ZXIgYW5kIHNldCBhIGhhcmQgc3RvcCBiZWZvcmUgdGhlIGV2ZW50IHN0YXJ0cy4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDYiLCBmb2N1czogIkRhbWFnZS1jb250cm9sIHByb3RvY29sIiwgZGV0YWlsczogIklmIG9mZi1wbGFuLCByZXR1cm4gaW1tZWRpYXRlbHkgYXQgbmV4dCBtZWFsIGluc3RlYWQgb2Ygd2FpdGluZyBmb3IgTW9uZGF5LiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNyIsIGZvY3VzOiAiU3VuZGF5IHJlc2V0IiwgZGV0YWlsczogIlBsYW4gZ3JvY2VyaWVzLCBwcmVwIHByb3RlaW4sIGFuZCBzY2hlZHVsZSB3b3Jrb3V0cyBiZWZvcmUgYmVkLiIgfQogICAgXSwKICAgIHN1cHBsZW1lbnRzOiBbCiAgICAgIHsgbmFtZTogIlByb3RlaW4gcG93ZGVyIiwgaG93OiAiVXNlIDEgc2VydmluZyBiZWZvcmUgaGlnaC1yaXNrIHNvY2lhbCB3aW5kb3dzLiIsIHdoeTogIlJlZHVjZXMgYXBwZXRpdGUgYW5kIGltcHJvdmVzIHBvcnRpb24gY29udHJvbCBsYXRlci4iLCBub3RlOiAiS2VlcCBhIHJlYWR5LXRvLW1peCBzZXJ2aW5nIG9uIGhhbmQuIiB9LAogICAgICB7IG5hbWU6ICJFbGVjdHJvbHl0ZSBtaXggKHN1Z2FyLWZyZWUpIiwgaG93OiAiVXNlIGluIHdhdGVyIGFyb3VuZCBzb2NpYWwgZXZlbnRzIG9yIGFmdGVyIGludGVuc2UgYWN0aXZpdHkuIiwgd2h5OiAiU3VwcG9ydHMgaHlkcmF0aW9uIGFuZCBjYW4gcmVkdWNlIG92ZXJlYXRpbmcgZHJpdmVuIGJ5IGRlaHlkcmF0aW9uL2ZhdGlndWUuIiwgbm90ZTogIlBpY2sgbG93ZXItc29kaXVtIG9wdGlvbnMgaWYgbWVkaWNhbGx5IG5lZWRlZC4iIH0sCiAgICAgIHsgbmFtZTogIk9tZWdhLTMgKEVQQS9ESEEpIiwgaG93OiAiVXNlIGRhaWx5IHdpdGggbWVhbHMgcGVyIGxhYmVsIGd1aWRhbmNlLiIsIHdoeTogIk1heSBzdXBwb3J0IG92ZXJhbGwgaGVhbHRoIGFuZCByZWNvdmVyeSB3aGlsZSBpbXByb3Zpbmcgcm91dGluZSBjb25zaXN0ZW5jeS4iLCBub3RlOiAiRGlzY3VzcyBkb3NpbmcgaWYgeW91IHVzZSBibG9vZC10aGlubmluZyBtZWRpY2F0aW9ucy4iIH0KICAgIF0sCiAgICBtZW50b3Jpbmc6IFsKICAgICAgeyBsYWJlbDogIk5vb20iLCB1cmw6ICJodHRwczovL3d3dy5ub29tLmNvbS8iLCBub3RlOiAiR3JlYXQgZm9yIG1pbmRzZXQgYXJvdW5kIHNvY2lhbCBlYXRpbmcgcGF0dGVybnMuIiB9LAogICAgICB7IGxhYmVsOiAiV1cgKFdlaWdodFdhdGNoZXJzKSIsIHVybDogImh0dHBzOi8vd3d3LndlaWdodHdhdGNoZXJzLmNvbS8iLCBub3RlOiAiRmxleGlibGUgc29jaWFsIGVhdGluZyBmcmFtZXdvcmsgd2l0aCBhY2NvdW50YWJpbGl0eS4iIH0sCiAgICAgIHsgbGFiZWw6ICJGaW5kIGEgUmVnaXN0ZXJlZCBEaWV0aXRpYW4iLCB1cmw6ICJodHRwczovL3d3dy5lYXRyaWdodC5vcmcvZmluZC1hLW51dHJpdGlvbi1leHBlcnQiLCBub3RlOiAiSGVscGZ1bCBmb3IgZXZlbnQtc3BlY2lmaWMgcGxhbm5pbmcgYW5kIHN1c3RhaW5hYmxlIGZhdCBsb3NzLiIgfQogICAgXSwKICAgIHJlY2lwZXM6IFsKICAgICAgeyBuYW1lOiAiUmVzdGF1cmFudC1TdHlsZSBGYWppdGEgUGxhdGUiLCB3aHk6ICJTb2NpYWwtZmVlbCBtZWFsIHdpdGggYnVpbHQtaW4gcG9ydGlvbiBjb250cm9sLiIsIGJ1aWxkOiAiR3JpbGxlZCBzdGVhay9jaGlja2VuLCBwZXBwZXJzLCBvbmlvbnMsIHNhbHNhLCBsZXR0dWNlLCBzbWFsbCB0b3J0aWxsYXMuIiB9LAogICAgICB7IG5hbWU6ICJIaWdoLVByb3RlaW4gQnJ1bmNoIE9tZWxldCIsIHdoeTogIlByZS1zb2NpYWwgcHJvdGVpbiBoZWxwcyByZWR1Y2UgbGF0ZXIgb3ZlcmVhdGluZy4iLCBidWlsZDogIkVnZ3MgKyBlZ2cgd2hpdGVzLCB0dXJrZXksIHNwaW5hY2gsIG11c2hyb29tcywgZnJ1aXQgb24gc2lkZS4iIH0sCiAgICAgIHsgbmFtZTogIlN1bmRheSBSZXNldCBDaGlsaSIsIHdoeTogIk1lYWwtcHJlcCBhbmNob3IgZm9yIHBvc3Qtd2Vla2VuZCByZXNldC4iLCBidWlsZDogIkxlYW4gYmVlZi90dXJrZXksIHRvbWF0b2VzLCBiZWFucywgb25pb25zLCBiZWxsIHBlcHBlcnMuIiB9CiAgICBdLAogICAgYXZvaWQ6ICJBdm9pZCB0aGUgYWxsLW9yLW5vdGhpbmcgcmVzZXQgbWVudGFsaXR5IGV2ZXJ5IE1vbmRheS4iLAogICAgdGltZWxpbmU6ICJFeHBlY3QgZmFzdGVyIHZpc2libGUgY2hhbmdlcyBvbmNlIHdlZWtlbmRzIGFyZSBjb250cm9sbGVkICgyLTQgd2Vla3MpLiIsCiAgICBhY2NlbnQ6ICIjQTY4QTY0IiwKICAgIGJnOiAiI0YwRThEOCIKICB9LAogIG1vbWVudHVtX2J1aWxkZXI6IHsKICAgIGxhYmVsOiAiTW9tZW50dW0gQnVpbGRlciIsCiAgICB0YWc6ICJDb25maWRlbmNlIGFuZCBjb25zaXN0ZW5jeSBmaXJzdCIsCiAgICBkZXNjcmlwdGlvbjogWwogICAgICAiWW91IHdpbGwgcHJvZ3Jlc3MgZmFzdGVzdCBieSBidWlsZGluZyBjb25maWRlbmNlIHdpdGggcmVwZWF0YWJsZSB3aW5zLCBub3QgYnkgY2hhc2luZyBleHRyZW1lIHBsYW5zLiIsCiAgICAgICJZb3VyIGJvZHkgYW5kIG1pbmRzZXQgcmVzcG9uZCBiZXN0IHdoZW4gZ29hbHMgYXJlIHJlYWxpc3RpYyBlbm91Z2ggdG8gbWFpbnRhaW4gdGhyb3VnaCBzdHJlc3MgYW5kIGxvdy1lbmVyZ3kgZGF5cy4iLAogICAgICAiT25jZSB5b3VyIHN0cmVhayBpcyBzdGFibGUsIGludGVuc2l0eSBjYW4gaW5jcmVhc2Ugd2l0aG91dCBidXJub3V0LiIKICAgIF0sCiAgICBmaXJzdEZvY3VzOiAiUHJvdGVjdCBhIGRhaWx5IHN0cmVhayB3aXRoIG9uZSBmb29kIGhhYml0IGFuZCBvbmUgbW92ZW1lbnQgaGFiaXQgdGhhdCBhcmUgYWxtb3N0IGltcG9zc2libGUgdG8gbWlzcy4iLAogICAgd2Vla1BsYW46IFsKICAgICAgeyBkYXk6ICJEYXkgMSIsIGZvY3VzOiAiQ2hvb3NlIHlvdXIgdHdvIG5vbi1uZWdvdGlhYmxlcyIsIGRldGFpbHM6ICJFeGFtcGxlOiBwcm90ZWluIGF0IGJyZWFrZmFzdCArIDIwLW1pbnV0ZSB3YWxrIGRhaWx5LiIgfSwKICAgICAgeyBkYXk6ICJEYXkgMiIsIGZvY3VzOiAiTG93ZXIgZnJpY3Rpb24iLCBkZXRhaWxzOiAiUGxhY2Ugc2hvZXMgYW5kIG1lYWwgaXRlbXMgd2hlcmUgeW91IGNhbiBzZWUgdGhlbSB0byByZWR1Y2UgZGVjaXNpb24gbG9hZC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDMiLCBmb2N1czogIlRyYWNrIHN0cmVhayBvbmx5IiwgZGV0YWlsczogIk1hcmsgY29tcGxldGlvbiBkYWlseS4gRG8gbm90IHRyYWNrIHBlcmZlY3Rpb24gb3IgbWFjcm8gcHJlY2lzaW9uIHlldC4iIH0sCiAgICAgIHsgZGF5OiAiRGF5IDQiLCBmb2N1czogIkVuZXJneSBjaGVja3BvaW50IiwgZGV0YWlsczogIlJhdGUgbW9vZCwgc2xlZXAsIGFuZCBodW5nZXIgdG8gc3BvdCB3aGF0IGlzIGFscmVhZHkgaW1wcm92aW5nLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNSIsIGZvY3VzOiAiQWRkIG9uZSB1cGdyYWRlIiwgZGV0YWlsczogIkFkZCBhIHNlY29uZCB3YWxrIG9yIGEgYnJpZWYgc3RyZW5ndGggc2Vzc2lvbiBpZiBtb21lbnR1bSBmZWVscyBnb29kLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNiIsIGZvY3VzOiAiUGxhbiBmb3IgaGFyZCBkYXlzIiwgZGV0YWlsczogIkRlZmluZSB5b3VyIG1pbmltdW0gdmVyc2lvbiBvZiBlYWNoIGhhYml0IGZvciBsb3ctbW90aXZhdGlvbiBkYXlzLiIgfSwKICAgICAgeyBkYXk6ICJEYXkgNyIsIGZvY3VzOiAiV2Vla2x5IHJlZmxlY3Rpb24iLCBkZXRhaWxzOiAiUmV2aWV3IHN0cmVhayBjb25zaXN0ZW5jeSBhbmQgY2hvb3NlIG9uZSBzbWFsbCBwcm9ncmVzc2lvbiBmb3IgbmV4dCB3ZWVrLiIgfQogICAgXSwKICAgIHN1cHBsZW1lbnRzOiBbCiAgICAgIHsgbmFtZTogIlByb3RlaW4gcG93ZGVyIiwgaG93OiAiMSBzZXJ2aW5nIG9uIGRheXMgcHJvdGVpbiBpbnRha2UgaXMgbG93LiIsIHdoeTogIlN1cHBvcnRzIHNhdGlldHkgYW5kIGhhYml0IGNvbnNpc3RlbmN5IHdpdGhvdXQgY29tcGxleCBtZWFsIHByZXAuIiwgbm90ZTogIlVzZSBhcyBzdXBwb3J0LCBub3QgYSByZXBsYWNlbWVudCBmb3Igd2hvbGUgZm9vZHMuIiB9LAogICAgICB7IG5hbWU6ICJDcmVhdGluZSBtb25vaHlkcmF0ZSIsIGhvdzogIjMtNWcgZGFpbHkuIiwgd2h5OiAiU3VwcG9ydHMgc3RyZW5ndGggYW5kIHBlcmZvcm1hbmNlIGFzIGFjdGl2aXR5IGluY3JlYXNlcy4iLCBub3RlOiAiU2FmZSBmb3IgbW9zdCBwZW9wbGUsIGJ1dCBjaGVjayB3aXRoIHlvdXIgY2xpbmljaWFuIGlmIG5lZWRlZC4iIH0sCiAgICAgIHsgbmFtZTogIk1hZ25lc2l1bSBnbHljaW5hdGUiLCBob3c6ICIyMDAtMzUwbWcgYXQgbmlnaHQuIiwgd2h5OiAiQ2FuIGhlbHAgc2xlZXAgcXVhbGl0eSBhbmQgcmVjb3ZlcnksIHdoaWNoIGltcHJvdmVzIGZvbGxvdy10aHJvdWdoLiIsIG5vdGU6ICJTdG9wIGlmIEdJIHNpZGUgZWZmZWN0cyBvY2N1ciBhbmQgYXNrIHlvdXIgY2xpbmljaWFuLiIgfQogICAgXSwKICAgIG1lbnRvcmluZzogWwogICAgICB7IGxhYmVsOiAiTm9vbSIsIHVybDogImh0dHBzOi8vd3d3Lm5vb20uY29tLyIsIG5vdGU6ICJCZWhhdmlvci1mb2N1c2VkIHByb21wdHMgaGVscCBtYWludGFpbiBtb21lbnR1bSBkYXkgdG8gZGF5LiIgfSwKICAgICAgeyBsYWJlbDogIldXIChXZWlnaHRXYXRjaGVycykiLCB1cmw6ICJodHRwczovL3d3dy53ZWlnaHR3YXRjaGVycy5jb20vIiwgbm90ZTogIlNpbXBsZSBmcmFtZXdvcmsgd2l0aCBjb21tdW5pdHkgYWNjb3VudGFiaWxpdHkuIiB9LAogICAgICB7IGxhYmVsOiAiRmluZCBhIFJlZ2lzdGVyZWQgRGlldGl0aWFuIiwgdXJsOiAiaHR0cHM6Ly93d3cuZWF0cmlnaHQub3JnL2ZpbmQtYS1udXRyaXRpb24tZXhwZXJ0Iiwgbm90ZTogIkdvb2QgbmV4dCBzdGVwIHdoZW4geW91IGFyZSByZWFkeSB0byBwZXJzb25hbGl6ZSBmdXJ0aGVyLiIgfQogICAgXSwKICAgIHJlY2lwZXM6IFsKICAgICAgeyBuYW1lOiAiMi0yLTIgU21vb3RoaWUiLCB3aHk6ICJFYXN5IHJlcGVhdGFibGUgbWVhbCB0byBtYWludGFpbiBzdHJlYWtzLiIsIGJ1aWxkOiAiMiBzY29vcHMgcHJvdGVpbiwgMiBjdXBzIHNwaW5hY2gsIDIgY3VwcyBmcm96ZW4gYmVycmllcyArIHdhdGVyLiIgfSwKICAgICAgeyBuYW1lOiAiQnVpbGQtWW91ci1Pd24gTm91cmlzaCBCb3dsIiwgd2h5OiAiRmxleGlibGUgYW5kIGZvcmdpdmluZyBmb3IgY29uc2lzdGVuY3kgZGF5cy4iLCBidWlsZDogIlByb3RlaW4gYmFzZSwgZ3JhaW4sIHJvYXN0ZWQgdmVnZXRhYmxlcywgYXZvY2Fkbywgc2ltcGxlIGRyZXNzaW5nLiIgfSwKICAgICAgeyBuYW1lOiAiT25lLVBhbiBDaGlja2VuICYgU3dlZXQgUG90YXRvIiwgd2h5OiAiU2ltcGxlIHByZXAgdGhhdCBmZWVscyBsaWtlIGEgY29tcGxldGUgd2luLiIsIGJ1aWxkOiAiQ2hpY2tlbiB0aGlnaHMsIHN3ZWV0IHBvdGF0byBjdWJlcywgYnJvY2NvbGksIG9saXZlIG9pbCwgc2Vhc29uaW5nLiIgfQogICAgXSwKICAgIGF2b2lkOiAiQXZvaWQganVtcGluZyBpbnRvIGFnZ3Jlc3NpdmUgcGxhbnMgdGhhdCBhcmUgaGFyZCB0byBzdXN0YWluLiIsCiAgICB0aW1lbGluZTogIkV4cGVjdCBoYWJpdCBjb25maWRlbmNlIGluIDEtMiB3ZWVrcyBhbmQgcGh5c2ljYWwgY2hhbmdlcyBvdmVyIDQrIHdlZWtzLiIsCiAgICBhY2NlbnQ6ICIjNEM3RDVBIiwKICAgIGJnOiAiI0U3RjFFQiIKICB9Cn07CnZhciBSRUNJUEVfREVUQUlMUyA9IHsKICAiTWFjcm8gUG93ZXIgQm93bCI6IHsKICAgIHByZXBUaW1lOiAiMTIgbWluIiwKICAgIGNvb2tUaW1lOiAiMTggbWluIiwKICAgIHNlcnZpbmdzOiAiMiIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiMTAgb3ogY2hpY2tlbiBicmVhc3QsIGN1YmVkIiwKICAgICAgIjEgY3VwIGNvb2tlZCBxdWlub2EiLAogICAgICAiMiBjdXBzIG1peGVkIHZlZ2V0YWJsZXMiLAogICAgICAiMSB0YnNwIG9saXZlIG9pbCIsCiAgICAgICJMZW1vbiBqdWljZSwgc2FsdCwgcGVwcGVyIgogICAgXSwKICAgIHN0ZXBzOiBbCiAgICAgICJTZWFzb24gY2hpY2tlbiB3aXRoIHNhbHQgYW5kIHBlcHBlciBhbmQgc2VhciBpbiBvbGl2ZSBvaWwgdW50aWwgY29va2VkIHRocm91Z2guIiwKICAgICAgIlJvYXN0IG9yIHNhdXRlIHZlZ2V0YWJsZXMgdW50aWwgdGVuZGVyLWNyaXNwLiIsCiAgICAgICJCdWlsZCBib3dscyB3aXRoIHF1aW5vYSwgY2hpY2tlbiwgYW5kIHZlZ2V0YWJsZXMuIiwKICAgICAgIkZpbmlzaCB3aXRoIGxlbW9uIGp1aWNlIGFuZCBhIGRyaXp6bGUgb2Ygb2xpdmUgb2lsLiIKICAgIF0KICB9LAogICJHcmVlayBZb2d1cnQgUHJvdGVpbiBQYXJmYWl0IjogewogICAgcHJlcFRpbWU6ICI2IG1pbiIsCiAgICBjb29rVGltZTogIjAgbWluIiwKICAgIHNlcnZpbmdzOiAiMSIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiMSBjdXAgcGxhaW4gR3JlZWsgeW9ndXJ0IiwKICAgICAgIjEgc2Nvb3AgdmFuaWxsYSBwcm90ZWluIHBvd2RlciIsCiAgICAgICIxLzIgY3VwIGJlcnJpZXMiLAogICAgICAiMSB0YnNwIGNoaWEgc2VlZHMiLAogICAgICAiMSB0YnNwIHNsaWNlZCBhbG1vbmRzIgogICAgXSwKICAgIHN0ZXBzOiBbCiAgICAgICJXaGlzayBwcm90ZWluIHBvd2RlciBpbnRvIEdyZWVrIHlvZ3VydCB1bnRpbCBzbW9vdGguIiwKICAgICAgIkxheWVyIHlvZ3VydCBtaXggYW5kIGJlcnJpZXMgaW4gYSBib3dsIG9yIGphci4iLAogICAgICAiVG9wIHdpdGggY2hpYSBhbmQgYWxtb25kcy4iLAogICAgICAiQ2hpbGwgZm9yIDUgbWludXRlcyBvciBlYXQgaW1tZWRpYXRlbHkuIgogICAgXQogIH0sCiAgIlNoZWV0LVBhbiBTYWxtb24gUGxhdGUiOiB7CiAgICBwcmVwVGltZTogIjEwIG1pbiIsCiAgICBjb29rVGltZTogIjIwIG1pbiIsCiAgICBzZXJ2aW5nczogIjIiLAogICAgaW5ncmVkaWVudHM6IFsKICAgICAgIjIgc2FsbW9uIGZpbGxldHMiLAogICAgICAiMiBjdXBzIGJyb2Njb2xpIGZsb3JldHMiLAogICAgICAiMSBtZWRpdW0gc3dlZXQgcG90YXRvLCBjdWJlZCIsCiAgICAgICIxIHRic3Agb2xpdmUgb2lsIiwKICAgICAgIkdhcmxpYyBwb3dkZXIsIHBhcHJpa2EsIHNhbHQsIHBlcHBlciIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiSGVhdCBvdmVuIHRvIDQyNUYgYW5kIGxpbmUgYSBzaGVldCBwYW4uIiwKICAgICAgIlRvc3MgYnJvY2NvbGkgYW5kIHN3ZWV0IHBvdGF0byB3aXRoIGhhbGYgdGhlIG9pbCBhbmQgc2Vhc29uaW5nLiIsCiAgICAgICJSb2FzdCB2ZWdldGFibGVzIGZvciAxMCBtaW51dGVzLCB0aGVuIGFkZCBzYWxtb24uIiwKICAgICAgIkJydXNoIHNhbG1vbiB3aXRoIHJlbWFpbmluZyBvaWwgYW5kIHJvYXN0IDEwLTEyIG1vcmUgbWludXRlcy4iCiAgICBdCiAgfSwKICAiMTAtTWludXRlIFJvdGlzc2VyaWUgV3JhcCI6IHsKICAgIHByZXBUaW1lOiAiMTAgbWluIiwKICAgIGNvb2tUaW1lOiAiMCBtaW4iLAogICAgc2VydmluZ3M6ICIxIiwKICAgIGluZ3JlZGllbnRzOiBbCiAgICAgICIxIHdob2xlLXdoZWF0IHdyYXAiLAogICAgICAiNCBveiByb3Rpc3NlcmllIGNoaWNrZW4iLAogICAgICAiMSB0YnNwIGh1bW11cyIsCiAgICAgICIxIGN1cCBzcGluYWNoIiwKICAgICAgIkN1Y3VtYmVyIHNsaWNlcyIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiU3ByZWFkIGh1bW11cyBhY3Jvc3MgdGhlIHdyYXAuIiwKICAgICAgIkxheWVyIGNoaWNrZW4sIHNwaW5hY2gsIGFuZCBjdWN1bWJlci4iLAogICAgICAiUm9sbCB0aWdodGx5IGFuZCBzbGljZSBpbiBoYWxmLiIsCiAgICAgICJTZXJ2ZSB3aXRoIGZydWl0IG9yIGNhcnJvdHMgZm9yIGV4dHJhIGZpYmVyLiIKICAgIF0KICB9LAogICJNaWNyb3dhdmUgRWdnICYgT2F0cyBCb3dsIjogewogICAgcHJlcFRpbWU6ICI0IG1pbiIsCiAgICBjb29rVGltZTogIjQgbWluIiwKICAgIHNlcnZpbmdzOiAiMSIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiMS8yIGN1cCBxdWljayBvYXRzIiwKICAgICAgIjMvNCBjdXAgd2F0ZXIiLAogICAgICAiMy80IGN1cCBlZ2cgd2hpdGVzIiwKICAgICAgIjEgY3VwIHNwaW5hY2giLAogICAgICAiU2Fsc2EgYW5kIHNocmVkZGVkIGNoZWVzZSIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiTWljcm93YXZlIG9hdHMgd2l0aCB3YXRlciBmb3IgOTAgc2Vjb25kcy4iLAogICAgICAiU3RpciBpbiBlZ2cgd2hpdGVzIGFuZCBzcGluYWNoLiIsCiAgICAgICJNaWNyb3dhdmUgaW4gMzAtc2Vjb25kIGJ1cnN0cyB1bnRpbCBlZ2dzIHNldC4iLAogICAgICAiVG9wIHdpdGggc2Fsc2EgYW5kIGEgc21hbGwgYW1vdW50IG9mIGNoZWVzZS4iCiAgICBdCiAgfSwKICAiRnJlZXplciBTdGlyLUZyeSBTaG9ydGN1dCI6IHsKICAgIHByZXBUaW1lOiAiNiBtaW4iLAogICAgY29va1RpbWU6ICIxMCBtaW4iLAogICAgc2VydmluZ3M6ICIyIiwKICAgIGluZ3JlZGllbnRzOiBbCiAgICAgICIzIGN1cHMgZnJvemVuIHN0aXItZnJ5IHZlZ2V0YWJsZXMiLAogICAgICAiOCBveiBwcmUtY29va2VkIGNoaWNrZW4gb3IgdG9mdSIsCiAgICAgICIyIGN1cHMgbWljcm93YXZlIHJpY2UiLAogICAgICAiMiB0YnNwIHNveS1naW5nZXIgc2F1Y2UiCiAgICBdLAogICAgc3RlcHM6IFsKICAgICAgIlNhdXRlIGZyb3plbiB2ZWdldGFibGVzIGluIGEgaG90IHBhbiB1bnRpbCBzb2Z0ZW5lZC4iLAogICAgICAiQWRkIHByb3RlaW4gYW5kIGNvb2sgdW50aWwgaGVhdGVkIHRocm91Z2guIiwKICAgICAgIk1pY3Jvd2F2ZSByaWNlIGFuZCBmb2xkIGludG8gdGhlIHBhbi4iLAogICAgICAiRmluaXNoIHdpdGggc295LWdpbmdlciBzYXVjZSBhbmQgc2VydmUuIgogICAgXQogIH0sCiAgIkdpYW50IENydW5jaCBTYWxhZCI6IHsKICAgIHByZXBUaW1lOiAiMTIgbWluIiwKICAgIGNvb2tUaW1lOiAiMCBtaW4iLAogICAgc2VydmluZ3M6ICIxIiwKICAgIGluZ3JlZGllbnRzOiBbCiAgICAgICIyIGN1cHMgY2hvcHBlZCByb21haW5lIiwKICAgICAgIjQgb3ogY29va2VkIGNoaWNrZW4iLAogICAgICAiMS8zIGN1cCBjaGlja3BlYXMiLAogICAgICAiQ3VjdW1iZXIgYW5kIHRvbWF0byIsCiAgICAgICIyIHRic3AgbGlnaHQgdmluYWlncmV0dGUiCiAgICBdLAogICAgc3RlcHM6IFsKICAgICAgIkFkZCBncmVlbnMgdG8gYSBsYXJnZSBib3dsLiIsCiAgICAgICJUb3Agd2l0aCBjaGlja2VuLCBjaGlja3BlYXMsIGN1Y3VtYmVyLCBhbmQgdG9tYXRvLiIsCiAgICAgICJUb3NzIHdpdGggdmluYWlncmV0dGUgcmlnaHQgYmVmb3JlIGVhdGluZy4iLAogICAgICAiQWRkIGV4dHJhIHZlZ2dpZXMgZm9yIG1vcmUgdm9sdW1lIGlmIG5lZWRlZC4iCiAgICBdCiAgfSwKICAiQ2hvY29sYXRlIFByb3RlaW4gUHVkZGluZyI6IHsKICAgIHByZXBUaW1lOiAiNSBtaW4iLAogICAgY29va1RpbWU6ICIwIG1pbiIsCiAgICBzZXJ2aW5nczogIjEiLAogICAgaW5ncmVkaWVudHM6IFsKICAgICAgIjMvNCBjdXAgcGxhaW4gR3JlZWsgeW9ndXJ0IiwKICAgICAgIjEvMiBzY29vcCBjaG9jb2xhdGUgcHJvdGVpbiBwb3dkZXIiLAogICAgICAiMSB0c3AgY29jb2EgcG93ZGVyIiwKICAgICAgIjEvMyBjdXAgYmVycmllcyIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiTWl4IHlvZ3VydCwgcHJvdGVpbiBwb3dkZXIsIGFuZCBjb2NvYSB1bnRpbCB0aGljay4iLAogICAgICAiQWRqdXN0IHRoaWNrbmVzcyB3aXRoIGEgc3BsYXNoIG9mIG1pbGsgaWYgbmVlZGVkLiIsCiAgICAgICJUb3Agd2l0aCBiZXJyaWVzLiIsCiAgICAgICJDaGlsbCAxMCBtaW51dGVzIGZvciBhIHB1ZGRpbmcgdGV4dHVyZS4iCiAgICBdCiAgfSwKICAiVGFjbyBDYXVsaWZsb3dlciBTa2lsbGV0IjogewogICAgcHJlcFRpbWU6ICI4IG1pbiIsCiAgICBjb29rVGltZTogIjE1IG1pbiIsCiAgICBzZXJ2aW5nczogIjIiLAogICAgaW5ncmVkaWVudHM6IFsKICAgICAgIjEwIG96IGxlYW4gZ3JvdW5kIHR1cmtleSIsCiAgICAgICIzIGN1cHMgY2F1bGlmbG93ZXIgcmljZSIsCiAgICAgICIxLzIgY3VwIGJsYWNrIGJlYW5zIiwKICAgICAgIjEvMiBjdXAgc2Fsc2EiLAogICAgICAiVGFjbyBzZWFzb25pbmcgYW5kIGF2b2NhZG8iCiAgICBdLAogICAgc3RlcHM6IFsKICAgICAgIkJyb3duIHR1cmtleSB3aXRoIHRhY28gc2Vhc29uaW5nIGluIGEgc2tpbGxldC4iLAogICAgICAiQWRkIGNhdWxpZmxvd2VyIHJpY2UgYW5kIGNvb2sgNC01IG1pbnV0ZXMuIiwKICAgICAgIlN0aXIgaW4gYmxhY2sgYmVhbnMgYW5kIHNhbHNhIHVudGlsIHdhcm0uIiwKICAgICAgIlNlcnZlIHRvcHBlZCB3aXRoIGF2b2NhZG8gc2xpY2VzLiIKICAgIF0KICB9LAogICJSZXN0YXVyYW50LVN0eWxlIEZhaml0YSBQbGF0ZSI6IHsKICAgIHByZXBUaW1lOiAiMTAgbWluIiwKICAgIGNvb2tUaW1lOiAiMTQgbWluIiwKICAgIHNlcnZpbmdzOiAiMiIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiMTAgb3ogc2xpY2VkIGNoaWNrZW4gb3Igc3RlYWsiLAogICAgICAiMiBiZWxsIHBlcHBlcnMsIHNsaWNlZCIsCiAgICAgICIxIG9uaW9uLCBzbGljZWQiLAogICAgICAiU2Fsc2EsIGxldHR1Y2UsIGFuZCBzbWFsbCB0b3J0aWxsYXMiLAogICAgICAiMSB0YnNwIG9pbCBhbmQgZmFqaXRhIHNlYXNvbmluZyIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiU2Vhc29uIHByb3RlaW4gYW5kIHNlYXIgaW4gYSBob3Qgc2tpbGxldC4iLAogICAgICAiQ29vayBwZXBwZXJzIGFuZCBvbmlvbnMgdW50aWwgc29mdGVuZWQuIiwKICAgICAgIlNlcnZlIHByb3RlaW4gYW5kIHZlZ2V0YWJsZXMgb3ZlciBsZXR0dWNlLiIsCiAgICAgICJBZGQgc2Fsc2EgYW5kIDEtMiBzbWFsbCB0b3J0aWxsYXMgb24gdGhlIHNpZGUuIgogICAgXQogIH0sCiAgIkhpZ2gtUHJvdGVpbiBCcnVuY2ggT21lbGV0IjogewogICAgcHJlcFRpbWU6ICI2IG1pbiIsCiAgICBjb29rVGltZTogIjggbWluIiwKICAgIHNlcnZpbmdzOiAiMSIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiMiB3aG9sZSBlZ2dzICsgMS8yIGN1cCBlZ2cgd2hpdGVzIiwKICAgICAgIjIgb3ogdHVya2V5IG9yIGNoaWNrZW4gc2F1c2FnZSIsCiAgICAgICIxIGN1cCBzcGluYWNoIiwKICAgICAgIk11c2hyb29tcyIsCiAgICAgICJGcnVpdCBvbiB0aGUgc2lkZSIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiU2F1dGUgbXVzaHJvb21zIGFuZCBzcGluYWNoIHVudGlsIHRlbmRlci4iLAogICAgICAiQWRkIHR1cmtleSBhbmQgd2FybSB0aHJvdWdoLiIsCiAgICAgICJQb3VyIGluIGVnZ3MgYW5kIGNvb2sgdW50aWwgc2V0LiIsCiAgICAgICJGb2xkIG9tZWxldCBhbmQgc2VydmUgd2l0aCBmcnVpdC4iCiAgICBdCiAgfSwKICAiU3VuZGF5IFJlc2V0IENoaWxpIjogewogICAgcHJlcFRpbWU6ICIxMiBtaW4iLAogICAgY29va1RpbWU6ICIyOCBtaW4iLAogICAgc2VydmluZ3M6ICI0IiwKICAgIGluZ3JlZGllbnRzOiBbCiAgICAgICIxIGxiIGxlYW4gYmVlZiBvciB0dXJrZXkiLAogICAgICAiMSBjYW4gZGljZWQgdG9tYXRvZXMiLAogICAgICAiMSBjYW4gYmVhbnMsIGRyYWluZWQiLAogICAgICAiMSBvbmlvbiBhbmQgMSBiZWxsIHBlcHBlciIsCiAgICAgICJDaGlsaSBwb3dkZXIsIGN1bWluLCBnYXJsaWMiCiAgICBdLAogICAgc3RlcHM6IFsKICAgICAgIkJyb3duIG1lYXQgd2l0aCBvbmlvbiBhbmQgYmVsbCBwZXBwZXIuIiwKICAgICAgIkFkZCB0b21hdG9lcywgYmVhbnMsIGFuZCBzZWFzb25pbmdzLiIsCiAgICAgICJTaW1tZXIgZm9yIDIwIG1pbnV0ZXMsIHN0aXJyaW5nIG9jY2FzaW9uYWxseS4iLAogICAgICAiUG9ydGlvbiBpbnRvIG1lYWwtcHJlcCBjb250YWluZXJzLiIKICAgIF0KICB9LAogICIyLTItMiBTbW9vdGhpZSI6IHsKICAgIHByZXBUaW1lOiAiNCBtaW4iLAogICAgY29va1RpbWU6ICIwIG1pbiIsCiAgICBzZXJ2aW5nczogIjEiLAogICAgaW5ncmVkaWVudHM6IFsKICAgICAgIjIgc2Nvb3BzIHByb3RlaW4gcG93ZGVyIiwKICAgICAgIjIgY3VwcyBzcGluYWNoIiwKICAgICAgIjIgY3VwcyBmcm96ZW4gYmVycmllcyIsCiAgICAgICJXYXRlciBhbmQgaWNlIGFzIG5lZWRlZCIKICAgIF0sCiAgICBzdGVwczogWwogICAgICAiQWRkIHdhdGVyIGZpcnN0LCB0aGVuIHByb3RlaW4sIHNwaW5hY2gsIGFuZCBiZXJyaWVzLiIsCiAgICAgICJCbGVuZCB1bnRpbCBmdWxseSBzbW9vdGguIiwKICAgICAgIkFkZCBleHRyYSBpY2UgZm9yIHRoaWNrZXIgdGV4dHVyZS4iLAogICAgICAiRHJpbmsgaW1tZWRpYXRlbHkgb3IgcmVmcmlnZXJhdGUgdXAgdG8gMjQgaG91cnMuIgogICAgXQogIH0sCiAgIkJ1aWxkLVlvdXItT3duIE5vdXJpc2ggQm93bCI6IHsKICAgIHByZXBUaW1lOiAiMTAgbWluIiwKICAgIGNvb2tUaW1lOiAiMTIgbWluIiwKICAgIHNlcnZpbmdzOiAiMiIsCiAgICBpbmdyZWRpZW50czogWwogICAgICAiOCBveiBjb29rZWQgcHJvdGVpbiIsCiAgICAgICIxIGN1cCBjb29rZWQgZ3JhaW4iLAogICAgICAiMiBjdXBzIHJvYXN0ZWQgdmVnZXRhYmxlcyIsCiAgICAgICIxLzIgYXZvY2FkbyIsCiAgICAgICJTaW1wbGUgb2xpdmUtb2lsIHZpbmFpZ3JldHRlIgogICAgXSwKICAgIHN0ZXBzOiBbCiAgICAgICJDb29rIGdyYWluIGFuZCByb2FzdCB2ZWdldGFibGVzLiIsCiAgICAgICJXYXJtIG9yIGNvb2sgeW91ciBwcm90ZWluIHNvdXJjZS4iLAogICAgICAiQXNzZW1ibGUgYm93bHMgd2l0aCBncmFpbiwgcHJvdGVpbiwgYW5kIHZlZ2V0YWJsZXMuIiwKICAgICAgIlRvcCB3aXRoIGF2b2NhZG8gYW5kIHZpbmFpZ3JldHRlLiIKICAgIF0KICB9LAogICJPbmUtUGFuIENoaWNrZW4gJiBTd2VldCBQb3RhdG8iOiB7CiAgICBwcmVwVGltZTogIjEwIG1pbiIsCiAgICBjb29rVGltZTogIjMwIG1pbiIsCiAgICBzZXJ2aW5nczogIjMiLAogICAgaW5ncmVkaWVudHM6IFsKICAgICAgIjEgbGIgY2hpY2tlbiB0aGlnaHMiLAogICAgICAiMiBtZWRpdW0gc3dlZXQgcG90YXRvZXMsIGN1YmVkIiwKICAgICAgIjIgY3VwcyBicm9jY29saSBmbG9yZXRzIiwKICAgICAgIjEgdGJzcCBvbGl2ZSBvaWwiLAogICAgICAiU2FsdCwgcGVwcGVyLCBnYXJsaWMgcG93ZGVyIgogICAgXSwKICAgIHN0ZXBzOiBbCiAgICAgICJIZWF0IG92ZW4gdG8gNDI1RiBhbmQgcHJlcCBhIHNoZWV0IHBhbi4iLAogICAgICAiVG9zcyBjaGlja2VuLCBzd2VldCBwb3RhdG9lcywgYW5kIGJyb2Njb2xpIHdpdGggb2lsIGFuZCBzZWFzb25pbmcuIiwKICAgICAgIlNwcmVhZCBldmVubHkgYW5kIHJvYXN0IDI1LTMwIG1pbnV0ZXMuIiwKICAgICAgIkZsaXAgbWlkd2F5IHRocm91Z2ggY29va2luZyBmb3IgZXZlbiBicm93bmluZy4iCiAgICBdCiAgfQp9Owp2YXIgUVVFU1RJT05TID0gWwogIHsKICAgIGlkOiAidmlzaW9uX2dvYWwiLAogICAgcHJvbXB0OiAiTGV0J3Mgc3RhcnQgd2l0aCB5b3VyIHZpc2lvbjogd2hhdCBvdXRjb21lIG1hdHRlcnMgbW9zdCByaWdodCBub3c/IiwKICAgIGhpbnQ6ICJQaWNrIHRoZSByZXN1bHQgdGhhdCB3b3VsZCBtYWtlIHlvdSBmZWVsIHRoZSBtb3N0IHByb3VkLiIsCiAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRyb3BoeSwgeyBzaXplOiAyMCB9KSwKICAgIGNob2ljZXM6IFsKICAgICAgewogICAgICAgIGlkOiAidmlzaW9uX3NjYWxlX2Rvd24iLAogICAgICAgIHRpdGxlOiAiRHJvcCBib2R5IHdlaWdodCBzdGVhZGlseSIsCiAgICAgICAgZGV0YWlsOiAiSSB3YW50IG1lYXN1cmFibGUgZmF0LWxvc3MgcHJvZ3Jlc3MuIiwKICAgICAgICBzY29yZXM6IHsgc3RydWN0dXJlZF9hY2hpZXZlcjogMiwgY3JhdmluZ19jcnVzaGVyOiAxLCBidXN5X21pbmltYWxpc3Q6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJ2aXNpb25fbW9yZV9lbmVyZ3kiLAogICAgICAgIHRpdGxlOiAiRmVlbCBtb3JlIGVuZXJnaXplZCBldmVyeSBkYXkiLAogICAgICAgIGRldGFpbDogIkkgd2FudCBlbmVyZ3kgYW5kIG1vbWVudHVtIGJhY2suIiwKICAgICAgICBzY29yZXM6IHsgbW9tZW50dW1fYnVpbGRlcjogMiwgYnVzeV9taW5pbWFsaXN0OiAxLCBjcmF2aW5nX2NydXNoZXI6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJ2aXNpb25fY29uZmlkZW5jZSIsCiAgICAgICAgdGl0bGU6ICJGZWVsIGNvbmZpZGVudCBpbiBteSBib2R5IiwKICAgICAgICBkZXRhaWw6ICJJIHdhbnQgdG8gZmVlbCBwcm91ZCBpbiBwaG90b3MgYW5kIGNsb3RoZXMuIiwKICAgICAgICBzY29yZXM6IHsgd2Vla2VuZF93YXJyaW9yOiAyLCBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAxLCBtb21lbnR1bV9idWlsZGVyOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAidmlzaW9uX2hlYWx0aCIsCiAgICAgICAgdGl0bGU6ICJJbXByb3ZlIG15IGxvbmctdGVybSBoZWFsdGgiLAogICAgICAgIGRldGFpbDogIkkgd2FudCBiZXR0ZXIgbWFya2VycyBhbmQgc3VzdGFpbmFibGUgaGFiaXRzLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDIsIG1vbWVudHVtX2J1aWxkZXI6IDIgfQogICAgICB9CiAgICBdCiAgfSwKICB7CiAgICBpZDogInZpc2lvbl9kcmVhbSIsCiAgICBwcm9tcHQ6ICJJZiB0aGlzIHBsYW4gd29ya3MsIHdoYXQgd291bGQgZmVlbCBtb3N0IGV4Y2l0aW5nIGluIDMgbW9udGhzPyIsCiAgICBoaW50OiAiVGhpcyBoZWxwcyB1cyBkZXNpZ24gZm9yIG1vdGl2YXRpb24sIG5vdCBqdXN0IGRpc2NpcGxpbmUuIiwKICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU3BhcmtsZXMsIHsgc2l6ZTogMjAgfSksCiAgICBjaG9pY2VzOiBbCiAgICAgIHsKICAgICAgICBpZDogImRyZWFtX2Nsb3RoZXMiLAogICAgICAgIHRpdGxlOiAiQ2xvdGhlcyBmaXQgYW5kIGxvb2sgYmV0dGVyIiwKICAgICAgICBkZXRhaWw6ICJJIHdhbnQgdG8gc2VlIHZpc2libGUgY2hhbmdlcyBpbiB0aGUgbWlycm9yLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDEsIHdlZWtlbmRfd2FycmlvcjogMiwgY3JhdmluZ19jcnVzaGVyOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAiZHJlYW1fZW5lcmd5IiwKICAgICAgICB0aXRsZTogIldha2UgdXAgd2l0aCBlbmVyZ3kgYW5kIGZvY3VzIiwKICAgICAgICBkZXRhaWw6ICJJIHdhbnQgdG8gZmVlbCBzdHJvbmdlciBhbmQgbGVzcyBzbHVnZ2lzaC4iLAogICAgICAgIHNjb3JlczogeyBtb21lbnR1bV9idWlsZGVyOiAyLCBidXN5X21pbmltYWxpc3Q6IDEsIGNyYXZpbmdfY3J1c2hlcjogMSB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogImRyZWFtX2NvbnNpc3RlbmN5IiwKICAgICAgICB0aXRsZTogIkZpbmFsbHkgc3RheSBjb25zaXN0ZW50IiwKICAgICAgICBkZXRhaWw6ICJJIHdhbnQgdG8gdHJ1c3QgbXlzZWxmIHRvIGZvbGxvdyB0aHJvdWdoLiIsCiAgICAgICAgc2NvcmVzOiB7IG1vbWVudHVtX2J1aWxkZXI6IDIsIGJ1c3lfbWluaW1hbGlzdDogMiB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogImRyZWFtX3N0cmVuZ3RoIiwKICAgICAgICB0aXRsZTogIkxvb2sgYW5kIHBlcmZvcm0gbGlrZSBhbiBhdGhsZXRlIiwKICAgICAgICBkZXRhaWw6ICJJIHdhbnQgdG8gdHJhaW4gaGFyZCBhbmQgc2VlIGJvZHkgcmVjb21wb3NpdGlvbi4iLAogICAgICAgIHNjb3JlczogeyBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAzLCB3ZWVrZW5kX3dhcnJpb3I6IDEgfQogICAgICB9CiAgICBdCiAgfSwKICB7CiAgICBpZDogInZpc2lvbl9jaGFuZ2UiLAogICAgcHJvbXB0OiAiV2hhdCBkbyB5b3UgbW9zdCB3YW50IHRvIGNoYW5nZSBmaXJzdD8iLAogICAgaGludDogIldlJ2xsIHByaW9yaXRpemUgeW91ciBiaWdnZXN0IGxldmVyYWdlIHBvaW50LiIsCiAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRhcmdldCwgeyBzaXplOiAyMCB9KSwKICAgIGNob2ljZXM6IFsKICAgICAgewogICAgICAgIGlkOiAiY2hhbmdlX2VhdGluZ19zdHJ1Y3R1cmUiLAogICAgICAgIHRpdGxlOiAiTXkgZWF0aW5nIHN0cnVjdHVyZSIsCiAgICAgICAgZGV0YWlsOiAiSSBuZWVkIGJldHRlciBkYWlseSBtZWFsIHJoeXRobS4iLAogICAgICAgIHNjb3JlczogeyBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAyLCBidXN5X21pbmltYWxpc3Q6IDIgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJjaGFuZ2VfY3JhdmluZ3MiLAogICAgICAgIHRpdGxlOiAiQ3JhdmluZ3MgYW5kIHNuYWNraW5nIiwKICAgICAgICBkZXRhaWw6ICJJIG5lZWQgYmV0dGVyIGFwcGV0aXRlIGNvbnRyb2wuIiwKICAgICAgICBzY29yZXM6IHsgY3JhdmluZ19jcnVzaGVyOiAzLCBtb21lbnR1bV9idWlsZGVyOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAiY2hhbmdlX2NvbnNpc3RlbmN5IiwKICAgICAgICB0aXRsZTogIkNvbnNpc3RlbmN5IGFuZCBmb2xsb3ctdGhyb3VnaCIsCiAgICAgICAgZGV0YWlsOiAiSSBuZWVkIGhhYml0cyB0aGF0IHN0aWNrIG9uIGJ1c3kgZGF5cy4iLAogICAgICAgIHNjb3JlczogeyBtb21lbnR1bV9idWlsZGVyOiAzLCBidXN5X21pbmltYWxpc3Q6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJjaGFuZ2Vfc29jaWFsX2NvbnRyb2wiLAogICAgICAgIHRpdGxlOiAiU29jaWFsIGFuZCB3ZWVrZW5kIGNvbnRyb2wiLAogICAgICAgIGRldGFpbDogIkkgbmVlZCBhIHN0cmF0ZWd5IGZvciBldmVudHMgYW5kIHdlZWtlbmRzLiIsCiAgICAgICAgc2NvcmVzOiB7IHdlZWtlbmRfd2FycmlvcjogMywgY3JhdmluZ19jcnVzaGVyOiAxIH0KICAgICAgfQogICAgXQogIH0sCiAgewogICAgaWQ6ICJkZXJhaWxlciIsCiAgICBwcm9tcHQ6ICJXaGF0IGRlcmFpbHMgeW91ciBwcm9ncmVzcyBtb3N0IG9mdGVuPyIsCiAgICBoaW50OiAiQ2hvb3NlIHRoZSBvbmUgdGhhdCBoYXBwZW5zIG1vc3QgY29uc2lzdGVudGx5LiIsCiAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEZsYW1lLCB7IHNpemU6IDIwIH0pLAogICAgY2hvaWNlczogWwogICAgICB7CiAgICAgICAgaWQ6ICJuaWdodF9jcmF2aW5ncyIsCiAgICAgICAgdGl0bGU6ICJOaWdodCBjcmF2aW5ncyIsCiAgICAgICAgZGV0YWlsOiAiRXZlbmluZ3MgYXJlIHdoZXJlIGNhbG9yaWVzIHNwaWtlLiIsCiAgICAgICAgc2NvcmVzOiB7IGNyYXZpbmdfY3J1c2hlcjogMywgbW9tZW50dW1fYnVpbGRlcjogMSB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInN0cmVzc19lYXRpbmciLAogICAgICAgIHRpdGxlOiAiU3RyZXNzIGVhdGluZyIsCiAgICAgICAgZGV0YWlsOiAiRm9vZCBiZWNvbWVzIHRoZSBxdWljayBkZWNvbXByZXNzaW9uIHRvb2wuIiwKICAgICAgICBzY29yZXM6IHsgY3JhdmluZ19jcnVzaGVyOiAyLCBtb21lbnR1bV9idWlsZGVyOiAyIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAibm9fdGltZSIsCiAgICAgICAgdGl0bGU6ICJObyB0aW1lIHRvIHByZXAiLAogICAgICAgIGRldGFpbDogIkJ1c3kgc2NoZWR1bGUga25vY2tzIG91dCBnb29kIGNob2ljZXMuIiwKICAgICAgICBzY29yZXM6IHsgYnVzeV9taW5pbWFsaXN0OiAzLCB3ZWVrZW5kX3dhcnJpb3I6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJzb2NpYWxfd2Vla2VuZHMiLAogICAgICAgIHRpdGxlOiAiU29jaWFsIHdlZWtlbmRzIiwKICAgICAgICBkZXRhaWw6ICJXZWVrZW5kcyB1bmRvIHdlZWtkYXkgbW9tZW50dW0uIiwKICAgICAgICBzY29yZXM6IHsgd2Vla2VuZF93YXJyaW9yOiAzLCBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAxIH0KICAgICAgfQogICAgXQogIH0sCiAgewogICAgaWQ6ICJyb3V0aW5lIiwKICAgIHByb21wdDogIllvdXIgY3VycmVudCBhY3Rpdml0eSBiYXNlbGluZSBpcyBjbG9zZXN0IHRvOiIsCiAgICBoaW50OiAiVGhpcyBoZWxwcyBjYWxpYnJhdGUgeW91ciBmaXJzdCBtb3ZlbWVudCB0YXJnZXQuIiwKICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQWN0aXZpdHksIHsgc2l6ZTogMjAgfSksCiAgICBjaG9pY2VzOiBbCiAgICAgIHsKICAgICAgICBpZDogIm1vc3RseV9zaXR0aW5nIiwKICAgICAgICB0aXRsZTogIk1vc3RseSBzaXR0aW5nIiwKICAgICAgICBkZXRhaWw6ICJEZXNrLWhlYXZ5IGRheXMgYW5kIGxvdyBtb3ZlbWVudC4iLAogICAgICAgIHNjb3JlczogeyBtb21lbnR1bV9idWlsZGVyOiAyLCBidXN5X21pbmltYWxpc3Q6IDIgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJzb21lX3dhbGtpbmciLAogICAgICAgIHRpdGxlOiAiU29tZSB3YWxraW5nIiwKICAgICAgICBkZXRhaWw6ICJBIGxpdHRsZSBhY3Rpdml0eSwgYnV0IGluY29uc2lzdGVudC4iLAogICAgICAgIHNjb3JlczogeyBidXN5X21pbmltYWxpc3Q6IDIsIG1vbWVudHVtX2J1aWxkZXI6IDIgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJyZWd1bGFyX3dvcmtvdXRzIiwKICAgICAgICB0aXRsZTogIjItMyB3b3Jrb3V0cy93ZWVrIiwKICAgICAgICBkZXRhaWw6ICJZb3UgYWxyZWFkeSBoYXZlIHNvbWUgc3RydWN0dXJlLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDIsIHdlZWtlbmRfd2FycmlvcjogMiB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInZlcnlfYWN0aXZlIiwKICAgICAgICB0aXRsZTogIlZlcnkgYWN0aXZlIiwKICAgICAgICBkZXRhaWw6ICJUcmFpbmluZyBpcyBub3QgdGhlIGlzc3VlLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDMsIGNyYXZpbmdfY3J1c2hlcjogMSB9CiAgICAgIH0KICAgIF0KICB9LAogIHsKICAgIGlkOiAib3ZlcmVhdGluZ190aW1lIiwKICAgIHByb21wdDogIldoZW4gZG8geW91IG92ZXJlYXQgdGhlIG1vc3Q/IiwKICAgIGhpbnQ6ICJQaW5wb2ludGluZyB0aW1pbmcgaW1wcm92ZXMgc3RyYXRlZ3kgcXVhbGl0eS4iLAogICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaW1lciwgeyBzaXplOiAyMCB9KSwKICAgIGNob2ljZXM6IFsKICAgICAgewogICAgICAgIGlkOiAiZXZlbmluZyIsCiAgICAgICAgdGl0bGU6ICJFdmVuaW5nIiwKICAgICAgICBkZXRhaWw6ICJMYXRlLWRheSBodW5nZXIgYW5kIGhhYml0IGVhdGluZy4iLAogICAgICAgIHNjb3JlczogeyBjcmF2aW5nX2NydXNoZXI6IDMsIG1vbWVudHVtX2J1aWxkZXI6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJtZWFscyIsCiAgICAgICAgdGl0bGU6ICJBdCBtYWluIG1lYWxzIiwKICAgICAgICBkZXRhaWw6ICJQb3J0aW9ucyBjcmVlcCBiaWdnZXIgdGhhbiBwbGFubmVkLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDIsIGJ1c3lfbWluaW1hbGlzdDogMiB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInNvY2lhbF9ldmVudHMiLAogICAgICAgIHRpdGxlOiAiU29jaWFsIGV2ZW50cyIsCiAgICAgICAgZGV0YWlsOiAiUmVzdGF1cmFudHMgYW5kIGdhdGhlcmluZ3MgYXJlIGhhcmRlc3QuIiwKICAgICAgICBzY29yZXM6IHsgd2Vla2VuZF93YXJyaW9yOiAzLCBjcmF2aW5nX2NydXNoZXI6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJyYW5kb21fc25hY2tpbmciLAogICAgICAgIHRpdGxlOiAiUmFuZG9tIHNuYWNraW5nIiwKICAgICAgICBkZXRhaWw6ICJVbnBsYW5uZWQgYml0ZXMgYWxsIGRheS4iLAogICAgICAgIHNjb3JlczogeyBidXN5X21pbmltYWxpc3Q6IDIsIGNyYXZpbmdfY3J1c2hlcjogMiB9CiAgICAgIH0KICAgIF0KICB9LAogIHsKICAgIGlkOiAidHJhY2tpbmciLAogICAgcHJvbXB0OiAiSG93IGRvIHlvdSBmZWVsIGFib3V0IHRyYWNraW5nIGZvb2QgZGF0YT8iLAogICAgaGludDogIk5vIHJpZ2h0IGFuc3dlci4gV2UgdGFpbG9yIHRoZSBwbGFuIHRvIHlvdXIgcHJlZmVyZW5jZS4iLAogICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGFydENvbHVtbiwgeyBzaXplOiAyMCB9KSwKICAgIGNob2ljZXM6IFsKICAgICAgewogICAgICAgIGlkOiAibG92ZV9kYXRhIiwKICAgICAgICB0aXRsZTogIkkgbGlrZSBkYXRhIiwKICAgICAgICBkZXRhaWw6ICJOdW1iZXJzIGhlbHAgbWUgc3RheSBhY2NvdW50YWJsZS4iLAogICAgICAgIHNjb3JlczogeyBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAzIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAic2hvcnRfdGVybSIsCiAgICAgICAgdGl0bGU6ICJPa2F5IHNob3J0LXRlcm0iLAogICAgICAgIGRldGFpbDogIkhlbHBmdWwgZm9yIGEgd2hpbGUsIHRoZW4gYW5ub3lpbmcuIiwKICAgICAgICBzY29yZXM6IHsgc3RydWN0dXJlZF9hY2hpZXZlcjogMSwgYnVzeV9taW5pbWFsaXN0OiAyLCB3ZWVrZW5kX3dhcnJpb3I6IDEgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJzaW1wbGVfcnVsZXMiLAogICAgICAgIHRpdGxlOiAiUHJlZmVyIHNpbXBsZSBydWxlcyIsCiAgICAgICAgZGV0YWlsOiAiSSB3YW50IGd1YXJkcmFpbHMsIG5vdCBzcHJlYWRzaGVldHMuIiwKICAgICAgICBzY29yZXM6IHsgYnVzeV9taW5pbWFsaXN0OiAzLCBtb21lbnR1bV9idWlsZGVyOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAibm9fdHJhY2tpbmciLAogICAgICAgIHRpdGxlOiAiSSBkbyBub3Qgd2FudCB0cmFja2luZyIsCiAgICAgICAgZGV0YWlsOiAiSSB3YW50IGJlaGF2aW9yLWZpcnN0IHRvb2xzIG9ubHkuIiwKICAgICAgICBzY29yZXM6IHsgbW9tZW50dW1fYnVpbGRlcjogMywgY3JhdmluZ19jcnVzaGVyOiAxIH0KICAgICAgfQogICAgXQogIH0sCiAgewogICAgaWQ6ICJtb3JuaW5ncyIsCiAgICBwcm9tcHQ6ICJZb3VyIG1vcm5pbmdzIHVzdWFsbHkgbG9vayBsaWtlOiIsCiAgICBoaW50OiAiTW9ybmluZyByaHl0aG0gcHJlZGljdHMgZGFpbHkgY29uc2lzdGVuY3kuIiwKICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU3BhcmtsZXMsIHsgc2l6ZTogMjAgfSksCiAgICBjaG9pY2VzOiBbCiAgICAgIHsKICAgICAgICBpZDogImNoYW90aWMiLAogICAgICAgIHRpdGxlOiAiQ2hhb3RpYyIsCiAgICAgICAgZGV0YWlsOiAiSSBhbSBydXNoaW5nIGZyb20gdGhlIHN0YXJ0LiIsCiAgICAgICAgc2NvcmVzOiB7IGJ1c3lfbWluaW1hbGlzdDogMywgbW9tZW50dW1fYnVpbGRlcjogMSB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInF1aWNrX3NpbXBsZSIsCiAgICAgICAgdGl0bGU6ICJRdWljayBhbmQgc2ltcGxlIiwKICAgICAgICBkZXRhaWw6ICJJIGNhbiBkbyBvbmUgZWFzeSByb3V0aW5lLiIsCiAgICAgICAgc2NvcmVzOiB7IGJ1c3lfbWluaW1hbGlzdDogMiwgbW9tZW50dW1fYnVpbGRlcjogMiB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInN0cnVjdHVyZWQiLAogICAgICAgIHRpdGxlOiAiU3RydWN0dXJlZCIsCiAgICAgICAgZGV0YWlsOiAiSSBjYW4gZXhlY3V0ZSBhIHNldCBwbGFuLiIsCiAgICAgICAgc2NvcmVzOiB7IHN0cnVjdHVyZWRfYWNoaWV2ZXI6IDMgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJwbGVudHlfdGltZSIsCiAgICAgICAgdGl0bGU6ICJQbGVudHkgb2YgdGltZSIsCiAgICAgICAgZGV0YWlsOiAiVGltZSBpcyBhdmFpbGFibGUsIGNvbnNpc3RlbmN5IHZhcmllcy4iLAogICAgICAgIHNjb3JlczogeyBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAyLCBjcmF2aW5nX2NydXNoZXI6IDEsIHdlZWtlbmRfd2FycmlvcjogMSB9CiAgICAgIH0KICAgIF0KICB9LAogIHsKICAgIGlkOiAibW92ZW1lbnRfc3R5bGUiLAogICAgcHJvbXB0OiAiQmVzdCBtb3ZlbWVudCBzdHlsZSBmb3IgeW91IHJpZ2h0IG5vdzoiLAogICAgaGludDogIlBpY2sgd2hhdCB5b3Ugd291bGQgYWN0dWFsbHkgZG8gdGhpcyB3ZWVrLiIsCiAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEZvb3RwcmludHMsIHsgc2l6ZTogMjAgfSksCiAgICBjaG9pY2VzOiBbCiAgICAgIHsKICAgICAgICBpZDogIndhbGtpbmciLAogICAgICAgIHRpdGxlOiAiV2Fsa2luZyBhbmQgc3RlcHMiLAogICAgICAgIGRldGFpbDogIlNpbXBsZSwgcmVwZWF0YWJsZSwgbG93IGJhcnJpZXIuIiwKICAgICAgICBzY29yZXM6IHsgYnVzeV9taW5pbWFsaXN0OiAyLCBtb21lbnR1bV9idWlsZGVyOiAyIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAiaG9tZV93b3Jrb3V0cyIsCiAgICAgICAgdGl0bGU6ICJIb21lIHdvcmtvdXRzIiwKICAgICAgICBkZXRhaWw6ICJFZmZpY2llbnQgYW5kIHNjaGVkdWxlLWZyaWVuZGx5LiIsCiAgICAgICAgc2NvcmVzOiB7IGJ1c3lfbWluaW1hbGlzdDogMiwgc3RydWN0dXJlZF9hY2hpZXZlcjogMSwgbW9tZW50dW1fYnVpbGRlcjogMSB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogImd5bV9zdHJlbmd0aCIsCiAgICAgICAgdGl0bGU6ICJHeW0gc3RyZW5ndGgiLAogICAgICAgIGRldGFpbDogIkkgbGlrZSBwcm9ncmVzc2l2ZSB0cmFpbmluZy4iLAogICAgICAgIHNjb3JlczogeyBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAzIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAiY2xhc3Nlc19zcG9ydHMiLAogICAgICAgIHRpdGxlOiAiQ2xhc3NlcyBvciBzcG9ydHMiLAogICAgICAgIGRldGFpbDogIkZ1biBrZWVwcyBtZSBjb25zaXN0ZW50LiIsCiAgICAgICAgc2NvcmVzOiB7IHdlZWtlbmRfd2FycmlvcjogMiwgbW9tZW50dW1fYnVpbGRlcjogMiB9CiAgICAgIH0KICAgIF0KICB9LAogIHsKICAgIGlkOiAiY29uc2lzdGVuY3lfYmFycmllciIsCiAgICBwcm9tcHQ6ICJCaWdnZXN0IGNvbnNpc3RlbmN5IGNoYWxsZW5nZToiLAogICAgaGludDogIkJlIGhvbmVzdC4gVGhpcyBkcml2ZXMgeW91ciBtYWluIGFjdGlvbiBwbGFuLiIsCiAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRhcmdldCwgeyBzaXplOiAyMCB9KSwKICAgIGNob2ljZXM6IFsKICAgICAgewogICAgICAgIGlkOiAibW90aXZhdGlvbl9kaXBzIiwKICAgICAgICB0aXRsZTogIk1vdGl2YXRpb24gZGlwcyIsCiAgICAgICAgZGV0YWlsOiAiR29vZCBzdGFydCwgdGhlbiBmYWRlLiIsCiAgICAgICAgc2NvcmVzOiB7IG1vbWVudHVtX2J1aWxkZXI6IDMgfQogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICJidXN5X3NjaGVkdWxlIiwKICAgICAgICB0aXRsZTogIkJ1c3kgc2NoZWR1bGUiLAogICAgICAgIGRldGFpbDogIlRvbyBtdWNoIGNvbnRleHQgc3dpdGNoaW5nLiIsCiAgICAgICAgc2NvcmVzOiB7IGJ1c3lfbWluaW1hbGlzdDogMyB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogImh1bmdlcl9jcmF2aW5ncyIsCiAgICAgICAgdGl0bGU6ICJIdW5nZXIgYW5kIGNyYXZpbmdzIiwKICAgICAgICBkZXRhaWw6ICJBcHBldGl0ZSBrZWVwcyBwdWxsaW5nIG1lIG9mZi1wbGFuLiIsCiAgICAgICAgc2NvcmVzOiB7IGNyYXZpbmdfY3J1c2hlcjogMyB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogInNvY2lhbF9ldmVudHMiLAogICAgICAgIHRpdGxlOiAiU29jaWFsIGV2ZW50cyIsCiAgICAgICAgZGV0YWlsOiAiRGlubmVycyBhbmQgd2Vla2VuZHMgYXJlIGhhcmQuIiwKICAgICAgICBzY29yZXM6IHsgd2Vla2VuZF93YXJyaW9yOiAzIH0KICAgICAgfQogICAgXQogIH0sCiAgewogICAgaWQ6ICJwYWNlIiwKICAgIHByb21wdDogIlByZWZlcnJlZCBwYWNlOiIsCiAgICBoaW50OiAiU3VzdGFpbmFibGUgcGxhbnMgYXJlIHRoZSBmYXN0ZXN0IGluIHRoZSBsb25nIHJ1bi4iLAogICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBcnJvd1JpZ2h0LCB7IHNpemU6IDIwIH0pLAogICAgY2hvaWNlczogWwogICAgICB7CiAgICAgICAgaWQ6ICJzbG93X2Vhc3kiLAogICAgICAgIHRpdGxlOiAiU2xvdyBhbmQgZWFzeSIsCiAgICAgICAgZGV0YWlsOiAiU21hbGwgd2lucyBJIGNhbiBrZWVwLiIsCiAgICAgICAgc2NvcmVzOiB7IG1vbWVudHVtX2J1aWxkZXI6IDMsIGJ1c3lfbWluaW1hbGlzdDogMSB9CiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogIm1vZGVyYXRlIiwKICAgICAgICB0aXRsZTogIk1vZGVyYXRlIGFuZCBiYWxhbmNlZCIsCiAgICAgICAgZGV0YWlsOiAiU3RlYWR5IHByb2dyZXNzLCBsb3cgYnVybm91dCByaXNrLiIsCiAgICAgICAgc2NvcmVzOiB7IGJ1c3lfbWluaW1hbGlzdDogMiwgc3RydWN0dXJlZF9hY2hpZXZlcjogMSwgd2Vla2VuZF93YXJyaW9yOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAiYWdncmVzc2l2ZSIsCiAgICAgICAgdGl0bGU6ICJBZ2dyZXNzaXZlIGJ1dCBzYWZlIiwKICAgICAgICBkZXRhaWw6ICJJIGNhbiBoYW5kbGUgdGlnaHRlciBzdHJ1Y3R1cmUuIiwKICAgICAgICBzY29yZXM6IHsgc3RydWN0dXJlZF9hY2hpZXZlcjogMywgY3JhdmluZ19jcnVzaGVyOiAxIH0KICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAibmVlZF9ndWlkYW5jZSIsCiAgICAgICAgdGl0bGU6ICJOb3Qgc3VyZSwgZ3VpZGUgbWUiLAogICAgICAgIGRldGFpbDogIkkgbmVlZCBhIHJlYWxpc3RpYyBzdGFydGluZyBwb2ludC4iLAogICAgICAgIHNjb3JlczogeyBtb21lbnR1bV9idWlsZGVyOiAyLCBidXN5X21pbmltYWxpc3Q6IDIgfQogICAgICB9CiAgICBdCiAgfQpdOwp2YXIgUVVFU1RJT05fQ0hPSUNFX0xPT0tVUCA9IG5ldyBNYXAoCiAgUVVFU1RJT05TLm1hcCgocXVlc3Rpb24pID0+IFsKICAgIHF1ZXN0aW9uLmlkLAogICAgbmV3IFNldChxdWVzdGlvbi5jaG9pY2VzLm1hcCgoY2hvaWNlKSA9PiBjaG9pY2UuaWQpKQogIF0pCik7CnZhciB0cmFja0V2ZW50ID0gKGV2ZW50LCBkYXRhKSA9PiB7CiAgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICBtZXRob2Q6ICJQT1NUIiwKICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBldmVudCwgZGF0YTogZGF0YSB8fCB7fSB9KQogIH0pLmNhdGNoKCgpID0+IHsKICB9KTsKfTsKdmFyIG5vcm1hbGl6ZUFwaUJhc2VVcmwgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIikgcmV0dXJuIG51bGw7CiAgY29uc3QgdHJpbW1lZCA9IHZhbHVlLnRyaW0oKTsKICBpZiAoIXRyaW1tZWQpIHJldHVybiBudWxsOwogIHJldHVybiB0cmltbWVkLnJlcGxhY2UoL1wvKyQvLCAiIik7Cn07CnZhciByZXNvbHZlQXBpQmFzZVVybCA9IChpbml0aWFsRGF0YTIpID0+IHsKICBjb25zdCBmcm9tSHlkcmF0aW9uID0gbm9ybWFsaXplQXBpQmFzZVVybChpbml0aWFsRGF0YTI/LmFwaV9iYXNlX3VybCB8fCBpbml0aWFsRGF0YTI/LmFwaUJhc2VVcmwpOwogIGlmIChmcm9tSHlkcmF0aW9uKSByZXR1cm4gZnJvbUh5ZHJhdGlvbjsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgIGNvbnN0IGZyb21HbG9iYWwgPSBub3JtYWxpemVBcGlCYXNlVXJsKHdpbmRvdy5fX1dFSUdIVF9MT1NTX1FVSVpfQVBJX0JBU0VfVVJMX18pOwogICAgaWYgKGZyb21HbG9iYWwpIHJldHVybiBmcm9tR2xvYmFsOwogICAgY29uc3Qgb3JpZ2luID0gd2luZG93LmxvY2F0aW9uLm9yaWdpbjsKICAgIGlmIChvcmlnaW4gJiYgb3JpZ2luICE9PSAibnVsbCIgJiYgIW9yaWdpbi5pbmNsdWRlcygid2ViLXNhbmRib3gub2FpdXNlcmNvbnRlbnQuY29tIikpIHsKICAgICAgcmV0dXJuIG9yaWdpbjsKICAgIH0KICB9CiAgcmV0dXJuICJodHRwOi8vbG9jYWxob3N0OjgwMDEiOwp9Owp2YXIgYnVpbGRBcGlVcmwgPSAoYXBpQmFzZVVybCwgcGF0aCkgPT4gewogIGlmICgvXmh0dHBzPzpcL1wvL2kudGVzdChwYXRoKSkgcmV0dXJuIHBhdGg7CiAgcmV0dXJuIGAke2FwaUJhc2VVcmx9JHtwYXRoLnN0YXJ0c1dpdGgoIi8iKSA/IHBhdGggOiBgLyR7cGF0aH1gfWA7Cn07CmZ1bmN0aW9uIFN1cHBsZW1lbnRQaG90byh7CiAgbmFtZSwKICBmYWxsYmFja0ltYWdlLAogIGN1c3RvbUxhYmVscwp9KSB7CiAgY29uc3QgY2FuZGlkYXRlcyA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZU1lbW8pKCgpID0+IGJ1aWxkU3VwcGxlbWVudFBob3RvQ2FuZGlkYXRlcyhuYW1lLCBjdXN0b21MYWJlbHMpLCBbbmFtZSwgY3VzdG9tTGFiZWxzXSk7CiAgY29uc3QgW2NhbmRpZGF0ZUluZGV4LCBzZXRDYW5kaWRhdGVJbmRleF0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoMCk7CiAgY29uc3QgW3VzZUZhbGxiYWNrLCBzZXRVc2VGYWxsYmFja10gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoZmFsc2UpOwogICgwLCBpbXBvcnRfcmVhY3QzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgc2V0Q2FuZGlkYXRlSW5kZXgoMCk7CiAgICBzZXRVc2VGYWxsYmFjayhmYWxzZSk7CiAgfSwgW25hbWUsIGN1c3RvbUxhYmVsc10pOwogIGNvbnN0IGhhbmRsZUltYWdlRXJyb3IgPSAoKSA9PiB7CiAgICBpZiAodXNlRmFsbGJhY2spIHJldHVybjsKICAgIGlmIChjYW5kaWRhdGVJbmRleCA8IGNhbmRpZGF0ZXMubGVuZ3RoIC0gMSkgewogICAgICBzZXRDYW5kaWRhdGVJbmRleCgocHJldikgPT4gcHJldiArIDEpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRVc2VGYWxsYmFjayh0cnVlKTsKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgImltZyIsCiAgICB7CiAgICAgIHNyYzogdXNlRmFsbGJhY2sgPyBmYWxsYmFja0ltYWdlIDogY2FuZGlkYXRlc1tjYW5kaWRhdGVJbmRleF0sCiAgICAgIGFsdDogbmFtZSwKICAgICAgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgaGVpZ2h0OiAxMjAsIG9iamVjdEZpdDogImNvdmVyIiwgZGlzcGxheTogImJsb2NrIiB9LAogICAgICBvbkVycm9yOiBoYW5kbGVJbWFnZUVycm9yCiAgICB9CiAgKTsKfQp2YXIgc2FuaXRpemVBbnN3ZXJzID0gKHZhbHVlKSA9PiB7CiAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiKSByZXR1cm4ge307CiAgY29uc3QgaW5wdXQgPSB2YWx1ZTsKICBjb25zdCBjbGVhbmVkID0ge307CiAgUVVFU1RJT05TLmZvckVhY2goKHF1ZXN0aW9uKSA9PiB7CiAgICBjb25zdCBjYW5kaWRhdGUgPSBpbnB1dFtxdWVzdGlvbi5pZF07CiAgICBjb25zdCB2YWxpZENob2ljZXMgPSBRVUVTVElPTl9DSE9JQ0VfTE9PS1VQLmdldChxdWVzdGlvbi5pZCk7CiAgICBpZiAodHlwZW9mIGNhbmRpZGF0ZSA9PT0gInN0cmluZyIgJiYgdmFsaWRDaG9pY2VzPy5oYXMoY2FuZGlkYXRlKSkgewogICAgICBjbGVhbmVkW3F1ZXN0aW9uLmlkXSA9IGNhbmRpZGF0ZTsKICAgIH0KICB9KTsKICByZXR1cm4gY2xlYW5lZDsKfTsKdmFyIGdldFNhdmVkQW5zd2VycyA9ICgpID0+IHsKICB0cnkgewogICAgY29uc3QgcmF3ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oUVVJWl9TVEFURV9LRVkpOwogICAgaWYgKCFyYXcpIHJldHVybiB7fTsKICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2UocmF3KTsKICAgIGlmIChwYXJzZWQgJiYgdHlwZW9mIHBhcnNlZCA9PT0gIm9iamVjdCIgJiYgcGFyc2VkLmFuc3dlcnMgJiYgdHlwZW9mIHBhcnNlZC5hbnN3ZXJzID09PSAib2JqZWN0IikgewogICAgICByZXR1cm4gc2FuaXRpemVBbnN3ZXJzKHBhcnNlZC5hbnN3ZXJzKTsKICAgIH0KICB9IGNhdGNoIHsKICB9CiAgcmV0dXJuIHt9Owp9Owp2YXIgc2NvcmVRdWl6ID0gKGFuc3dlcnMpID0+IHsKICBjb25zdCB0b3RhbHMgPSB7CiAgICBzdHJ1Y3R1cmVkX2FjaGlldmVyOiAwLAogICAgYnVzeV9taW5pbWFsaXN0OiAwLAogICAgY3JhdmluZ19jcnVzaGVyOiAwLAogICAgd2Vla2VuZF93YXJyaW9yOiAwLAogICAgbW9tZW50dW1fYnVpbGRlcjogMAogIH07CiAgUVVFU1RJT05TLmZvckVhY2goKHF1ZXN0aW9uKSA9PiB7CiAgICBjb25zdCBzZWxlY3RlZCA9IHF1ZXN0aW9uLmNob2ljZXMuZmluZCgoY2hvaWNlKSA9PiBjaG9pY2UuaWQgPT09IGFuc3dlcnNbcXVlc3Rpb24uaWRdKTsKICAgIGlmICghc2VsZWN0ZWQpIHJldHVybjsKICAgIFBST0ZJTEVfT1JERVIuZm9yRWFjaCgocHJvZmlsZSkgPT4gewogICAgICB0b3RhbHNbcHJvZmlsZV0gKz0gc2VsZWN0ZWQuc2NvcmVzW3Byb2ZpbGVdIHx8IDA7CiAgICB9KTsKICB9KTsKICByZXR1cm4gdG90YWxzOwp9Owp2YXIgcGlja1RvcFByb2ZpbGUgPSAoc2NvcmVzKSA9PiB7CiAgcmV0dXJuIFBST0ZJTEVfT1JERVIuc2xpY2UoKS5zb3J0KChhLCBiKSA9PiB7CiAgICBjb25zdCBzY29yZURpZmYgPSBzY29yZXNbYl0gLSBzY29yZXNbYV07CiAgICBpZiAoc2NvcmVEaWZmICE9PSAwKSByZXR1cm4gc2NvcmVEaWZmOwogICAgcmV0dXJuIFBST0ZJTEVfT1JERVIuaW5kZXhPZihhKSAtIFBST0ZJTEVfT1JERVIuaW5kZXhPZihiKTsKICB9KVswXTsKfTsKZnVuY3Rpb24gV2VpZ2h0TG9zc1F1aXooeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBhcGlCYXNlVXJsID0gKDAsIGltcG9ydF9yZWFjdDMudXNlTWVtbykoKCkgPT4gcmVzb2x2ZUFwaUJhc2VVcmwoaW5pdGlhbERhdGEyKSwgW2luaXRpYWxEYXRhMl0pOwogIGNvbnN0IFthbnN3ZXJzLCBzZXRBbnN3ZXJzXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgoKSA9PiBnZXRTYXZlZEFuc3dlcnMoKSk7CiAgY29uc3QgW2N1cnJlbnRJbmRleCwgc2V0Q3VycmVudEluZGV4XSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgoKSA9PiB7CiAgICBjb25zdCBzYXZlZCA9IGdldFNhdmVkQW5zd2VycygpOwogICAgY29uc3QgbmV4dE9wZW4gPSBRVUVTVElPTlMuZmluZEluZGV4KChxKSA9PiAhc2F2ZWRbcS5pZF0pOwogICAgcmV0dXJuIG5leHRPcGVuID09PSAtMSA/IFFVRVNUSU9OUy5sZW5ndGggLSAxIDogbmV4dE9wZW47CiAgfSk7CiAgY29uc3QgW3Nob3dSZXN1bHRzLCBzZXRTaG93UmVzdWx0c10gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoKCkgPT4gewogICAgY29uc3Qgc2F2ZWQgPSBnZXRTYXZlZEFuc3dlcnMoKTsKICAgIHJldHVybiBRVUVTVElPTlMuZXZlcnkoKHEpID0+IEJvb2xlYW4oc2F2ZWRbcS5pZF0pKTsKICB9KTsKICBjb25zdCBbc2hvd0hvbWVTY3JlZW4sIHNldFNob3dIb21lU2NyZWVuXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgoKSA9PiB7CiAgICBjb25zdCBzYXZlZCA9IGdldFNhdmVkQW5zd2VycygpOwogICAgcmV0dXJuICFRVUVTVElPTlMuZXZlcnkoKHEpID0+IEJvb2xlYW4oc2F2ZWRbcS5pZF0pKTsKICB9KTsKICBjb25zdCBbc2hvd1N1YnNjcmliZU1vZGFsLCBzZXRTaG93U3Vic2NyaWJlTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc3Vic2NyaWJlRW1haWwsIHNldFN1YnNjcmliZUVtYWlsXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3N1YnNjcmliZVN0YXR1cywgc2V0U3Vic2NyaWJlU3RhdHVzXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgiaWRsZSIpOwogIGNvbnN0IFtzdWJzY3JpYmVNZXNzYWdlLCBzZXRTdWJzY3JpYmVNZXNzYWdlXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3Nob3dGZWVkYmFja01vZGFsLCBzZXRTaG93RmVlZGJhY2tNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtmZWVkYmFja1RleHQsIHNldEZlZWRiYWNrVGV4dF0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtmZWVkYmFja1N0YXR1cywgc2V0RmVlZGJhY2tTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW2Vuam95Vm90ZSwgc2V0RW5qb3lWb3RlXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCBzYXZlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEVOSk9ZX1ZPVEVfS0VZKTsKICAgICAgcmV0dXJuIHNhdmVkID09PSAidXAiIHx8IHNhdmVkID09PSAiZG93biIgPyBzYXZlZCA6IG51bGw7CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfSk7CiAgY29uc3QgW2NvcGllZCwgc2V0Q29waWVkXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2V4cGFuZGVkUmVjaXBlcywgc2V0RXhwYW5kZWRSZWNpcGVzXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSh7fSk7CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICB0cnkgewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShRVUlaX1NUQVRFX0tFWSwgSlNPTi5zdHJpbmdpZnkoeyBhbnN3ZXJzLCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfSkpOwogICAgfSBjYXRjaCB7CiAgICB9CiAgfSwgW2Fuc3dlcnNdKTsKICAoMCwgaW1wb3J0X3JlYWN0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIHRyYWNrRXZlbnQoInF1aXpfdmlldyIsIHsgZnJvbUh5ZHJhdGlvbjogQm9vbGVhbihpbml0aWFsRGF0YTIgJiYgT2JqZWN0LmtleXMoaW5pdGlhbERhdGEyKS5sZW5ndGggPiAwKSB9KTsKICB9LCBbaW5pdGlhbERhdGEyXSk7CiAgY29uc3QgYW5zd2VyZWRDb3VudCA9IE1hdGgubWluKE9iamVjdC5rZXlzKGFuc3dlcnMpLmxlbmd0aCwgUVVFU1RJT05TLmxlbmd0aCk7CiAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigxMDAsIE1hdGgucm91bmQoYW5zd2VyZWRDb3VudCAvIFFVRVNUSU9OUy5sZW5ndGggKiAxMDApKTsKICBjb25zdCBhY3RpdmVRdWVzdGlvbiA9IFFVRVNUSU9OU1tNYXRoLm1pbihjdXJyZW50SW5kZXgsIFFVRVNUSU9OUy5sZW5ndGggLSAxKV07CiAgY29uc3QgaXNWaXNpb25TdGFnZSA9ICFzaG93UmVzdWx0cyAmJiBjdXJyZW50SW5kZXggPCAzOwogIGNvbnN0IHNjb3JlcyA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZU1lbW8pKCgpID0+IHNjb3JlUXVpeihhbnN3ZXJzKSwgW2Fuc3dlcnNdKTsKICBjb25zdCB0b3BQcm9maWxlID0gKDAsIGltcG9ydF9yZWFjdDMudXNlTWVtbykoKCkgPT4gcGlja1RvcFByb2ZpbGUoc2NvcmVzKSwgW3Njb3Jlc10pOwogIGNvbnN0IHByb2ZpbGUgPSBQUk9GSUxFU1t0b3BQcm9maWxlXTsKICBjb25zdCBhcmNoZXR5cGVWaXN1YWwgPSBBUkNIRVRZUEVfVklTVUFMU1t0b3BQcm9maWxlXTsKICBjb25zdCBtYXhTY29yZSA9IE1hdGgubWF4KC4uLk9iamVjdC52YWx1ZXMoc2NvcmVzKSwgMSk7CiAgY29uc3QgaGFuZGxlQW5zd2VyID0gKHF1ZXN0aW9uSWQsIGNob2ljZUlkKSA9PiB7CiAgICBjb25zdCBuZXh0QW5zd2VycyA9IHsgLi4uYW5zd2VycywgW3F1ZXN0aW9uSWRdOiBjaG9pY2VJZCB9OwogICAgc2V0QW5zd2VycyhuZXh0QW5zd2Vycyk7CiAgICB0cmFja0V2ZW50KCJxdWl6X2Fuc3dlcmVkIiwgeyBxdWVzdGlvbklkLCBjaG9pY2VJZCwgYW5zd2VyZWRDb3VudDogT2JqZWN0LmtleXMobmV4dEFuc3dlcnMpLmxlbmd0aCB9KTsKICAgIGNvbnN0IGlzTGFzdFF1ZXN0aW9uID0gY3VycmVudEluZGV4ID49IFFVRVNUSU9OUy5sZW5ndGggLSAxOwogICAgaWYgKGlzTGFzdFF1ZXN0aW9uKSB7CiAgICAgIHNldFNob3dSZXN1bHRzKHRydWUpOwogICAgICB0cmFja0V2ZW50KCJxdWl6X2NvbXBsZXRlZCIsIHsgcHJvZmlsZTogcGlja1RvcFByb2ZpbGUoc2NvcmVRdWl6KG5leHRBbnN3ZXJzKSkgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHsKICAgICAgc2V0Q3VycmVudEluZGV4KChwcmV2KSA9PiBNYXRoLm1pbihwcmV2ICsgMSwgUVVFU1RJT05TLmxlbmd0aCAtIDEpKTsKICAgIH0sIDEyMCk7CiAgfTsKICBjb25zdCBoYW5kbGVSZXN0YXJ0ID0gKCkgPT4gewogICAgc2V0QW5zd2Vycyh7fSk7CiAgICBzZXRDdXJyZW50SW5kZXgoMCk7CiAgICBzZXRTaG93UmVzdWx0cyhmYWxzZSk7CiAgICBzZXRTaG93SG9tZVNjcmVlbih0cnVlKTsKICAgIHNldEV4cGFuZGVkUmVjaXBlcyh7fSk7CiAgICBzZXRDb3BpZWQoZmFsc2UpOwogICAgdHJ5IHsKICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oUVVJWl9TVEFURV9LRVkpOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICB0cmFja0V2ZW50KCJxdWl6X3Jlc2V0Iik7CiAgfTsKICBjb25zdCBoYW5kbGVTdGFydFF1aXogPSAoKSA9PiB7CiAgICBzZXRTaG93SG9tZVNjcmVlbihmYWxzZSk7CiAgICB0cmFja0V2ZW50KCJxdWl6X3N0YXJ0ZWQiLCB7IHJlc3VtZWQ6IGFuc3dlcmVkQ291bnQgPiAwIH0pOwogIH07CiAgY29uc3QgaGFuZGxlQ29weVBsYW4gPSBhc3luYyAoKSA9PiB7CiAgICBjb25zdCB0ZXh0ID0gWwogICAgICBgV2VpZ2h0LUxvc3MgUXVpeiBSZXN1bHQ6ICR7cHJvZmlsZS5sYWJlbH1gLAogICAgICBgQXJjaGV0eXBlIGNvZGU6ICR7YXJjaGV0eXBlVmlzdWFsLmNvZGV9YCwKICAgICAgYXJjaGV0eXBlVmlzdWFsLmhlYWRsaW5lLAogICAgICAuLi5hcmNoZXR5cGVWaXN1YWwucGlsbGFycy5tYXAoKHBpbGxhcikgPT4gYCR7cGlsbGFyLmxldHRlcn0gLSAke3BpbGxhci50aXRsZX06ICR7cGlsbGFyLmRldGFpbH1gKSwKICAgICAgLi4ucHJvZmlsZS5kZXNjcmlwdGlvbiwKICAgICAgYEZpcnN0IGZvY3VzOiAke3Byb2ZpbGUuZmlyc3RGb2N1c31gLAogICAgICAiNyBEYXkgUGxhbjoiLAogICAgICAuLi5wcm9maWxlLndlZWtQbGFuLm1hcCgoZW50cnkpID0+IGAke2VudHJ5LmRheX06ICR7ZW50cnkuZm9jdXN9IC0gJHtlbnRyeS5kZXRhaWxzfWApLAogICAgICAiU3VwcGxlbWVudHM6IiwKICAgICAgLi4uRkVBVFVSRURfU1VQUExFTUVOVFMubWFwKChpdGVtKSA9PiBgLSAke2l0ZW0ubmFtZX06ICR7aXRlbS5hbWF6b25Vcmx9YCksCiAgICAgICJHdWlkYW5jZSBBbmQgTWVudG9yc2hpcDoiLAogICAgICAuLi5wcm9maWxlLm1lbnRvcmluZy5tYXAoKGl0ZW0pID0+IGAtICR7aXRlbS5sYWJlbH06ICR7aXRlbS51cmx9ICgke2l0ZW0ubm90ZX0pYCksCiAgICAgICJQZXJzb25hbGl6ZWQgUmVjaXBlczoiLAogICAgICAuLi5wcm9maWxlLnJlY2lwZXMubWFwKChpdGVtKSA9PiBgLSAke2l0ZW0ubmFtZX06ICR7aXRlbS53aHl9IEJ1aWxkOiAke2l0ZW0uYnVpbGR9YCksCiAgICAgIGBBdm9pZDogJHtwcm9maWxlLmF2b2lkfWAsCiAgICAgIGBUaW1lbGluZTogJHtwcm9maWxlLnRpbWVsaW5lfWAKICAgIF0uam9pbigiXG4iKTsKICAgIHRyeSB7CiAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpOwogICAgICBzZXRDb3BpZWQodHJ1ZSk7CiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHNldENvcGllZChmYWxzZSksIDE4MDApOwogICAgICB0cmFja0V2ZW50KCJxdWl6X2NvcHlfcGxhbiIsIHsgcHJvZmlsZTogcHJvZmlsZS5sYWJlbCB9KTsKICAgIH0gY2F0Y2ggewogICAgICBzZXRDb3BpZWQoZmFsc2UpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlRW5qb3lWb3RlID0gKHZvdGUpID0+IHsKICAgIHNldEVuam95Vm90ZSh2b3RlKTsKICAgIHRyeSB7CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEVOSk9ZX1ZPVEVfS0VZLCB2b3RlKTsKICAgIH0gY2F0Y2ggewogICAgfQogICAgdHJhY2tFdmVudCgiZW5qb3lfdm90ZSIsIHsgdm90ZSwgdG9vbDogIndlaWdodC1sb3NzLXF1aXoiIH0pOwogICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgfTsKICBjb25zdCBoYW5kbGVTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIXN1YnNjcmliZUVtYWlsIHx8ICFzdWJzY3JpYmVFbWFpbC5pbmNsdWRlcygiQCIpKSB7CiAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiUGxlYXNlIGVudGVyIGEgdmFsaWQgZW1haWwuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldFN1YnNjcmliZVN0YXR1cygibG9hZGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChidWlsZEFwaVVybChhcGlCYXNlVXJsLCAiL2FwaS9zdWJzY3JpYmUiKSwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGVtYWlsOiBzdWJzY3JpYmVFbWFpbCwKICAgICAgICAgIHRvcGljSWQ6ICJ3ZWlnaHQtbG9zcy1xdWl6LW5ld3MiLAogICAgICAgICAgdG9waWNOYW1lOiAiV2VpZ2h0LUxvc3MgUXVpeiBVcGRhdGVzIgogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBpZiAocmVzcG9uc2Uub2sgJiYgZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLm1lc3NhZ2UgfHwgIlN1YnNjcmliZWQuIik7CiAgICAgICAgdHJhY2tFdmVudCgibm90aWZ5X21lX3N1YnNjcmliZSIsIHsgdG9waWM6ICJ3ZWlnaHQtbG9zcy1xdWl6LW5ld3MiIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKGRhdGEuZXJyb3IgfHwgIlVuYWJsZSB0byBzdWJzY3JpYmUgcmlnaHQgbm93LiIpOwogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJOZXR3b3JrIGVycm9yLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlRmVlZGJhY2tTdWJtaXQgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIWZlZWRiYWNrVGV4dC50cmltKCkpIHJldHVybjsKICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWJtaXR0aW5nIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGJ1aWxkQXBpVXJsKGFwaUJhc2VVcmwsICIvYXBpL3RyYWNrIiksIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogInVzZXJfZmVlZGJhY2siLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICB0b29sOiAid2VpZ2h0LWxvc3MtcXVpeiIsCiAgICAgICAgICAgIGVuam95bWVudFZvdGU6IGVuam95Vm90ZSwKICAgICAgICAgICAgcHJvZmlsZTogcHJvZmlsZS5sYWJlbCwKICAgICAgICAgICAgZmVlZGJhY2s6IGZlZWRiYWNrVGV4dAogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgIHRyYWNrRXZlbnQoInVzZXJfZmVlZGJhY2siLCB7IHByb2ZpbGU6IHByb2ZpbGUubGFiZWwsIGVuam95bWVudFZvdGU6IGVuam95Vm90ZSB8fCBudWxsIH0pOwogICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpOwogICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgfSwgOTAwKTsKICAgIH0gY2F0Y2ggewogICAgICBzZXRGZWVkYmFja1N0YXR1cygiZXJyb3IiKTsKICAgIH0KICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICJkaXYiLAogICAgewogICAgICBzdHlsZTogewogICAgICAgIG1pbkhlaWdodDogIjEwMHZoIiwKICAgICAgICBiYWNrZ3JvdW5kOiBgbGluZWFyLWdyYWRpZW50KDE2MGRlZywgJHtDT0xPUlMuYmd9IDAlLCAjRUZFOEREIDQ1JSwgI0U1RUZFOCAxMDAlKWAsCiAgICAgICAgcGFkZGluZzogIjIwcHggMTJweCAzMnB4IiwKICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICAgIGZvbnRGYW1pbHk6IEZPTlRTLmJvZHkKICAgICAgfSwKICAgICAgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICBtYXhXaWR0aDogNjAwLAogICAgICAgICAgICAgIG1hcmdpbjogIjAgYXV0byIsCiAgICAgICAgICAgICAgYW5pbWF0aW9uOiAiZmxvYXRJbiAyMjBtcyBlYXNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjIsCiAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDIwLAogICAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICIwIDEycHggMzBweCByZ2JhKDI2LDI2LDI2LDAuMDcpIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICFzaG93UmVzdWx0cyAmJiBzaG93SG9tZVNjcmVlbiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGFuaW1hdGlvbjogImZsb2F0SW4gMjYwbXMgZWFzZSIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTgsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDE4LAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCwKICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogYHJhZGlhbC1ncmFkaWVudChjaXJjbGUgYXQgdG9wIHJpZ2h0LCAjRTVFRkU4IDAlLCAjRjdGM0VDIDQyJSwgI0ZGRkZGRiAxMDAlKWAKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDk5OSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuOCkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldHRlclNwYWNpbmc6IDAuNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU3BhcmtsZXMsIHsgc2l6ZTogMTMgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgV2VpZ2h0LUxvc3MgQmx1ZXByaW50IFF1aXoiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMSIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiMTJweCAwIDhweCIsIGZvbnRTaXplOiAzMCwgbGluZUhlaWdodDogMS4wOCwgZm9udEZhbWlseTogRk9OVFMuZGlzcGxheSB9LCBjaGlsZHJlbjogIlRha2UgdGhlIDItbWludXRlIHF1aXogdG8gZ2V0IHlvdXIgZmF0LWxvc3MgYmx1ZXByaW50LiIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjAgMCAxMHB4IiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTQsIGxpbmVIZWlnaHQ6IDEuNSB9LCBjaGlsZHJlbjogIlN0YXJ0IHRoZSBxdWl6IG5vdyB0byBpZGVudGlmeSB5b3VyIGFyY2hldHlwZSBhbmQgZmluaXNoIHdpdGggYSBwZXJzb25hbGl6ZWQgNy1kYXkgcGxhbiwgY3VzdG9tIHJlY2lwZXMsIGFuZCBzdXBwbGVtZW50IHN1Z2dlc3Rpb25zIG1hdGNoZWQgdG8geW91ciBoYWJpdHMuIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1mbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhcDogNywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA5OTksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjg2KSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI3cHggMTFweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkJvdHRvbTogMTQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNzAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBcnJvd1JpZ2h0LCB7IHNpemU6IDEzIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIFRhcCBcdTIwMUNUYWtlIHRoZSBxdWl6IG5vd1x1MjAxRCB0byBiZWdpbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBnYXA6IDksIG1hcmdpbkJvdHRvbTogMTQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRhcmdldCwgeyBzaXplOiAxNSwgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyayB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAiS25vdyB5b3VyIGFyY2hldHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWw6ICJMZWFybiB0aGUgZXhhY3QgYmVoYXZpb3IgcGF0dGVybiB0aGF0IGlzIGRyaXZpbmcgeW91ciBmYXQtbG9zcyByZXN1bHRzLiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hhcnRDb2x1bW4sIHsgc2l6ZTogMTUsIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmsgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogIkdldCBhIHBlcnNvbmFsaXplZCA3LWRheSBwbGFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbDogIlJlY2VpdmUgY2xlYXIgZGFpbHkgYWN0aW9ucyBmb3IgeW91ciBmaXJzdCB3ZWVrLiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoSGVhcnQsIHsgc2l6ZTogMTUsIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmsgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogIlVubG9jayBjdXN0b20gcmVjaXBlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWw6ICJTZWUgcHJhY3RpY2FsIHJlY2lwZSBpZGVhcyBidWlsdCBmb3IgeW91ciBwcm9maWxlLiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVGltZXIsIHsgc2l6ZTogMTUsIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmsgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogIkdldCBzdXBwbGVtZW50IHN1Z2dlc3Rpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbDogIlJldmlldyAzIHRhaWxvcmVkIHN1cHBsZW1lbnQgcGlja3Mgd2l0aCBidXkgbGlua3MuIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgXS5tYXAoKGl0ZW0pID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTBweCAxMXB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjgyKSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAyOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAyOCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxleFNocmluazogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5hY2NlbnRMaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBpdGVtLmljb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogaXRlbS50aXRsZSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjQgfSwgY2hpbGRyZW46IGl0ZW0uZGV0YWlsIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUKICAgICAgICAgICAgICAgICAgICAgICAgKSkgfSksCiAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVTdGFydFF1aXosCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDogYGxpbmVhci1ncmFkaWVudCg5MGRlZywgJHtDT0xPUlMucHJpbWFyeURhcmt9LCAke0NPTE9SUy5wcmltYXJ5fSlgLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogODAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMnB4IDE0cHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1mbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyZWRDb3VudCA+IDAgPyAiUmVzdW1lIHF1aXoiIDogIlRha2UgdGhlIHF1aXogbm93IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBcnJvd1JpZ2h0LCB7IHNpemU6IDE2IH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApIH0pLAogICAgICAgICAgICAgICAgICAhc2hvd1Jlc3VsdHMgJiYgIXNob3dIb21lU2NyZWVuICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxMiwgYWxpZ25JdGVtczogImNlbnRlciIsIG1hcmdpbkJvdHRvbTogMTQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGV0dGVyU3BhY2luZzogMC4zLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogIldlaWdodC1Mb3NzIEJsdWVwcmludCBRdWl6IiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDEiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjZweCAwIDAiLCBmb250U2l6ZTogMjQsIGxpbmVIZWlnaHQ6IDEuMTUsIGZvbnRGYW1pbHk6IEZPTlRTLmRpc3BsYXkgfSwgY2hpbGRyZW46ICJGaW5kIHlvdXIgZWFzaWVzdCBmYXQtbG9zcyBzdHJhdGVneSIgfSkKICAgICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aDogNzIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDEwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA5OTksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dEFsaWduOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IGAke2Fuc3dlcmVkQ291bnR9LyR7UVVFU1RJT05TLmxlbmd0aH1gCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxOCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDgsIGJvcmRlclJhZGl1czogOTk5LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBgJHtwcm9ncmVzc30lYCwKICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDk5OSwKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBgbGluZWFyLWdyYWRpZW50KDkwZGVnLCAke0NPTE9SUy5wcmltYXJ5RGFya30sICR7Q09MT1JTLnByaW1hcnl9KWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogIndpZHRoIDIyMG1zIGVhc2UiCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApIH0pIH0pCiAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICFzaG93UmVzdWx0cyAmJiAhc2hvd0hvbWVTY3JlZW4gJiYgYWN0aXZlUXVlc3Rpb24gJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoaW1wb3J0X2pzeF9ydW50aW1lLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxNAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3BhbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1mbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDM0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMzQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5hY2NlbnRMaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogYWN0aXZlUXVlc3Rpb24uaWNvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgaXNWaXNpb25TdGFnZSA/IGBWaXNpb24gc3RlcCAke2N1cnJlbnRJbmRleCArIDF9IG9mIDNgIDogYFF1ZXN0aW9uICR7Y3VycmVudEluZGV4ICsgMX1gCiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgyIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgOHB4IiwgZm9udFNpemU6IDIxLCBsaW5lSGVpZ2h0OiAxLjI1IH0sIGNoaWxkcmVuOiBhY3RpdmVRdWVzdGlvbi5wcm9tcHQgfSksCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiMCAwIDE2cHgiLCBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogYWN0aXZlUXVlc3Rpb24uaGludCB9KSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ2FwOiAxMCB9LCBjaGlsZHJlbjogYWN0aXZlUXVlc3Rpb24uY2hvaWNlcy5tYXAoKGNob2ljZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNTZWxlY3RlZCA9IGFuc3dlcnNbYWN0aXZlUXVlc3Rpb24uaWRdID09PSBjaG9pY2UuaWQ7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IGhhbmRsZUFuc3dlcihhY3RpdmVRdWVzdGlvbi5pZCwgY2hvaWNlLmlkKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dEFsaWduOiAibGVmdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTRweCAxNHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGlzU2VsZWN0ZWQgPyBgMnB4IHNvbGlkICR7Q09MT1JTLnByaW1hcnl9YCA6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGlzU2VsZWN0ZWQgPyBDT0xPUlMuYWNjZW50TGlnaHQgOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjE1cyBlYXNlIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250U2l6ZTogMTQgfSwgY2hpbGRyZW46IGNob2ljZS50aXRsZSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDIsIGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBjaG9pY2UuZGV0YWlsIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTZWxlY3RlZCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENpcmNsZUNoZWNrLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaG9pY2UuaWQKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkgfSksCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldEN1cnJlbnRJbmRleCgocCkgPT4gTWF0aC5tYXgoMCwgcCAtIDEpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZDogY3VycmVudEluZGV4ID09PSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IGN1cnJlbnRJbmRleCA9PT0gMCA/IENPTE9SUy50ZXh0TXV0ZWQgOiBDT0xPUlMudGV4dE1haW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOXB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiBjdXJyZW50SW5kZXggPT09IDAgPyAibm90LWFsbG93ZWQiIDogInBvaW50ZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaGV2cm9uTGVmdCwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgQmFjayIKICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggPj0gUVVFU1RJT05TLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0U2hvd1Jlc3VsdHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNrRXZlbnQoInF1aXpfY29tcGxldGVkIiwgeyBwcm9maWxlOiB0b3BQcm9maWxlIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEluZGV4KChwKSA9PiBNYXRoLm1pbihRVUVTVElPTlMubGVuZ3RoIC0gMSwgcCArIDEpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOXB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPj0gUVVFU1RJT05TLmxlbmd0aCAtIDEgPyAiU2hvdyByZXN1bHQiIDogIk5leHQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShBcnJvd1JpZ2h0LCB7IHNpemU6IDE1IH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICBzaG93UmVzdWx0cyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBhbmltYXRpb246ICJmbG9hdEluIDIyMG1zIGVhc2UiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBgbGluZWFyLWdyYWRpZW50KDE0NWRlZywgJHtwcm9maWxlLmJnfSAwJSwgI0ZGRkZGRiAxMDAlKWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogMTgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAxNAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBwcm9maWxlLmFjY2VudCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNCB9LCBjaGlsZHJlbjogIllvdXIgYXJjaGV0eXBlIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTQsIGZsZXhXcmFwOiAid3JhcCIsIG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbldpZHRoOiAxMjAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGV4OiAiMCAwIDEyMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiBgbGluZWFyLWdyYWRpZW50KDE2MGRlZywgJHtwcm9maWxlLmFjY2VudH0gMCUsICR7Q09MT1JTLnByaW1hcnlEYXJrfSAxMDAlKWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiNmZmYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggOHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm94U2hhZG93OiAiMCAxMHB4IDIycHggcmdiYSgwLDAsMCwwLjE2KSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDEsIG9wYWNpdHk6IDAuOSB9LCBjaGlsZHJlbjogIlR5cGUiIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogNTIsIGxpbmVIZWlnaHQ6IDEsIGZvbnRXZWlnaHQ6IDgwMCwgZm9udEZhbWlseTogRk9OVFMuZGlzcGxheSB9LCBjaGlsZHJlbjogYXJjaGV0eXBlVmlzdWFsLmNvZGUgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuOCwgb3BhY2l0eTogMC45IH0sIGNoaWxkcmVuOiAiQXJjaGV0eXBlIiB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6ICIxIDEgMjgwcHgiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgyIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgNHB4IiwgZm9udFNpemU6IDQwLCBsaW5lSGVpZ2h0OiAxLjAyLCBmb250RmFtaWx5OiBGT05UUy5kaXNwbGF5IH0sIGNoaWxkcmVuOiBwcm9maWxlLmxhYmVsIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwIiwgeyBzdHlsZTogeyBtYXJnaW46IDAsIGZvbnRTaXplOiAxNiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBwcm9maWxlLnRhZyB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiMTBweCAwIDAiLCBmb250U2l6ZTogMTUsIGxpbmVIZWlnaHQ6IDEuNDUsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IGFyY2hldHlwZVZpc3VhbC5oZWFkbGluZSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDEyLCBkaXNwbGF5OiAiZ3JpZCIsIGdhcDogNyB9LCBjaGlsZHJlbjogYXJjaGV0eXBlVmlzdWFsLnBpbGxhcnMubWFwKChwaWxsYXIsIGlkeCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiNGQ0ZDRkEiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAzNCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDM0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHBpbGxhci5jb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiNmZmYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAyMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA4MDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZUhlaWdodDogIjM0cHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxleFNocmluazogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250RmFtaWx5OiBGT05UUy5kaXNwbGF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBwaWxsYXIubGV0dGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgZm9udEZhbWlseTogRk9OVFMuZGlzcGxheSB9LCBjaGlsZHJlbjogcGlsbGFyLnRpdGxlIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGluZUhlaWdodDogMS40IH0sIGNoaWxkcmVuOiBwaWxsYXIuZGV0YWlsIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZS5kZXNjcmlwdGlvbltpZHhdICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiA2LCBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGxpbmVIZWlnaHQ6IDEuNDUgfSwgY2hpbGRyZW46IHByb2ZpbGUuZGVzY3JpcHRpb25baWR4XSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpbGxhci50aXRsZQogICAgICAgICAgICAgICAgICAgICAgICAgICkpIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNCwKICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAxNCwKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjZmZmIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEyCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjAgMCA4cHgiLCBmb250U2l6ZTogMTgsIGZvbnRGYW1pbHk6IEZPTlRTLmRpc3BsYXkgfSwgY2hpbGRyZW46ICJZb3VyIGZpcnN0IGZvY3VzIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgMTJweCIsIGZvbnRTaXplOiAxNSwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjUgfSwgY2hpbGRyZW46IHByb2ZpbGUuZmlyc3RGb2N1cyB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXRhaWxzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDEwcHgiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3VtbWFyeSIsIHsgc3R5bGU6IHsgY3Vyc29yOiAicG9pbnRlciIsIGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBmb250RmFtaWx5OiBGT05UUy5kaXNwbGF5IH0sIGNoaWxkcmVuOiAiNyBEYXkgUGxhbiIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBnYXA6IDgsIG1hcmdpblRvcDogMTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2ZpbGUud2Vla1BsYW4ubWFwKChlbnRyeSkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmsgfSwgY2hpbGRyZW46IGVudHJ5LmRheSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAyLCBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgZm9udEZhbWlseTogRk9OVFMuZGlzcGxheSB9LCBjaGlsZHJlbjogZW50cnkuZm9jdXMgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMywgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGxpbmVIZWlnaHQ6IDEuNDUgfSwgY2hpbGRyZW46IGVudHJ5LmRldGFpbHMgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJ5LmRheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luVG9wOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMud2FybmluZ0JnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICNFQkQ5QkFgLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZUhlaWdodDogMS40NSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIzZGNEQxQSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiAiQXZvaWQgdGhpczoiIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZmlsZS5hdm9pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAyLCBmb250U2l6ZTogMTQsIGxpbmVIZWlnaHQ6IDEuNDUsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogcHJvZmlsZS50aW1lbGluZSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGV0YWlscyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDEwcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpblRvcDogMTAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdW1tYXJ5IiwgeyBzdHlsZTogeyBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRGYW1pbHk6IEZPTlRTLmRpc3BsYXkgfSwgY2hpbGRyZW46ICJQZXJzb25hbGl6ZWQgUmVjaXBlcyIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdhcDogOCwgbWFyZ2luVG9wOiAxMCB9LCBjaGlsZHJlbjogcHJvZmlsZS5yZWNpcGVzLm1hcCgoaXRlbSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGV0YWlscyA9IFJFQ0lQRV9ERVRBSUxTW2l0ZW0ubmFtZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0V4cGFuZGVkID0gQm9vbGVhbihleHBhbmRlZFJlY2lwZXNbaXRlbS5uYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDExcHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjRkNGQ0ZBIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxMCwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgZm9udEZhbWlseTogRk9OVFMuZGlzcGxheSB9LCBjaGlsZHJlbjogaXRlbS5uYW1lIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBsaW5lSGVpZ2h0OiAxLjQ1LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogaXRlbS53aHkgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0RXhwYW5kZWRSZWNpcGVzKChwcmV2KSA9PiAoeyAuLi5wcmV2LCBbaXRlbS5uYW1lXTogIWlzRXhwYW5kZWQgfSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAibm93cmFwIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBpc0V4cGFuZGVkID8gIkhpZGUiIDogIkV4cGFuZCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGxpbmVIZWlnaHQ6IDEuNDUsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG1hcmdpblRvcDogNSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiAiQnVpbGQ6IiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiAiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmJ1aWxkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFeHBhbmRlZCAmJiBkZXRhaWxzICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgYm9yZGVyVG9wOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsIHBhZGRpbmdUb3A6IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMucHJpbWFyeURhcmsgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzLnByZXBUaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgcHJlcCBceEI3ICIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlscy5jb29rVGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGNvb2sgXHhCNyBTZXJ2ZXMgIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzLnNlcnZpbmdzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiA4LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkluZ3JlZGllbnRzIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgidWwiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjZweCAwIDAiLCBwYWRkaW5nTGVmdDogMTgsIGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjQ1IH0sIGNoaWxkcmVuOiBkZXRhaWxzLmluZ3JlZGllbnRzLm1hcCgoaW5ncmVkaWVudCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGkiLCB7IGNoaWxkcmVuOiBpbmdyZWRpZW50IH0sIGluZ3JlZGllbnQpKSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDgsIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiUmVjaXBlIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgib2wiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjZweCAwIDAiLCBwYWRkaW5nTGVmdDogMTgsIGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjQ1IH0sIGNoaWxkcmVuOiBkZXRhaWxzLnN0ZXBzLm1hcCgoc3RlcCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGkiLCB7IGNoaWxkcmVuOiBzdGVwIH0sIHN0ZXApKSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRldGFpbHMiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkJvdHRvbTogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTBweCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdW1tYXJ5IiwgeyBzdHlsZTogeyBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRGYW1pbHk6IEZPTlRTLmRpc3BsYXkgfSwgY2hpbGRyZW46ICJTdXBwbGVtZW50cyIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICJyZXBlYXQoYXV0by1maXQsIG1pbm1heCgxNTBweCwgMWZyKSkiLCBnYXA6IDEwLCBtYXJnaW5Ub3A6IDEwIH0sIGNoaWxkcmVuOiBGRUFUVVJFRF9TVVBQTEVNRU5UUy5tYXAoKGl0ZW0pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZpc3VhbCA9IGdldFN1cHBsZW1lbnRWaXN1YWwoaXRlbS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImEiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHJlZjogaXRlbS5hbWF6b25VcmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiAiX2JsYW5rIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWw6ICJub29wZW5lciBub3JlZmVycmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogImNvbHVtbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0RGVjb3JhdGlvbjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAiI0ZGRkZGRiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVyZmxvdzogImhpZGRlbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5IZWlnaHQ6IDIxNAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU3VwcGxlbWVudFBob3RvLCB7IG5hbWU6IGl0ZW0ubmFtZSwgZmFsbGJhY2tJbWFnZTogdmlzdWFsLmltYWdlLCBjdXN0b21MYWJlbHM6IGl0ZW0ucGhvdG9MYWJlbHMgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjExcHggMTBweCA5cHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogImNvbHVtbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGV4OiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ6IDEuMzUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5IZWlnaHQ6IDMyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiAzMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogIi13ZWJraXQtYm94IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdlYmtpdExpbmVDbGFtcDogMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdlYmtpdEJveE9yaWVudDogInZlcnRpY2FsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRPdmVyZmxvdzogImVsbGlwc2lzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRCcmVhazogImJyZWFrLXdvcmQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogaXRlbS5jYXJkVGl0bGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzcGFuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Ub3A6IDQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnblNlbGY6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDUwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0dGVyU3BhY2luZzogMC4zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA5OTksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNHB4IDhweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogIlZpZXcgZGV0YWlscyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Ub3A6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAiI0Y4RjdGMyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVIZWlnaHQ6IDEuNDUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiU3VwcGxlbWVudHMgYXJlIG9wdGlvbmFsIGFuZCBub3QgbWVkaWNhbCBhZHZpY2UuIENoZWNrIHdpdGggeW91ciBjbGluaWNpYW4sIGVzcGVjaWFsbHkgaWYgeW91IHVzZSBwcmVzY3JpcHRpb24gbWVkaWNhdGlvbnMgb3IgaGF2ZSBoZWFsdGggY29uZGl0aW9ucy4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkZXRhaWxzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTBweCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdW1tYXJ5IiwgeyBzdHlsZTogeyBjdXJzb3I6ICJwb2ludGVyIiwgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIGZvbnRGYW1pbHk6IEZPTlRTLmRpc3BsYXkgfSwgY2hpbGRyZW46ICJHdWlkYW5jZSBBbmQgTWVudG9yc2hpcCIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdhcDogOCwgbWFyZ2luVG9wOiAxMCB9LCBjaGlsZHJlbjogcHJvZmlsZS5tZW50b3JpbmcubWFwKChpdGVtKSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGxpbmVIZWlnaHQ6IDEuNDUgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhyZWY6IGl0ZW0udXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogIl9ibGFuayIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsOiAibm9vcGVuZXIgbm9yZWZlcnJlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywgZm9udFdlaWdodDogNzAwLCB0ZXh0RGVjb3JhdGlvbjogIm5vbmUiLCBmb250RmFtaWx5OiBGT05UUy5kaXNwbGF5IH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IGl0ZW0ubGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBpdGVtLm5vdGUgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdIH0sIGl0ZW0ubGFiZWwpKSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJMaWdodH1gLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogMTQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAiI2ZmZiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAxNAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgzIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgMTBweCIsIGZvbnRTaXplOiAxNSB9LCBjaGlsZHJlbjogIlByb2ZpbGUgc2NvcmUgYnJlYWtkb3duIiB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBQUk9GSUxFX09SREVSLm1hcCgocHJvZmlsZUtleSkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZm9udFNpemU6IDEyLCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46IFBST0ZJTEVTW3Byb2ZpbGVLZXldLmxhYmVsIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IHNjb3Jlc1twcm9maWxlS2V5XSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgaGVpZ2h0OiA4LCBib3JkZXJSYWRpdXM6IDk5OSwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZyB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGAke01hdGgubWF4KDgsIE1hdGgucm91bmQoc2NvcmVzW3Byb2ZpbGVLZXldIC8gbWF4U2NvcmUgKiAxMDApKX0lYCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogIjEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA5OTksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IFBST0ZJTEVTW3Byb2ZpbGVLZXldLmFjY2VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSB9KQogICAgICAgICAgICAgICAgICAgICAgICAgIF0gfSwgcHJvZmlsZUtleSkpIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogaGFuZGxlQ29weVBsYW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aDogMTYwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjExcHggMTRweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IGNvcGllZCA/ICJDb3BpZWQiIDogIkNvcHkgbXkgNy1kYXkgcGxhbiIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogaGFuZGxlUmVzdGFydCwKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1mbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA3LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTFweCAxNHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShSb3RhdGVDY3csIHsgc2l6ZTogMTQgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIFJldGFrZSBxdWl6IgogICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgIXNob3dIb21lU2NyZWVuICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpblRvcDogMTgsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3A6IDE0LAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCwKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICBmbGV4V3JhcDogIndyYXAiLAogICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDgKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0U2hvd1N1YnNjcmliZU1vZGFsKHRydWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImlubGluZS1mbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhcDogNywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTBweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1haWwsIHsgc2l6ZTogMTQgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgV2Vla2x5IHRpcHMiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA3LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTWVzc2FnZVNxdWFyZSwgeyBzaXplOiAxNCB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBGZWVkYmFjayIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICFlbmpveVZvdGUgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luTGVmdDogImF1dG8iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5pbnB1dEJnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggOHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiRW5qb3lpbmcgdGhpcyBxdWl6PyIgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gaGFuZGxlRW5qb3lWb3RlKCJ1cCIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaHVtYnNVcCwgeyBzaXplOiAxNCB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBoYW5kbGVFbmpveVZvdGUoImRvd24iKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogeyBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogInRyYW5zcGFyZW50IiwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgY29sb3I6IENPTE9SUy5kYW5nZXIgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRodW1ic0Rvd24sIHsgc2l6ZTogMTQgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIHNob3dTdWJzY3JpYmVNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgICAgICAgICAgaW5zZXQ6IDAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjQ1KSIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBwYWRkaW5nOiAxMiwKICAgICAgICAgICAgICB6SW5kZXg6IDIwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSksCiAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAiZGl2IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwKICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgIG1heFdpZHRoOiA0MjAsCiAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNiwKICAgICAgICAgICAgICAgICAgcGFkZGluZzogMTgsCiAgICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgzIiwgeyBzdHlsZTogeyBtYXJnaW46ICIwIDAgOHB4IiwgZm9udFNpemU6IDE4IH0sIGNoaWxkcmVuOiAiR2V0IHdlZWtseSBmYXQtbG9zcyB0aXBzIiB9KSwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiMCAwIDEycHgiLCBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIldlIHNlbmQgcHJhY3RpY2FsLCBuby1ub2lzZSBpZGVhcyB5b3UgY2FuIGFwcGx5IGluIHJlYWwgbGlmZS4iIH0pLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN1YnNjcmliZUVtYWlsLAogICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRTdWJzY3JpYmVFbWFpbChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogInlvdUBleGFtcGxlLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTQKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgIHN1YnNjcmliZU1lc3NhZ2UgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDEwLCBmb250U2l6ZTogMTIsIGNvbG9yOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJzdWNjZXNzIiA/IENPTE9SUy5wcmltYXJ5RGFyayA6IENPTE9SUy5kYW5nZXIgfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBtYXJnaW5Ub3A6IDE0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogaGFuZGxlU3Vic2NyaWJlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZDogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmxleDogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTJweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJpbmxpbmUtZmxleCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGdhcDogNgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2FkZXJDaXJjbGUsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IGFuaW1hdGlvbjogInNwaW4gMXMgbGluZWFyIGluZmluaXRlIiB9IH0pIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAiU3Vic2NyaWJlIgogICAgICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogImJ0bi1wcmVzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiQ2xvc2UiCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICBzaG93RmVlZGJhY2tNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICAgICAgICAgICAgaW5zZXQ6IDAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjQ1KSIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBwYWRkaW5nOiAxMiwKICAgICAgICAgICAgICB6SW5kZXg6IDIwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKSwKICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgbWF4V2lkdGg6IDQyMCwKICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDE2LAogICAgICAgICAgICAgICAgICBwYWRkaW5nOiAxOCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEhlYXJ0LCB7IHNpemU6IDE2LCBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgzIiwgeyBzdHlsZTogeyBtYXJnaW46IDAsIGZvbnRTaXplOiAxOCB9LCBjaGlsZHJlbjogIlNoYXJlIHF1aWNrIGZlZWRiYWNrIiB9KQogICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICJ0ZXh0YXJlYSIsCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZlZWRiYWNrVGV4dCwKICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RmVlZGJhY2tUZXh0KGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiV2hhdCBmZWx0IHVzZWZ1bCwgY29uZnVzaW5nLCBvciBtaXNzaW5nPyIsCiAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siLAogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgICAgICAgICAgICBtaW5IZWlnaHQ6IDExMCwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgICAgICAgICByZXNpemU6ICJ2ZXJ0aWNhbCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJveFNpemluZzogImJvcmRlci1ib3giCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgY29sb3I6IENPTE9SUy5kYW5nZXIsIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogIkNvdWxkIG5vdCBzdWJtaXQgZmVlZGJhY2suIiB9KSwKICAgICAgICAgICAgICAgICAgZmVlZGJhY2tTdGF0dXMgPT09ICJzdWNjZXNzIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiAiRmVlZGJhY2sgc2VudC4gVGhhbmsgeW91LiIgfSksCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBtYXJnaW5Ub3A6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAiYnRuLXByZXNzIiwKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljazogaGFuZGxlRmVlZGJhY2tTdWJtaXQsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkOiBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciLAogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDcwMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiaW5saW5lLWZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDYKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2FkZXJDaXJjbGUsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IGFuaW1hdGlvbjogInNwaW4gMXMgbGluZWFyIGluZmluaXRlIiB9IH0pIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAiU2VuZCIKICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICJidG4tcHJlc3MiLAogICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSksCiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiQ2xvc2UiCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdCiAgICB9CiAgKTsKfQoKLy8gd2ViL3NyYy9tYWluLnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lMiA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIEVycm9yQm91bmRhcnkgPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDQuZGVmYXVsdC5Db21wb25lbnQgewogIGNvbnN0cnVjdG9yKHByb3BzKSB7CiAgICBzdXBlcihwcm9wcyk7CiAgICB0aGlzLnN0YXRlID0geyBoYXNFcnJvcjogZmFsc2UgfTsKICB9CiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvcikgewogICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIGVycm9yIH07CiAgfQogIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHsKICAgIGNvbnNvbGUuZXJyb3IoIldpZGdldCBFcnJvciBCb3VuZGFyeSBjYXVnaHQgZXJyb3I6IiwgZXJyb3IsIGVycm9ySW5mbyk7CiAgICB0cnkgewogICAgICBmZXRjaCgiL2FwaS90cmFjayIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogImNyYXNoIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yPy5tZXNzYWdlIHx8ICJVbmtub3duIGVycm9yIiwKICAgICAgICAgICAgc3RhY2s6IGVycm9yPy5zdGFjaywKICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mbz8uY29tcG9uZW50U3RhY2sKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlcG9ydCBjcmFzaCIsIGUpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuc3RhdGUuaGFzRXJyb3IpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udEZhbWlseTogInNhbnMtc2VyaWYiLCBjb2xvcjogIiNEQzI2MjYiLCB3b3JkQnJlYWs6ICJicmVhay13b3JkIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgY2hpbGRyZW46ICJTb21ldGhpbmcgd2VudCB3cm9uZy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBjaGlsZHJlbjogIlBsZWFzZSB0cnkgcmVmcmVzaGluZyB0aGUgcGFnZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGV0YWlscyIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMCwgdGV4dEFsaWduOiAibGVmdCIsIGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiAiIzY2NiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdW1tYXJ5IiwgeyBjaGlsZHJlbjogIkRlYnVnIEVycm9yIERldGFpbHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIGJhY2tncm91bmQ6ICIjZjVmNWY1IiwgcGFkZGluZzogMTAsIGJvcmRlclJhZGl1czogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy50b1N0cmluZygpLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnN0YWNrCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW47CiAgfQp9Owp2YXIgZ2V0SHlkcmF0aW9uRGF0YSA9ICgpID0+IHsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gU3RhcnRpbmcgaHlkcmF0aW9uIGNoZWNrLi4uIik7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gV2luZG93IGlzIHVuZGVmaW5lZCIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCBvYSA9IHdpbmRvdy5vcGVuYWk7CiAgaWYgKCFvYSkgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgbm90IGZvdW5kLCByZW5kZXJpbmcgd2l0aCBkZWZhdWx0cyIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBmb3VuZDoiLCBPYmplY3Qua2V5cyhvYSkpOwogIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICBvYS50b29sT3V0cHV0LAogICAgb2Euc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EudG9vbElucHV0CiAgXTsKICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gRm91bmQgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTm8gZGF0YSBmb3VuZCBpbiBhbnkgY2FuZGlkYXRlIHNvdXJjZSIpOwogIHJldHVybiB7fTsKfTsKY29uc29sZS5sb2coIltNYWluXSBXZWlnaHQgTG9zcyBRdWl6IG1haW4udHN4IGxvYWRpbmcuLi4iKTsKZnVuY3Rpb24gQXBwKHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KSB7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFdlaWdodExvc3NRdWl6LCB7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSk7Cn0KdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ3ZWlnaHQtbG9zcy1xdWl6LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoIndlaWdodC1sb3NzLXF1aXotcm9vdCBlbGVtZW50IG5vdCBmb3VuZCIpOwp9CnZhciByb290ID0gKDAsIGltcG9ydF9jbGllbnQuY3JlYXRlUm9vdCkoY29udGFpbmVyKTsKdmFyIHJlbmRlckFwcCA9IChkYXRhKSA9PiB7CiAgcm9vdC5yZW5kZXIoCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShpbXBvcnRfcmVhY3Q0LmRlZmF1bHQuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoRXJyb3JCb3VuZGFyeSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQXBwLCB7IGluaXRpYWxEYXRhOiBkYXRhIH0sIERhdGUubm93KCkpIH0pIH0pCiAgKTsKfTsKdmFyIGluaXRpYWxEYXRhID0gZ2V0SHlkcmF0aW9uRGF0YSgpOwpyZW5kZXJBcHAoaW5pdGlhbERhdGEpOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3BlbmFpOnNldF9nbG9iYWxzIiwgKGV2KSA9PiB7CiAgY29uc3QgZ2xvYmFscyA9IGV2Py5kZXRhaWw/Lmdsb2JhbHM7CiAgaWYgKGdsb2JhbHMpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBMYXRlIGV2ZW50IHJlY2VpdmVkOiIsIGdsb2JhbHMpOwogICAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgICAgZ2xvYmFscy50b29sT3V0cHV0LAogICAgICBnbG9iYWxzLnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMudG9vbElucHV0CiAgICBdOwogICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBsYXRlIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgICByZW5kZXJBcHAoY2FuZGlkYXRlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9Cn0pOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigKICAibWVzc2FnZSIsCiAgKGV2ZW50KSA9PiB7CiAgICBpZiAoZXZlbnQuc291cmNlICE9PSB3aW5kb3cucGFyZW50KSByZXR1cm47CiAgICBjb25zdCBtZXNzYWdlID0gZXZlbnQuZGF0YTsKICAgIGlmICghbWVzc2FnZSB8fCBtZXNzYWdlLmpzb25ycGMgIT09ICIyLjAiKSByZXR1cm47CiAgICBpZiAobWVzc2FnZS5tZXRob2QgIT09ICJ1aS9ub3RpZmljYXRpb25zL3Rvb2wtcmVzdWx0IikgcmV0dXJuOwogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE1DUCBBcHBzIGJyaWRnZSB0b29sLXJlc3VsdCByZWNlaXZlZDoiLCBtZXNzYWdlLnBhcmFtcyk7CiAgICBjb25zdCB0b29sUmVzdWx0ID0gbWVzc2FnZS5wYXJhbXM7CiAgICBjb25zdCBkYXRhID0gdG9vbFJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQgPz8gdG9vbFJlc3VsdD8ucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCA/PyB7fTsKICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBNQ1AgQXBwcyBicmlkZ2UgZGF0YToiLCBkYXRhKTsKICAgICAgcmVuZGVyQXBwKGRhdGEpOwogICAgfQogIH0sCiAgeyBwYXNzaXZlOiB0cnVlIH0KKTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2FjdGl2aXR5LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctcmlnaHQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGFydC1jb2x1bW4uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLWxlZnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9mbGFtZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Zvb3RwcmludHMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9oZWFydC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci1jaXJjbGUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc3BhcmtsZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90YXJnZXQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aHVtYnMtZG93bi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RpbWVyLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJvcGh5LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vbHVjaWRlLXJlYWN0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiovCg==";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Weight-Loss Quiz] Failed to load:', err);
          const root = document.getElementById('weight-loss-quiz-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load quiz</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
